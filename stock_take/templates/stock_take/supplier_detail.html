{% extends 'base.html' %}
{% load static %}

{% block title %}{{ supplier.name }} - Supplier{% endblock %}

{% block nav_suppliers_active %}active{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/suppliers.css' %}">
<link rel="stylesheet" href="{% static 'css/purchase_orders.css' %}">
{% endblock %}

{% block content %}
<div class="content-card">
    <div class="supplier-detail-header">
        <div class="supplier-detail-title">
            <a href="{% url 'suppliers_list' %}" class="back-link" title="Back to Suppliers">
                <i class="bi bi-arrow-left"></i>
            </a>
            <h1>{{ supplier.name }}</h1>
            {% if supplier.is_active %}
            <span class="supplier-active-badge active">Active</span>
            {% else %}
            <span class="supplier-active-badge inactive">Inactive</span>
            {% endif %}
        </div>
        <div class="supplier-detail-actions">
            <button class="btn-edit-customer" id="btn-edit" onclick="toggleEditMode()"><i class="bi bi-pencil"></i> Edit</button>
            <button class="btn-save-customer" id="btn-save" style="display:none;" onclick="saveSupplier()"><i class="bi bi-check-lg"></i> Save Changes</button>
            <button class="btn-cancel-customer" id="btn-cancel" style="display:none;" onclick="cancelEdit()"><i class="bi bi-x-lg"></i> Cancel</button>
        </div>
    </div>

    <div id="save-notification" class="customer-save-notification" style="display:none;"></div>

    <!-- Supplier Info Grid -->
    <div class="supplier-info-grid" id="supplier-info">
        <div class="supplier-info-section">
            <h3>Contact Information</h3>
            <div class="supplier-info-row">
                <span class="supplier-info-label">Name</span>
                <span class="supplier-info-value view-val">{{ supplier.name|default:"-" }}</span>
                <input class="customer-edit-input edit-val" data-field="name" value="{{ supplier.name|default:'' }}" style="display:none;">
            </div>
            <div class="supplier-info-row">
                <span class="supplier-info-label">Email</span>
                <span class="supplier-info-value view-val">
                    {% if supplier.email %}
                    <a href="mailto:{{ supplier.email }}">{{ supplier.email }}</a>
                    {% else %}-{% endif %}
                </span>
                <input class="customer-edit-input edit-val" data-field="email" type="email" value="{{ supplier.email|default:'' }}" style="display:none;">
            </div>
            <div class="supplier-info-row">
                <span class="supplier-info-label">Phone</span>
                <span class="supplier-info-value view-val">{{ supplier.phone|default:"-" }}</span>
                <input class="customer-edit-input edit-val" data-field="phone" value="{{ supplier.phone|default:'' }}" style="display:none;">
            </div>
            <div class="supplier-info-row">
                <span class="supplier-info-label">Fax</span>
                <span class="supplier-info-value view-val">{{ supplier.fax|default:"-" }}</span>
                <input class="customer-edit-input edit-val" data-field="fax" value="{{ supplier.fax|default:'' }}" style="display:none;">
            </div>
            <div class="supplier-info-row">
                <span class="supplier-info-label">Website</span>
                <span class="supplier-info-value view-val">
                    {% if supplier.website %}
                    <a href="{{ supplier.website }}" target="_blank">{{ supplier.website }}</a>
                    {% else %}-{% endif %}
                </span>
                <input class="customer-edit-input edit-val" data-field="website" value="{{ supplier.website|default:'' }}" style="display:none;">
            </div>
            <div class="supplier-info-row">
                <span class="supplier-info-label">Tax / VAT</span>
                <span class="supplier-info-value view-val">{{ supplier.abn|default:"-" }}</span>
                <input class="customer-edit-input edit-val" data-field="abn" value="{{ supplier.abn|default:'' }}" style="display:none;">
            </div>
        </div>

        <div class="supplier-info-section">
            <h3>Address</h3>
            <div class="supplier-info-row">
                <span class="supplier-info-label">Address 1</span>
                <span class="supplier-info-value view-val">{{ supplier.address_1|default:"-" }}</span>
                <input class="customer-edit-input edit-val" data-field="address_1" value="{{ supplier.address_1|default:'' }}" style="display:none;">
            </div>
            <div class="supplier-info-row">
                <span class="supplier-info-label">Address 2</span>
                <span class="supplier-info-value view-val">{{ supplier.address_2|default:"-" }}</span>
                <input class="customer-edit-input edit-val" data-field="address_2" value="{{ supplier.address_2|default:'' }}" style="display:none;">
            </div>
            <div class="supplier-info-row">
                <span class="supplier-info-label">City</span>
                <span class="supplier-info-value view-val">{{ supplier.city|default:"-" }}</span>
                <input class="customer-edit-input edit-val" data-field="city" value="{{ supplier.city|default:'' }}" style="display:none;">
            </div>
            <div class="supplier-info-row">
                <span class="supplier-info-label">State</span>
                <span class="supplier-info-value view-val">{{ supplier.state|default:"-" }}</span>
                <input class="customer-edit-input edit-val" data-field="state" value="{{ supplier.state|default:'' }}" style="display:none;">
            </div>
            <div class="supplier-info-row">
                <span class="supplier-info-label">Postcode</span>
                <span class="supplier-info-value view-val">{{ supplier.postcode|default:"-" }}</span>
                <input class="customer-edit-input edit-val" data-field="postcode" value="{{ supplier.postcode|default:'' }}" style="display:none;">
            </div>
            <div class="supplier-info-row">
                <span class="supplier-info-label">Country</span>
                <span class="supplier-info-value view-val">{{ supplier.country|default:"-" }}</span>
                <input class="customer-edit-input edit-val" data-field="country" value="{{ supplier.country|default:'' }}" style="display:none;">
            </div>
        </div>

        <div class="supplier-info-section">
            <h3>Financial</h3>
            <div class="supplier-info-row">
                <span class="supplier-info-label">Currency</span>
                <span class="supplier-info-value view-val">{{ supplier.currency|default:"GBP" }}</span>
                <input class="customer-edit-input edit-val" data-field="currency" value="{{ supplier.currency|default:'GBP' }}" style="display:none;">
            </div>
            <div class="supplier-info-row">
                <span class="supplier-info-label">Credit Limit</span>
                <span class="supplier-info-value view-val">£{{ supplier.credit_limit|floatformat:2 }}</span>
                <input class="customer-edit-input edit-val" data-field="credit_limit" type="number" step="0.01" value="{{ supplier.credit_limit }}" style="display:none;">
            </div>
            <div class="supplier-info-row">
                <span class="supplier-info-label">Credit Days</span>
                <span class="supplier-info-value view-val">{{ supplier.credit_days|default:"-" }}</span>
                <input class="customer-edit-input edit-val" data-field="credit_days" value="{{ supplier.credit_days|default:'' }}" style="display:none;">
            </div>
            <div class="supplier-info-row">
                <span class="supplier-info-label">Credit Terms</span>
                <span class="supplier-info-value view-val">{{ supplier.credit_terms_type|default:"-" }}</span>
                <input class="customer-edit-input edit-val" data-field="credit_terms_type" value="{{ supplier.credit_terms_type|default:'' }}" style="display:none;">
            </div>
            <div class="supplier-info-row">
                <span class="supplier-info-label">Tax Rate</span>
                <span class="supplier-info-value view-val">{{ supplier.supplier_tax_rate|default:"-" }}</span>
                <input class="customer-edit-input edit-val" data-field="supplier_tax_rate" value="{{ supplier.supplier_tax_rate|default:'' }}" style="display:none;">
            </div>
            <div class="supplier-info-row">
                <span class="supplier-info-label">Lead Time (days)</span>
                <span class="supplier-info-value view-val">{{ supplier.estimate_lead_time|default:"-" }}</span>
                <input class="customer-edit-input edit-val" data-field="estimate_lead_time" type="number" value="{{ supplier.estimate_lead_time|default:'' }}" style="display:none;">
            </div>
            <div class="supplier-info-row">
                <span class="supplier-info-label">Total Spend</span>
                <span class="supplier-info-value supplier-total-spend">£{{ total_spend|floatformat:2 }}</span>
            </div>
            <div class="supplier-info-row">
                <span class="supplier-info-label">Purchase Orders</span>
                <span class="supplier-info-value">{{ po_count }}</span>
            </div>
        </div>
    </div>

    <!-- Contacts Section -->
    <div class="supplier-po-section">
        <div class="contacts-section-header">
            <h2><i class="bi bi-person-lines-fill"></i> Contacts ({{ contacts|length }})</h2>
            <button class="btn-contact-action success" onclick="openAddContactModal()"><i class="bi bi-plus-lg"></i> Add Contact</button>
        </div>

        <div id="contacts-notification" class="customer-save-notification" style="display:none;"></div>

        {% if contacts %}
        <div class="po-table-container">
            <table class="po-table" id="contacts-table">
                <thead>
                    <tr>
                        <th>First Name</th>
                        <th>Last Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Position</th>
                        <th>Default</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for contact in contacts %}
                    <tr data-contact-id="{{ contact.id }}">
                        <td class="contact-first-name">{{ contact.first_name }}</td>
                        <td class="contact-last-name">{{ contact.last_name }}</td>
                        <td><a href="mailto:{{ contact.email }}">{{ contact.email }}</a></td>
                        <td>{{ contact.phone|default:"-" }}</td>
                        <td>{{ contact.position|default:"-" }}</td>
                        <td style="text-align:center;">
                            {% if contact.is_default %}
                            <span class="supplier-active-badge active">Default</span>
                            {% else %}
                            <button class="btn-contact-action primary" onclick="setDefault({{ contact.id }})"><i class="bi bi-star"></i> Set Default</button>
                            {% endif %}
                        </td>
                        <td style="white-space:nowrap;">
                            <button class="btn-contact-action secondary" onclick="openEditContactModal({{ contact.id }}, '{{ contact.first_name|escapejs }}', '{{ contact.last_name|escapejs }}', '{{ contact.email|escapejs }}', '{{ contact.phone|escapejs }}', '{{ contact.position|escapejs }}', {{ contact.is_default|yesno:'true,false' }})"><i class="bi bi-pencil"></i> Edit</button>
                            <button class="btn-contact-action danger" onclick="deleteContact({{ contact.id }})"><i class="bi bi-trash"></i> Delete</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="po-empty-state" id="contacts-empty">
            <p>No contacts added yet. Click <strong>Add Contact</strong> to add one.</p>
        </div>
        {% endif %}
    </div>

    <!-- Add/Edit Contact Modal -->
    <div id="contact-modal" class="contact-modal-overlay">
        <div class="contact-modal-box">
            <div class="contact-modal-header">
                <h3><i class="bi bi-person-vcard"></i> <span id="contact-modal-title">Add Contact</span></h3>
                <button class="contact-modal-close" onclick="closeContactModal()">&times;</button>
            </div>
            <input type="hidden" id="contact-modal-id" value="">
            <div class="contact-modal-body">
                <div class="contact-field-row">
                    <div class="contact-field">
                        <label>First Name</label>
                        <input type="text" id="contact-first-name" placeholder="First name">
                    </div>
                    <div class="contact-field">
                        <label>Last Name</label>
                        <input type="text" id="contact-last-name" placeholder="Last name">
                    </div>
                </div>
                <div class="contact-field-row">
                    <div class="contact-field full">
                        <label>Email</label>
                        <input type="email" id="contact-email" placeholder="email@example.com">
                    </div>
                </div>
                <div class="contact-field-row">
                    <div class="contact-field">
                        <label>Phone</label>
                        <input type="text" id="contact-phone" placeholder="Phone number">
                    </div>
                    <div class="contact-field">
                        <label>Position</label>
                        <input type="text" id="contact-position" placeholder="e.g. Head of Sales">
                    </div>
                </div>
                <label class="contact-default-check">
                    <input type="checkbox" id="contact-is-default">
                    <span>Set as default PO recipient</span>
                </label>
            </div>
            <div class="contact-modal-footer">
                <button class="btn-contact-action secondary" onclick="closeContactModal()">Cancel</button>
                <button class="btn-contact-action success" onclick="saveContact()"><i class="bi bi-check-lg"></i> Save Contact</button>
            </div>
        </div>
    </div>

    <!-- Purchase Orders for this supplier -->
    <div class="supplier-po-section">
        <h2><i class="bi bi-clipboard-check"></i> Purchase Orders ({{ po_count }})</h2>

        {% if purchase_orders %}
        <div class="po-table-container">
            <table class="po-table">
                <thead>
                    <tr>
                        <th>PO Number</th>
                        <th>Project</th>
                        <th>Description</th>
                        <th>Issue Date</th>
                        <th>Expected Date</th>
                        <th class="text-right">Total</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for po in purchase_orders %}
                    <tr>
                        <td>
                            <a href="{% url 'purchase_order_detail' po.workguru_id %}" class="po-number">
                                {{ po.display_number|default:"-" }}
                            </a>
                        </td>
                        <td>{{ po.project_name|default:"-" }}</td>
                        <td class="po-desc-cell">{{ po.description|default:"-"|truncatewords:10 }}</td>
                        <td>{{ po.issue_date|default:"-" }}</td>
                        <td>{{ po.expected_date|default:"-" }}</td>
                        <td class="text-right">£{{ po.total|floatformat:2 }}</td>
                        <td>
                            <span class="po-status {% if po.status == 'Draft' %}draft{% elif po.status == 'Sent' %}sent{% elif po.status == 'Received' %}received{% elif po.status == 'Approved' %}approved{% elif po.status == 'Cancelled' %}cancelled{% endif %}">
                                {{ po.status|default:"Draft" }}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="po-empty-state">
            <p>No purchase orders found for this supplier.</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
function toggleEditMode() {
    document.querySelectorAll('.view-val').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.edit-val').forEach(el => el.style.display = 'block');
    document.getElementById('btn-edit').style.display = 'none';
    document.getElementById('btn-save').style.display = 'inline-flex';
    document.getElementById('btn-cancel').style.display = 'inline-flex';
}

function cancelEdit() {
    document.querySelectorAll('.view-val').forEach(el => el.style.display = '');
    document.querySelectorAll('.edit-val').forEach(el => el.style.display = 'none');
    document.getElementById('btn-edit').style.display = 'inline-flex';
    document.getElementById('btn-save').style.display = 'none';
    document.getElementById('btn-cancel').style.display = 'none';
    // Reset inputs to original values
    document.querySelectorAll('.edit-val').forEach(input => {
        input.value = input.defaultValue;
    });
    hideNotification();
}

function saveSupplier() {
    const data = {};
    document.querySelectorAll('.edit-val[data-field]').forEach(input => {
        data[input.dataset.field] = input.value;
    });

    fetch("{% url 'supplier_save' supplier.workguru_id %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showNotification('Supplier details saved successfully!', 'success');
            // Update view values from saved data
            document.querySelectorAll('.edit-val[data-field]').forEach(input => {
                const field = input.dataset.field;
                const row = input.closest('.supplier-info-row');
                const viewVal = row.querySelector('.view-val');
                if (viewVal) {
                    const val = input.value || '-';
                    if (field === 'email' && input.value) {
                        viewVal.innerHTML = '<a href="mailto:' + input.value + '">' + input.value + '</a>';
                    } else if (field === 'website' && input.value) {
                        viewVal.innerHTML = '<a href="' + input.value + '" target="_blank">' + input.value + '</a>';
                    } else if (field === 'credit_limit') {
                        viewVal.textContent = '£' + parseFloat(input.value || 0).toFixed(2);
                    } else {
                        viewVal.textContent = val;
                    }
                }
                input.defaultValue = input.value;
            });
            // Update page title if name changed
            const nameInput = document.querySelector('.edit-val[data-field="name"]');
            if (nameInput) {
                document.querySelector('.supplier-detail-title h1').textContent = nameInput.value;
            }
            cancelEdit();
        } else {
            showNotification('Error: ' + result.error, 'error');
        }
    })
    .catch(error => {
        showNotification('Error saving supplier details.', 'error');
    });
}

function showNotification(message, type) {
    const notif = document.getElementById('save-notification');
    notif.textContent = message;
    notif.className = 'customer-save-notification ' + type;
    notif.style.display = 'block';
    if (type === 'success') {
        setTimeout(() => hideNotification(), 3000);
    }
}

function hideNotification() {
    document.getElementById('save-notification').style.display = 'none';
}

// ── Contacts ──────────────────────────────────────────────────────────────────

const SUPPLIER_ID = {{ supplier.workguru_id }};
const URL_CONTACT_ADD    = "{% url 'supplier_contact_add' supplier.workguru_id %}";
const URL_CONTACT_EDIT   = (id) => `/stock/supplier/${SUPPLIER_ID}/contacts/${id}/edit/`;
const URL_CONTACT_DELETE = (id) => `/stock/supplier/${SUPPLIER_ID}/contacts/${id}/delete/`;
const URL_CONTACT_DEFAULT = (id) => `/stock/supplier/${SUPPLIER_ID}/contacts/${id}/set-default/`;

function openAddContactModal() {
    document.getElementById('contact-modal-title').textContent = 'Add Contact';
    document.getElementById('contact-modal-id').value = '';
    document.getElementById('contact-first-name').value = '';
    document.getElementById('contact-last-name').value = '';
    document.getElementById('contact-email').value = '';
    document.getElementById('contact-phone').value = '';
    document.getElementById('contact-position').value = '';
    document.getElementById('contact-is-default').checked = false;
    document.getElementById('contact-modal').classList.add('open');
}

function openEditContactModal(id, firstName, lastName, email, phone, position, isDefault) {
    document.getElementById('contact-modal-title').textContent = 'Edit Contact';
    document.getElementById('contact-modal-id').value = id;
    document.getElementById('contact-first-name').value = firstName;
    document.getElementById('contact-last-name').value = lastName;
    document.getElementById('contact-email').value = email;
    document.getElementById('contact-phone').value = phone;
    document.getElementById('contact-position').value = position;
    document.getElementById('contact-is-default').checked = isDefault;
    document.getElementById('contact-modal').classList.add('open');
}

function closeContactModal() {
    document.getElementById('contact-modal').classList.remove('open');
}

function showContactNotification(message, type) {
    const n = document.getElementById('contacts-notification');
    n.textContent = message;
    n.className = 'customer-save-notification ' + type;
    n.style.display = 'block';
    if (type === 'success') setTimeout(() => { n.style.display = 'none'; }, 3000);
}

function saveContact() {
    const id = document.getElementById('contact-modal-id').value;
    const body = {
        first_name: document.getElementById('contact-first-name').value.trim(),
        last_name:  document.getElementById('contact-last-name').value.trim(),
        email:      document.getElementById('contact-email').value.trim(),
        phone:      document.getElementById('contact-phone').value.trim(),
        position:   document.getElementById('contact-position').value.trim(),
        is_default: document.getElementById('contact-is-default').checked,
    };
    const url = id ? URL_CONTACT_EDIT(id) : URL_CONTACT_ADD;
    fetch(url, {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken')},
        body: JSON.stringify(body),
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            closeContactModal();
            showContactNotification(id ? 'Contact updated.' : 'Contact added.', 'success');
            setTimeout(() => location.reload(), 700);
        } else {
            showContactNotification(data.error || 'Failed to save contact.', 'error');
        }
    })
    .catch(() => showContactNotification('Error saving contact.', 'error'));
}

function deleteContact(id) {
    if (!confirm('Delete this contact?')) return;
    fetch(URL_CONTACT_DELETE(id), {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken')},
        body: '{}',
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            document.querySelector(`#contacts-table tr[data-contact-id="${id}"]`)?.remove();
            showContactNotification('Contact deleted.', 'success');
        } else {
            showContactNotification(data.error || 'Failed to delete.', 'error');
        }
    })
    .catch(() => showContactNotification('Error deleting contact.', 'error'));
}

function setDefault(id) {
    fetch(URL_CONTACT_DEFAULT(id), {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken')},
        body: '{}',
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showContactNotification('Default contact updated.', 'success');
            setTimeout(() => location.reload(), 700);
        } else {
            showContactNotification(data.error || 'Failed to set default.', 'error');
        }
    })
    .catch(() => showContactNotification('Error setting default.', 'error'));
}

function getCookie(name) {
    const v = document.cookie.match('(^|;) ?' + name + '=([^;]*)(;|$)');
    return v ? v[2] : null;
}

// Close modal on backdrop click
document.getElementById('contact-modal').addEventListener('click', function(e) {
    if (e.target === this) closeContactModal();
});

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closeContactModal();
});
</script>
{% endblock %}
