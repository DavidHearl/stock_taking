{% extends 'base.html' %}
{% load static %}

{% block title %}{{ customer.name }} - Customer{% endblock %}

{% block nav_stock_active %}active{% endblock %}
{% block nav_customers_active %}active{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/customers.css' %}">
{% endblock %}

{% block content %}
<div class="content-card">
    <div class="customer-detail-header">
        <div class="customer-detail-title">
            <a href="{% url 'customers_list' %}" class="back-link" title="Back to Customers">
                <i class="bi bi-arrow-left"></i>
            </a>
            <h1>{{ customer.name|default:customer }}</h1>
            {% if customer.is_active %}
            <span class="customer-active-badge active">Active</span>
            {% else %}
            <span class="customer-active-badge inactive">Inactive</span>
            {% endif %}
            {% if customer.code %}
            <span class="customer-code-badge">{{ customer.code }}</span>
            {% endif %}
        </div>
        <div class="customer-detail-actions">
            <button class="btn-edit-customer" id="btn-edit" onclick="toggleEditMode()"><i class="bi bi-pencil"></i> Edit</button>
            <button class="btn-save-customer" id="btn-save" style="display:none;" onclick="saveCustomer()"><i class="bi bi-check-lg"></i> Save Changes</button>
            <button class="btn-cancel-customer" id="btn-cancel" style="display:none;" onclick="cancelEdit()"><i class="bi bi-x-lg"></i> Cancel</button>
        </div>
    </div>

    <div id="save-notification" class="customer-save-notification" style="display:none;"></div>

    <!-- Customer Info Grid (like WorkGuru client detail) -->
    <div class="customer-info-grid" id="customer-info">
        <!-- Contact Information -->
        <div class="customer-info-section">
            <h3><i class="bi bi-person-lines-fill"></i> Contact Details</h3>
            <div class="customer-info-row">
                <span class="customer-info-label">Name</span>
                <span class="customer-info-value view-val">{{ customer.name|default:"-" }}</span>
                <input class="customer-edit-input edit-val" data-field="name" value="{{ customer.name|default:'' }}" style="display:none;">
            </div>
            <div class="customer-info-row">
                <span class="customer-info-label">Email</span>
                <span class="customer-info-value view-val">
                    {% if customer.email %}
                    <a href="mailto:{{ customer.email }}">{{ customer.email }}</a>
                    {% else %}-{% endif %}
                </span>
                <input class="customer-edit-input edit-val" data-field="email" type="email" value="{{ customer.email|default:'' }}" style="display:none;">
            </div>
            <div class="customer-info-row">
                <span class="customer-info-label">Phone</span>
                <span class="customer-info-value view-val">{{ customer.phone|default:"-" }}</span>
                <input class="customer-edit-input edit-val" data-field="phone" value="{{ customer.phone|default:'' }}" style="display:none;">
            </div>
            <div class="customer-info-row">
                <span class="customer-info-label">Fax</span>
                <span class="customer-info-value view-val">{{ customer.fax|default:"-" }}</span>
                <input class="customer-edit-input edit-val" data-field="fax" value="{{ customer.fax|default:'' }}" style="display:none;">
            </div>
            <div class="customer-info-row">
                <span class="customer-info-label">Website</span>
                <span class="customer-info-value view-val">
                    {% if customer.website %}
                    <a href="{{ customer.website }}" target="_blank">{{ customer.website }}</a>
                    {% else %}-{% endif %}
                </span>
                <input class="customer-edit-input edit-val" data-field="website" value="{{ customer.website|default:'' }}" style="display:none;">
            </div>
            <div class="customer-info-row">
                <span class="customer-info-label">Tax / VAT</span>
                <span class="customer-info-value view-val">{{ customer.abn|default:"-" }}</span>
                <input class="customer-edit-input edit-val" data-field="abn" value="{{ customer.abn|default:'' }}" style="display:none;">
            </div>
            <div class="customer-info-row">
                <span class="customer-info-label">Client Code</span>
                <span class="customer-info-value view-val">{{ customer.code|default:"-" }}</span>
                <input class="customer-edit-input edit-val" data-field="code" value="{{ customer.code|default:'' }}" style="display:none;">
            </div>
        </div>

        <!-- Address -->
        <div class="customer-info-section">
            <h3><i class="bi bi-geo-alt"></i> Address</h3>
            <div class="customer-info-row">
                <span class="customer-info-label">Address 1</span>
                <span class="customer-info-value view-val">{{ customer.address_1|default:"-" }}</span>
                <input class="customer-edit-input edit-val" data-field="address_1" value="{{ customer.address_1|default:'' }}" style="display:none;">
            </div>
            <div class="customer-info-row">
                <span class="customer-info-label">Address 2</span>
                <span class="customer-info-value view-val">{{ customer.address_2|default:"-" }}</span>
                <input class="customer-edit-input edit-val" data-field="address_2" value="{{ customer.address_2|default:'' }}" style="display:none;">
            </div>
            <div class="customer-info-row">
                <span class="customer-info-label">City</span>
                <span class="customer-info-value view-val">{{ customer.city|default:"-" }}</span>
                <input class="customer-edit-input edit-val" data-field="city" value="{{ customer.city|default:'' }}" style="display:none;">
            </div>
            <div class="customer-info-row">
                <span class="customer-info-label">Suburb</span>
                <span class="customer-info-value view-val">{{ customer.suburb|default:"-" }}</span>
                <input class="customer-edit-input edit-val" data-field="suburb" value="{{ customer.suburb|default:'' }}" style="display:none;">
            </div>
            <div class="customer-info-row">
                <span class="customer-info-label">State</span>
                <span class="customer-info-value view-val">{{ customer.state|default:"-" }}</span>
                <input class="customer-edit-input edit-val" data-field="state" value="{{ customer.state|default:'' }}" style="display:none;">
            </div>
            <div class="customer-info-row">
                <span class="customer-info-label">Postcode</span>
                <span class="customer-info-value view-val">{{ customer.postcode|default:"-" }}</span>
                <input class="customer-edit-input edit-val" data-field="postcode" value="{{ customer.postcode|default:'' }}" style="display:none;">
            </div>
            <div class="customer-info-row">
                <span class="customer-info-label">Country</span>
                <span class="customer-info-value view-val">{{ customer.country|default:"-" }}</span>
                <input class="customer-edit-input edit-val" data-field="country" value="{{ customer.country|default:'' }}" style="display:none;">
            </div>
        </div>

        <!-- Financial & Settings -->
        <div class="customer-info-section">
            <h3><i class="bi bi-cash-stack"></i> Financial</h3>
            <div class="customer-info-row">
                <span class="customer-info-label">Currency</span>
                <span class="customer-info-value view-val">{{ customer.currency|default:"GBP" }}</span>
                <input class="customer-edit-input edit-val" data-field="currency" value="{{ customer.currency|default:'GBP' }}" style="display:none;">
            </div>
            <div class="customer-info-row">
                <span class="customer-info-label">Price Tier</span>
                <span class="customer-info-value view-val">{{ customer.price_tier|default:"-" }}</span>
                <input class="customer-edit-input edit-val" data-field="price_tier" value="{{ customer.price_tier|default:'' }}" style="display:none;">
            </div>
            <div class="customer-info-row">
                <span class="customer-info-label">Credit Terms</span>
                <span class="customer-info-value view-val">{{ customer.credit_terms_type|default:"-" }}</span>
                <input class="customer-edit-input edit-val" data-field="credit_terms_type" value="{{ customer.credit_terms_type|default:'' }}" style="display:none;">
            </div>
            <div class="customer-info-row">
                <span class="customer-info-label">Credit Days</span>
                <span class="customer-info-value view-val">{{ customer.credit_days|default:"-" }}</span>
                <input class="customer-edit-input edit-val" data-field="credit_days" value="{{ customer.credit_days|default:'' }}" style="display:none;">
            </div>
            <div class="customer-info-row">
                <span class="customer-info-label">Credit Limit</span>
                <span class="customer-info-value view-val">Â£{{ customer.credit_limit|floatformat:2 }}</span>
                <input class="customer-edit-input edit-val" data-field="credit_limit" type="number" step="0.01" value="{{ customer.credit_limit }}" style="display:none;">
            </div>
            <div class="customer-info-row">
                <span class="customer-info-label">Billing Client</span>
                <span class="customer-info-value view-val">{{ customer.billing_client|default:"-" }}</span>
                <input class="customer-edit-input edit-val" data-field="billing_client" value="{{ customer.billing_client|default:'' }}" style="display:none;">
            </div>
            <div class="customer-info-row">
                <span class="customer-info-label">Xero ID</span>
                <span class="customer-info-value customer-mono view-val">{{ customer.xero_id|default:"-" }}</span>
            </div>
        </div>
    </div>

    <!-- Tabs Section (WorkGuru style) -->
    <div class="customer-tabs-section">
        <div class="customer-tabs">
            <button class="customer-tab active" data-tab="contacts" onclick="switchTab('contacts')">
                <i class="bi bi-person-badge"></i> Contacts
                {% if contacts %}<span class="tab-count">{{ contacts|length }}</span>{% endif %}
            </button>
            <button class="customer-tab" data-tab="projects" onclick="switchTab('projects')">
                <i class="bi bi-folder"></i> Projects
                {% if orders %}<span class="tab-count">{{ order_count }}</span>{% endif %}
            </button>
            <button class="customer-tab" data-tab="invoices" onclick="switchTab('invoices')">
                <i class="bi bi-receipt"></i> Invoices
            </button>
            <button class="customer-tab" data-tab="quotes" onclick="switchTab('quotes')">
                <i class="bi bi-file-text"></i> Quotes
            </button>
            <button class="customer-tab" data-tab="notes" onclick="switchTab('notes')">
                <i class="bi bi-journal-text"></i> General Notes
            </button>
        </div>

        <!-- Contacts Tab -->
        <div class="customer-tab-content active" id="tab-contacts">
            {% if contacts %}
            <div class="customer-contacts-grid">
                {% for contact in contacts %}
                <div class="customer-contact-card">
                    <div class="contact-name">
                        <i class="bi bi-person-circle"></i>
                        {{ contact.firstName|default:"" }} {{ contact.lastName|default:"" }}
                    </div>
                    {% if contact.email %}
                    <div class="contact-detail">
                        <i class="bi bi-envelope"></i>
                        <a href="mailto:{{ contact.email }}">{{ contact.email }}</a>
                    </div>
                    {% endif %}
                    {% if contact.phone %}
                    <div class="contact-detail">
                        <i class="bi bi-telephone"></i> {{ contact.phone }}
                    </div>
                    {% endif %}
                    {% if contact.mobile %}
                    <div class="contact-detail">
                        <i class="bi bi-phone"></i> {{ contact.mobile }}
                    </div>
                    {% endif %}
                    {% if contact.position %}
                    <div class="contact-detail">
                        <i class="bi bi-briefcase"></i> {{ contact.position }}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="customer-tab-empty">
                <i class="bi bi-person-badge"></i>
                <p>No contacts found for this customer.</p>
            </div>
            {% endif %}
        </div>

        <!-- Projects Tab -->
        <div class="customer-tab-content" id="tab-projects">
            {% if orders %}
            <div class="customer-table-container">
                <table class="customer-orders-table">
                    <thead>
                        <tr>
                            <th>Sale Number</th>
                            <th>Order Date</th>
                            <th>Fit Date</th>
                            <th>Type</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders %}
                        <tr>
                            <td>
                                <a href="{% url 'order_details' order.id %}" class="customer-order-link">
                                    {{ order.sale_number }}
                                </a>
                            </td>
                            <td>{{ order.order_date|date:"d/m/Y" }}</td>
                            <td>{{ order.fit_date|date:"d/m/Y" }}</td>
                            <td>
                                <span class="order-type-badge {{ order.order_type }}">
                                    {{ order.get_order_type_display }}
                                </span>
                            </td>
                            <td>
                                {% if order.job_finished %}
                                <span class="order-status-badge finished">Finished</span>
                                {% else %}
                                <span class="order-status-badge active">Active</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="customer-tab-empty">
                <i class="bi bi-folder"></i>
                <p>No projects linked to this customer.</p>
            </div>
            {% endif %}
        </div>

        <!-- Invoices Tab -->
        <div class="customer-tab-content" id="tab-invoices">
            <div class="customer-tab-empty">
                <i class="bi bi-receipt"></i>
                <p>Invoice data will be available once synced from WorkGuru.</p>
            </div>
        </div>

        <!-- Quotes Tab -->
        <div class="customer-tab-content" id="tab-quotes">
            <div class="customer-tab-empty">
                <i class="bi bi-file-text"></i>
                <p>Quote data will be available once synced from WorkGuru.</p>
            </div>
        </div>

        <!-- General Notes Tab -->
        <div class="customer-tab-content" id="tab-notes">
            <div class="customer-tab-empty">
                <i class="bi bi-journal-text"></i>
                <p>No general notes for this customer.</p>
            </div>
        </div>
    </div>

    <!-- System Info -->
    <div class="customer-system-info">
        <div class="system-info-row">
            <span>WorkGuru ID</span>
            <span class="customer-mono">{{ customer.workguru_id|default:"-" }}</span>
        </div>
        {% if customer.creation_time %}
        <div class="system-info-row">
            <span>Created</span>
            <span>{{ customer.creation_time|date:"d/m/Y H:i" }}</span>
        </div>
        {% endif %}
        {% if customer.last_modification_time %}
        <div class="system-info-row">
            <span>Last Modified</span>
            <span>{{ customer.last_modification_time|date:"d/m/Y H:i" }}</span>
        </div>
        {% endif %}
    </div>
</div>

<script>
function switchTab(tabName) {
    document.querySelectorAll('.customer-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.customer-tab-content').forEach(c => c.classList.remove('active'));
    document.querySelector(`.customer-tab[data-tab="${tabName}"]`).classList.add('active');
    document.getElementById(`tab-${tabName}`).classList.add('active');
}

function toggleEditMode() {
    document.getElementById('customer-info').classList.add('editing');
    document.querySelectorAll('.view-val').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.edit-val').forEach(el => el.style.display = 'block');
    document.getElementById('btn-edit').style.display = 'none';
    document.getElementById('btn-save').style.display = 'inline-flex';
    document.getElementById('btn-cancel').style.display = 'inline-flex';
}

function cancelEdit() {
    document.getElementById('customer-info').classList.remove('editing');
    document.querySelectorAll('.view-val').forEach(el => el.style.display = '');
    document.querySelectorAll('.edit-val').forEach(el => el.style.display = 'none');
    document.getElementById('btn-edit').style.display = '';
    document.getElementById('btn-save').style.display = 'none';
    document.getElementById('btn-cancel').style.display = 'none';
    // Reset input values to original
    document.querySelectorAll('.edit-val').forEach(input => {
        input.value = input.getAttribute('data-original') || input.defaultValue;
    });
}

function saveCustomer() {
    const data = {};
    document.querySelectorAll('.edit-val').forEach(input => {
        const field = input.getAttribute('data-field');
        if (field) data[field] = input.value;
    });

    const btn = document.getElementById('btn-save');
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Saving...';

    const notification = document.getElementById('save-notification');

    fetch("{% url 'customer_save' customer.pk %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            notification.className = 'customer-save-notification success';
            notification.innerHTML = '<i class="bi bi-check-circle"></i> Customer saved successfully';
            notification.style.display = 'flex';
            setTimeout(() => location.reload(), 800);
        } else {
            notification.className = 'customer-save-notification error';
            notification.innerHTML = '<i class="bi bi-exclamation-circle"></i> ' + (result.error || 'Failed to save');
            notification.style.display = 'flex';
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-check-lg"></i> Save Changes';
            setTimeout(() => notification.style.display = 'none', 3000);
        }
    })
    .catch(err => {
        notification.className = 'customer-save-notification error';
        notification.innerHTML = '<i class="bi bi-exclamation-circle"></i> Network error';
        notification.style.display = 'flex';
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-check-lg"></i> Save Changes';
        setTimeout(() => notification.style.display = 'none', 3000);
    });
}
</script>
{% endblock %}
