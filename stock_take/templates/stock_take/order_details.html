{% extends 'base.html' %}
{% load static %}

{% block title %}Order Details - {{ order.sale_number }}{% endblock %}

{% block content %}
<div class="container mt-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="order-details-title">Order Details - {{order.first_name}} {{order.last_name}} - ({{ order.sale_number }})</h2>
        <a href="{% url 'ordering' %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Back to Orders
        </a>
    </div>

    <!-- Messages Display -->
    {% if messages %}
    <div class="mt-3">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header with-header-links field-div">
                    <h5 class="mb-0">Edit Order Information</h5>
                    <div class="div-header-links">
                        {% if order.anthill_id %}
                            <a href="https://sliderobes.anthillcrm.com/system/Customers/ViewCustomer.aspx?CustomerID={{ order.anthill_id }}"  target="_blank" class="ms-2 btn btn-sm btn-outline-success">
                                <i class="bi bi-box-arrow-up-right"></i>Anthill
                            </a>
                        {% endif %}
                        {% if order.workguru_id %}
                            <a href="https://uk.workguru.io/App/Projects/Detail/{{ order.workguru_id }}" target="_blank" class="ms-2 btn btn-sm btn-outline-primary">
                                <i class="bi bi-box-arrow-up-right"></i>WorkGuru
                            </a>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Form Errors Display -->
                {% if form.errors %}
                <div class="alert alert-danger mb-3">
                    <h6>Please correct the following errors:</h6>
                    <ul class="mb-0">
                        {% for field in form %}
                            {% for error in field.errors %}
                                <li><strong>{{ field.label }}:</strong> {{ error }}</li>
                            {% endfor %}
                        {% endfor %}
                        {% for error in form.non_field_errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
                
                <!-- Edit Order Information -->
                <div class="card-body">
                    <form method="POST">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="field-div mb-3">
                                    <label for="{{ form.first_name.id_for_label }}" class="form-label">First Name</label>
                                    {{ form.first_name }}
                                </div>
                                <div class="field-div mb-3">
                                    <label for="{{ form.last_name.id_for_label }}" class="form-label">Last Name</label>
                                    {{ form.last_name }}
                                </div>
                                <div class="field-div mb-3">
                                    <label for="{{ form.order_date.id_for_label }}" class="form-label">Order Date</label>
                                    {{ form.order_date }}
                                </div>
                                <div class="field-div mb-3">
                                    <label for="{{ form.fit_date.id_for_label }}" class="form-label">Fit Date</label>
                                    {{ form.fit_date }}
                                </div>
                                <div class="field-div mb-3">
                                    <label for="{{ form.boards_po.id_for_label }}" class="form-label">Boards PO</label>
                                    {{ form.boards_po }}
                                </div>
                                <div class="field-div mb-3">
                                    <label for="{{ form.order_type.id_for_label }}" class="form-label">Order Type</label>
                                    {{ form.order_type }}
                                </div>
                                <div class="field-div mb-3">
                                    <label for="{{ form.all_items_ordered.id_for_label }}" class="form-label">All Items Ordered</label>
                                    <div class="form-check prominent-checkbox">
                                        {{ form.all_items_ordered }}
                                    </div>
                                </div>
                                <div class="field-div">
                                    <label for="{{ form.job_finished.id_for_label }}" class="form-label">Job Finished</label>
                                    <div class="form-check prominent-checkbox">
                                        {{ form.job_finished }}
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="field-div mb-3">
                                    <label for="{{ form.sale_number.id_for_label }}" class="form-label">Sale Number</label>
                                    {{ form.sale_number }}
                                </div>
                                <div class="field-div mb-3">
                                    <label for="{{ form.customer_number.id_for_label }}" class="form-label">Customer Number</label>
                                    {{ form.customer_number }}
                                </div>
                                <div class="field-div mb-3">
                                    <label for="{{ form.anthill_id.id_for_label }}" class="form-label">Anthill ID</label>
                                    {{ form.anthill_id }}
                                </div>
                                <div class="field-div mb-3">
                                    <label for="{{ form.workguru_id.id_for_label }}" class="form-label">WorkGuru ID</label>
                                    {{ form.workguru_id }}
                                </div>
                                <div class="field-div mb-3">
                                    <label for="{{ form.address.id_for_label }}" class="form-label">Address</label>
                                    {{ form.address }}
                                </div>
                                <div class="field-div mb-3">
                                    <label for="{{ form.postcode.id_for_label }}" class="form-label">Postcode</label>
                                    {{ form.postcode }}
                                </div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end mt-3">
                            <button type="submit" class="btn btn-outline-primary edit-order-submit-button">
                                <i class="bi bi-save"></i> Save Changes
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Order Summary</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-2">
                        <div class="col-6 bold-text">Customer:</div>
                        <div class="col-6">{{ order.first_name }} {{ order.last_name }}</div>
                    </div>

                    <div class="row mb-2">
                        <div class="col-6 bold-text">Boards Ordered:</div>
                        <div class="col-6 field-div">
                            {% if order.boards_po and order.boards_po.boards_ordered %}
                                <span class="badge bg-success">Yes</span>
                            {% else %}
                                <span class="badge bg-warning">No</span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row mb-2">
                        <div class="col-6 bold-text">Boards Received:</div>
                        <div class="col-6 field-div">
                            {% if order.order_boards_received %}
                                <span class="badge bg-success">Yes</span>
                            {% else %}
                                <span class="badge bg-danger">No</span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row mb-2">
                        <div class="col-6 bold-text">All Items Ordered:</div>
                        <div class="col-6 field-div">
                            {% if order.all_items_ordered %}
                                <span class="badge bg-success">Yes</span>
                            {% else %}
                                <span class="badge bg-danger">No</span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row mb-2">
                        <div class="col-6 bold-text">Sale #:</div>
                        <div class="col-6">{{ order.sale_number }}</div>
                    </div>

                    <div class="row mb-2">
                        <div class="col-6 bold-text">Customer #:</div>
                        <div class="col-6">{{ order.customer_number }}</div>
                    </div>

                    <div class="row mb-2">
                        <div class="col-6 bold-text">Order Date:</div>
                        <div class="col-6">{{ order.order_date }}</div>
                    </div>

                    <div class="row mb-2">
                        <div class="col-6 bold-text">Fit Date:</div>
                        <div class="col-6">{{ order.fit_date }}</div>
                    </div>

                    <div class="row mb-2">
                        <div class="col-6 bold-text">Time Allowance:</div>
                        <div class="col-6">{{ order.time_allowance }} days</div>
                    </div>

                    <div class="row mb-2">
                        <div class="col-6 bold-text field-div">Boards PO:</div>
                        <div class="col-6 field-div">
                            {% if order.boards_po %}
                                {{ order.boards_po.po_number }}
                            {% else %}
                                <span class="text-muted">Not assigned</span>
                            {% endif %}

                            {% if order.boards_po.file %}
                                <a href="{{ order.boards_po.file.url }}" target="_blank" class="btn btn-sm btn-outline-primary ms-2">
                                    <i class="bi bi-file-earmark-pdf"></i>
                                </a>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row mb-2">
                        <div class="col-6 bold-text">Order Type:</div>
                        <div class="col-6">                            
                            <span class="badge bg-{% if order.order_type == 'sale' %}primary{% elif order.order_type == 'remedial' %}warning{% else %}info{% endif %}">
                                {{ order.get_order_type_display }}
                            </span>
                        </div>
                    </div>

                    <div class="row mb-2">
                        <div class="col-6 bold-text">Job Finished:</div>
                        <div class="col-6">                            
                            {% if order.job_finished %}
                                <span class="badge bg-success">Yes</span>
                            {% else %}
                                <span class="badge bg-warning">No</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            {% if order.boards_po %}
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0">Boards PO Details</h6>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <h3 class="boards-po-title">{{ order.boards_po.po_number }}</h3>
                        <div class="d-flex gap-2">
                            {% if order.boards_po.file %}
                                <a href="{{ order.boards_po.file.url }}" target="_blank" class="btn btn-outline-success btn-sm d-flex align-items-center justify-content-center">
                                    <i class="bi bi-file-earmark-spreadsheet"></i> Download PNX File
                                </a>
                            {% endif %}
                            {% if order_pnx_items %}
                                <button type="button" class="btn btn-outline-primary" id="save-pnx-changes">
                                    <i class="bi bi-save"></i> Save PNX Changes
                                </button>
                            {% endif %}
                        </div>
                    </div>

                    {% if order_pnx_items %}
                        <p class="mb-2"><strong>PNX Items for this Order ({{ order_pnx_items|length }} items):</strong></p>
                        <div class="table-responsive">
                            <table class="table table-striped table-sm">
                                <thead>
                                    <tr>
                                        <th>Barcode</th>
                                        <th>Material</th>
                                        <th>Dimensions (LxW)</th>
                                        <th>Count</th>
                                        <th>Cost</th>
                                        <th>Customer</th>
                                        <th>Received</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in order_pnx_items %}
                                    <tr>
                                        <td>{{ item.barcode }}</td>
                                        <td>{{ item.matname }}</td>
                                        <td>{{ item.cleng }} x {{ item.cwidth }}</td>
                                        <td>{{ item.cnt|floatformat:0 }}</td>
                                        <td>£{{ item.calculated_cost|floatformat:2 }}</td>
                                        <td>{{ item.customer }}</td>
                                        <td>
                                            <input type="number" 
                                                   class="form-control form-control-sm pnx-received-quantity" 
                                                   style="width: 80px;" 
                                                   min="0" 
                                                   max="{{ item.cnt|floatformat:0 }}"
                                                   step="1"
                                                   value="{{ item.received_quantity|floatformat:0 }}"
                                                   data-pnx-id="{{ item.id }}"
                                                   data-original-quantity="{{ item.received_quantity|floatformat:0 }}">
                                        </td>
                                        <td>
                                            {% if item.is_fully_received %}
                                                <span class="badge bg-success">Received</span>
                                            {% elif item.is_partially_received %}
                                                <span class="badge bg-warning">Partial</span>
                                            {% else %}
                                                <span class="badge bg-danger">Not Received</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                    <tr class="table-info">
                                        <td colspan="7"><strong>Total Cost:</strong></td>
                                        <td><strong>£{{ pnx_total_cost|floatformat:2 }}</strong></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    {% endif %}

                    <p class="mb-1"><strong>Other Orders:</strong></p>
                    <div class="d-flex flex-wrap gap-2">
                        {% for other_order in other_orders %}
                            <a href="{% url 'order_details' other_order.id %}" class="btn btn-outline-primary btn-sm">
                                {{ other_order.sale_number }} - {{ other_order.first_name }} {{ other_order.last_name }}
                            </a>
                        {% empty %}
                            <span class="text-muted">No other orders assigned to this PO</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- OS Doors Section -->
            <div class="card mt-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">OS Doors</h6>
                    <div>
                        {% if order.os_doors_required %}
                        <button type="button" class="btn btn-sm btn-outline-primary me-2" data-bs-toggle="modal" data-bs-target="#updateOSDModal">
                            <i class="bi bi-pencil"></i> Update PO
                        </button>
                        {% endif %}
                        <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#addOSDoorForm">
                            <i class="bi bi-plus-circle"></i> Add OS Door
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    {% if order.os_doors_required %}
                    <div class="row mb-3">
                        <div class="col-12">
                            <strong>Status:</strong> 
                            <span class="badge bg-success">Required</span>
                            {% if order.os_doors_po %}
                                <span class="badge bg-success ms-2">Ordered (PO: {{ order.os_doors_po }})</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    <!-- Existing OS Doors -->
                    {% if order.os_doors.all %}
                    <div class="table-responsive">
                        <table class="table table-striped table-sm mb-0">
                            <thead>
                                <tr>
                                    <th>Door Style</th>
                                    <th>Style Colour</th>
                                    <th>Dimensions</th>
                                    <th>Colour</th>
                                    <th>Qty</th>
                                    <th>Ordered</th>
                                    <th>Received</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for os_door in order.os_doors.all %}
                                <tr>
                                    <td>{{ os_door.door_style }}</td>
                                    <td>{{ os_door.style_colour }}</td>
                                    <td>{{ os_door.height }} x {{ os_door.width }}</td>
                                    <td>{{ os_door.colour }}</td>
                                    <td>{{ os_door.quantity|floatformat:0 }}</td>
                                    <td>
                                        {% if os_door.ordered %}
                                            <i class="bi bi-check-circle text-success"></i>
                                        {% else %}
                                            <i class="bi bi-x-circle text-muted"></i>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if os_door.received %}
                                            <input type="checkbox" class="form-check-input os-door-received-checkbox" 
                                                   data-os-door-id="{{ os_door.id }}" checked>
                                        {% else %}
                                            <input type="checkbox" class="form-check-input os-door-received-checkbox" 
                                                   data-os-door-id="{{ os_door.id }}">
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="d-flex justify-content-end mt-3">
                        <button type="button" class="btn btn-outline-primary" id="save-os-doors-changes">
                            <i class="bi bi-save"></i> Save OS Doors Changes
                        </button>
                    </div>
                    {% else %}
                    <p class="text-muted mb-3">No OS doors added yet.</p>
                    {% endif %}

                    <!-- Add OS Door Form -->
                    <div class="collapse" id="addOSDoorForm">
                        <hr>
                        <h6>Add New OS Door</h6>
                        <form method="POST">
                            {% csrf_token %}
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="{{ os_door_form.door_style.id_for_label }}" class="form-label">Door Style</label>
                                        {{ os_door_form.door_style }}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="{{ os_door_form.style_colour.id_for_label }}" class="form-label">Style Colour</label>
                                        {{ os_door_form.style_colour }}
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="{{ os_door_form.item_description.id_for_label }}" class="form-label">Item Description</label>
                                {{ os_door_form.item_description }}
                            </div>

                            <div class="row">
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="{{ os_door_form.height.id_for_label }}" class="form-label">Height (mm)</label>
                                        {{ os_door_form.height }}
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="{{ os_door_form.width.id_for_label }}" class="form-label">Width (mm)</label>
                                        {{ os_door_form.width }}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="{{ os_door_form.colour.id_for_label }}" class="form-label">Colour</label>
                                        {{ os_door_form.colour }}
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="mb-3">
                                        <label for="{{ os_door_form.quantity.id_for_label }}" class="form-label">Quantity</label>
                                        {{ os_door_form.quantity }}
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check mb-3">
                                        {{ os_door_form.ordered }}
                                        <label for="{{ os_door_form.ordered.id_for_label }}" class="form-check-label">Ordered</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check mb-3">
                                        {{ os_door_form.received }}
                                        <label for="{{ os_door_form.received.id_for_label }}" class="form-check-label">Received</label>
                                    </div>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-plus-circle"></i> Add OS Door
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Accessories Section -->
            <div class="card mt-3 mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Accessories</h6>
                    <div>
                        <button class="btn btn-sm btn-outline-primary me-2" type="button" data-bs-toggle="modal" data-bs-target="#uploadAccessoriesModal">
                            <i class="bi bi-upload"></i> Upload CSV
                        </button>
                        {% if order.accessories.exists %}
                        <form method="POST" action="{% url 'delete_all_accessories' order.id %}" style="display: inline;" 
                            onsubmit="return confirm('Are you sure you want to remove ALL accessories from this order? This action cannot be undone.');">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                <i class="bi bi-trash"></i> Remove All
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    <!-- CSV Files Section -->
                    {% if order.original_csv %}
                    <div class="mb-3">
                        <h6>CSV Files</h6>
                        <div class="row">
                            {% if order.original_csv %}
                            <div class="col-md-6">
                                <div class="card {% if order.csv_has_missing_items %}border-warning{% else %}border-info{% endif %}">
                                    <div class="card-header {% if order.csv_has_missing_items %}bg-warning text-dark{% else %}bg-info text-white{% endif %}">
                                        <h6 class="mb-0">
                                            <i class="bi bi-file-earmark-spreadsheet"></i> Original CSV
                                            {% if order.csv_has_missing_items %}
                                                <span class="badge bg-danger ms-2">Missing Items</span>
                                            {% endif %}
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <p class="mb-2"><strong>Filename:</strong> {{ order.original_csv.name|slice:"12:" }}</p>
                                        <p class="text-muted small">Generated from the Order Generator</p>
                                        {% if order.original_csv_uploaded_at %}
                                            <p class="text-muted small"><i class="bi bi-calendar-event"></i> Uploaded: {{ order.original_csv_uploaded_at|date:"M j, Y" }} at {{ order.original_csv_uploaded_at|time:"g:i A" }}</p>
                                        {% endif %}
                                        {% if order.csv_has_missing_items %}
                                            <p class="text-warning small"><i class="bi bi-exclamation-triangle"></i> This CSV contains missing items that need to be resolved</p>
                                        {% endif %}
                                        <div class="d-flex gap-2">
                                            <a href="{{ order.original_csv.url }}" class="btn btn-sm btn-outline-primary" target="_blank">
                                                <i class="bi bi-download"></i> Download
                                            </a>
                                            {% if order.csv_has_missing_items %}
                                            <form method="POST" action="{% url 'resolve_missing_items' order.id %}" style="display: inline;">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-sm btn-warning" title="Apply substitutions to resolve missing items">
                                                    <i class="bi bi-check-circle"></i> Resolve
                                                </button>
                                            </form>
                                            {% endif %}
                                            <form method="POST" action="{% url 'remove_order_csv' order.id 'original' %}" style="display: inline;" 
                                                onsubmit="return confirm('Are you sure you want to remove the original CSV file?');">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                                    <i class="bi bi-trash"></i> Remove
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            {% if order.processed_csv %}
                            <div class="col-md-6">
                                <div class="card border-success">
                                    <div class="card-header bg-success text-white">
                                        <h6 class="mb-0"><i class="bi bi-file-earmark-spreadsheet-fill"></i> Processed CSV</h6>
                                    </div>
                                    <div class="card-body">
                                        <p class="mb-2"><strong>Filename:</strong> {{ order.processed_csv.name|slice:"12:" }}</p>
                                        <p class="text-muted small">Contains substitutions applied automatically</p>
                                        {% if order.processed_csv_created_at %}
                                            <p class="text-muted small"><i class="bi bi-calendar-check"></i> Created: {{ order.processed_csv_created_at|date:"M j, Y" }} at {{ order.processed_csv_created_at|time:"g:i A" }}</p>
                                        {% endif %}
                                        <div class="d-flex gap-2">
                                            <a href="{% url 'download_processed_csv' order.id %}" class="btn btn-sm btn-outline-success">
                                                <i class="bi bi-download"></i> Download
                                            </a>
                                            <form method="POST" action="{% url 'remove_order_csv' order.id 'processed' %}" style="display: inline;" 
                                                onsubmit="return confirm('Are you sure you want to remove the processed CSV file?');">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                                    <i class="bi bi-trash"></i> Remove
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            {% if not order.processed_csv %}
                            <div class="col-md-6">
                                <div class="card border-warning">
                                    <div class="card-header bg-warning text-dark">
                                        <h6 class="mb-0"><i class="bi bi-file-earmark-spreadsheet-fill"></i> Processed CSV</h6>
                                    </div>
                                    <div class="card-body">
                                        <p class="mb-2"><strong>Status:</strong> Not generated</p>
                                        <p class="text-muted small">Generate a processed CSV with substitutions applied</p>
                                        <form method="POST" action="{% url 'resolve_missing_items' order.id %}" style="display: inline;">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-sm btn-warning">
                                                <i class="bi bi-arrow-repeat"></i> Generate Processed CSV
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Existing Accessories -->
                    {% if order.accessories.all %}
                    <div class="table-responsive">
                        <table class="table table-striped table-sm mb-0">
                            <thead>
                                <tr>
                                    <th>SKU</th>
                                    <th>Name</th>
                                    <th>Description</th>
                                    <th>Qty</th>
                                    <th>Available</th>
                                    <th>Status</th>
                                    {% if has_os_door_accessories %}
                                    <th>Required</th>
                                    <th>Ordered</th>
                                    {% endif %}
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for accessory in order.accessories.all %}
                                <tr>
                                    <td>{{ accessory.sku }}</td>
                                    <td>{{ accessory.name }}</td>
                                    <td>{{ accessory.description|truncatechars:30 }}</td>
                                    <td>{{ accessory.quantity|floatformat:0 }}</td>
                                    <td>
                                        {% if accessory.stock_item %}
                                            {{ accessory.available_quantity|floatformat:0 }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if accessory.missing %}
                                            <span class="badge bg-warning">Missing</span>
                                        {% elif accessory.stock_item %}
                                            {% if accessory.available_quantity >= accessory.quantity %}
                                                <span class="badge bg-success">In Stock</span>
                                            {% else %}
                                                <span class="badge bg-danger">Low Stock</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="badge bg-info">No Stock Link</span>
                                        {% endif %}
                                    </td>
                                    {% if has_os_door_accessories %}
                                    <td>
                                        {% if accessory.is_os_door %}
                                            <input type="checkbox" {% if accessory.required %}checked{% endif %} disabled>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if accessory.is_os_door %}
                                            <input type="checkbox" {% if accessory.ordered %}checked{% endif %} disabled>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    {% endif %}
                                    <td>
                                        <form method="POST" action="{% url 'delete_accessory' accessory.id %}" style="display: inline;" 
                                            onsubmit="return confirm('Are you sure you want to remove this accessory?');">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-sm btn-outline-danger" title="Remove Accessory">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted mb-3">No accessories added yet.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Modal for Uploading Accessories CSV -->
<div class="modal fade" id="uploadAccessoriesModal" tabindex="-1" aria-labelledby="uploadAccessoriesModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{% url 'upload_accessories_csv' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="uploadAccessoriesModalLabel">Upload Accessories CSV (Auto-Order Detection)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="id_csv_file" class="form-label">CSV File</label>
                        <input type="file" class="form-control" id="id_csv_file" name="csv_file" accept=".csv" required>
                        <small class="form-text text-muted">CSV should have columns: Sku, Name, Description, CostPrice, SellPrice, Quantity, Billable. Order will be auto-detected from customer number in filename.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Upload & Process</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal for Updating OS Doors PO -->
<div class="modal fade" id="updateOSDModal" tabindex="-1" aria-labelledby="updateOSDModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{% url 'update_os_doors_po' order.id %}">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="updateOSDModalLabel">Update OS Doors PO</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="id_os_doors_po" class="form-label">OS Doors PO Number</label>
                        <input type="text" class="form-control" id="id_os_doors_po" name="os_doors_po" 
                               value="{{ order.os_doors_po }}" placeholder="Enter PO number when ordered">
                        <small class="form-text text-muted">Leave blank if not yet ordered</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update PO</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Auto-dismiss alerts after 5 seconds
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(function(alert) {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        });
    }, 5000); // 5 seconds

    // Track PNX changes instead of auto-saving
    let pnxChanges = {};

    // Handle PNX received quantity changes (just track changes, don't save)
    document.querySelectorAll('.pnx-received-quantity').forEach(function(input) {
        input.addEventListener('input', function() {
            const pnxId = this.getAttribute('data-pnx-id');
            const quantity = parseFloat(this.value) || 0;
            const originalQuantity = parseFloat(this.getAttribute('data-original-quantity')) || 0;
            
            if (quantity !== originalQuantity) {
                pnxChanges[pnxId] = quantity;
            } else {
                delete pnxChanges[pnxId];
            }
        });
    });

    // Handle save button click
    document.getElementById('save-pnx-changes').addEventListener('click', function() {
        if (Object.keys(pnxChanges).length === 0) {
            showAlert('No changes to save.', 'info');
            return;
        }

        // Disable button during save
        this.disabled = true;
        this.innerHTML = '<i class="bi bi-hourglass"></i> Saving...';

        // Send all changes in one request
        fetch('/stock-take/update-pnx-batch/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ changes: pnxChanges })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('PNX changes saved successfully!', 'success');
                pnxChanges = {}; // Clear changes
                // Update original quantities
                Object.keys(pnxChanges).forEach(pnxId => {
                    const input = document.querySelector(`[data-pnx-id="${pnxId}"]`);
                    if (input) {
                        input.setAttribute('data-original-quantity', pnxChanges[pnxId].toString());
                    }
                });
                location.reload(); // Reload to show updated status
            } else {
                showAlert('Error saving PNX changes: ' + data.error, 'danger');
                // Re-enable button
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-save"></i> Save PNX Changes';
            }
        })
        .catch(error => {
            showAlert('Error saving PNX changes', 'danger');
            // Re-enable button
            this.disabled = false;
            this.innerHTML = '<i class="bi bi-save"></i> Save PNX Changes';
        });
    });

    // Track OS Doors changes
    let osDoorsChanges = {};

    // Handle OS Doors received checkbox changes (just track changes, don't save)
    document.querySelectorAll('.os-door-received-checkbox').forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            const osDoorId = this.getAttribute('data-os-door-id');
            const received = this.checked;
            // Find the corresponding quantity from the table
            const row = this.closest('tr');
            const quantityCell = row.querySelector('td:nth-child(5)'); // Qty column
            const quantity = parseInt(quantityCell.textContent.trim()) || 0;
            osDoorsChanges[osDoorId] = received ? quantity : 0;
        });
    });

    // Handle save button click for OS Doors
    const saveOsDoorsBtn = document.getElementById('save-os-doors-changes');
    if (saveOsDoorsBtn) {
        saveOsDoorsBtn.addEventListener('click', function() {
            if (Object.keys(osDoorsChanges).length === 0) {
                showAlert('No changes to save.', 'info');
                return;
            }

            // Disable button during save
            this.disabled = true;
            this.innerHTML = '<i class="bi bi-hourglass"></i> Saving...';

            // Send all changes in one request
            fetch('/stock-take/update-os-doors-batch/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ changes: osDoorsChanges })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('OS Doors changes saved successfully!', 'success');
                    osDoorsChanges = {}; // Clear changes
                    location.reload(); // Reload to show updated status
                } else {
                    showAlert('Error saving OS Doors changes: ' + data.error, 'danger');
                    // Re-enable button
                    this.disabled = false;
                    this.innerHTML = '<i class="bi bi-save"></i> Save OS Doors Changes';
                }
            })
            .catch(error => {
                showAlert('Error saving OS Doors changes', 'danger');
                // Re-enable button
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-save"></i> Save OS Doors Changes';
            });
        });
    }

    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.container').firstChild);
    }
});
</script>

{% endblock %}