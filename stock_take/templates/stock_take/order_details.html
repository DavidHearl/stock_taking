{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Order Details - {{ order.sale_number }}{% endblock %}

{% block extra_css %}
<link href="{% static 'css/order_details.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="page-content">
    <div class="page-header">
        <h1>Order Details - {{order.first_name}} {{order.last_name}} - ({{ order.sale_number }})</h1>
        <div class="header-actions">
            <a href="{% url 'generate_summary_document' order.id %}" class="btn btn-primary" title="Download Summary Document PDF">
                <i class="bi bi-file-earmark-pdf"></i> Summary Document
            </a>
            <a href="{% url 'ordering' %}" class="btn btn-secondary">
                ← Back to Orders
            </a>
        </div>
    </div>

    <div class="order-details-grid">
        <div class="main-column">
            <!-- Workflow Stage Card -->
            <div class="card workflow-stage-card">
                <div class="card-header">
                    <h3>Workflow Stage</h3>
                    <button class="btn btn-secondary btn-sm" onclick="openWorkflowModal()">
                        <i class="bi bi-diagram-3"></i> View Full Workflow
                    </button>
                </div>
                <div class="card-body padded">
                    <div class="workflow-current-stage">
                        {% if workflow_progress.current_stage %}
                        <div class="stage-info {{ workflow_progress.current_stage.role }}">
                            <div class="stage-meta">
                                <h4>{{ workflow_progress.current_stage.name }}</h4>
                                <span class="stage-role-badge">{{ workflow_progress.current_stage.get_role_display }}</span>
                                <span class="stage-phase-badge">{{ workflow_progress.current_stage.get_phase_display }}</span>
                                {% if workflow_progress.current_stage.expected_days %}
                                <span class="stage-days">{{ workflow_progress.current_stage.expected_days }} day{{ workflow_progress.current_stage.expected_days|pluralize }}</span>
                                {% endif %}
                            </div>
                            <p class="stage-description">{{ workflow_progress.current_stage.description }}</p>
                        </div>
                        
                        <!-- Tasks for Current Stage -->
                        {% if workflow_progress.current_stage.tasks.all %}
                        <div class="stage-tasks-toggle" onclick="toggleStageTasks()">
                            <span><i class="bi bi-list-check"></i> Criteria ({{ workflow_progress.current_stage.tasks.all|length }})</span>
                            <i class="bi bi-chevron-down toggle-arrow"></i>
                        </div>
                        <div class="stage-tasks collapsed" id="stage-tasks-content">
                            {% for task in workflow_progress.current_stage.tasks.all %}
                            {% with completion=task_completions|get_item:task.id %}
                            <div class="task-item task-type-{{ task.task_type }}">
                                {% if task.task_type == 'decision_matrix' %}
                                    <div class="task-decision-matrix">
                                        <strong>{{ task.description }}</strong>
                                        <div class="decision-options">
                                            <button class="decision-btn decision-proceed {% if completion.selected_option == 'proceed' %}active{% endif %}" 
                                                    onclick="updateTaskDecision({{ order.id }}, {{ task.id }}, 'proceed')">
                                                <i class="bi bi-arrow-right-circle"></i> Proceed to Next Step
                                            </button>
                                            <button class="decision-btn decision-postpone {% if completion.selected_option == 'postpone' %}active{% endif %}"
                                                    onclick="updateTaskDecision({{ order.id }}, {{ task.id }}, 'postpone')">
                                                <i class="bi bi-clock-history"></i> Postpone
                                            </button>
                                            <button class="decision-btn decision-dead {% if completion.selected_option == 'dead' %}active{% endif %}"
                                                    onclick="updateTaskDecision({{ order.id }}, {{ task.id }}, 'dead')">
                                                <i class="bi bi-x-circle"></i> Mark as Dead/Inactive
                                            </button>
                                        </div>
                                    </div>
                                {% elif task.task_type == 'radio' %}
                                    <div class="task-radio-group">
                                        <strong>{{ task.description }}</strong>
                                        {% if task.options %}
                                        {% for option in task.options|split_options %}
                                        <label class="radio-option">
                                            <input type="radio" name="task_{{ task.id }}" value="{{ option }}"
                                                   {% if completion.selected_option == option %}checked{% endif %}
                                                   onchange="updateTaskRadio({{ order.id }}, {{ task.id }}, '{{ option }}')"/>
                                            {{ option }}
                                        </label>
                                        {% endfor %}
                                        {% endif %}
                                    </div>
                                {% elif task.task_type == 'dropdown' %}
                                    <div class="task-dropdown-group">
                                        <label>
                                            <strong>{{ task.description }}</strong>
                                            <select class="task-select" onchange="updateTaskDropdown({{ order.id }}, {{ task.id }}, this.value)">
                                                <option value="">Select...</option>
                                                {% if task.options %}
                                                {% for option in task.options|split_options %}
                                                <option value="{{ option }}" {% if completion.selected_option == option %}selected{% endif %}>{{ option }}</option>
                                                {% endfor %}
                                                {% endif %}
                                            </select>
                                        </label>
                                    </div>
                                {% elif task.task_type == 'attachment' %}
                                    <label class="task-attachment">
                                        <input type="checkbox" {% if completion.completed %}checked{% endif %}
                                               onchange="updateTaskCheckbox({{ order.id }}, {{ task.id }}, this.checked)"/>
                                        {{ task.description }}
                                        <span class="badge-attachment"><i class="bi bi-paperclip"></i></span>
                                        {% if completion.attachment %}
                                        <a href="{{ completion.attachment.url }}" target="_blank" class="attachment-link">View File</a>
                                        {% endif %}
                                    </label>
                                    <input type="file" id="attachment_{{ task.id }}" class="attachment-input" 
                                           onchange="uploadTaskAttachment({{ order.id }}, {{ task.id }}, this)"/>
                                {% else %}
                                    <label class="required-label">
                                        <input type="checkbox" {% if completion.completed %}checked{% endif %}
                                               onchange="updateTaskCheckbox({{ order.id }}, {{ task.id }}, this.checked)"/>
                                        {{ task.description }}
                                        {% if task.task_type == 'requirement' %}
                                        <span class="badge-required">Required</span>
                                        {% endif %}
                                    </label>
                                {% endif %}
                            </div>
                            {% endwith %}
                            {% endfor %}
                        </div>
                        {% endif %}

                        <!-- Stage Navigation Buttons -->
                        <div class="stage-navigation">
                            <button class="btn-stage-nav btn-previous" onclick="revertToPreviousStage({{ order.id }})">
                                <i class="bi bi-arrow-left-circle"></i> Revert to Previous Stage
                            </button>
                            <button class="btn-stage-nav btn-next" onclick="progressToNextStage({{ order.id }})">
                                Progress to Next Stage <i class="bi bi-arrow-right-circle"></i>
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3>Edit Order Information</h3>
                    <div class="header-links">
                        <select class="order-type-select" onchange="updateOrderType(this, {{ order.id }})">
                            <option value="sale" {% if order.order_type == 'sale' %}selected{% endif %}>Sale</option>
                            <option value="remedial" {% if order.order_type == 'remedial' %}selected{% endif %}>Remedial</option>
                            <option value="warranty" {% if order.order_type == 'warranty' %}selected{% endif %}>Warranty</option>
                        </select>
                    </div>
                </div>
                
                <!-- Form Errors Display -->
                {% if form.errors %}
                <div class="alert alert-danger mb-3">
                    <h6>Please correct the following errors:</h6>
                    <ul class="mb-0">
                        {% for field in form %}
                            {% for error in field.errors %}
                                <li><strong>{{ field.label }}:</strong> {{ error }}</li>
                            {% endfor %}
                        {% endfor %}
                        {% for error in form.non_field_errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
                
                <!-- Edit Order Information -->
                <div class="card-body padded">
                    <div class="form-grid-2col">
                        <!-- Left Column: Customer Info + Job Info -->
                        <div>
                            <!-- Customer Info -->
                            <div>
                                <div class="info-section-header">
                                    <h4 class="info-section-title customer">Customer Info</h4>
                                    <button type="button" class="btn btn-sm btn-outline-primary edit-btn-spacing" id="edit-customer-btn" onclick="toggleCustomerEdit()">
                                        <i class="bi bi-pencil"></i> Edit
                                    </button>
                                </div>
                            <div id="customer-display" class="info-display">
                                <div>
                                    <div class="field-label">Customer Name</div>
                                    <div class="field-value-large" id="customer-name-display">{{ order.first_name }} {{ order.last_name }}</div>
                                </div>
                                <div>
                                    <div class="field-label">Anthill Customer ID</div>
                                    <div class="field-row-with-button">
                                        <div class="field-value" id="anthill-id-display">{{ order.anthill_id|default:"Not specified" }}</div>
                                        {% if order.anthill_id %}
                                            <a href="https://sliderobes.anthillcrm.com/system/Customers/ViewCustomer.aspx?CustomerID={{ order.anthill_id }}" target="_blank" class="btn btn-sm btn-outline-success external-link-btn">
                                                <i class="bi bi-box-arrow-up-right"></i> View Anthill Customer
                                            </a>
                                        {% endif %}
                                    </div>
                                </div>
                                <div>
                                    <div class="field-label">Address</div>
                                    <div class="field-value" id="address-display">{{ order.address|default:"Not set" }}</div>
                                </div>
                                <div>
                                    <div class="field-label">Postcode</div>
                                    <div class="field-value" id="postcode-display">{{ order.postcode|default:"Not set" }}</div>
                                </div>
                            </div>
                            <div id="customer-edit" class="info-edit">
                                <div>
                                    <label class="form-label">First Name</label>
                                    <input type="text" class="form-input" id="first-name-input" value="{{ order.first_name }}">
                                </div>
                                <div>
                                    <label class="form-label">Last Name</label>
                                    <input type="text" class="form-input" id="last-name-input" value="{{ order.last_name }}">
                                </div>
                                <div>
                                    <label class="form-label">Anthill Customer ID</label>
                                    <input type="text" class="form-input" id="anthill-id-input" value="{{ order.anthill_id }}">
                                </div>
                                <div>
                                    <label class="form-label">Address</label>
                                    <input type="text" class="form-input" id="address-input" value="{{ order.address }}">
                                </div>
                                <div>
                                    <label class="form-label">Postcode</label>
                                    <input type="text" class="form-input" id="postcode-input" value="{{ order.postcode }}">
                                </div>
                                <button type="button" class="btn btn-outline-success btn-sm" onclick="saveCustomerInfo({{ order.id }})">
                                    <i class="bi bi-check-lg"></i> Save Customer Info
                                </button>
                            </div>
                            </div>
                        
                            <!-- Job Info Section -->
                            <div class="job-section-spacing">
                                <div class="info-section-header">
                                    <h4 class="info-section-title job">Job Info</h4>
                                </div>

                                <div class="job-info-column">
                                    <!-- Boards PO (Editable Dropdown) -->
                                    <div>
                                        <label class="form-label-uppercase">Boards PO</label>
                                        <div class="boards-po-combo" style="position:relative;">
                                            <div class="flex-row-gap">
                                                <div style="flex:1;position:relative;">
                                                    <input type="text" class="form-input" id="boards-po-search"
                                                           placeholder="Search PO number..."
                                                           value="{% if order.boards_po %}{{ order.boards_po.po_number }}{% endif %}"
                                                           autocomplete="off"
                                                           oninput="searchBoardsPO(this.value)"
                                                           onfocus="this.select(); searchBoardsPO(this.value);">
                                                    <div class="boards-po-results" id="boards-po-results" style="display:none;"></div>
                                                </div>
                                                {% if order.boards_po %}
                                                <button type="button" class="btn btn-sm btn-outline-danger btn-icon-add" onclick="clearBoardsPOLink({{ order.id }})" title="Remove PO link">
                                                    <i class="bi bi-x-lg"></i>
                                                </button>
                                                {% else %}
                                                <button type="button" class="btn btn-sm btn-success btn-icon-add" onclick="createNextBoardsPO({{ order.id }})" title="Create new PO with next available number">
                                                    <i class="bi bi-plus-lg"></i>
                                                </button>
                                                {% endif %}
                                                {% if order.workguru_id and not order.boards_po %}
                                                <a href="{% url 'create_workguru_po' order.id %}" 
                                                   class="btn btn-sm btn-primary btn-icon-add" 
                                                   title="Create PO in WorkGuru"
                                                   onclick="return confirm('Create a new Purchase Order in WorkGuru for this order?');">
                                                    <i class="bi bi-cloud-plus"></i>
                                                </a>
                                                {% endif %}
                                            </div>
                                            {% if order.boards_po and boards_purchase_order %}
                                            <div style="margin-top:4px;">
                                                <a href="{% url 'purchase_order_detail' boards_purchase_order.workguru_id %}" class="btn-link-sm" style="font-size:0.8rem;">
                                                    <i class="bi bi-eye"></i> View Purchase Order
                                                </a>
                                            </div>
                                            {% endif %}
                                        </div>

                                    </div>
                                    
                                    <!-- Boards Ordered Checkbox -->
                                    {% if order.boards_po %}
                                    <div class="job-checkbox-container">
                                        <input class="job-checkbox" type="checkbox" id="boardsOrdered" 
                                               {% if order.boards_po.boards_ordered %}checked{% endif %}
                                               onchange="updateBoardsOrdered({{ order.boards_po.id }}, this.checked)">
                                        <label class="job-checkbox-label" for="boardsOrdered">
                                            <i class="bi bi-box"></i> Boards Ordered
                                        </label>
                                    </div>
                                    {% endif %}
                                    
                                    <!-- All Items Ordered Checkbox -->
                                    <div class="job-checkbox-container">
                                        <input class="job-checkbox" type="checkbox" id="allItemsOrdered" 
                                               {% if order.all_items_ordered %}checked{% endif %}
                                               onchange="updateJobCheckbox({{ order.id }}, 'all_items_ordered', this.checked)">
                                        <label class="job-checkbox-label" for="allItemsOrdered">
                                            <i class="bi bi-box-seam"></i> All Items Ordered
                                        </label>
                                    </div>
                                    
                                    <!-- Job Finished Checkbox -->
                                    <div class="job-checkbox-container">
                                        <input class="job-checkbox" type="checkbox" id="jobFinished" 
                                               {% if order.job_finished %}checked{% endif %}
                                               onchange="updateJobCheckbox({{ order.id }}, 'job_finished', this.checked)">
                                        <label class="job-checkbox-label" for="jobFinished">
                                            <i class="bi bi-check2-circle"></i> Job Finished
                                        </label>
                                    </div>

                                    <!-- Materials Allocated Checkbox -->
                                    {% if order.accessories.exists %}
                                    <div class="job-checkbox-container">
                                        <input class="job-checkbox" type="checkbox" id="materialsAllocated" 
                                               {% if all_allocated %}checked{% endif %}
                                               onchange="toggleMaterialsAllocated({{ order.id }}, this.checked, this)">
                                        <label class="job-checkbox-label" for="materialsAllocated">
                                            <i class="bi bi-box-arrow-in-down"></i> Materials Allocated
                                        </label>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Right Column: Sale Info -->
                        <div>
                            <div class="info-section-header">
                                <h4 class="info-section-title sale">Sale Info</h4>
                                <button type="button" class="btn btn-sm btn-outline-success edit-btn-spacing" id="edit-sale-btn" onclick="toggleSaleEdit()">
                                    <i class="bi bi-pencil"></i> Edit
                                </button>
                            </div>
                            <div id="sale-display" class="info-display">
                                <div>
                                    <div class="field-label">Sale Number</div>
                                    <div class="field-row-with-button">
                                        <div class="field-value-medium" id="sale-number-display">{{ order.sale_number }}</div>
                                        {% if order.sale_number %}
                                            <a href="https://sliderobes.anthillcrm.com/system/Orders/ViewOrder.aspx?OrderID={{ order.sale_number }}" target="_blank" class="btn btn-sm btn-outline-success external-link-btn">
                                                <i class="bi bi-box-arrow-up-right"></i> View Anthill Sale
                                            </a>
                                        {% endif %}
                                    </div>
                                </div>
                                <div>
                                    <div class="field-label">Customer Number</div>
                                    <div class="field-value" id="customer-number-display">{{ order.customer_number }}</div>
                                </div>
                                <div>
                                    <div class="field-label">Designer</div>
                                    <div class="field-value" id="designer-display">{{ order.designer|default:"-" }}</div>
                                </div>
                                <div>
                                    <div class="field-label">WorkGuru ID</div>
                                    <div class="field-row-with-button">
                                        <div class="field-value" id="workguru-id-display">{{ order.workguru_id|default:"Not set" }}</div>
                                        {% if order.workguru_id %}
                                            <a href="https://uk.workguru.io/App/Projects/Detail/{{ order.workguru_id }}" target="_blank" class="btn btn-sm btn-outline-primary external-link-btn">
                                                <i class="bi bi-box-arrow-up-right"></i> View WorkGuru Project
                                            </a>
                                        {% endif %}
                                    </div>
                                </div>
                                <div>
                                    <div class="field-label">Order Date</div>
                                    <div class="field-value" id="order-date-display">{{ order.order_date|date:"d M Y"|default:"Not set" }}</div>
                                </div>
                                <div>
                                    <div class="field-label">Fit Date</div>
                                    <div class="field-value" id="fit-date-display">{{ order.fit_date|date:"d M Y"|default:"Not set" }}</div>
                                </div>
                                <div>
                                    <div class="field-label">Total Value (Inc VAT)</div>
                                    <div class="field-value field-value-total" id="total-value-display">£{{ order.total_value_inc_vat|default:'0.00'|floatformat:2 }}</div>
                                </div>
                            </div>
                            <div id="sale-edit" class="info-edit">
                                <div>
                                    <label class="form-label">Sale Number</label>
                                    <input type="text" class="form-input" id="sale-number-input" value="{{ order.sale_number }}">
                                </div>
                                <div>
                                    <label class="form-label">Customer Number</label>
                                    <input type="text" class="form-input" id="customer-number-input" value="{{ order.customer_number }}">
                                </div>
                                <div>
                                    <label class="form-label">Designer</label>
                                    <div class="flex-row-gap">
                                        <select class="form-input flex-1" id="designer-input">
                                            <option value="">Select designer...</option>
                                            {% for designer in designers %}
                                                <option value="{{ designer.id }}" {% if order.designer and order.designer.id == designer.id %}selected{% endif %}>{{ designer.name }}</option>
                                            {% endfor %}
                                        </select>
                                        <button type="button" class="btn btn-sm btn-success btn-icon-add" onclick="toggleAddDesignerInline()" title="Add new designer">
                                            <i class="bi bi-plus-lg"></i>
                                        </button>
                                    </div>
                                    <div id="new-designer-inline" class="new-person-inline">
                                        <input type="text" id="new-designer-name-inline" class="form-input flex-1" placeholder="New designer name">
                                        <button type="button" class="btn btn-sm btn-success" onclick="saveNewDesignerInline()" title="Save designer">
                                            <i class="bi bi-check-lg"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-secondary" onclick="cancelAddDesignerInline()" title="Cancel">
                                            <i class="bi bi-x-lg"></i>
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <label class="form-label">WorkGuru ID</label>
                                    <input type="text" class="form-input" id="workguru-id-input" value="{{ order.workguru_id }}">
                                </div>
                                <div>
                                    <label class="form-label">Order Date</label>
                                    <input type="date" class="form-input" id="order-date-input" value="{{ order.order_date|date:'Y-m-d' }}">
                                </div>
                                <div>
                                    <label class="form-label">Fit Date</label>
                                    <input type="date" class="form-input" id="fit-date-input" value="{{ order.fit_date|date:'Y-m-d' }}">
                                </div>
                                <div>
                                    <label class="form-label">Total Value (Inc VAT)</label>
                                    <input type="number" step="0.01" class="form-input" id="total-value-input" value="{{ order.total_value_inc_vat|default:'0.00' }}" oninput="calculateExcVat()">
                                </div>
                                <button type="button" class="btn btn-outline-success btn-sm" onclick="saveSaleInfo({{ order.id }})">
                                    <i class="bi bi-check-lg"></i> Save Sale Info
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="sidebar-column">
            <!-- Financial Summary Card -->
            <div class="card">
                <div class="card-header">
                    <h3>Financial Summary</h3>
                    <button class="btn btn-success btn-sm" onclick="saveFinancials({{ order.id }})" title="Save financial data">
                        <i class="bi bi-floppy"></i> Save
                    </button>
                </div>
                <div class="financial-card-body">
                    <div class="financial-cards-vertical">
                        <!-- Total Value Inc VAT (Display only) -->
                        <div class="financial-card-vertical card-total-inc">
                            <div class="financial-card-icon">
                                <i class="bi bi-cash-stack"></i>
                            </div>
                            <div class="financial-card-content">
                                <span class="financial-card-label">Total Value (Inc VAT)</span>
                                <div class="financial-display" id="total_value_inc_vat_display">£{{ order.total_value_inc_vat|default:'0.00'|floatformat:2 }}</div>
                            </div>
                        </div>

                        <!-- Total Value Exc VAT (Auto-calculated) -->
                        <div class="financial-card-vertical card-total-exc">
                            <div class="financial-card-icon">
                                <i class="bi bi-calculator"></i>
                            </div>
                            <div class="financial-card-content">
                                <span class="financial-card-label">Total Value (Exc VAT)</span>
                                <div class="financial-display" id="total_value_exc_vat_display">£{{ order.total_value_exc_vat|default:'0.00'|floatformat:2 }}</div>
                            </div>
                        </div>

                        <!-- Materials Cost (Auto-calculated from boards, accessories, OS doors) -->
                        <div class="financial-card-vertical card-materials">
                            <div class="financial-card-icon">
                                <i class="bi bi-box-seam"></i>
                            </div>
                            <div class="financial-card-content">
                                <span class="financial-card-label">Materials Cost (Auto)</span>
                                <div class="financial-display" id="materials_cost_display">£{{ materials_cost|default:'0.00'|floatformat:2 }}</div>
                                {% if order.total_value_exc_vat > 0 %}
                                <div class="financial-progress-wrapper">
                                    <div class="financial-progress">
                                        {% if boards_cost > 0 %}
                                        <div class="financial-progress-bar-segment boards-segment" 
                                             style="width: {% widthratio boards_cost order.total_value_exc_vat 100 %}%"
                                             title="Boards: £{{ boards_cost|floatformat:2 }} ({% widthratio boards_cost materials_cost 100 %}% of materials)"></div>
                                        {% endif %}
                                        {% if accessories_cost > 0 %}
                                        <div class="financial-progress-bar-segment accessories-segment" 
                                             style="width: {% widthratio accessories_cost order.total_value_exc_vat 100 %}%"
                                             title="Accessories: £{{ accessories_cost|floatformat:2 }} ({% widthratio accessories_cost materials_cost 100 %}% of materials)"></div>
                                        {% endif %}
                                        {% if os_doors_cost > 0 %}
                                        <div class="financial-progress-bar-segment os-doors-segment" 
                                             style="width: {% widthratio os_doors_cost order.total_value_exc_vat 100 %}%"
                                             title="OS Doors: £{{ os_doors_cost|floatformat:2 }} ({% widthratio os_doors_cost materials_cost 100 %}% of materials)"></div>
                                        {% endif %}
                                    </div>
                                    <span class="financial-percentage">{% widthratio materials_cost order.total_value_exc_vat 100 %}%</span>
                                </div>
                                <div class="cost-breakdown-legend">
                                    {% if boards_cost > 0 %}
                                    <span class="legend-item">
                                        <span class="legend-color boards-color"></span>
                                        Boards: £{{ boards_cost|floatformat:2 }}
                                    </span>
                                    {% endif %}
                                    {% if accessories_cost > 0 %}
                                    <span class="legend-item">
                                        <span class="legend-color accessories-color"></span>
                                        Accessories: £{{ accessories_cost|floatformat:2 }}
                                    </span>
                                    {% endif %}
                                    {% if os_doors_cost > 0 %}
                                    <span class="legend-item">
                                        <span class="legend-color os-doors-color"></span>
                                        OS Doors: £{{ os_doors_cost|floatformat:2 }}
                                    </span>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Installation Cost -->
                        <div class="financial-card-vertical card-installation">
                            <div class="financial-card-icon">
                                <i class="bi bi-tools"></i>
                            </div>
                            <div class="financial-card-content">
                                <span class="financial-card-label">
                                    Installation Cost
                                    <button type="button" class="btn btn-sm btn-primary ms-2 btn-timesheet-add" onclick="openTimesheetModal('installation')">
                                        <i class="bi bi-plus-circle"></i> Add
                                    </button>
                                </span>
                                <div class="financial-display-value" id="installation_cost_display">
                                    £{{ calculated_installation_cost|floatformat:2 }}
                                </div>
                                {% if order.total_value_exc_vat > 0 %}
                                <div class="financial-progress-wrapper">
                                    <div class="financial-progress">
                                        {% if installation_fitter_cost > 0 %}
                                        <div class="financial-progress-bar-segment installation-fitter-segment" 
                                             style="width: {% widthratio installation_fitter_cost order.total_value_exc_vat 100 %}%"
                                             title="Fitter Timesheets: £{{ installation_fitter_cost|floatformat:2 }}"></div>
                                        {% endif %}
                                        {% if installation_helper_cost > 0 %}
                                        <div class="financial-progress-bar-segment installation-helper-segment" 
                                             style="width: {% widthratio installation_helper_cost order.total_value_exc_vat 100 %}%"
                                             title="Helper Timesheets: £{{ installation_helper_cost|floatformat:2 }}"></div>
                                        {% endif %}
                                        {% if petrol_cost > 0 %}
                                        <div class="financial-progress-bar-segment petrol-segment" 
                                             style="width: {% widthratio petrol_cost order.total_value_exc_vat 100 %}%"
                                             title="Petrol: £{{ petrol_cost|floatformat:2 }}"></div>
                                        {% endif %}
                                        {% if materials_expense_cost > 0 %}
                                        <div class="financial-progress-bar-segment materials-expense-segment" 
                                             style="width: {% widthratio materials_expense_cost order.total_value_exc_vat 100 %}%"
                                             title="Materials Expenses: £{{ materials_expense_cost|floatformat:2 }}"></div>
                                        {% endif %}
                                        {% if other_expense_cost > 0 %}
                                        <div class="financial-progress-bar-segment other-expense-segment" 
                                             style="width: {% widthratio other_expense_cost order.total_value_exc_vat 100 %}%"
                                             title="Other Expenses: £{{ other_expense_cost|floatformat:2 }}"></div>
                                        {% endif %}
                                    </div>
                                    <span class="financial-percentage">{% widthratio calculated_installation_cost order.total_value_exc_vat 100 %}%</span>
                                </div>
                                <div class="cost-breakdown-legend">
                                    {% if installation_fitter_cost > 0 %}
                                    <span class="legend-item">
                                        <span class="legend-color installation-fitter-color"></span>
                                        Fitters: £{{ installation_fitter_cost|floatformat:2 }}
                                    </span>
                                    {% endif %}
                                    {% if installation_helper_cost > 0 %}
                                    <span class="legend-item">
                                        <span class="legend-color installation-helper-color"></span>
                                        Helpers: £{{ installation_helper_cost|floatformat:2 }}
                                    </span>
                                    {% endif %}
                                    {% if petrol_cost > 0 %}
                                    <span class="legend-item">
                                        <span class="legend-color petrol-color"></span>
                                        Petrol: £{{ petrol_cost|floatformat:2 }}
                                    </span>
                                    {% endif %}
                                    {% if materials_expense_cost > 0 %}
                                    <span class="legend-item">
                                        <span class="legend-color materials-expense-color"></span>
                                        Materials: £{{ materials_expense_cost|floatformat:2 }}
                                    </span>
                                    {% endif %}
                                    {% if other_expense_cost > 0 %}
                                    <span class="legend-item">
                                        <span class="legend-color other-expense-color"></span>
                                        Other: £{{ other_expense_cost|floatformat:2 }}
                                    </span>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Manufacturing Cost -->
                        <div class="financial-card-vertical card-manufacturing">
                            <div class="financial-card-icon">
                                <i class="bi bi-gear"></i>
                            </div>
                            <div class="financial-card-content">
                                <span class="financial-card-label">
                                    Manufacturing Cost
                                    <button type="button" class="btn btn-sm btn-primary ms-2 btn-timesheet-add" onclick="openTimesheetModal('manufacturing')">
                                        <i class="bi bi-plus-circle"></i> Add
                                    </button>
                                </span>
                                <div class="financial-display-value" id="manufacturing_cost_display">
                                    £{{ calculated_manufacturing_cost|floatformat:2 }}
                                </div>
                                {% if order.total_value_exc_vat > 0 and calculated_manufacturing_cost > 0 %}
                                <div class="financial-progress-wrapper">
                                    <div class="financial-progress">
                                        <div class="financial-progress-bar-segment manufacturing-worker-segment manufacturing-worker-1" 
                                             style="width: {% widthratio calculated_manufacturing_cost order.total_value_exc_vat 100 %}%"
                                             title="Manufacturing: £{{ calculated_manufacturing_cost|floatformat:2 }}"></div>
                                    </div>
                                    <span class="financial-percentage">{% widthratio calculated_manufacturing_cost order.total_value_exc_vat 100 %}%</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Profit (Auto-calculated) -->
                        <div class="financial-card-vertical card-profit">
                            <div class="financial-card-icon">
                                <i class="bi bi-graph-up"></i>
                            </div>
                            <div class="financial-card-content">
                                <span class="financial-card-label">Profit</span>
                                <div class="financial-display" id="profit_display">£{{ order.profit|default:'0.00'|floatformat:2 }}</div>
                                {% if order.total_value_exc_vat > 0 %}
                                <div class="financial-progress-wrapper">
                                    <div class="financial-progress">
                                        <div class="financial-progress-bar" id="profit_progress_bar" style="width: {% if order.profit > 0 %}{% widthratio order.profit order.total_value_exc_vat 100 %}{% else %}0{% endif %}%"></div>
                                    </div>
                                    <span class="financial-percentage" id="profit_percentage">{% if order.profit > 0 %}{% widthratio order.profit order.total_value_exc_vat 100 %}{% else %}0{% endif %}%</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Fully Costed Checkbox -->
                        <div class="fully-costed-container">
                            <label class="fully-costed-label">
                                <input type="checkbox" id="fully_costed_checkbox" class="fully-costed-checkbox" {% if order.fully_costed %}checked{% endif %}>
                                <span class="fully-costed-text">
                                    Mark as Fully Costed
                                </span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Order Summary Card -->
            <div class="card">
                <div class="card-header">
                    <h3>Order Summary</h3>
                </div>
                <div class="card-body padded">
                    <dl class="summary-list">
                        <div class="summary-row">
                            <dt>Time Allowance:</dt>
                            <dd>{{ order.time_allowance }} days</dd>
                        </div>
                        <div class="summary-row remove-border">
                            <dt>Boards PO:</dt>
                            <dd>
                                {% if order.boards_po %}
                                    <strong>{{ order.boards_po.po_number }}</strong>
                                    {% for extra_po in order.additional_boards_pos.all %}
                                        <span class="badge badge-info" style="margin-left: 4px;">{{ extra_po.po_number }}</span>
                                    {% endfor %}
                                {% else %}
                                    <span class="text-muted">Not assigned</span>
                                {% endif %}
                                {% if order.boards_po and order.boards_po.file %}
                                    <span class="file-status" title="PNX File">
                                        {% if order.boards_po.file %}
                                            <a href="{{ order.boards_po.file.url }}" download class="btn-icon" title="Download PNX">
                                                <i class="bi bi-download"></i>
                                            </a>
                                        {% endif %}
                                        PNX
                                    </span>
                                {% endif %}
                            </dd>
                        </div>
                        <div class="summary-row">
                            <dt>Boards Ordered:</dt>
                            <dd>
                                {% if order.all_materials_ordered %}
                                    <span class="costing-badge success"><i class="bi bi-check"></i></span>
                                {% else %}
                                    <span class="costing-badge danger"><i class="bi bi-x"></i></span>
                                {% endif %}
                            </dd>
                        </div>
                        <div class="summary-row">
                            <dt>Boards Received:</dt>
                            <dd>
                                {% if order.order_boards_received %}
                                    <span class="costing-badge success"><i class="bi bi-check"></i></span>
                                {% else %}
                                    <span class="costing-badge danger"><i class="bi bi-x"></i></span>
                                {% endif %}
                            </dd>
                        </div>
                        <div class="summary-row">
                            <dt>All Items Ordered:</dt>
                            <dd>
                                {% if order.all_items_ordered %}
                                    <span class="costing-badge success"><i class="bi bi-check"></i></span>
                                {% else %}
                                    <span class="costing-badge danger"><i class="bi bi-x"></i></span>
                                {% endif %}
                            </dd>
                        </div>
                        <div class="summary-row">
                            <dt>Job Finished:</dt>
                            <dd>
                                {% if order.job_finished %}
                                    <span class="costing-badge success"><i class="bi bi-check"></i></span>
                                {% else %}
                                    <span class="costing-badge danger"><i class="bi bi-x"></i></span>
                                {% endif %}
                            </dd>
                        </div>
                    </dl>
                </div>
            </div>
        </div>
    </div>

    <div class="full-width-section">
        {% for bpo_data in boards_po_list %}
        <div class="card {% if not forloop.first %}mt-3{% endif %}">
            <div class="card-header">
                <div class="boards-header-left">
                    {% if bpo_data.purchase_order %}
                        <a href="{% url 'purchase_order_detail' bpo_data.purchase_order.workguru_id %}" class="btn btn-sm btn-view-po" title="View Purchase Order">
                            <i class="bi bi-eye"></i> View PO
                        </a>
                    {% endif %}
                    <h3>{{ bpo_data.po.po_number }} : Board Details{% if not bpo_data.is_primary %} <span class="badge badge-info badge-ml">Additional</span>{% endif %}</h3>
                </div>
                <div class="header-actions">
                    <!-- File status indicators -->
                    <div class="file-status-group">
                        <span class="file-status" title="PNX File">
                            PNX
                            {% if bpo_data.po.file %}
                                <i class="bi bi-check-circle-fill text-success"></i>
                                <a href="{{ bpo_data.po.file.url }}" download class="btn-icon" title="Download PNX">
                                    <i class="bi bi-download"></i>
                                </a>
                            {% else %}
                                <i class="bi bi-x-circle-fill text-danger"></i>
                            {% endif %}
                        </span>
                        <span class="file-status" title="CSV File">
                            CSV
                            {% if bpo_data.po.csv_file %}
                                <i class="bi bi-check-circle-fill text-success"></i>
                                <a href="{{ bpo_data.po.csv_file.url }}" download class="btn-icon" title="Download CSV">
                                    <i class="bi bi-download"></i>
                                </a>
                            {% else %}
                                <i class="bi bi-x-circle-fill text-danger"></i>
                            {% endif %}
                        </span>
                    </div>
                    {% if order.customer_number %}
                        <button type="button" class="btn btn-sm btn-generate-cad" onclick="analyzePNXGeneration(event, {{ bpo_data.po.id }})">
                            <i class="bi bi-file-earmark-plus"></i> Generate PNX - CAD
                        </button>
                    {% endif %}
                    <div class="section-actions">
                        <button type="button" class="btn btn-sm btn-add-board" onclick="openModal('addBoardModal', {{ bpo_data.po.id }})">
                            <i class="bi bi-plus-circle"></i> Add Board
                        </button>
                        {% if bpo_data.pnx_items and bpo_data.po.po_number %}
                            {% if bpo_data.purchase_order %}
                                <button type="button" class="btn btn-sm btn-update-files-po" onclick="updateBoardsPO({{ bpo_data.po.id }})" title="Regenerate PNX/CSV files and update PO attachments">
                                    <i class="bi bi-arrow-repeat"></i> Update Files &amp; PO
                                </button>
                            {% else %}
                                <a href="{% url 'create_boards_purchase_order' order.id %}?boards_po_id={{ bpo_data.po.id }}" class="btn btn-sm btn-create-po"
                                   onclick="return confirm('Create a local Purchase Order for {{ bpo_data.po.po_number }} and attach the board files?');"
                                   title="Create a local PO and attach PNX/CSV files">
                                    <i class="bi bi-file-earmark-plus"></i> Create PO
                                </a>
                            {% endif %}
                        {% endif %}
                        {% if not bpo_data.is_primary %}
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeAdditionalBoardsPO({{ order.id }}, {{ bpo_data.po.id }})" title="Remove this additional PO from the order">
                                <i class="bi bi-x-lg"></i> Remove
                            </button>
                        {% endif %}
                        {% if bpo_data.pnx_items %}
                            <button type="button" class="btn btn-save-dims btn-save-changes save-pnx-btn" data-boards-po-id="{{ bpo_data.po.id }}" style="display: none;">
                                <i class="bi bi-check-lg"></i> Save Changes
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="card-body">
                {% if bpo_data.pnx_items %}
                    <div class="pnx-items-header">
                        <p><strong>PNX Items for this Order ({{ bpo_data.pnx_items|length }} items):</strong></p>
                        <div style="display: flex; gap: 10px;">
                            <button type="button" class="btn btn-warning btn-sm" onclick="reimportPNX({{ bpo_data.po.id }})">
                                <i class="bi bi-arrow-clockwise"></i> Reimport from PNX
                            </button>
                            <button type="button" class="btn btn-danger btn-sm btn-delete-selected" data-boards-po-id="{{ bpo_data.po.id }}">
                                <i class="bi bi-trash"></i> Delete Selected
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" class="select-all-pnx" data-boards-po-id="{{ bpo_data.po.id }}"></th>
                                    <th>Barcode</th>
                                    <th>Material</th>
                                    <th class="col-dim">Length</th>
                                    <th class="col-dim">Width</th>
                                    <th class="col-cnt">QTY</th>
                                    <th title="PRFID1">E1</th>
                                    <th title="PRFID3">E3</th>
                                    <th title="PRFID4">E4</th>
                                    <th title="PRFID2">E2</th>
                                    <th class="col-stock">Stock</th>
                                    <th>Status</th>
                                    <th>Cost</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in bpo_data.pnx_items %}
                                <tr>
                                    <td><input type="checkbox" class="pnx-item-checkbox" data-item-id="{{ item.id }}" data-boards-po-id="{{ bpo_data.po.id }}"></td>
                                    <td>
                                        <input type="text" 
                                               class="quantity-input pnx-text-input" 
                                               value="{{ item.barcode }}"
                                               data-pnx-id="{{ item.id }}"
                                               data-field="barcode"
                                               data-boards-po-id="{{ bpo_data.po.id }}"
                                               data-original-value="{{ item.barcode }}">
                                    </td>
                                    <td>
                                        <input type="text" 
                                               class="quantity-input pnx-text-input" 
                                               value="{{ item.matname }}"
                                               data-pnx-id="{{ item.id }}"
                                               data-field="matname"
                                               data-boards-po-id="{{ bpo_data.po.id }}"
                                               data-original-value="{{ item.matname }}">
                                    </td>
                                    <td>
                                        <input type="number" 
                                               class="quantity-input pnx-dimension-input" 
                                               min="0" 
                                               step="1"
                                               value="{{ item.cleng|floatformat:0 }}"
                                               data-pnx-id="{{ item.id }}"
                                               data-field="cleng"
                                               data-boards-po-id="{{ bpo_data.po.id }}"
                                               data-original-value="{{ item.cleng|floatformat:0 }}">
                                    </td>
                                    <td>
                                        <input type="number" 
                                               class="quantity-input pnx-dimension-input" 
                                               min="0" 
                                               step="1"
                                               value="{{ item.cwidth|floatformat:0 }}"
                                               data-pnx-id="{{ item.id }}"
                                               data-field="cwidth"
                                               data-boards-po-id="{{ bpo_data.po.id }}"
                                               data-original-value="{{ item.cwidth|floatformat:0 }}">
                                    </td>
                                    <td>
                                        <input type="number" 
                                               class="quantity-input pnx-dimension-input" 
                                               min="0" 
                                               step="1"
                                               value="{{ item.cnt|floatformat:0 }}"
                                               data-pnx-id="{{ item.id }}"
                                               data-field="cnt"
                                               data-boards-po-id="{{ bpo_data.po.id }}"
                                               data-original-value="{{ item.cnt|floatformat:0 }}">
                                    </td>
                                    <td class="edging-cell">
                                        <input type="checkbox" class="pnx-edging-checkbox" 
                                               data-pnx-id="{{ item.id }}" data-field="prfid1"
                                               data-boards-po-id="{{ bpo_data.po.id }}"
                                               {% if item.prfid1 %}checked{% endif %}>
                                    </td>
                                    <td class="edging-cell">
                                        <input type="checkbox" class="pnx-edging-checkbox" 
                                               data-pnx-id="{{ item.id }}" data-field="prfid3"
                                               data-boards-po-id="{{ bpo_data.po.id }}"
                                               {% if item.prfid3 %}checked{% endif %}>
                                    </td>
                                    <td class="edging-cell">
                                        <input type="checkbox" class="pnx-edging-checkbox" 
                                               data-pnx-id="{{ item.id }}" data-field="prfid4"
                                               data-boards-po-id="{{ bpo_data.po.id }}"
                                               {% if item.prfid4 %}checked{% endif %}>
                                    </td>
                                    <td class="edging-cell">
                                        <input type="checkbox" class="pnx-edging-checkbox" 
                                               data-pnx-id="{{ item.id }}" data-field="prfid2"
                                               data-boards-po-id="{{ bpo_data.po.id }}"
                                               {% if item.prfid2 %}checked{% endif %}>
                                    </td>
                                    <td class="stock-qty-cell {% if item.is_standard_board %}{% if item.stock_quantity == 0 %}stock-zero{% elif item.stock_quantity < 5 %}stock-low{% endif %}{% endif %}">
                                        {% if item.is_standard_board %}{{ item.stock_quantity }}{% else %}-{% endif %}
                                    </td>
                                    <td>
                                        {% if item.is_fully_received %}
                                            <span class="badge badge-success">Received</span>
                                        {% elif item.is_partially_received %}
                                            <span class="badge badge-warning">Partial</span>
                                        {% else %}
                                            <span class="badge badge-danger">Pending</span>
                                        {% endif %}
                                    </td>
                                    <td>£{{ item.calculated_cost|floatformat:2 }}</td>
                                </tr>
                                {% endfor %}
                                <tr class="total-row">
                                    <td colspan="11"><strong>Total Cost:</strong></td>
                                    <td><strong>£{{ bpo_data.total_cost|floatformat:2 }}</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted" style="padding: 12px;">No board items yet. Use "Add Board" or "Generate PNX - CAD" to add items.</p>
                {% endif %}
            </div>
        </div>
        {% endfor %}

        {% if not boards_po_list %}
        <!-- No boards PO assigned yet -->
        <div class="card">
            <div class="card-header">
                <h3>Board Details</h3>
            </div>
            <div class="card-body">
                <p class="text-muted" style="padding: 12px;">No Boards PO assigned. Assign one in the Job Info section above.</p>
            </div>
        </div>
        {% endif %}

        <!-- Add Additional Boards PO button -->
        {% if order.boards_po %}
        <div style="margin-bottom: 12px; text-align: right;">
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addAdditionalBoardsPO({{ order.id }})" title="Create an additional boards PO for this order">
                <i class="bi bi-plus-circle"></i> Add Additional Boards PO
            </button>
        </div>
        {% endif %}

        <!-- OS Doors Section -->
        <div class="card">
            <div class="card-header">
                <h3>
                    OS Doors
                    {% if order.os_doors_po %}
                        <span class="badge badge-info badge-ml">{{ order.os_doors_po }}</span>
                    {% endif %}
                    {% if order.os_doors_required %}
                        {% if order.os_doors_po %}
                            <span class="badge badge-success badge-ml">Ordered</span>
                        {% else %}
                            <span class="badge badge-danger badge-ml">Required</span>
                        {% endif %}
                    {% endif %}
                </h3>
                <div class="header-actions">
                    {% if os_doors_purchase_order %}
                        <a href="{% url 'purchase_order_detail' os_doors_purchase_order.workguru_id %}" class="btn btn-sm btn-view-po" title="View Purchase Order">
                            <i class="bi bi-eye"></i> View PO
                        </a>
                    {% endif %}
                    {% if order.os_doors.exists and not order.os_doors_po %}
                    <a href="{% url 'create_os_doors_purchase_order' order.id %}"
                       class="btn btn-sm btn-create-po"
                       title="Create a local PO for OS Doors"
                       onclick="return confirm('Create a Purchase Order for OS Doors on this order?');">
                        <i class="bi bi-file-earmark-plus"></i> Create PO
                    </a>
                    {% endif %}
                    <button type="button" class="btn btn-sm btn-save-dims" id="save-os-doors-changes" style="display: none;">
                        <i class="bi bi-save"></i> Save Changes
                    </button>
                    <button type="button" class="btn btn-sm btn-danger hidden" id="delete-os-doors-selected">
                        <i class="bi bi-trash"></i> Delete Selected (<span id="os-door-selected-count">0</span>)
                    </button>
                    <button class="btn btn-sm btn-add-board" type="button" onclick="openModal('pasteOSDoorModal')">
                        <i class="bi bi-clipboard"></i> Paste OS Door
                    </button>
                    <button class="btn btn-sm btn-add-board" type="button" onclick="toggleCollapse('addOSDoorForm')">
                        <i class="bi bi-plus-lg"></i> Add OS Door
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Existing OS Doors -->
                {% if order.os_doors.all %}
                <div class="table-container">
                    <table class="table" id="os-doors-table">
                        <thead>
                            <tr>
                                <th style="width: 30px;"><input type="checkbox" id="os-door-select-all" title="Select all"></th>
                                <th>Door Style</th>
                                <th>Style Colour</th>
                                <th>Height</th>
                                <th>Width</th>
                                <th>Colour</th>
                                <th>Qty</th>
                                <th>Cost Price</th>
                                <th>Total Cost</th>
                                <th>PO Number</th>
                                <th>Ordered</th>
                                <th>Received</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for os_door in order.os_doors.all %}
                            <tr data-os-door-id="{{ os_door.id }}">
                                <td><input type="checkbox" class="checkbox-input os-door-select" data-os-door-id="{{ os_door.id }}"></td>
                                <td>{{ os_door.door_style }}</td>
                                <td>{{ os_door.style_colour }}</td>
                                <td>{{ os_door.height|floatformat:0 }}</td>
                                <td>{{ os_door.width|floatformat:0 }}</td>
                                <td>{{ os_door.colour }}</td>
                                <td>
                                    <input type="number" step="1" min="1" class="form-input os-door-qty-input input-width-60" 
                                           data-os-door-id="{{ os_door.id }}" 
                                           value="{{ os_door.quantity }}">
                                </td>
                                <td>
                                    <input type="number" step="0.01" min="0" class="form-input os-door-cost-input input-width-100" 
                                           data-os-door-id="{{ os_door.id }}" 
                                           value="{{ os_door.cost_price }}" 
                                           placeholder="£0.00">
                                </td>
                                <td class="os-door-total-cost" data-os-door-id="{{ os_door.id }}">
                                    £{{ os_door.cost_price|multiply:os_door.quantity }}
                                </td>
                                <td>{{ os_door.po_number|default:"-" }}</td>
                                <td>
                                    {% if os_door.ordered %}
                                        <span class="status-icon success">✓</span>
                                    {% else %}
                                        <span class="status-icon muted">✕</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <input type="checkbox" class="checkbox-input os-door-received-checkbox" 
                                           data-os-door-id="{{ os_door.id }}" {% if os_door.received %}checked{% endif %}>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">No OS doors added yet.</p>
                {% endif %}

                    <!-- Add OS Door Form -->
                <div class="collapsible-form" id="addOSDoorForm">
                    <hr>
                    <h4>Add New OS Door</h4>
                    <form method="POST">
                        {% csrf_token %}
                        <div class="form-grid-2col">
                            <div class="form-group">
                                <label for="{{ os_door_form.door_style.id_for_label }}">Door Style</label>
                                {{ os_door_form.door_style }}
                            </div>
                            <div class="form-group">
                                <label for="{{ os_door_form.style_colour.id_for_label }}">Style Colour</label>
                                {{ os_door_form.style_colour }}
                            </div>
                            <div class="form-group form-group-span-2">
                                <label for="{{ os_door_form.item_description.id_for_label }}">Item Description</label>
                                {{ os_door_form.item_description }}
                            </div>
                            <div class="form-group">
                                <label for="{{ os_door_form.height.id_for_label }}">Height (mm)</label>
                                {{ os_door_form.height }}
                            </div>
                            <div class="form-group">
                                <label for="{{ os_door_form.width.id_for_label }}">Width (mm)</label>
                                {{ os_door_form.width }}
                            </div>
                            <div class="form-group">
                                <label for="{{ os_door_form.colour.id_for_label }}">Colour</label>
                                {{ os_door_form.colour }}
                            </div>
                            <div class="form-group">
                                <label for="{{ os_door_form.quantity.id_for_label }}">Quantity</label>
                                {{ os_door_form.quantity }}
                            </div>
                            <div class="form-group">
                                <label for="{{ os_door_form.cost_price.id_for_label }}">Cost Price (£)</label>
                                {{ os_door_form.cost_price }}
                            </div>
                            <div class="form-group">
                                <label for="{{ os_door_form.po_number.id_for_label }}">PO Number</label>
                                {{ os_door_form.po_number }}
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    {{ os_door_form.ordered }}
                                    <span>Ordered</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    {{ os_door_form.received }}
                                    <span>Received</span>
                                </label>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success" id="add-os-door-submit">
                            <i class="bi bi-plus-lg"></i> Add OS Door
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Glass Section -->
        <div class="card">
            <div class="card-header">
                <h3>
                    Glass
                    {% if glass_items %}
                        <span class="badge badge-info badge-ml">{{ glass_items|length }} item{{ glass_items|length|pluralize }}</span>
                    {% endif %}
                </h3>
                <div class="header-actions">
                    <button class="btn btn-sm btn-primary" type="button" onclick="openModal('addGlassModal')">
                        <i class="bi bi-plus-lg"></i> Add Glass
                    </button>
                    {% if glass_items %}
                    <button type="button" class="btn btn-sm btn-danger hidden" id="delete-glass-selected" title="Delete selected">
                        <i class="bi bi-trash"></i> <span id="glass-selected-count">0</span>
                    </button>
                    <button type="button" class="btn btn-sm btn-add-to-po hidden" id="glass-add-to-po" onclick="openAddToPOModal('glass')">
                        <i class="bi bi-cart-plus"></i> Add to PO
                    </button>
                    <button type="button" class="btn btn-sm btn-create-po hidden" id="glass-create-po" onclick="createPOFromSelected('glass')">
                        <i class="bi bi-file-earmark-plus"></i> Create PO
                    </button>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                {% if glass_items %}
                <div class="table-container">
                    <table class="table" id="glass-table">
                        <thead>
                            <tr>
                                <th style="width: 30px;"><input type="checkbox" id="glass-select-all" title="Select all"></th>
                                <th>SKU</th>
                                <th>Name</th>
                                <th>Qty</th>
                                <th>Cost</th>
                                <th>Stock</th>
                                <th style="text-align: center;">Replace</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for glass in glass_items %}
                            <tr data-accessory-id="{{ glass.id }}" {% if glass.is_allocated %}class="allocated-row"{% endif %}>
                                <td><input type="checkbox" class="checkbox-input glass-select" data-accessory-id="{{ glass.id }}" data-allocated="{{ glass.is_allocated|yesno:'1,0' }}"></td>
                                <td>{{ glass.sku }}</td>
                                <td>{{ glass.name }}</td>
                                <td>
                                    <input type="number" class="quantity-input accessory-quantity" 
                                           value="{{ glass.quantity|floatformat:0 }}" 
                                           data-accessory-id="{{ glass.id }}"
                                           data-original-quantity="{{ glass.quantity|floatformat:0 }}"
                                           min="0" step="1">
                                </td>
                                <td>£{{ glass.cost_price|floatformat:2 }}</td>
                                <td>
                                    {% if glass.stock_item %}
                                        {% with remaining=glass|calculate_remaining %}
                                            <div class="accessory-price-info">
                                                <div><span>Stock</span><span>{{ glass.available_quantity|floatformat:0 }}</span></div>
                                                <div><span>Allocated</span><span>{{ glass.allocated_quantity|floatformat:0 }}</span></div>
                                                <div class="{% if glass.incoming_quantity %}incoming-highlight{% else %}incoming-zero{% endif %}"><span>Incoming</span><span>{{ glass.incoming_quantity|floatformat:0 }}</span></div>
                                                <div class="accessory-remaining {% if remaining < 0 %}accessory-remaining-negative{% elif remaining == 0 %}accessory-remaining-zero{% else %}accessory-remaining-positive{% endif %}"><span>Remaining</span><span>{{ remaining|floatformat:0 }}</span></div>
                                            </div>
                                        {% endwith %}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td style="text-align: center;">
                                    <button type="button" class="btn btn-outline-primary btn-sm" title="Replace Item" 
                                        onclick="openSwapModal('{{ glass.id }}', '{{ glass.sku }}', '{{ glass.name|escapejs }}')">
                                        <i class="bi bi-arrow-repeat"></i> Replace
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                            <tr class="table-total-row">
                                <td colspan="4" class="text-right">Total:</td>
                                <td>£{{ glass_items|sum_accessory_costs }}</td>
                                <td colspan="1"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">No glass items added yet.</p>
                {% endif %}
            </div>
        </div>

        <!-- Raumplus Section -->
        <div class="card">
            <div class="card-header">
                <h3>
                    Raumplus
                    {% if raumplus_accessories %}
                        <span class="badge badge-info badge-ml">{{ raumplus_accessories|length }} item{{ raumplus_accessories|length|pluralize }}</span>
                    {% endif %}
                </h3>
                <div class="header-actions">
                    {% if raumplus_accessories %}
                    <button type="button" class="btn btn-sm btn-danger hidden" id="delete-raumplus-selected" title="Delete selected">
                        <i class="bi bi-trash"></i> <span id="raumplus-selected-count">0</span>
                    </button>
                    <button type="button" class="btn btn-sm btn-add-to-po hidden" id="raumplus-add-to-po" onclick="openAddToPOModal('raumplus')">
                        <i class="bi bi-cart-plus"></i> Add to PO
                    </button>
                    <button type="button" class="btn btn-sm btn-create-po hidden" id="raumplus-create-po" onclick="createPOFromSelected('raumplus')">
                        <i class="bi bi-file-earmark-plus"></i> Create PO
                    </button>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                {% if raumplus_accessories %}
                <div class="table-container">
                    <table class="table" id="raumplus-table">
                        <thead>
                            <tr>
                                <th style="width: 30px;"><input type="checkbox" id="raumplus-select-all" title="Select all"></th>
                                <th>SKU</th>
                                <th>Name</th>
                                <th>Qty</th>
                                <th>Cost</th>
                                <th>Stock</th>
                                <th style="text-align: center;">Replace</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for rau in raumplus_accessories %}
                            <tr data-accessory-id="{{ rau.id }}" {% if rau.is_allocated %}class="allocated-row"{% endif %}>
                                <td><input type="checkbox" class="checkbox-input raumplus-select" data-accessory-id="{{ rau.id }}" data-allocated="{{ rau.is_allocated|yesno:'1,0' }}"></td>
                                <td class="accessory-sku-cell">
                                    <div class="accessory-sku-cell-inner">
                                        {% if rau.stock_item %}
                                            <a href="{% url 'product_detail' rau.stock_item.id %}" class="sku-link" target="_blank">{{ rau.sku }}</a>
                                        {% else %}
                                            {{ rau.sku }}
                                        {% endif %}
                                        <button type="button" class="btn-copy-sku" title="Copy SKU" onclick="copyToClipboard('{{ rau.sku|escapejs }}', this)"><i class="bi bi-clipboard"></i></button>
                                    </div>
                                </td>
                                <td>{{ rau.name }}</td>
                                <td>
                                    <input type="number" class="quantity-input accessory-quantity" 
                                           value="{{ rau.quantity|floatformat:0 }}" 
                                           data-accessory-id="{{ rau.id }}"
                                           data-original-quantity="{{ rau.quantity|floatformat:0 }}"
                                           min="0" step="1">
                                </td>
                                <td>£{{ rau.cost_price|floatformat:2 }}</td>
                                <td>
                                    {% if rau.stock_item %}
                                        {% with remaining=rau|calculate_remaining %}
                                            <div class="accessory-price-info">
                                                <div><span>Stock</span><span>{{ rau.available_quantity|floatformat:0 }}</span></div>
                                                <div><span>Allocated</span><span>{{ rau.allocated_quantity|floatformat:0 }}</span></div>
                                                <div class="{% if rau.incoming_quantity %}incoming-highlight{% else %}incoming-zero{% endif %}"><span>Incoming</span><span>{{ rau.incoming_quantity|floatformat:0 }}</span></div>
                                                <div class="accessory-remaining {% if remaining < 0 %}accessory-remaining-negative{% elif remaining == 0 %}accessory-remaining-zero{% else %}accessory-remaining-positive{% endif %}"><span>Remaining</span><span>{{ remaining|floatformat:0 }}</span></div>
                                            </div>
                                        {% endwith %}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td style="text-align: center;">
                                    <button type="button" class="btn btn-sm btn-outline-primary" title="Replace Item" 
                                        onclick="openSwapModal({{ rau.id }}, '{{ rau.sku }}', '{{ rau.name|escapejs }}')">
                                        <i class="bi bi-arrow-repeat"></i> Replace
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                            <tr class="table-total-row">
                                <td colspan="4" class="text-right">Total:</td>
                                <td>£{{ raumplus_accessories|sum_accessory_costs }}</td>
                                <td colspan="2"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">No Raumplus items added yet.</p>
                {% endif %}
            </div>
        </div>

            <!-- Accessories Section -->
            <div class="card">
                <div class="card-header">
                    <h3>
                        Accessories
                        <a href="{% url 'generate_and_upload_accessories_csv' order.id %}" class="btn btn-sm btn-generate-cad"
                           onclick="return confirm('Generate accessories CSV from CAD data?\n\nThis will create/update accessories from the CAD database.');">
                            <i class="bi bi-file-earmark-spreadsheet"></i> Generate CSV - CAD
                        </a>
                    </h3>
                    <div class="header-actions">
                        <button class="btn btn-sm btn-add-board" type="button" onclick="openModal('addItemModal')">
                            <i class="bi bi-plus-lg"></i> Add Item
                        </button>
                        {% if order.original_csv %}
                        <button class="btn btn-sm btn-update-files-po" type="button" onclick="regenerateCSV({{ order.id }})">
                            <i class="bi bi-arrow-repeat"></i> Regenerate CSV
                        </button>
                        {% endif %}
                        {% if order.accessories.exists %}
                        <button type="button" class="btn btn-sm btn-save-dims btn-save-changes" id="save-accessory-changes" style="display: none;">
                            <i class="bi bi-save"></i> Save Changes
                        </button>
                        <button type="button" class="btn btn-sm btn-danger hidden" id="delete-accessories-selected" title="Delete selected">
                            <i class="bi bi-trash"></i> <span id="accessory-selected-count">0</span>
                        </button>
                        <button type="button" class="btn btn-sm btn-add-to-po hidden" id="acc-add-to-po" onclick="openAddToPOModal('accessory')">
                            <i class="bi bi-cart-plus"></i> Add to PO
                        </button>
                        <button type="button" class="btn btn-sm btn-create-po hidden" id="acc-create-po" onclick="createPOFromSelected('accessory')">
                            <i class="bi bi-file-earmark-plus"></i> Create PO
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    
                    <!-- Existing Accessories -->
                    {% if non_glass_accessories %}
                    <div class="table-container">
                        <table class="table" id="accessories-table">
                            <thead>
                                <tr>
                                    <th style="width: 30px;"><input type="checkbox" id="accessory-select-all" title="Select all"></th>
                                    <th>SKU</th>
                                    <th>Name</th>
                                    <th>Qty</th>
                                    <th>Cost</th>
                                    <th>Stock</th>
                                    {% if has_os_door_accessories %}
                                    <th>Required</th>
                                    <th>Ordered</th>
                                    {% endif %}
                                    <th style="text-align: center;">Replace</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for accessory in non_glass_accessories %}
                                <tr data-accessory-id="{{ accessory.id }}" {% if accessory.is_allocated %}class="allocated-row"{% endif %}>
                                    <td><input type="checkbox" class="checkbox-input accessory-select" data-accessory-id="{{ accessory.id }}" data-allocated="{{ accessory.is_allocated|yesno:'1,0' }}"></td>
                                    <td class="accessory-sku-cell">
                                        <div class="accessory-sku-cell-inner">
                                            {% if accessory.stock_item %}
                                                <a href="{% url 'product_detail' accessory.stock_item.id %}" class="sku-link" target="_blank">{{ accessory.sku }}</a>
                                            {% else %}
                                                {{ accessory.sku }}
                                            {% endif %}
                                            <button type="button" class="btn-copy-sku" title="Copy SKU" onclick="copyToClipboard('{{ accessory.sku|escapejs }}', this)"><i class="bi bi-clipboard"></i></button>
                                        </div>
                                    </td>
                                    <td>{{ accessory.name }}</td>
                                    <td>
                                        <input type="number" class="quantity-input accessory-quantity" 
                                               value="{{ accessory.quantity|floatformat:0 }}" 
                                               data-accessory-id="{{ accessory.id }}"
                                               data-original-quantity="{{ accessory.quantity|floatformat:0 }}"
                                               min="0" step="1">
                                    </td>
                                    <td>£{{ accessory.cost_price|floatformat:2 }}</td>
                                    <td>
                                        {% if accessory.stock_item %}
                                            {% with remaining=accessory|calculate_remaining %}
                                                <div class="accessory-price-info">
                                                    <div><span>Stock</span><span>{{ accessory.available_quantity|floatformat:0 }}</span></div>
                                                    <div><span>Allocated</span><span>{{ accessory.allocated_quantity|floatformat:0 }}</span></div>
                                                    <div class="{% if accessory.incoming_quantity %}incoming-highlight{% else %}incoming-zero{% endif %}"><span>Incoming</span><span>{{ accessory.incoming_quantity|floatformat:0 }}</span></div>
                                                    <div class="accessory-remaining {% if remaining < 0 %}accessory-remaining-negative{% elif remaining == 0 %}accessory-remaining-zero{% else %}accessory-remaining-positive{% endif %}"><span>Remaining</span><span>{{ remaining|floatformat:0 }}</span></div>
                                                </div>
                                            {% endwith %}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    {% if has_os_door_accessories %}
                                    <td>
                                        {% if accessory.is_os_door %}
                                            <input type="checkbox" {% if accessory.required %}checked{% endif %} disabled>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if accessory.is_os_door %}
                                            <input type="checkbox" {% if accessory.ordered %}checked{% endif %} disabled>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    {% endif %}
                                    <td style="text-align: center;">
                                        <button type="button" class="btn btn-sm btn-outline-primary" title="Replace Item" 
                                            onclick="openSwapModal({{ accessory.id }}, '{{ accessory.sku }}', '{{ accessory.name|escapejs }}')">
                                            <i class="bi bi-arrow-repeat"></i> Replace
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                                <tr class="table-total-row">
                                    <td colspan="4" class="text-right">Total:</td>
                                    <td>£{{ non_glass_accessories|sum_accessory_costs }}</td>
                                    <td colspan="{% if has_os_door_accessories %}3{% else %}1{% endif %}"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">No accessories added yet.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Timesheets and Expenses Section -->
    <div class="card card-mt">
        <div class="card-header">
            <h3>Labor Costs & Expenses</h3>
        </div>
        <div class="card-body">
            <!-- Installation Timesheets -->
            <h4 class="section-header-purple">Installation Timesheets</h4>
            {% if installation_timesheets %}
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Fitter</th>
                                <th>Date</th>
                                <th>Price</th>
                                <th>Total Cost</th>
                                <th>Description</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for timesheet in installation_timesheets %}
                            <tr>
                                <td>{{ timesheet.worker_name }}</td>
                                <td>{{ timesheet.date|date:"d/m/Y" }}</td>
                                <td>£{{ timesheet.price|floatformat:2 }}</td>
                                <td>£{{ timesheet.total_cost|floatformat:2 }}</td>
                                <td>{{ timesheet.description|default:"-" }}</td>
                                <td>
                                    <button type="button" class="btn btn-danger btn-sm" onclick="deleteTimesheet({{ timesheet.id }})">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                            <tr class="table-subtotal-row-purple">
                                <td colspan="3" class="text-right">Subtotal:</td>
                                <td>£{{ calculated_installation_cost|floatformat:2 }}</td>
                                <td colspan="2"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-muted">No installation timesheets added yet.</p>
            {% endif %}
            
            <hr>
            
            <!-- Manufacturing Timesheets -->
            <h4 class="section-header-orange">Manufacturing Timesheets</h4>
            {% if manufacturing_timesheets %}
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Worker</th>
                                <th>Date</th>
                                <th>Hours</th>
                                <th>Rate/Hour</th>
                                <th>Total Cost</th>
                                <th>Description</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for timesheet in manufacturing_timesheets %}
                            <tr>
                                <td>{{ timesheet.worker_name }}</td>
                                <td>{{ timesheet.date|date:"d/m/Y" }}</td>
                                <td>{{ timesheet.hours }}</td>
                                <td>£{{ timesheet.hourly_rate }}</td>
                                <td>£{{ timesheet.total_cost|floatformat:2 }}</td>
                                <td>{{ timesheet.description|default:"-" }}</td>
                                <td>
                                    <button type="button" class="btn btn-danger btn-sm" onclick="deleteTimesheet({{ timesheet.id }})">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                            <tr class="table-subtotal-row-orange">
                                <td colspan="4" class="text-right">Subtotal:</td>
                                <td>£{{ calculated_manufacturing_cost|floatformat:2 }}</td>
                                <td colspan="2"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-muted">No manufacturing timesheets added yet.</p>
            {% endif %}
            
            <hr>
            
            <!-- Expenses -->
            <h4 class="section-header-red">Expenses</h4>
            {% if expenses %}
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Fitter</th>
                                <th>Type</th>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Description</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for expense in expenses %}
                            <tr>
                                <td>{{ expense.fitter.name }}</td>
                                <td>{{ expense.get_expense_type_display }}</td>
                                <td>{{ expense.date|date:"d/m/Y" }}</td>
                                <td>£{{ expense.amount }}</td>
                                <td>{{ expense.description|default:"-" }}</td>
                                <td>
                                    <button type="button" class="btn btn-danger btn-sm" onclick="deleteExpense({{ expense.id }})">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                            <tr class="table-subtotal-row-red">
                                <td colspan="3" class="text-right">Total Expenses:</td>
                                <td>£{{ expenses|sum_expenses|floatformat:2 }}</td>
                                <td colspan="2"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-muted">No expenses added yet.</p>
            {% endif %}
        </div>
    </div>
</div>
</div> <!-- End page-content -->


<!-- Modal for Uploading Accessories CSV -->
<div class="modal" id="uploadAccessoriesModal">
    <div class="modal-overlay" onclick="closeModal('uploadAccessoriesModal')"></div>
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{% url 'upload_accessories_csv' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-header">
                    <h3>Upload Accessories CSV (Auto-Order Detection)</h3>
                    <button type="button" class="modal-close" onclick="closeModal('uploadAccessoriesModal')">✕</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="id_csv_file">CSV File</label>
                        <input type="file" class="form-input" id="id_csv_file" name="csv_file" accept=".csv" required>
                        <small class="form-help">CSV should have columns: Sku, Name, Description, CostPrice, SellPrice, Quantity, Billable. Order will be auto-detected from customer number in filename.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('uploadAccessoriesModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Upload & Process</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal for Updating OS Doors PO -->
<div class="modal" id="updateOSDModal">
    <div class="modal-overlay" onclick="closeModal('updateOSDModal')"></div>
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{% url 'update_os_doors_po' order.id %}">
                {% csrf_token %}
                <div class="modal-header">
                    <h3>Update OS Doors PO</h3>
                    <button type="button" class="modal-close" onclick="closeModal('updateOSDModal')">✕</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="id_os_doors_po">OS Doors PO Number</label>
                        <input type="text" class="form-input" id="id_os_doors_po" name="os_doors_po" 
                               value="{{ order.os_doors_po }}" placeholder="Enter PO number when ordered">
                        <small class="form-help">Leave blank if not yet ordered</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('updateOSDModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update PO</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal for Pasting OS Door Data -->
<div class="modal" id="pasteOSDoorModal">
    <div class="modal-overlay" onclick="closeModal('pasteOSDoorModal')"></div>
    <div class="modal-dialog modal-dialog-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Paste OS Door Data</h3>
                <button type="button" class="modal-close" onclick="closeModal('pasteOSDoorModal')">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="osd-paste-input">Paste row from supplier sheet</label>
                    <textarea class="form-input" id="osd-paste-input" rows="3" 
                              placeholder="e.g. Morris &#9;Superior Matt Light Grey Superior Matt Light Grey &#9;Morris Superior Matt Light Grey Drawer 210 x 960 (MTM) &#9;Light Grey Light Grey &#9;H &#9;£36.58"></textarea>
                    <small class="form-help">Paste a tab-separated row directly from the supplier spreadsheet, then click Parse.</small>
                </div>
                <div class="flex-row-gap" style="margin-bottom: 1rem;">
                    <button type="button" class="btn btn-primary" onclick="parseOSDoorPaste()">
                        <i class="bi bi-magic"></i> Parse
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('osd-parse-rules').classList.toggle('hidden')">
                        <i class="bi bi-info-circle"></i> Parsing Rules
                    </button>
                </div>

                <!-- Parsing rules reference (hidden by default) -->
                <div id="osd-parse-rules" class="hidden" style="background: var(--bg-tertiary); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.85rem;">
                    <h4 style="margin-bottom: 0.5rem;">Parsing Rules</h4>
                    <p style="margin-bottom: 0.5rem;"><strong>Expected tab-separated columns:</strong></p>
                    <ol style="margin: 0.5rem 0 1rem; padding-left: 1.5rem;">
                        <li><strong>Door Style</strong> — e.g. Morris, Lanark</li>
                        <li><strong>Style Colour</strong> — e.g. Superior Matt Light Grey (may be duplicated)</li>
                        <li><strong>Item Description</strong> — full description including dimensions</li>
                        <li><strong>Colour</strong> — e.g. Light Grey (may be duplicated)</li>
                        <li><strong>Handing</strong> — H (ignored)</li>
                        <li><strong>Unit Price</strong> — e.g. £18.29</li>
                        <li><strong>Quantity</strong> — e.g. 2</li>
                        <li><strong>Total Price</strong> — e.g. £36.58</li>
                    </ol>
                    <p style="margin-bottom: 0.25rem;"><strong>Dimensions</strong> are extracted from the description (e.g. "210 x 960").</p>
                    <p style="margin-bottom: 0.5rem;">Empty leading columns are automatically skipped.</p>
                    <hr style="border-color: var(--border-color); margin: 0.75rem 0;">
                    <div class="form-grid-2col" style="gap: 0.5rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="osd-rules-styles" style="font-size: 0.85rem;"><strong>Known Door Styles</strong> (comma-separated)</label>
                            <input type="text" class="form-input" id="osd-rules-styles" 
                                   value="Morris, Lanark" style="font-size: 0.85rem;">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="osd-rules-colours" style="font-size: 0.85rem;"><strong>Known Style Colours</strong> (comma-separated)</label>
                            <input type="text" class="form-input" id="osd-rules-colours" 
                                   value="Superior Matt Light Grey, Superior Matt White, Superior Matt Cashmere, Superior Matt Anthracite, Superior Matt Dust Grey, Superior Matt Graphite" 
                                   style="font-size: 0.85rem;">
                        </div>
                    </div>
                    <small class="form-help" style="margin-top: 0.25rem; display: block;">Edit these lists to add new door styles or colours. Changes are used immediately when you click Parse.</small>
                </div>

                <!-- Parsed result preview -->
                <div id="osd-parse-result" class="hidden">
                    <h4 style="margin-bottom: 0.5rem;">Parsed Result</h4>
                    <form method="POST" id="osd-parsed-form">
                        {% csrf_token %}
                        <div class="form-grid-2col">
                            <div class="form-group">
                                <label for="osd-parsed-door-style">Door Style</label>
                                <input type="text" class="form-input" id="osd-parsed-door-style" name="door_style" required>
                            </div>
                            <div class="form-group">
                                <label for="osd-parsed-style-colour">Style Colour</label>
                                <input type="text" class="form-input" id="osd-parsed-style-colour" name="style_colour" required>
                            </div>
                            <div class="form-group form-group-span-2">
                                <label for="osd-parsed-description">Item Description</label>
                                <textarea class="form-input" id="osd-parsed-description" name="item_description" rows="2" required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="osd-parsed-height">Height (mm)</label>
                                <input type="number" class="form-input" id="osd-parsed-height" name="height" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label for="osd-parsed-width">Width (mm)</label>
                                <input type="number" class="form-input" id="osd-parsed-width" name="width" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label for="osd-parsed-colour">Colour</label>
                                <input type="text" class="form-input" id="osd-parsed-colour" name="colour" required>
                            </div>
                            <div class="form-group">
                                <label for="osd-parsed-quantity">Quantity</label>
                                <input type="number" class="form-input" id="osd-parsed-quantity" name="quantity" min="1" value="1" required>
                            </div>
                            <div class="form-group">
                                <label for="osd-parsed-cost-price">Cost Price (£)</label>
                                <input type="number" class="form-input" id="osd-parsed-cost-price" name="cost_price" step="0.01" min="0" value="0">
                            </div>
                            <div class="form-group">
                                <label for="osd-parsed-total-price">Total Price (£)</label>
                                <input type="number" class="form-input" id="osd-parsed-total-price" step="0.01" min="0" value="0" disabled 
                                       style="background: var(--bg-tertiary); color: var(--text-secondary);">
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('pasteOSDoorModal')">Cancel</button>
                <button type="button" class="btn btn-success" id="osd-parsed-submit" onclick="submitParsedOSDoor()" disabled>
                    <i class="bi bi-plus-lg"></i> Add OS Door
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Adding Board to PNX -->
<div class="modal" id="addBoardModal">
    <div class="modal-overlay" onclick="closeModal('addBoardModal')"></div>
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Board</h3>
                <button type="button" class="modal-close" onclick="closeModal('addBoardModal')">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="add-board-barcode">Barcode *</label>
                    <input type="text" class="form-input" id="add-board-barcode" placeholder="e.g., BRD001">
                </div>
                <div class="form-group">
                    <label for="add-board-matname">Material Name *</label>
                    <input type="text" class="form-input" id="add-board-matname" placeholder="e.g., White Gloss 18mm">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="add-board-length">Length (mm) *</label>
                        <input type="number" class="form-input" id="add-board-length" step="0.1" min="0" placeholder="e.g., 2800">
                    </div>
                    <div class="form-group">
                        <label for="add-board-width">Width (mm) *</label>
                        <input type="number" class="form-input" id="add-board-width" step="0.1" min="0" placeholder="e.g., 600">
                    </div>
                    <div class="form-group">
                        <label for="add-board-count">Count *</label>
                        <input type="number" class="form-input" id="add-board-count" step="1" min="1" value="1" placeholder="e.g., 2">
                    </div>
                </div>
                <div class="form-group">
                    <label for="add-board-grain">Grain</label>
                    <select class="form-input" id="add-board-grain">
                        <option value="N">N</option>
                        <option value="Y">Y</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="add-board-partdesc">Part Description</label>
                    <input type="text" class="form-input" id="add-board-partdesc" placeholder="e.g., Shelf">
                </div>
                <div class="form-group">
                    <label>Edging (check sides that need edging)</label>
                    <div class="edging-checkboxes">
                        <label class="checkbox-label"><input type="checkbox" id="add-board-prfid1"> PRFID1</label>
                        <label class="checkbox-label"><input type="checkbox" id="add-board-prfid3"> PRFID3</label>
                        <label class="checkbox-label"><input type="checkbox" id="add-board-prfid4"> PRFID4</label>
                        <label class="checkbox-label"><input type="checkbox" id="add-board-prfid2"> PRFID2</label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('addBoardModal')">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addBoardItem()">Add Board</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Swapping Accessory Item -->
<div class="modal" id="swapItemModal">
    <div class="modal-overlay" onclick="closeModal('swapItemModal')"></div>
    <div class="modal-dialog modal-dialog-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Swap Accessory Item</h3>
                <button type="button" class="modal-close" onclick="closeModal('swapItemModal')">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label><strong>Current Item:</strong></label>
                    <p id="current-item-info" class="text-muted"></p>
                </div>
                <div class="form-group">
                    <label for="swap-search">Search for Replacement Item</label>
                    <input type="text" class="form-input" id="swap-search" 
                           placeholder="Search by SKU or Name..." onkeyup="searchStockItems()">
                </div>
                <div id="search-results" class="search-results-container">
                    <p class="text-muted">Type to search for items...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('swapItemModal')">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Adding Timesheet -->
<div class="modal" id="addTimesheetModal">
    <div class="modal-overlay" onclick="closeModal('addTimesheetModal')"></div>
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="timesheet-modal-title">Add Timesheet</h3>
                <button type="button" class="modal-close" onclick="closeModal('addTimesheetModal')">✕</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="timesheet_type" name="timesheet_type">
                
                <div class="form-group" id="fitter-group">
                    <label for="timesheet_fitter">Fitter</label>
                    <div class="flex-row-gap">
                        <select class="form-input flex-1" id="timesheet_fitter" name="fitter" onchange="handleInstallationPersonSelect('fitter')">
                            <option value="">Select a fitter...</option>
                            <!-- Will be populated dynamically -->
                        </select>
                        <button type="button" class="btn btn-sm btn-success" onclick="toggleAddFitterInline()" title="Add new fitter">
                            <i class="bi bi-plus-lg"></i>
                        </button>
                    </div>
                    <div id="new-fitter-inline" class="new-person-inline">
                        <input type="text" id="new-fitter-name" class="form-input new-person-input" placeholder="Fitter name">
                        <div class="flex-row-gap">
                            <button type="button" class="btn btn-sm btn-success" onclick="saveNewFitter()" title="Save fitter">
                                <i class="bi bi-check-lg"></i> Save
                            </button>
                            <button type="button" class="btn btn-sm btn-secondary" onclick="cancelAddFitter()" title="Cancel">
                                <i class="bi bi-x-lg"></i> Cancel
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="form-group form-group-hidden" id="helper-group">
                    <label for="timesheet_helper">Helper / Additional Party</label>
                    <div class="flex-row-gap">
                        <select class="form-input flex-1" id="timesheet_helper" name="helper" onchange="handleInstallationPersonSelect('helper')">
                            <option value="">Select a helper...</option>
                            <!-- Will be populated dynamically -->
                        </select>
                        <button type="button" class="btn btn-sm btn-success" onclick="toggleAddHelperInline()" title="Add new helper">
                            <i class="bi bi-plus-lg"></i>
                        </button>
                    </div>
                    <div id="new-helper-inline" class="new-person-inline">
                        <input type="text" id="new-helper-name" class="form-input new-person-input" placeholder="Helper name">
                        <div class="flex-row-gap">
                            <button type="button" class="btn btn-sm btn-success" onclick="saveNewHelper()" title="Save helper">
                                <i class="bi bi-check-lg"></i> Save
                            </button>
                            <button type="button" class="btn btn-sm btn-secondary" onclick="cancelAddHelper()" title="Cancel">
                                <i class="bi bi-x-lg"></i> Cancel
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="form-group form-group-hidden" id="installation-worker-group">
                    <label for="timesheet_installation_worker">Factory Worker (if doing fit)</label>
                    <div class="flex-row-gap">
                        <select class="form-input flex-1" id="timesheet_installation_worker" name="installation_factory_worker" onchange="handleInstallationPersonSelect('installation_worker')">
                            <option value="">Select a factory worker...</option>
                            <!-- Will be populated dynamically -->
                        </select>
                    </div>
                </div>
                
                <div class="form-group form-group-hidden" id="worker-group">
                    <label for="timesheet_worker">Factory Worker</label>
                    <div class="flex-row-gap">
                        <select class="form-input flex-1" id="timesheet_worker" name="factory_worker">
                            <option value="">Select a worker...</option>
                            <!-- Will be populated dynamically -->
                        </select>
                        <button type="button" class="btn btn-sm btn-success" onclick="toggleAddWorkerInline()" title="Add new worker">
                            <i class="bi bi-plus-lg"></i>
                        </button>
                    </div>
                    <div id="new-worker-inline" class="new-person-inline">
                        <input type="text" id="new-worker-name" class="form-input new-person-input" placeholder="Worker name">
                        <div class="flex-row-gap">
                            <button type="button" class="btn btn-sm btn-success" onclick="saveNewWorker()" title="Save worker">
                                <i class="bi bi-check-lg"></i> Save
                            </button>
                            <button type="button" class="btn btn-sm btn-secondary" onclick="cancelAddWorker()" title="Cancel">
                                <i class="bi bi-x-lg"></i> Cancel
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- For installation: fixed price -->
                <div class="form-group" id="price-group">
                    <label for="timesheet_price">Price (£)</label>
                    <input type="number" step="0.01" min="0" class="form-input" id="timesheet_price" name="price" value="220.00" required>
                </div>
                
                <!-- Hours field (shown for both, optional for installation, required for manufacturing) -->
                <div class="form-group form-group-hidden" id="hours-group">
                    <label for="timesheet_hours">Hours <span id="hours-optional-label">(Optional)</span></label>
                    <input type="number" step="0.25" min="0" class="form-input" id="timesheet_hours" name="hours">
                </div>
                
                <input type="hidden" id="timesheet_hourly_rate" name="hourly_rate">
                
                <div class="form-group">
                    <label for="timesheet_description">Description (Optional)</label>
                    <textarea class="form-input" id="timesheet_description" name="description" rows="3"></textarea>
                </div>
                
                <div class="form-group form-group-hidden" id="add-expense-group">
                    <label>
                        <input type="checkbox" id="add_petrol_expense" onchange="togglePetrolAmount()">
                        Add Petrol Expense
                    </label>
                    <input type="number" step="0.01" min="0" class="form-input form-group-hidden petrol-amount-input" id="petrol_amount" 
                           name="petrol_amount" value="20.00" placeholder="Amount (£)">
                </div>
                
                <!-- Manufacturing Staging Table -->
                <div id="manufacturing-staging-section" class="manufacturing-staging-section">
                    <div class="staging-header">
                        <h4><i class="bi bi-list-check"></i> Staged Timesheets</h4>
                        <span id="staging-total" class="staging-total">Total: £0.00</span>
                    </div>
                    <div class="staging-table-container">
                        <table class="table staging-table" id="staging-table">
                            <thead>
                                <tr>
                                    <th>Worker</th>
                                    <th>Hours</th>
                                    <th>Rate</th>
                                    <th>Cost</th>
                                    <th class="th-narrow"></th>
                                </tr>
                            </thead>
                            <tbody id="staging-table-body">
                                <!-- Staged entries will be added here -->
                            </tbody>
                        </table>
                    </div>
                    <p id="staging-empty-message" class="text-muted staging-empty-message">
                        No timesheets staged yet. Add entries above.
                    </p>
                </div>
            </div>
            <div class="modal-footer" id="timesheet-modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('addTimesheetModal')">Cancel</button>
                <!-- Installation: single save button -->
                <button type="button" class="btn btn-primary" id="save-single-timesheet-btn" onclick="saveTimesheet()">Save Timesheet</button>
                <!-- Manufacturing: add to list + save all buttons -->
                <button type="button" class="btn btn-success btn-save-changes" id="add-to-staging-btn" onclick="addToStagingTable()">
                    <i class="bi bi-plus-lg"></i> Add to List
                </button>
                <button type="button" class="btn btn-primary btn-save-changes" id="save-all-timesheets-btn" onclick="saveAllStagedTimesheets()">
                    <i class="bi bi-check-all"></i> Save All (<span id="staged-count">0</span>)
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Adding New Accessory Item -->
<div class="modal" id="addItemModal">
    <div class="modal-overlay" onclick="closeModal('addItemModal')"></div>
    <div class="modal-dialog modal-dialog-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Accessory Item</h3>
                <button type="button" class="modal-close" onclick="closeModal('addItemModal')">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="add-item-search">Search for Item</label>
                    <input type="text" class="form-input" id="add-item-search" 
                           placeholder="Search by SKU or Name..." onkeyup="searchItemsToAdd()">
                </div>
                <div id="add-item-results" class="search-results-container">
                    <p class="text-muted">Type to search for items...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('addItemModal')">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Glass Modal -->
<div class="modal" id="addGlassModal">
    <div class="modal-overlay" onclick="closeModal('addGlassModal')"></div>
    <div class="modal-dialog modal-dialog-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Glass Item</h3>
                <button type="button" class="modal-close" onclick="closeModal('addGlassModal')">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="add-glass-search">Search for Item</label>
                    <input type="text" class="form-input" id="add-glass-search" 
                           placeholder="Search by SKU or Name..." onkeyup="searchGlassToAdd()">
                </div>
                <div id="add-glass-results" class="search-results-container">
                    <p class="text-muted">Type to search for items...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('addGlassModal')">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- Add to Existing PO Modal -->
<div class="modal" id="addToPOModal">
    <div class="modal-overlay" onclick="closeModal('addToPOModal')"></div>
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Items to Purchase Order</h3>
                <button type="button" class="modal-close" onclick="closeModal('addToPOModal')">✕</button>
            </div>
            <div class="modal-body">
                <p id="po-modal-item-count" class="text-muted mb-2"></p>
                <div class="form-group">
                    <label for="po-select">Select Purchase Order</label>
                    <select class="form-input" id="po-select">
                        <option value="">-- Select a PO --</option>
                        {% for po in available_purchase_orders %}
                        <option value="{{ po.workguru_id }}">{{ po.display_number }} - {{ po.supplier_name }} ({{ po.status }})</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('addToPOModal')">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirm-add-to-po" onclick="submitAddToPO()">
                    <i class="bi bi-cart-plus"></i> Add to PO
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Workflow Modal -->
<div class="modal" id="workflowModal">
    <div class="modal-overlay" onclick="closeModal('workflowModal')"></div>
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Full Workflow Overview</h3>
                <button type="button" class="modal-close" onclick="closeModal('workflowModal')">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Department Color Key -->
                <div class="workflow-color-key">
                    <div class="color-key-item">
                        <span class="color-indicator sales"></span>
                        <span class="color-label">Sales</span>
                    </div>
                    <div class="color-key-item">
                        <span class="color-indicator admin"></span>
                        <span class="color-label">Admin</span>
                    </div>
                    <div class="color-key-item">
                        <span class="color-indicator factory"></span>
                        <span class="color-label">Factory</span>
                    </div>
                    <div class="color-key-item">
                        <span class="color-indicator installation"></span>
                        <span class="color-label">Installation</span>
                    </div>
                </div>
                
                <div class="workflow-modal-container">
                    {% for phase, phase_display in phases %}
                        <div class="workflow-phase-section">
                            <div class="phase-header">
                                <h4>{{ phase_display }}</h4>
                            </div>
                            
                            {% for stage in stages_by_phase|get_item:phase %}
                            <div class="workflow-stage-box {{ stage.role }} {% if workflow_progress.current_stage.id == stage.id %}current-stage{% endif %}" 
                                 onclick="selectWorkflowStage({{ order.id }}, {{ stage.id }})">
                                <div class="stage-box-header">
                                    <h5>{{ stage.name }}</h5>
                                    {% if workflow_progress.current_stage.id == stage.id %}
                                    <span class="current-badge"><i class="bi bi-check-circle-fill"></i> Current</span>
                                    {% endif %}
                                </div>
                                <div class="stage-box-meta">
                                    <span class="stage-role-tag">{{ stage.get_role_display }}</span>
                                    {% if stage.expected_days %}
                                    <span class="stage-duration-tag">{{ stage.expected_days }}d</span>
                                    {% endif %}
                                </div>
                                <p class="stage-box-description">{{ stage.description }}</p>
                            </div>
                            
                            {% if not forloop.last %}
                            <div class="stage-connector">
                                <i class="bi bi-arrow-down"></i>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                    {% endfor %}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('workflowModal')">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Adding Boards PO -->
<div class="modal" id="addPOModal">
    <div class="modal-overlay" onclick="closeModal('addPOModal')"></div>
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="add-po-form" method="POST" action="{% url 'create_boards_po' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-header">
                    <h3>Add New Boards PO</h3>
                    <button type="button" class="modal-close" onclick="closeModal('addPOModal')">✕</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="po-number-input">PO Number</label>
                        <input type="text" id="po-number-input" name="po_number" class="form-input" placeholder="e.g., PO1234" required>
                        <small class="form-help">Must start with "PO"</small>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="boards_ordered" id="boards-ordered-input">
                            <span>Boards Ordered</span>
                        </label>
                        <small class="form-help">Check if boards have already been ordered</small>
                    </div>
                    <div class="form-group">
                        <label for="po-file-input">Attach File (Optional)</label>
                        <input type="file" id="po-file-input" name="file" class="form-input">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addPOModal')">Cancel</button>
                    <button type="submit" class="btn btn-warning">Create PO</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal for Stock Allocation Confirmation -->
<div class="modal" id="allocationModal">
    <div class="modal-overlay" onclick="closeModal('allocationModal')"></div>
    <div class="modal-dialog modal-dialog-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="bi bi-box-arrow-in-down"></i> Confirm Stock Allocation</h3>
                <button type="button" class="modal-close" onclick="closeModal('allocationModal')">✕</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 12px; color: var(--text-secondary);">
                    Review the items below. Adjust quantities if needed, then confirm to deduct from stock.
                </p>
                <div class="table-container">
                    <table class="table" id="allocation-modal-table">
                        <thead>
                            <tr>
                                <th>SKU</th>
                                <th>Name</th>
                                <th style="width:90px;">Qty</th>
                                <th>In Stock</th>
                                <th>After Allocation</th>
                            </tr>
                        </thead>
                        <tbody id="allocation-modal-body">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
                <div id="allocation-warnings" style="margin-top:12px;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('allocationModal')">Cancel</button>
                <button type="button" class="btn btn-success" id="confirm-allocation-btn" onclick="confirmAllocation()">
                    <i class="bi bi-check-lg"></i> Confirm Allocation
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for PNX Generation Analysis -->
<div class="modal" id="pnxAnalysisModal">
    <div class="modal-overlay" onclick="closePNXAnalysisModal()"></div>
    <div class="modal-dialog modal-dialog-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h3>PNX Generation Analysis</h3>
                <button type="button" class="modal-close" onclick="closePNXAnalysisModal()">✕</button>
            </div>
            <div class="modal-body">
                <div id="pnx-analysis-content">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closePNXAnalysisModal()">Cancel</button>
                <button type="button" class="btn btn-success" id="confirm-pnx-btn" onclick="confirmPNXGeneration()">Proceed with Generation</button>
            </div>
        </div>
    </div>
</div>

<script>
// Open Add PO Modal
function openAddPOModal() {
    document.getElementById('add-po-form').reset();
    openModal('addPOModal');
}

// Toggle Customer Edit Mode
function toggleCustomerEdit() {
    const display = document.getElementById('customer-display');
    const edit = document.getElementById('customer-edit');
    const btn = document.getElementById('edit-customer-btn');
    
    if (display.style.display === 'none') {
        display.style.display = 'flex';
        edit.style.display = 'none';
        btn.innerHTML = '<i class="bi bi-pencil"></i> Edit';
    } else {
        display.style.display = 'none';
        edit.style.display = 'flex';
        btn.innerHTML = '<i class="bi bi-x-lg"></i> Cancel';
    }
}

// Toggle Sale Edit Mode
function toggleSaleEdit() {
    const display = document.getElementById('sale-display');
    const edit = document.getElementById('sale-edit');
    const btn = document.getElementById('edit-sale-btn');
    
    if (display.style.display === 'none') {
        display.style.display = 'flex';
        edit.style.display = 'none';
        btn.innerHTML = '<i class="bi bi-pencil"></i> Edit';
    } else {
        display.style.display = 'none';
        edit.style.display = 'flex';
        btn.innerHTML = '<i class="bi bi-x-lg"></i> Cancel';
    }
}

// Save Customer Info
function saveCustomerInfo(orderId) {
    const data = {
        first_name: document.getElementById('first-name-input').value,
        last_name: document.getElementById('last-name-input').value,
        anthill_id: document.getElementById('anthill-id-input').value,
        address: document.getElementById('address-input').value,
        postcode: document.getElementById('postcode-input').value
    };
    
    fetch(`/order/${orderId}/update-customer/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            // Update display values
            document.getElementById('customer-name-display').textContent = `${data.first_name} ${data.last_name}`;
            document.getElementById('anthill-id-display').textContent = data.anthill_id || 'Not specified';
            document.getElementById('address-display').textContent = data.address || 'Not specified';
            document.getElementById('postcode-display').textContent = data.postcode || 'Not specified';
            
            // Toggle back to display mode
            toggleCustomerEdit();
            showAlert('Customer information updated successfully!', 'success');
        } else {
            showAlert('Error updating customer information', 'danger');
        }
    })
    .catch(error => {
        showAlert('Error updating customer information', 'danger');
    });
}

// Save Sale Info
function saveSaleInfo(orderId) {
    const designerSelect = document.getElementById('designer-input');
    const designerId = designerSelect.value;
    const designerName = designerSelect.options[designerSelect.selectedIndex].text;
    
    const data = {
        sale_number: document.getElementById('sale-number-input').value,
        customer_number: document.getElementById('customer-number-input').value,
        designer_id: designerId,
        workguru_id: document.getElementById('workguru-id-input').value,
        order_date: document.getElementById('order-date-input').value,
        fit_date: document.getElementById('fit-date-input').value,
        total_value_inc_vat: document.getElementById('total-value-input').value
    };
    
    fetch(`/order/${orderId}/update-sale/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            // Update display values
            document.getElementById('sale-number-display').textContent = data.sale_number;
            document.getElementById('customer-number-display').textContent = data.customer_number;
            document.getElementById('designer-display').textContent = designerId ? designerName : 'Not assigned';
            document.getElementById('workguru-id-display').textContent = data.workguru_id || 'Not set';
            
            // Format dates for display
            const orderDate = new Date(data.order_date);
            const fitDate = new Date(data.fit_date);
            document.getElementById('order-date-display').textContent = orderDate.toLocaleDateString('en-GB', {day: 'numeric', month: 'short', year: 'numeric'});
            document.getElementById('fit-date-display').textContent = fitDate.toLocaleDateString('en-GB', {day: 'numeric', month: 'short', year: 'numeric'});
            
            // Update total value displays
            const totalValue = parseFloat(data.total_value_inc_vat) || 0;
            document.getElementById('total-value-display').textContent = '£' + totalValue.toFixed(2);
            
            // Update financial summary displays
            document.getElementById('total_value_inc_vat_display').textContent = '£' + totalValue.toFixed(2);
            const excVat = totalValue / 1.2;
            document.getElementById('total_value_exc_vat_display').textContent = '£' + excVat.toFixed(2);
            
            // Toggle back to display mode
            toggleSaleEdit();
            showAlert('Sale information updated successfully!', 'success');
        } else {
            showAlert('Error updating sale information', 'danger');
        }
    })
    .catch(error => {
        showAlert('Error updating sale information', 'danger');
    });
}

// Designer inline management functions
function toggleAddDesignerInline() {
    const row = document.getElementById('new-designer-inline');
    if (row.style.display === 'none' || row.style.display === '') {
        row.style.display = 'flex';
        document.getElementById('new-designer-name-inline').focus();
    } else {
        row.style.display = 'none';
        document.getElementById('new-designer-name-inline').value = '';
    }
}

function cancelAddDesignerInline() {
    document.getElementById('new-designer-inline').style.display = 'none';
    document.getElementById('new-designer-name-inline').value = '';
}

function saveNewDesignerInline() {
    const designerName = document.getElementById('new-designer-name-inline').value.trim();
    
    if (!designerName) {
        showAlert('Please enter a designer name', 'warning');
        return;
    }
    
    fetch('/add-designer/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ name: designerName })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Add new option to designer dropdown and select it
            const designerSelect = document.getElementById('designer-input');
            const option = new Option(data.designer.name, data.designer.id, true, true);
            designerSelect.add(option);
            
            // Hide the input row
            document.getElementById('new-designer-inline').style.display = 'none';
            document.getElementById('new-designer-name-inline').value = '';
            
            showAlert('Designer added successfully!', 'success');
        } else {
            showAlert('Error: ' + (data.error || 'Failed to add designer'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error adding designer', 'danger');
    });
}

// Update Order Type
function updateOrderType(selectElement, orderId) {
    const orderType = selectElement.value;
    fetch(`/order/${orderId}/update-order-type/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({order_type: orderType})
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showAlert('Order type updated successfully!', 'success');
            // Update select styling based on type
            selectElement.style.borderColor = orderType === 'sale' ? '#10b981' : orderType === 'remedial' ? '#f59e0b' : '#ef4444';
            selectElement.style.color = 'white';
            selectElement.style.background = orderType === 'sale' ? '#10b981' : orderType === 'remedial' ? '#f59e0b' : '#ef4444';
        } else {
            showAlert('Error updating order type', 'danger');
        }
    })
    .catch(error => {
        showAlert('Error updating order type', 'danger');
    });
}

// ─── Boards PO search-based combo ─────────────────────────────────────────
let _boardsPOSearchTimer = null;

function searchBoardsPO(query) {
    clearTimeout(_boardsPOSearchTimer);
    const resultsDiv = document.getElementById('boards-po-results');

    if (query.length < 2) {
        resultsDiv.style.display = 'none';
        return;
    }

    _boardsPOSearchTimer = setTimeout(() => {
        fetch(`{% url 'purchase_order_search' %}?q=${encodeURIComponent(query)}`)
            .then(r => r.json())
            .then(data => {
                resultsDiv.innerHTML = '';
                if (data.results.length === 0) {
                    resultsDiv.innerHTML = '<div class="boards-po-result-item boards-po-empty">No purchase orders found</div>';
                    resultsDiv.style.display = 'block';
                    return;
                }
                data.results.forEach(po => {
                    const item = document.createElement('div');
                    item.className = 'boards-po-result-item';
                    item.innerHTML = `
                        <span class="boards-po-result-number">${po.display_number}</span>
                        <span class="boards-po-result-meta">${po.supplier_name}${po.project_number ? ' · ' + po.project_number : ''}</span>
                        <span class="boards-po-result-status badge-${(po.status || 'draft').toLowerCase()}">${po.status}</span>
                    `;
                    item.addEventListener('click', () => selectBoardsPO({{ order.id }}, po));
                    resultsDiv.appendChild(item);
                });
                resultsDiv.style.display = 'block';
            })
            .catch(() => {
                resultsDiv.style.display = 'none';
            });
    }, 250);
}

function selectBoardsPO(orderId, po) {
    const input = document.getElementById('boards-po-search');
    const resultsDiv = document.getElementById('boards-po-results');
    input.value = po.display_number;
    resultsDiv.style.display = 'none';

    fetch(`/order/${orderId}/update-boards-po/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ purchase_order_id: po.id })
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            showAlert(`Boards PO set to ${po.display_number}`, 'success');
            location.reload();
        } else {
            showAlert('Error: ' + (result.error || 'Unknown'), 'danger');
        }
    })
    .catch(err => showAlert('Error updating Boards PO', 'danger'));
}

function clearBoardsPOLink(orderId) {
    if (!confirm('Remove the Boards PO link from this order?')) return;
    fetch(`/order/${orderId}/update-boards-po/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({})
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            showAlert('Boards PO link removed', 'success');
            location.reload();
        } else {
            showAlert('Error: ' + (result.error || 'Unknown'), 'danger');
        }
    })
    .catch(err => showAlert('Error updating Boards PO', 'danger'));
}

// Close results dropdown when clicking outside
document.addEventListener('click', function(e) {
    const combo = document.querySelector('.boards-po-combo');
    const results = document.getElementById('boards-po-results');
    if (combo && results && !combo.contains(e.target)) {
        results.style.display = 'none';
    }
});

// Update Job Checkbox
function updateJobCheckbox(orderId, field, value) {
    const data = {};
    data[field] = value;
    
    fetch(`/order/${orderId}/update-job-checkbox/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            const fieldName = field.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            showAlert(`${fieldName} updated successfully!`, 'success');
        } else {
            const fieldName = field.replace(/_/g, ' ');
            showAlert(`Error updating ${fieldName}`, 'danger');
        }
    })
    .catch(error => {
        const fieldName = field.replace(/_/g, ' ');
        showAlert(`Error updating ${fieldName}`, 'danger');
    });
}

// Update Boards Ordered Checkbox
function updateBoardsOrdered(boardsPoId, value) {
    fetch(`/stock-take/boards-po/${boardsPoId}/update-boards-ordered/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ boards_ordered: value })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showAlert('Boards Ordered updated successfully!', 'success');
        } else {
            showAlert('Error updating Boards Ordered', 'danger');
        }
    })
    .catch(error => {
        showAlert('Error updating Boards Ordered', 'danger');
    });
}

// Auto-dismiss alerts after 5 seconds
document.addEventListener('DOMContentLoaded', function() {
    // Calculate profit on page load
    calculateProfit();
    
    setTimeout(function() {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(function(alert) {
            alert.style.opacity = '0';
            alert.style.transition = 'opacity 0.3s ease';
            setTimeout(() => alert.remove(), 300);
        });
    }, 5000); // 5 seconds

    // Track PNX dimension changes per boards PO
    // Key: boardsPoId, Value: { changeKey: { pnxId, field, value } }
    let pnxDimensionChangesByPO = {};

    function showSaveBtn(boardsPoId) {
        const btn = document.querySelector(`.save-pnx-btn[data-boards-po-id="${boardsPoId}"]`);
        if (btn) btn.style.display = 'inline-block';
    }

    function hideSaveBtnIfEmpty(boardsPoId) {
        const changes = pnxDimensionChangesByPO[boardsPoId] || {};
        if (Object.keys(changes).length === 0) {
            const btn = document.querySelector(`.save-pnx-btn[data-boards-po-id="${boardsPoId}"]`);
            if (btn) btn.style.display = 'none';
        }
    }

    // Handle PNX dimension/count input changes - track changes
    document.querySelectorAll('.pnx-dimension-input').forEach(function(input) {
        input.addEventListener('input', function() {
            const pnxId = this.getAttribute('data-pnx-id');
            const field = this.getAttribute('data-field');
            const boardsPoId = this.getAttribute('data-boards-po-id');
            const value = parseFloat(this.value) || 0;
            const originalValue = parseFloat(this.getAttribute('data-original-value')) || 0;
            const key = `${pnxId}_${field}`;
            
            if (!pnxDimensionChangesByPO[boardsPoId]) pnxDimensionChangesByPO[boardsPoId] = {};
            
            if (value !== originalValue) {
                pnxDimensionChangesByPO[boardsPoId][key] = { pnxId: pnxId, field: field, value: value };
                showSaveBtn(boardsPoId);
            } else {
                delete pnxDimensionChangesByPO[boardsPoId][key];
                hideSaveBtnIfEmpty(boardsPoId);
            }
        });
    });

    // Handle PNX text input changes (barcode, material name)
    document.querySelectorAll('.pnx-text-input').forEach(function(input) {
        input.addEventListener('input', function() {
            const pnxId = this.getAttribute('data-pnx-id');
            const field = this.getAttribute('data-field');
            const boardsPoId = this.getAttribute('data-boards-po-id');
            const value = this.value.trim();
            const originalValue = this.getAttribute('data-original-value');
            const key = `${pnxId}_${field}`;
            
            if (!pnxDimensionChangesByPO[boardsPoId]) pnxDimensionChangesByPO[boardsPoId] = {};
            
            if (value !== originalValue) {
                pnxDimensionChangesByPO[boardsPoId][key] = { pnxId: pnxId, field: field, value: value };
                showSaveBtn(boardsPoId);
            } else {
                delete pnxDimensionChangesByPO[boardsPoId][key];
                hideSaveBtnIfEmpty(boardsPoId);
            }
        });
    });

    // Handle "Save Changes" button click per PO
    document.querySelectorAll('.save-pnx-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const boardsPoId = this.getAttribute('data-boards-po-id');
            const changes = pnxDimensionChangesByPO[boardsPoId] || {};
            
            if (Object.keys(changes).length === 0) {
                showAlert('No changes to save', 'warning');
                return;
            }
            
            const changesArray = Object.values(changes);
            const saveBtn = this;
            
            fetch('/stock-take/update-pnx-dimensions/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ 
                    changes: changesArray,
                    boards_po_id: parseInt(boardsPoId)
                })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showAlert('PNX items updated and files regenerated!', 'success');
                    // Update original values for inputs in this PO section only
                    document.querySelectorAll(`.pnx-dimension-input[data-boards-po-id="${boardsPoId}"], .pnx-text-input[data-boards-po-id="${boardsPoId}"]`).forEach(function(input) {
                        input.setAttribute('data-original-value', input.value);
                    });
                    pnxDimensionChangesByPO[boardsPoId] = {};
                    saveBtn.style.display = 'none';
                } else {
                    showAlert('Error updating PNX items: ' + result.error, 'danger');
                }
            })
            .catch(error => {
                showAlert('Error updating PNX items', 'danger');
            });
        });
    });

    // Handle PNX edging checkbox changes - track and show update button
    document.querySelectorAll('.pnx-edging-checkbox').forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            const pnxId = this.getAttribute('data-pnx-id');
            const field = this.getAttribute('data-field');
            const boardsPoId = this.getAttribute('data-boards-po-id');
            const value = this.checked ? 'Sliderobe_Edge_08' : '';
            const key = `${pnxId}_${field}`;
            
            if (!pnxDimensionChangesByPO[boardsPoId]) pnxDimensionChangesByPO[boardsPoId] = {};
            pnxDimensionChangesByPO[boardsPoId][key] = { pnxId: pnxId, field: field, value: value };
            showSaveBtn(boardsPoId);
        });
    });

    // Handle PNX received quantity changes (just track changes, don't save)
    // Track Accessory quantity changes
    let accessoryChanges = {};
    
    document.querySelectorAll('.accessory-quantity').forEach(function(input) {
        input.addEventListener('input', function() {
            const accessoryId = this.getAttribute('data-accessory-id');
            const quantity = parseFloat(this.value) || 0;
            const originalQuantity = parseFloat(this.getAttribute('data-original-quantity')) || 0;
            
            if (quantity !== originalQuantity) {
                accessoryChanges[accessoryId] = quantity;
                // Show save button
                const saveAccessoryBtn = document.getElementById('save-accessory-changes');
                if (saveAccessoryBtn) saveAccessoryBtn.style.display = 'inline-block';
            } else {
                delete accessoryChanges[accessoryId];
                // Hide save button if no changes
                if (Object.keys(accessoryChanges).length === 0) {
                    const saveAccessoryBtn = document.getElementById('save-accessory-changes');
                    if (saveAccessoryBtn) saveAccessoryBtn.style.display = 'none';
                }
            }
        });
    });

    // Handle save accessory changes button click
    const saveAccessoryBtn = document.getElementById('save-accessory-changes');
    if (saveAccessoryBtn) {
        saveAccessoryBtn.addEventListener('click', function() {
            if (Object.keys(accessoryChanges).length === 0) {
                showAlert('No changes to save.', 'info');
                return;
            }

            this.disabled = true;
            this.innerHTML = '<i class=\"bi bi-hourglass\"></i> Saving...';

            fetch('/stock-take/update-accessory-quantities/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ changes: accessoryChanges })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Accessory quantities updated successfully!', 'success');
                    accessoryChanges = {};
                    this.style.display = 'none';
                    // Update original quantities
                    document.querySelectorAll('.accessory-quantity').forEach(function(input) {
                        input.setAttribute('data-original-quantity', input.value);
                    });
                    // Regenerate CSV automatically
                    if (data.csv_regenerated) {
                        showAlert('Processed CSV regenerated with new quantities.', 'info');
                        setTimeout(() => location.reload(), 1500);
                    }
                } else {
                    showAlert('Error saving quantities: ' + data.error, 'danger');
                    this.disabled = false;
                    this.innerHTML = '<i class=\"bi bi-save\"></i> Save Changes';
                }
            })
            .catch(error => {
                showAlert('Error saving quantities', 'danger');
                this.disabled = false;
                this.innerHTML = '<i class=\"bi bi-save\"></i> Save Changes';
            });
        });
    }

    // ─── Accessories select / bulk delete / allocate ─────────────────────────
    const accessorySelectAll = document.getElementById('accessory-select-all');
    const deleteAccessoriesBtn = document.getElementById('delete-accessories-selected');
    const accessoryCountSpan = document.getElementById('accessory-selected-count');
    const accAddToPOBtn = document.getElementById('acc-add-to-po');
    const accCreatePOBtn = document.getElementById('acc-create-po');

    function updateAccessoryActionButtons() {
        const checked = document.querySelectorAll('.accessory-select:checked');
        const count = checked.length;
        if (accessoryCountSpan) accessoryCountSpan.textContent = count;
        [deleteAccessoriesBtn, accAddToPOBtn, accCreatePOBtn].forEach(btn => {
            if (btn) {
                if (count > 0) btn.classList.remove('hidden');
                else btn.classList.add('hidden');
            }
        });
    }

    if (accessorySelectAll) {
        accessorySelectAll.addEventListener('change', function() {
            document.querySelectorAll('.accessory-select').forEach(cb => cb.checked = this.checked);
            updateAccessoryActionButtons();
        });
    }

    document.querySelectorAll('.accessory-select').forEach(function(cb) {
        cb.addEventListener('change', updateAccessoryActionButtons);
    });

    if (deleteAccessoriesBtn) {
        deleteAccessoriesBtn.addEventListener('click', function() {
            const checked = document.querySelectorAll('.accessory-select:checked');
            const ids = Array.from(checked).map(cb => cb.getAttribute('data-accessory-id'));
            if (ids.length === 0) return;
            if (!confirm(`Delete ${ids.length} accessory item(s)? This cannot be undone.`)) return;

            this.disabled = true;
            this.innerHTML = '<i class="bi bi-hourglass-split"></i> Deleting...';

            fetch('/stock-take/delete-accessories-batch/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ ids: ids })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert(`${data.deleted} accessory item(s) deleted.`, 'success');
                    location.reload();
                } else {
                    showAlert('Error deleting items: ' + data.error, 'danger');
                    this.disabled = false;
                    this.innerHTML = '<i class="bi bi-trash"></i> <span id="accessory-selected-count">' + ids.length + '</span>';
                }
            })
            .catch(error => {
                showAlert('Error deleting items.', 'danger');
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-trash"></i> <span id="accessory-selected-count">0</span>';
            });
        });
    }

    // ─── Glass select / bulk delete ──────────────────────────────────────────
    const glassSelectAll = document.getElementById('glass-select-all');
    const deleteGlassBtn = document.getElementById('delete-glass-selected');
    const glassCountSpan = document.getElementById('glass-selected-count');
    const glassAddToPOBtn = document.getElementById('glass-add-to-po');
    const glassCreatePOBtn = document.getElementById('glass-create-po');

    function updateGlassActionButtons() {
        const checked = document.querySelectorAll('.glass-select:checked');
        const count = checked.length;
        if (glassCountSpan) glassCountSpan.textContent = count;
        [deleteGlassBtn, glassAddToPOBtn, glassCreatePOBtn].forEach(btn => {
            if (btn) {
                if (count > 0) btn.classList.remove('hidden');
                else btn.classList.add('hidden');
            }
        });
    }

    if (glassSelectAll) {
        glassSelectAll.addEventListener('change', function() {
            document.querySelectorAll('.glass-select').forEach(cb => cb.checked = this.checked);
            updateGlassActionButtons();
        });
    }

    document.querySelectorAll('.glass-select').forEach(function(cb) {
        cb.addEventListener('change', updateGlassActionButtons);
    });

    if (deleteGlassBtn) {
        deleteGlassBtn.addEventListener('click', function() {
            const checked = document.querySelectorAll('.glass-select:checked');
            const ids = Array.from(checked).map(cb => cb.getAttribute('data-accessory-id'));
            if (ids.length === 0) return;
            if (!confirm(`Delete ${ids.length} glass item(s)? This cannot be undone.`)) return;

            this.disabled = true;
            this.innerHTML = '<i class="bi bi-hourglass-split"></i>';

            fetch('/stock-take/delete-accessories-batch/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ ids: ids })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert(`${data.deleted} glass item(s) deleted.`, 'success');
                    location.reload();
                } else {
                    showAlert('Error deleting items: ' + data.error, 'danger');
                    this.disabled = false;
                    this.innerHTML = '<i class="bi bi-trash"></i> <span id="glass-selected-count">' + ids.length + '</span>';
                }
            })
            .catch(error => {
                showAlert('Error deleting items.', 'danger');
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-trash"></i> <span id="glass-selected-count">0</span>';
            });
        });
    }

    // ─── Raumplus select / bulk delete ─────────────────────────────────────
    const rauplusSelectAll = document.getElementById('raumplus-select-all');
    const deleteRauplusBtn = document.getElementById('delete-raumplus-selected');
    const rauplusCountSpan = document.getElementById('raumplus-selected-count');
    const rauplusAddToPOBtn = document.getElementById('raumplus-add-to-po');
    const rauplusCreatePOBtn = document.getElementById('raumplus-create-po');

    function updateRauplusActionButtons() {
        const checked = document.querySelectorAll('.raumplus-select:checked');
        const count = checked.length;
        if (rauplusCountSpan) rauplusCountSpan.textContent = count;
        [deleteRauplusBtn, rauplusAddToPOBtn, rauplusCreatePOBtn].forEach(btn => {
            if (btn) {
                if (count > 0) btn.classList.remove('hidden');
                else btn.classList.add('hidden');
            }
        });
    }

    if (rauplusSelectAll) {
        rauplusSelectAll.addEventListener('change', function() {
            document.querySelectorAll('.raumplus-select').forEach(cb => cb.checked = this.checked);
            updateRauplusActionButtons();
        });
    }

    document.querySelectorAll('.raumplus-select').forEach(function(cb) {
        cb.addEventListener('change', updateRauplusActionButtons);
    });

    if (deleteRauplusBtn) {
        deleteRauplusBtn.addEventListener('click', function() {
            const checked = document.querySelectorAll('.raumplus-select:checked');
            const ids = Array.from(checked).map(cb => cb.getAttribute('data-accessory-id'));
            if (ids.length === 0) return;
            if (!confirm(`Delete ${ids.length} Raumplus item(s)? This cannot be undone.`)) return;

            this.disabled = true;
            this.innerHTML = '<i class="bi bi-hourglass-split"></i>';

            fetch('/stock-take/delete-accessories-batch/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ ids: ids })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert(`${data.deleted} Raumplus item(s) deleted.`, 'success');
                    location.reload();
                } else {
                    showAlert('Error deleting items: ' + data.error, 'danger');
                    this.disabled = false;
                    this.innerHTML = '<i class="bi bi-trash"></i> <span id="raumplus-selected-count">' + ids.length + '</span>';
                }
            })
            .catch(error => {
                showAlert('Error deleting items.', 'danger');
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-trash"></i> <span id="raumplus-selected-count">0</span>';
            });
        });
    }

    // ─── PO actions (Add to PO / Create PO) ─────────────────────────────────
    // Exposed on window so inline onclick handlers can access them
    let poModalType = null;

    window.openAddToPOModal = function(type) {
        poModalType = type;
        let selector;
        if (type === 'glass') selector = '.glass-select:checked';
        else if (type === 'raumplus') selector = '.raumplus-select:checked';
        else selector = '.accessory-select:checked';
        const count = document.querySelectorAll(selector).length;
        const label = document.getElementById('po-modal-item-count');
        if (label) label.textContent = `${count} ${type} item(s) selected`;
        openModal('addToPOModal');
    }

    window.submitAddToPO = function() {
        const poId = document.getElementById('po-select').value;
        if (!poId) {
            showAlert('Please select a Purchase Order.', 'warning');
            return;
        }
        sendItemsToPO(poModalType, poId);
    }

    window.createPOFromSelected = function(type) {
        if (!confirm(`Create a new Purchase Order from the selected ${type} items?`)) return;
        sendItemsToPO(type, null);
    }

    function sendItemsToPO(type, poId) {
        let selector;
        if (type === 'glass') selector = '.glass-select:checked';
        else if (type === 'raumplus') selector = '.raumplus-select:checked';
        else selector = '.accessory-select:checked';
        const checked = document.querySelectorAll(selector);
        const ids = Array.from(checked).map(cb => cb.getAttribute('data-accessory-id'));
        if (ids.length === 0) return;

        const payload = { accessory_ids: ids };
        if (poId) payload.po_id = poId;

        const btn = poId ? document.getElementById('confirm-add-to-po') : null;
        if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Adding...';
        }

        fetch('/stock-take/add-accessories-to-po/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(payload)
        })
        .then(response => {
            if (!response.ok) throw new Error(`Server error ${response.status}`);
            return response.json();
        })
        .then(data => {
            if (data.success) {
                closeModal('addToPOModal');
                showAlert(`${data.added} item(s) added to PO ${data.po_number}.`, 'success');
                // Optionally redirect to PO
                if (data.po_id) {
                    setTimeout(() => {
                        window.location.href = `/purchase-order/${data.po_id}/`;
                    }, 1500);
                }
            } else {
                showAlert('Error: ' + (data.error || 'Unknown error'), 'danger');
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-cart-plus"></i> Add to PO';
                }
            }
        })
        .catch(error => {
            showAlert('Error adding items to PO: ' + error.message, 'danger');
            console.error('PO error:', error);
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-cart-plus"></i> Add to PO';
            }
        });
    }

    // ─── Toggle materials allocation (Job Info checkbox) ────────────────────
    function toggleMaterialsAllocated(orderId, allocate, checkbox) {
        if (!allocate) {
            // Unallocate – simple confirm
            const msg = 'Unallocate all materials?\n\nThis will add quantities back to stock.';
            if (!confirm(msg)) {
                checkbox.checked = true;
                return;
            }
            doAllocation(orderId, false, {}, checkbox);
            return;
        }

        // Allocate – show modal with editable quantities
        const tbody = document.getElementById('allocation-modal-body');
        const warnings = document.getElementById('allocation-warnings');
        tbody.innerHTML = '';
        warnings.innerHTML = '';

        // Gather unallocated accessories from the page
        const rows = document.querySelectorAll('#accessories-table tbody tr[data-accessory-id], #glass-table tbody tr[data-accessory-id]');
        let hasItems = false;

        rows.forEach(row => {
            const allocated = row.classList.contains('allocated-row');
            if (allocated) return; // skip already-allocated rows

            const accId = row.getAttribute('data-accessory-id');
            const sku = row.querySelector('td:nth-child(2)').textContent.trim();
            const name = row.querySelector('td:nth-child(3)').textContent.trim();
            const qtyInput = row.querySelector('.accessory-quantity');
            const qty = qtyInput ? parseInt(qtyInput.value) || 0 : 0;

            // Parse stock info from stacked .accessory-price-info div
            const priceInfo = row.querySelector('.accessory-price-info');
            let stockQty = '-';
            let afterAlloc = '-';
            let isLow = false;

            if (priceInfo) {
                const stockDiv = priceInfo.querySelector('div:first-child');
                if (stockDiv) {
                    const match = stockDiv.textContent.match(/Stock:\s*(-?\d+)/);
                    if (match) {
                        stockQty = parseInt(match[1]);
                        afterAlloc = stockQty - qty;
                        isLow = afterAlloc < 0;
                    }
                }
            }

            const tr = document.createElement('tr');
            if (isLow) tr.style.background = 'rgba(220, 53, 69, 0.08)';
            tr.innerHTML = `
                <td><code>${sku}</code></td>
                <td>${name}</td>
                <td><input type="number" class="quantity-input alloc-modal-qty" data-acc-id="${accId}" value="${qty}" min="0" step="1" style="width:80px;" oninput="updateAllocPreview()"></td>
                <td>${stockQty}</td>
                <td class="alloc-after" data-stock="${typeof stockQty === 'number' ? stockQty : ''}"
                    style="${isLow ? 'color:#dc3545;font-weight:bold;' : 'color:#28a745;'}">${afterAlloc}</td>
            `;
            tbody.appendChild(tr);
            hasItems = true;
        });

        if (!hasItems) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center" style="padding:16px;color:var(--text-secondary);">No unallocated accessories found.</td></tr>';
            document.getElementById('confirm-allocation-btn').disabled = true;
        } else {
            document.getElementById('confirm-allocation-btn').disabled = false;
        }

        // Store the checkbox ref and order id for the confirm action
        window._allocOrderId = orderId;
        window._allocCheckbox = checkbox;
        openModal('allocationModal');
    }

    function updateAllocPreview() {
        document.querySelectorAll('#allocation-modal-body tr').forEach(row => {
            const qtyInput = row.querySelector('.alloc-modal-qty');
            const afterCell = row.querySelector('.alloc-after');
            if (!qtyInput || !afterCell) return;
            const stock = afterCell.getAttribute('data-stock');
            if (stock === '') { afterCell.textContent = '-'; return; }
            const newQty = parseInt(qtyInput.value) || 0;
            const remaining = parseInt(stock) - newQty;
            afterCell.textContent = remaining;
            afterCell.style.color = remaining < 0 ? '#dc3545' : '#28a745';
            afterCell.style.fontWeight = remaining < 0 ? 'bold' : 'normal';
            row.style.background = remaining < 0 ? 'rgba(220, 53, 69, 0.08)' : '';
        });

        // Show warning if any items go negative
        const negatives = document.querySelectorAll('#allocation-modal-body .alloc-after');
        let hasNeg = false;
        negatives.forEach(c => { if (parseInt(c.textContent) < 0) hasNeg = true; });
        const warnings = document.getElementById('allocation-warnings');
        if (hasNeg) {
            warnings.innerHTML = '<div style="padding:8px 12px;background:rgba(220,53,69,0.1);border:1px solid rgba(220,53,69,0.3);border-radius:6px;color:#dc3545;font-size:0.9rem;"><i class="bi bi-exclamation-triangle"></i> Some items will go below zero stock. You can still proceed.</div>';
        } else {
            warnings.innerHTML = '';
        }
    }

    function confirmAllocation() {
        const orderId = window._allocOrderId;
        const checkbox = window._allocCheckbox;

        // Collect quantity overrides
        const quantities = {};
        document.querySelectorAll('.alloc-modal-qty').forEach(input => {
            const accId = input.getAttribute('data-acc-id');
            quantities[accId] = parseInt(input.value) || 0;
        });

        const btn = document.getElementById('confirm-allocation-btn');
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Allocating...';

        doAllocation(orderId, true, quantities, checkbox);
    }

    function doAllocation(orderId, allocate, quantities, checkbox) {
        fetch('{% url "allocate_accessories" order.id %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ allocate: allocate, quantities: quantities })
        })
        .then(res => {
            if (!res.ok) console.error('Allocate response not OK:', res.status);
            return res.json();
        })
        .then(data => {
            if (data.success) {
                closeModal('allocationModal');
                const verb = allocate ? 'allocated' : 'unallocated';
                showAlert(`${data.count} item(s) ${verb}, ${data.stock_changes} stock change(s) made.`, 'success');
                location.reload();
            } else {
                showAlert('Error: ' + (data.error || 'Unknown error'), 'danger');
                checkbox.checked = !allocate;
                const btn = document.getElementById('confirm-allocation-btn');
                if (btn) { btn.disabled = false; btn.innerHTML = '<i class="bi bi-check-lg"></i> Confirm Allocation'; }
            }
        })
        .catch(err => {
            console.error('Allocate fetch error:', err);
            showAlert('Error: ' + err.message, 'danger');
            checkbox.checked = !allocate;
            const btn = document.getElementById('confirm-allocation-btn');
            if (btn) { btn.disabled = false; btn.innerHTML = '<i class="bi bi-check-lg"></i> Confirm Allocation'; }
        });
    }

    // Track OS Doors changes
    let osDoorsChanges = {};

    function recalcOsDoorTotal(row) {
        const costInput = row.querySelector('.os-door-cost-input');
        const qtyInput = row.querySelector('.os-door-qty-input');
        const costPrice = parseFloat(costInput.value) || 0;
        const quantity = parseInt(qtyInput.value) || 0;
        const totalCostCell = row.querySelector('.os-door-total-cost');
        totalCostCell.textContent = '£' + (costPrice * quantity).toFixed(2);
    }

    // Handle OS Doors cost price input changes
    document.querySelectorAll('.os-door-cost-input').forEach(function(input) {
        input.addEventListener('input', function() {
            const osDoorId = this.getAttribute('data-os-door-id');
            const costPrice = parseFloat(this.value) || 0;
            if (!osDoorsChanges[osDoorId]) osDoorsChanges[osDoorId] = {};
            osDoorsChanges[osDoorId].cost_price = costPrice;
            recalcOsDoorTotal(this.closest('tr'));
            const saveBtn = document.getElementById('save-os-doors-changes');
            if (saveBtn) saveBtn.style.display = '';
        });
    });

    // Handle OS Doors quantity input changes
    document.querySelectorAll('.os-door-qty-input').forEach(function(input) {
        input.addEventListener('input', function() {
            const osDoorId = this.getAttribute('data-os-door-id');
            const quantity = parseInt(this.value) || 0;
            if (!osDoorsChanges[osDoorId]) osDoorsChanges[osDoorId] = {};
            osDoorsChanges[osDoorId].quantity = quantity;
            recalcOsDoorTotal(this.closest('tr'));
            const saveBtn = document.getElementById('save-os-doors-changes');
            if (saveBtn) saveBtn.style.display = '';
        });
    });

    // Handle OS Doors received checkbox changes
    document.querySelectorAll('.os-door-received-checkbox').forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            const osDoorId = this.getAttribute('data-os-door-id');
            const row = this.closest('tr');
            const qtyInput = row.querySelector('.os-door-qty-input');
            const quantity = parseInt(qtyInput.value) || 0;
            if (!osDoorsChanges[osDoorId]) osDoorsChanges[osDoorId] = {};
            osDoorsChanges[osDoorId].received_quantity = this.checked ? quantity : 0;
            const saveBtn = document.getElementById('save-os-doors-changes');
            if (saveBtn) saveBtn.style.display = '';
        });
    });

    // ─── Select / bulk delete ─────────────────────────────────────
    const selectAllCheckbox = document.getElementById('os-door-select-all');
    const deleteBtn = document.getElementById('delete-os-doors-selected');
    const selectedCountSpan = document.getElementById('os-door-selected-count');

    function updateDeleteButton() {
        const checked = document.querySelectorAll('.os-door-select:checked');
        const count = checked.length;
        if (selectedCountSpan) selectedCountSpan.textContent = count;
        if (deleteBtn) {
            if (count > 0) {
                deleteBtn.classList.remove('hidden');
            } else {
                deleteBtn.classList.add('hidden');
            }
        }
    }

    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            document.querySelectorAll('.os-door-select').forEach(cb => cb.checked = this.checked);
            updateDeleteButton();
        });
    }

    document.querySelectorAll('.os-door-select').forEach(function(cb) {
        cb.addEventListener('change', updateDeleteButton);
    });

    if (deleteBtn) {
        deleteBtn.addEventListener('click', function() {
            const checked = document.querySelectorAll('.os-door-select:checked');
            const ids = Array.from(checked).map(cb => cb.getAttribute('data-os-door-id'));
            if (ids.length === 0) return;
            if (!confirm(`Delete ${ids.length} OS door item(s)? This cannot be undone.`)) return;

            this.disabled = true;
            this.innerHTML = '<i class="bi bi-hourglass"></i> Deleting...';

            fetch('/stock-take/delete-os-doors-batch/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ ids: ids })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert(`${data.deleted} OS door item(s) deleted.`, 'success');
                    location.reload();
                } else {
                    showAlert('Error deleting items: ' + data.error, 'danger');
                    this.disabled = false;
                    this.innerHTML = '<i class="bi bi-trash"></i> Delete Selected (<span id="os-door-selected-count">' + ids.length + '</span>)';
                }
            })
            .catch(error => {
                showAlert('Error deleting items.', 'danger');
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-trash"></i> Delete Selected';
            });
        });
    }

    // Handle save button click for OS Doors
    const saveOsDoorsBtn = document.getElementById('save-os-doors-changes');
    if (saveOsDoorsBtn) {
        saveOsDoorsBtn.addEventListener('click', function() {
            if (Object.keys(osDoorsChanges).length === 0) {
                showAlert('No changes to save.', 'info');
                return;
            }

            // Disable button during save
            this.disabled = true;
            this.innerHTML = '<i class="bi bi-hourglass"></i> Saving...';

            // Send all changes in one request
            fetch('/stock-take/update-os-doors-batch/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ changes: osDoorsChanges })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('OS Doors changes saved successfully!', 'success');
                    osDoorsChanges = {}; // Clear changes
                    location.reload(); // Reload to show updated status
                } else {
                    showAlert('Error saving OS Doors changes: ' + data.error, 'danger');
                    // Re-enable button
                    this.disabled = false;
                    this.innerHTML = '<i class="bi bi-save"></i> Save OS Doors Changes';
                }
            })
            .catch(error => {
                showAlert('Error saving OS Doors changes', 'danger');
                // Re-enable button
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-save"></i> Save OS Doors Changes';
            });
        });
    }

    // Add loading state to the regular Add OS Door form submit
    const addOsDoorBtn = document.getElementById('add-os-door-submit');
    if (addOsDoorBtn) {
        addOsDoorBtn.closest('form').addEventListener('submit', function() {
            addOsDoorBtn.disabled = true;
            addOsDoorBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Adding...';
        });
    }
});

// Alert functions (global scope so they can be used by all functions)
function showAlert(message, type) {
    let container = document.getElementById('toastContainer');
    if (!container) {
        container = document.createElement('div');
        container.className = 'toast-container';
        container.id = 'toastContainer';
        document.body.appendChild(container);
    }
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <span class="toast-text">${message}</span>
        <button type="button" class="toast-close" onclick="dismissToast(this.parentElement)">&times;</button>
    `;
    container.appendChild(toast);
    requestAnimationFrame(() => toast.classList.add('toast-visible'));
    setTimeout(() => dismissToast(toast), 4000);
}

function dismissToast(el) {
    if (!el) return;
    el.classList.add('toast-hiding');
    setTimeout(() => el.remove(), 300);
}

// Toggle collapse function for forms (global scope)
function toggleCollapse(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
        if (element.style.display === 'none' || element.style.display === '') {
            element.style.display = 'block';
        } else {
            element.style.display = 'none';
        }
    }
}

// ─── OS Door paste-to-parse ───────────────────────────────────────

function getKnownStyles() {
    const input = document.getElementById('osd-rules-styles');
    if (input) return input.value.split(',').map(s => s.trim()).filter(s => s);
    return ['Morris', 'Lanark'];
}

function getKnownColours() {
    const input = document.getElementById('osd-rules-colours');
    if (input) return input.value.split(',').map(s => s.trim()).filter(s => s);
    return ['Superior Matt Light Grey', 'Superior Matt White', 'Superior Matt Cashmere'];
}

function parseOSDoorPaste() {
    const raw = document.getElementById('osd-paste-input').value.trim();
    if (!raw) {
        showAlert('Paste some data first.', 'warning');
        return;
    }

    // Split by tab characters, keep empty entries to preserve column positions
    const rawCols = raw.split('\t').map(c => c.trim());
    // Strip leading empty columns
    const cols = rawCols.slice(rawCols.findIndex(c => c.length > 0));

    let doorStyle = '';
    let styleColour = '';
    let itemDescription = '';
    let colour = '';
    let height = 0;
    let width = 0;
    let costPrice = 0;
    let quantity = 1;
    let totalPrice = 0;

    const knownStyles = getKnownStyles();
    const knownColours = getKnownColours();

    // ── Strategy: tab-separated columns ──
    // Expected layout after stripping leading empties:
    //   [0] Door Style        e.g. "Morris"
    //   [1] Style Colour      e.g. "Superior Matt Light Grey Superior Matt Light Grey"
    //   [2] Item Description  e.g. "Morris Superior Matt Light Grey Drawer 210 x 960 (MTM)"
    //   [3] Colour            e.g. "Light Grey Light Grey"
    //   [4] Handing           e.g. "H"  (ignored)
    //   [5] Unit Price        e.g. "£18.29"
    //   [6] Quantity          e.g. "2"
    //   [7] Total Price       e.g. "£36.58"

    if (cols.length >= 4) {
        // Column 0 → Door Style
        doorStyle = cols[0];

        // Column 1 → Style Colour (may be duplicated)
        styleColour = deduplicateColour(cols[1]);

        // Column 2 → Item Description
        itemDescription = cols[2];

        // Column 3 → Colour (may be duplicated)
        colour = deduplicateColour(cols[3]);

        // Extract dimensions from description
        const dims = extractDimensions(itemDescription);
        height = dims.height;
        width = dims.width;

        // Scan remaining columns for price, quantity, total
        // Strategy: find £ values and pure numbers
        let pricesFound = [];
        let numbersFound = [];

        for (let i = 4; i < cols.length; i++) {
            const val = cols[i];
            // Skip handing indicators (single letter)
            if (/^[A-Z]$/.test(val)) continue;
            // Skip X buttons, empty strings
            if (val === 'X' || val === '') continue;

            const price = extractPrice(val);
            if (price > 0) {
                pricesFound.push({ index: i, value: price });
            } else if (/^\d+$/.test(val)) {
                numbersFound.push({ index: i, value: parseInt(val) });
            }
        }

        // Assign: first price = unit cost, pure number = quantity, second price = total
        if (pricesFound.length >= 1) costPrice = pricesFound[0].value;
        if (numbersFound.length >= 1) quantity = numbersFound[0].value;
        if (pricesFound.length >= 2) {
            totalPrice = pricesFound[pricesFound.length - 1].value;
        } else {
            totalPrice = costPrice * quantity;
        }
    } else {
        // Fallback: try to parse the whole string
        for (const style of knownStyles) {
            if (raw.includes(style)) {
                doorStyle = style;
                break;
            }
        }

        for (const c of knownColours) {
            if (raw.includes(c)) {
                styleColour = c;
                const parts = c.split(' ');
                colour = parts.slice(-2).join(' ');
                break;
            }
        }

        const dims = extractDimensions(raw);
        height = dims.height;
        width = dims.width;
        costPrice = extractPrice(raw);
        totalPrice = costPrice;
        itemDescription = raw;
    }

    // Populate the parsed form
    document.getElementById('osd-parsed-door-style').value = doorStyle;
    document.getElementById('osd-parsed-style-colour').value = styleColour;
    document.getElementById('osd-parsed-description').value = itemDescription;
    document.getElementById('osd-parsed-height').value = height || '';
    document.getElementById('osd-parsed-width').value = width || '';
    document.getElementById('osd-parsed-colour').value = colour;
    document.getElementById('osd-parsed-quantity').value = quantity;
    document.getElementById('osd-parsed-cost-price').value = costPrice || '';
    document.getElementById('osd-parsed-total-price').value = totalPrice ? totalPrice.toFixed(2) : '';

    // Recalculate total when qty or cost changes
    updateParsedTotal();

    // Show result and enable submit
    document.getElementById('osd-parse-result').classList.remove('hidden');
    document.getElementById('osd-parsed-submit').disabled = false;
}

// Live total recalculation
function updateParsedTotal() {
    const qty = parseFloat(document.getElementById('osd-parsed-quantity').value) || 0;
    const cost = parseFloat(document.getElementById('osd-parsed-cost-price').value) || 0;
    document.getElementById('osd-parsed-total-price').value = (qty * cost).toFixed(2);
}

// Attach live recalc listeners after DOM load
document.addEventListener('DOMContentLoaded', function() {
    const qtyInput = document.getElementById('osd-parsed-quantity');
    const costInput = document.getElementById('osd-parsed-cost-price');
    if (qtyInput) qtyInput.addEventListener('input', updateParsedTotal);
    if (costInput) costInput.addEventListener('input', updateParsedTotal);
});

function deduplicateColour(str) {
    // "Superior Matt Light Grey Superior Matt Light Grey" → "Superior Matt Light Grey"
    // "Light Grey Light Grey" → "Light Grey"
    if (!str) return '';
    const half = Math.floor(str.length / 2);
    const first = str.substring(0, half).trim();
    const second = str.substring(half).trim();
    if (first === second) return first;

    // Also try word-based dedup
    const words = str.split(/\s+/);
    if (words.length % 2 === 0) {
        const mid = words.length / 2;
        const firstHalf = words.slice(0, mid).join(' ');
        const secondHalf = words.slice(mid).join(' ');
        if (firstHalf === secondHalf) return firstHalf;
    }
    return str;
}

function extractDimensions(str) {
    // Match patterns like "210 x 960", "210x960", "210 X 960"
    const match = str.match(/(\d+)\s*[xX×]\s*(\d+)/);
    if (match) {
        return { height: parseInt(match[1]), width: parseInt(match[2]) };
    }
    return { height: 0, width: 0 };
}

function extractPrice(str) {
    // Match £12.34 or 12.34
    const match = str.match(/£?([\d]+\.[\d]{2})/);
    if (match) return parseFloat(match[1]);
    return 0;
}

function submitParsedOSDoor() {
    const form = document.getElementById('osd-parsed-form');
    const formData = new FormData(form);
    const btn = document.getElementById('osd-parsed-submit');

    // Validate required fields
    const requiredFields = ['door_style', 'style_colour', 'item_description', 'height', 'width', 'colour', 'quantity'];
    for (const field of requiredFields) {
        if (!formData.get(field)) {
            showAlert(`Please fill in the ${field.replace('_', ' ')} field.`, 'warning');
            return;
        }
    }

    // Show loading state
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Adding...';

    // Submit via fetch to the same add-door endpoint
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch(window.location.href, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken
        },
        body: formData
    })
    .then(response => {
        if (response.redirected) {
            window.location.href = response.url;
        } else {
            return response.text().then(html => {
                location.reload();
            });
        }
    })
    .catch(error => {
        showAlert('Error adding OS Door: ' + error, 'danger');
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-plus-lg"></i> Add OS Door';
    });
}

// Track which boards PO is currently being acted on
let activeBoardsPoId = null;

// Modal functions (defined outside DOMContentLoaded so onclick handlers can access them)
function openModal(modalId, boardsPoId) {
    if (boardsPoId) {
        activeBoardsPoId = boardsPoId;
    }
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.add('active');
        document.body.classList.add('modal-open');
    }
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('active');
        modal.classList.remove('show');
        document.body.classList.remove('modal-open');
    }
}

// Add Board Item functionality
function addBoardItem() {
    const barcode = document.getElementById('add-board-barcode').value.trim();
    const matname = document.getElementById('add-board-matname').value.trim();
    const cleng = parseFloat(document.getElementById('add-board-length').value) || 0;
    const cwidth = parseFloat(document.getElementById('add-board-width').value) || 0;
    const cnt = parseInt(document.getElementById('add-board-count').value) || 1;
    const grain = document.getElementById('add-board-grain').value;
    const partdesc = document.getElementById('add-board-partdesc').value.trim();
    
    // Get edging checkboxes
    const prfid1 = document.getElementById('add-board-prfid1').checked ? 'Sliderobe_Edge_08' : '';
    const prfid3 = document.getElementById('add-board-prfid3').checked ? 'Sliderobe_Edge_08' : '';
    const prfid4 = document.getElementById('add-board-prfid4').checked ? 'Sliderobe_Edge_08' : '';
    const prfid2 = document.getElementById('add-board-prfid2').checked ? 'Sliderobe_Edge_08' : '';
    
    // Validation
    if (!barcode) {
        showAlert('Barcode is required', 'danger');
        return;
    }
    if (!matname) {
        showAlert('Material Name is required', 'danger');
        return;
    }
    if (cleng <= 0) {
        showAlert('Length must be greater than 0', 'danger');
        return;
    }
    if (cwidth <= 0) {
        showAlert('Width must be greater than 0', 'danger');
        return;
    }
    
    fetch('/stock-take/add-board-item/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            boards_po_id: activeBoardsPoId,
            barcode: barcode,
            matname: matname,
            cleng: cleng,
            cwidth: cwidth,
            cnt: cnt,
            grain: grain,
            partdesc: partdesc,
            prfid1: prfid1,
            prfid2: prfid2,
            prfid3: prfid3,
            prfid4: prfid4
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showAlert('Board added successfully! Files regenerated.', 'success');
            closeModal('addBoardModal');
            // Clear form
            document.getElementById('add-board-barcode').value = '';
            document.getElementById('add-board-matname').value = '';
            document.getElementById('add-board-length').value = '';
            document.getElementById('add-board-width').value = '';
            document.getElementById('add-board-count').value = '1';
            document.getElementById('add-board-grain').value = '';
            document.getElementById('add-board-partdesc').value = '';
            document.getElementById('add-board-prfid1').checked = false;
            document.getElementById('add-board-prfid3').checked = false;
            document.getElementById('add-board-prfid4').checked = false;
            document.getElementById('add-board-prfid2').checked = false;
            // Reload page to show new item
            location.reload();
        } else {
            showAlert('Error adding board: ' + result.error, 'danger');
        }
    })
    .catch(error => {
        showAlert('Error adding board', 'danger');
    });
}

// Regenerate PNX and CSV files from database items
function regenerateBoardsFiles() {
    if (!confirm('This will regenerate the PNX and CSV files from the database records and upload them to storage. Continue?')) {
        return;
    }

    const orderId = {{ order.id }};
    fetch(`/order/${orderId}/regenerate-boards-files/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showAlert(data.error || 'Failed to regenerate files', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error regenerating files', 'danger');
    });
}

// Update PO - regenerate PNX/CSV files and update PO attachments
function updateBoardsPO(boardsPoId) {
    if (!confirm('This will regenerate PNX/CSV files and update the Purchase Order attachments. Continue?')) {
        return;
    }

    const orderId = {{ order.id }};
    const btn = event.target.closest('button');
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Updating...';

    fetch(`/order/${orderId}/update-boards-po-files/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ boards_po_id: boardsPoId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showAlert(data.error || 'Failed to update PO', 'danger');
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error updating PO', 'danger');
        btn.disabled = false;
        btn.innerHTML = originalHtml;
    });
}

// Reimport PNX items from file
function reimportPNX(boardsPoId) {
    if (!confirm('This will delete all current PNX items and re-import them from the PNX file. Continue?')) {
        return;
    }
    
    fetch(`/stock-take/boards-po/${boardsPoId}/reimport-pnx/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showAlert(`Successfully reimported ${result.count} items from PNX file`, 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showAlert('Error reimporting PNX: ' + result.error, 'danger');
        }
    })
    .catch(error => {
        showAlert('Error reimporting PNX', 'danger');
    });
}

// Close modals on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        document.querySelectorAll('.modal.show').forEach(function(modal) {
            modal.classList.remove('show');
        });
        document.body.classList.remove('modal-open');
    }
});

// Swap item functionality
let currentAccessoryId = null;
let searchTimeout = null;

function openSwapModal(accessoryId, currentSku, currentName) {
    currentAccessoryId = accessoryId;
    document.getElementById('current-item-info').textContent = `${currentSku} - ${currentName}`;
    document.getElementById('swap-search').value = '';
    document.getElementById('search-results').innerHTML = '<p class="text-muted">Type to search for items...</p>';
    openModal('swapItemModal');
}

function searchStockItems() {
    const searchTerm = document.getElementById('swap-search').value.trim();
    
    // Clear previous timeout
    if (searchTimeout) {
        clearTimeout(searchTimeout);
    }
    
    // Don't search if less than 2 characters
    if (searchTerm.length < 2) {
        document.getElementById('search-results').innerHTML = '<p class="text-muted">Type at least 2 characters to search...</p>';
        return;
    }
    
    // Debounce search
    searchTimeout = setTimeout(function() {
        fetch(`/stock-take/search-stock-items/?q=${encodeURIComponent(searchTerm)}`)
            .then(response => response.json())
            .then(data => {
                displaySearchResults(data.results);
            })
            .catch(error => {
                console.error('Search error:', error);
                document.getElementById('search-results').innerHTML = '<p class="text-danger">Error searching items</p>';
            });
    }, 300); // Wait 300ms after user stops typing
}

function displaySearchResults(results) {
    const container = document.getElementById('search-results');
    
    if (results.length === 0) {
        container.innerHTML = '<p class="text-muted">No items found</p>';
        return;
    }
    
    let html = '<table class="table table-hover"><thead><tr><th>SKU</th><th>Name</th><th>Stock</th><th>Action</th></tr></thead><tbody>';
    
    results.forEach(item => {
        const stockBadge = item.quantity > 0 
            ? `<span class="badge badge-success">${item.quantity}</span>` 
            : `<span class="badge badge-danger">0</span>`;
        
        html += `
            <tr>
                <td>${item.sku}</td>
                <td>${item.name}</td>
                <td>${stockBadge}</td>
                <td>
                    <button type="button" class="btn btn-primary btn-sm" 
                            onclick="performSwap(${item.id}, '${item.sku}', '${item.name.replace(/'/g, "\\'")}')">
                        Select
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

function performSwap(newStockItemId, newSku, newName) {
    if (!confirm(`Swap to ${newSku} - ${newName}?\n\nThis will update the accessory and regenerate the processed CSV.`)) {
        return;
    }
    
    fetch(`/stock-take/swap-accessory/${currentAccessoryId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ 
            new_stock_item_id: newStockItemId 
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeModal('swapItemModal');
            showAlert(data.message, 'success');
            // Reload page to show updated accessory
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert('Error: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Swap error:', error);
        showAlert('Error swapping item', 'danger');
    });
}

// Add new item functionality
let addItemSearchTimeout = null;
let addGlassSearchTimeout = null;

function searchItemsToAdd() {
    const searchTerm = document.getElementById('add-item-search').value.trim();
    
    if (addItemSearchTimeout) {
        clearTimeout(addItemSearchTimeout);
    }
    
    if (searchTerm.length < 2) {
        document.getElementById('add-item-results').innerHTML = '<p class="text-muted">Type at least 2 characters to search...</p>';
        return;
    }
    
    addItemSearchTimeout = setTimeout(function() {
        fetch(`/stock-take/search-stock-items/?q=${encodeURIComponent(searchTerm)}`)
            .then(response => response.json())
            .then(data => {
                displayAddItemResults(data.results);
            })
            .catch(error => {
                console.error('Search error:', error);
                document.getElementById('add-item-results').innerHTML = '<p class="text-danger">Error searching items</p>';
            });
    }, 300);
}

function searchGlassToAdd() {
    const searchTerm = document.getElementById('add-glass-search').value.trim();
    
    if (addGlassSearchTimeout) {
        clearTimeout(addGlassSearchTimeout);
    }
    
    if (searchTerm.length < 2) {
        document.getElementById('add-glass-results').innerHTML = '<p class="text-muted">Type at least 2 characters to search...</p>';
        return;
    }
    
    addGlassSearchTimeout = setTimeout(function() {
        fetch(`/stock-take/search-stock-items/?q=${encodeURIComponent(searchTerm)}`)
            .then(response => response.json())
            .then(data => {
                displayAddGlassResults(data.results);
            })
            .catch(error => {
                console.error('Search error:', error);
                document.getElementById('add-glass-results').innerHTML = '<p class="text-danger">Error searching items</p>';
            });
    }, 300);
}

function displayAddGlassResults(results) {
    const container = document.getElementById('add-glass-results');
    
    if (results.length === 0) {
        container.innerHTML = '<p class="text-muted">No items found</p>';
        return;
    }
    
    let html = '<table class="table table-hover"><thead><tr><th>SKU</th><th>Name</th><th>Stock</th><th>Action</th></tr></thead><tbody>';
    
    results.forEach(item => {
        const stockBadge = item.quantity > 0 
            ? `<span class="badge badge-success">${item.quantity}</span>` 
            : `<span class="badge badge-danger">0</span>`;
        
        html += `
            <tr>
                <td>${item.sku}</td>
                <td>${item.name}</td>
                <td>${stockBadge}</td>
                <td>
                    <button type="button" class="btn btn-primary btn-sm" 
                            onclick="addGlassToOrder(${item.id}, '${item.sku}', '${item.name.replace(/'/g, "\\'")}')">
                        Add
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

function addGlassToOrder(stockItemId, sku, name) {
    const quantity = prompt(`How many ${sku} do you want to add?`, '1');
    
    if (quantity === null || quantity === '') {
        return;
    }
    
    const qty = parseFloat(quantity);
    if (isNaN(qty) || qty <= 0) {
        showAlert('Please enter a valid quantity', 'danger');
        return;
    }
    
    fetch(`/stock-take/add-accessory-item/{{ order.id }}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ 
            stock_item_id: stockItemId,
            quantity: qty
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeModal('addGlassModal');
            showAlert(data.message, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert('Error: ' + (data.error || 'Unknown error'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error adding glass:', error);
        showAlert('Error adding glass item', 'danger');
    });
}


function displayAddItemResults(results) {
    const container = document.getElementById('add-item-results');
    
    if (results.length === 0) {
        container.innerHTML = '<p class="text-muted">No items found</p>';
        return;
    }
    
    let html = '<table class="table table-hover"><thead><tr><th>SKU</th><th>Name</th><th>Stock</th><th>Action</th></tr></thead><tbody>';
    
    results.forEach(item => {
        const stockBadge = item.quantity > 0 
            ? `<span class="badge badge-success">${item.quantity}</span>` 
            : `<span class="badge badge-danger">0</span>`;
        
        html += `
            <tr>
                <td>${item.sku}</td>
                <td>${item.name}</td>
                <td>${stockBadge}</td>
                <td>
                    <button type="button" class="btn btn-primary btn-sm" 
                            onclick="addItemToOrder(${item.id}, '${item.sku}', '${item.name.replace(/'/g, "\\'")}')">
                        Add
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

function addItemToOrder(stockItemId, sku, name) {
    const quantity = prompt(`How many ${sku} do you want to add?`, '1');
    
    if (quantity === null || quantity === '') {
        return;
    }
    
    const qty = parseFloat(quantity);
    if (isNaN(qty) || qty <= 0) {
        showAlert('Please enter a valid quantity', 'danger');
        return;
    }
    
    fetch(`/stock-take/add-accessory-item/{{ order.id }}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ 
            stock_item_id: stockItemId,
            quantity: qty
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeModal('addItemModal');
            showAlert(data.message, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert('Error: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Add item error:', error);
        showAlert('Error adding item', 'danger');
    });
}

// Regenerate CSV function
function regenerateCSV(orderId) {
    if (!confirm('Regenerate the processed CSV with current accessory data?\n\nAny unsaved quantity changes will be saved automatically.')) {
        return;
    }
    
    // First, save any pending accessory quantity changes
    const accessoryChangesEl = document.querySelector('.accessory-quantity');
    if (accessoryChangesEl) {
        // Get accessoryChanges from the DOMContentLoaded scope
        let pendingChanges = {};
        document.querySelectorAll('.accessory-quantity').forEach(function(input) {
            const accessoryId = input.getAttribute('data-accessory-id');
            const quantity = parseFloat(input.value) || 0;
            const originalQuantity = parseFloat(input.getAttribute('data-original-quantity')) || 0;
            
            if (quantity !== originalQuantity) {
                pendingChanges[accessoryId] = quantity;
            }
        });
        
        // If there are pending changes, save them first
        if (Object.keys(pendingChanges).length > 0) {
            showAlert('Saving quantity changes before regenerating CSV...', 'info');
            
            fetch('/stock-take/update-accessory-quantities/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ changes: pendingChanges })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Now regenerate the CSV
                    performCSVRegeneration(orderId);
                } else {
                    showAlert('Error saving quantities: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                console.error('Save error:', error);
                showAlert('Error saving quantities', 'danger');
            });
        } else {
            // No pending changes, just regenerate
            performCSVRegeneration(orderId);
        }
    } else {
        // No accessories or no changes, just regenerate
        performCSVRegeneration(orderId);
    }
}

function performCSVRegeneration(orderId) {
    fetch(`/stock-take/regenerate-csv/${orderId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert('Error: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Regenerate error:', error);
        showAlert('Error regenerating CSV', 'danger');
    });
}

// Workflow functions
function toggleStageTasks() {
    const content = document.getElementById('stage-tasks-content');
    const toggle = document.querySelector('.stage-tasks-toggle');
    if (!content) return;
    const isCollapsed = content.classList.contains('collapsed');
    content.classList.toggle('collapsed', !isCollapsed);
    content.classList.toggle('expanded', isCollapsed);
    toggle.classList.toggle('expanded', isCollapsed);
}

function updateWorkflowStage(orderId, stageId) {
    fetch(`/order/${orderId}/update-workflow-stage/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: `stage_id=${stageId}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert('Error: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error updating stage:', error);
        showAlert('Error updating workflow stage', 'danger');
    });
}

function calculateExcVat() {
    const incVatInput = document.getElementById('total-value-input');
    if (!incVatInput) return; // Field only exists in edit mode
    
    const incVat = parseFloat(incVatInput.value) || 0;
    const excVat = incVat / 1.2;
    document.getElementById('total_value_exc_vat_display').textContent = '£' + excVat.toFixed(2);
    calculateProfit();
}

function calculateProfit() {
    let incVat = 0;
    const incVatInput = document.getElementById('total-value-input');
    const incVatDisplay = document.getElementById('total-value-display');
    
    if (incVatInput) {
        incVat = parseFloat(incVatInput.value) || 0;
    } else if (incVatDisplay) {
        incVat = parseFloat(incVatDisplay.textContent.replace('£', '').replace(',', '')) || 0;
    }
    
    const excVat = incVat / 1.2;
    
    const materialsElement = document.getElementById('materials_cost_display');
    const materials = materialsElement ? parseFloat(materialsElement.textContent.replace('£', '').replace(',', '')) || 0 : 0;
    
    const installationElement = document.getElementById('installation_cost_display');
    const installation = installationElement ? parseFloat(installationElement.textContent.replace('£', '').replace(',', '')) || 0 : 0;
    
    const manufacturingElement = document.getElementById('manufacturing_cost_display');
    const manufacturing = manufacturingElement ? parseFloat(manufacturingElement.textContent.replace('£', '').replace(',', '')) || 0 : 0;
    
    const profit = excVat - materials - installation - manufacturing;
    const profitElement = document.getElementById('profit_display');
    if (profitElement) {
        profitElement.textContent = '£' + profit.toFixed(2);
    }
    
    // Update progress bar and percentage
    const profitProgressBar = document.getElementById('profit_progress_bar');
    const profitPercentage = document.getElementById('profit_percentage');
    if (profitProgressBar && profitPercentage && excVat > 0) {
        const percentage = profit > 0 ? Math.round((profit / excVat) * 100) : 0;
        profitProgressBar.style.width = percentage + '%';
        profitPercentage.textContent = percentage + '%';
    }
}

function saveFinancials(orderId) {
    let incVat = 0;
    const incVatInput = document.getElementById('total-value-input');
    const incVatDisplay = document.getElementById('total-value-display');
    
    if (incVatInput) {
        incVat = parseFloat(incVatInput.value) || 0;
    } else if (incVatDisplay) {
        incVat = parseFloat(incVatDisplay.textContent.replace('£', '').replace(',', '')) || 0;
    }
    
    const excVat = incVat / 1.2;
    
    const materialsElement = document.getElementById('materials_cost_display');
    const materials = materialsElement ? parseFloat(materialsElement.textContent.replace('£', '').replace(',', '')) || 0 : 0;
    
    const installationElement = document.getElementById('installation_cost_display');
    const installation = installationElement ? parseFloat(installationElement.textContent.replace('£', '').replace(',', '')) || 0 : 0;
    
    const manufacturingElement = document.getElementById('manufacturing_cost_display');
    const manufacturing = manufacturingElement ? parseFloat(manufacturingElement.textContent.replace('£', '').replace(',', '')) || 0 : 0;
    
    const profit = excVat - materials - installation - manufacturing;

    const fullyCostedCheckbox = document.getElementById('fully_costed_checkbox');
    const fullyCosted = fullyCostedCheckbox ? fullyCostedCheckbox.checked : false;

    const data = {
        total_value_inc_vat: incVat,
        total_value_exc_vat: excVat,
        materials_cost: materials,
        installation_cost: installation,
        manufacturing_cost: manufacturing,
        profit: profit,
        fully_costed: fullyCosted
    };

    fetch(`/order/${orderId}/save-all-financials/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Financial data saved successfully', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert('Error: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error saving financials:', error);
        showAlert('Error saving financial information', 'danger');
    });
}

function recalculateFinancials(orderId) {
    // Disable the button and show loading state
    const btn = event.target.closest('button');
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass"></i> Recalculating...';
    
    fetch(`/order/${orderId}/recalculate-financials/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Financial data recalculated successfully!', 'success');
            // Update all displays with new values
            if (data.materials_cost !== undefined) {
                document.getElementById('materials_cost_display').textContent = '£' + parseFloat(data.materials_cost).toFixed(2);
            }
            if (data.installation_cost !== undefined) {
                document.getElementById('installation_cost_display').textContent = '£' + parseFloat(data.installation_cost).toFixed(2);
            }
            if (data.manufacturing_cost !== undefined) {
                document.getElementById('manufacturing_cost_display').textContent = '£' + parseFloat(data.manufacturing_cost).toFixed(2);
            }
            if (data.total_value_exc_vat !== undefined) {
                document.getElementById('total_value_exc_vat_display').textContent = '£' + parseFloat(data.total_value_exc_vat).toFixed(2);
            }
            
            // Recalculate profit with new values
            calculateProfit();
            
            // Reload page after a short delay to show updated progress bars
            setTimeout(() => location.reload(), 1500);
        } else {
            showAlert('Error: ' + data.error, 'danger');
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }
    })
    .catch(error => {
        console.error('Error recalculating financials:', error);
        showAlert('Error recalculating financial information', 'danger');
        btn.disabled = false;
        btn.innerHTML = originalHtml;
    });
}

function updateFinancial(orderId, field, value) {
    fetch(`/order/${orderId}/update-financial/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ field: field, value: value })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload to update percentages
            location.reload();
        } else {
            showAlert('Error: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error updating financial:', error);
        showAlert('Error updating financial information', 'danger');
    });
}

function updateTaskCheckbox(orderId, taskId, checked) {
    fetch(`/order/${orderId}/task/${taskId}/update/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: `action=checkbox&completed=${checked}`
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            showAlert('Error: ' + data.error, 'danger');
        }
    })
    .catch(error => console.error('Error updating task:', error));
}

function updateTaskRadio(orderId, taskId, option) {
    fetch(`/order/${orderId}/task/${taskId}/update/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: `action=radio&selected_option=${encodeURIComponent(option)}`
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            showAlert('Error: ' + data.error, 'danger');
        }
    })
    .catch(error => console.error('Error updating task:', error));
}

function updateTaskDropdown(orderId, taskId, option) {
    fetch(`/order/${orderId}/task/${taskId}/update/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: `action=dropdown&selected_option=${encodeURIComponent(option)}`
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            showAlert('Error: ' + data.error, 'danger');
        }
    })
    .catch(error => console.error('Error updating task:', error));
}

function updateTaskDecision(orderId, taskId, decision) {
    // Remove active class from all buttons in this decision group
    event.target.closest('.decision-options').querySelectorAll('.decision-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Add active class to clicked button
    event.target.closest('.decision-btn').classList.add('active');
    
    fetch(`/order/${orderId}/task/${taskId}/update/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: `action=decision&selected_option=${decision}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(`Decision: ${decision}`, 'info');
        } else {
            showAlert('Error: ' + data.error, 'danger');
        }
    })
    .catch(error => console.error('Error updating decision:', error));
}

function progressToNextStage(orderId) {
    fetch(`/order/${orderId}/workflow/progress/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert('Error: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error progressing stage:', error);
        showAlert('Error progressing to next stage', 'danger');
    });
}

function revertToPreviousStage(orderId) {
    if (!confirm('Are you sure you want to revert to the previous stage?')) {
        return;
    }
    
    fetch(`/order/${orderId}/workflow/revert/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert('Error: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error reverting stage:', error);
        showAlert('Error reverting to previous stage', 'danger');
    });
}

function openWorkflowModal() {
    const modal = document.getElementById('workflowModal');
    if (modal) {
        modal.classList.add('show');
        document.body.classList.add('modal-open');
        
        // Scroll to current stage
        setTimeout(() => {
            const currentStage = modal.querySelector('.current-stage');
            if (currentStage) {
                currentStage.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }, 100);
    }
}

function selectWorkflowStage(orderId, stageId) {
    if (!confirm('Are you sure you want to change the workflow stage?')) {
        return;
    }
    
    fetch(`/order/${orderId}/update-workflow-stage/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: `stage_id=${stageId}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Workflow stage updated successfully', 'success');
            closeModal('workflowModal');
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert('Error: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error updating workflow stage:', error);
        showAlert('Error updating workflow stage', 'danger');
    });
}

// PNX Generation Analysis Functions
window.analyzePNXGeneration = function(event, boardsPoId) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    activeBoardsPoId = boardsPoId || null;
    const orderId = {{ order.id }};
    const queryParam = boardsPoId ? `?boards_po_id=${boardsPoId}` : '';
    
    fetch(`/order/${orderId}/generate-pnx/${queryParam}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showPNXAnalysisModal(data);
        } else {
            showAlert('Error: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error analyzing PNX:', error);
        showAlert('Error analyzing PNX generation', 'danger');
    });
};

// Store PNX data globally for manipulation
let pnxStagingData = {
    newItems: [],
    updatedItems: [],
    duplicateItems: []
};

function showPNXAnalysisModal(data) {
    const content = document.getElementById('pnx-analysis-content');
    
    // New structure - all_items with status
    const allItems = data.all_items || [];
    
    // Store in global state
    pnxStagingData.newItems = allItems.filter(item => item.status === 'new');
    pnxStagingData.updatedItems = allItems.filter(item => item.status === 'updated');
    pnxStagingData.duplicateItems = allItems.filter(item => item.status === 'duplicate');
    
    // Render the modal
    renderPNXAnalysisModal();
    openModal('pnxAnalysisModal');
}

function renderPNXAnalysisModal() {
    const content = document.getElementById('pnx-analysis-content');
    let html = '';
    
    const duplicateCount = pnxStagingData.duplicateItems.length;
    const updateCount = pnxStagingData.updatedItems.length;
    const newCount = pnxStagingData.newItems.length;
    
    // Action Summary at the top
    html += '<div style="background-color: #e7f3ff; border-left: 4px solid #2196F3; padding: 15px; margin-bottom: 25px; border-radius: 4px;">';
    html += '<h5 style="margin: 0 0 10px 0; color: #1976D2;"><i class="bi bi-info-circle-fill"></i> PNX Staging - Review Before Import</h5>';
    html += '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; font-size: 14px;">';
    
    if (newCount > 0) {
        html += '<div>';
        html += '<div style="color: #155724; font-weight: 600;"><i class="bi bi-plus-circle"></i> Will Add</div>';
        html += `<div style="font-size: 20px; font-weight: bold; color: #155724;">${newCount}</div>`;
        html += '<div style="font-size: 12px; color: #6c757d;">new items</div>';
        html += '</div>';
    }
    
    if (updateCount > 0) {
        html += '<div>';
        html += '<div style="color: #856404; font-weight: 600;"><i class="bi bi-arrow-up-circle"></i> Will Update</div>';
        html += `<div style="font-size: 20px; font-weight: bold; color: #856404;">${updateCount}</div>`;
        html += '<div style="font-size: 12px; color: #6c757d;">quantity changes</div>';
        html += '</div>';
    }
    
    if (duplicateCount > 0) {
        html += '<div>';
        html += '<div style="color: #6c757d; font-weight: 600;"><i class="bi bi-dash-circle"></i> Will Ignore</div>';
        html += `<div style="font-size: 20px; font-weight: bold; color: #6c757d;">${duplicateCount}</div>`;
        html += '<div style="font-size: 12px; color: #6c757d;">duplicates</div>';
        html += '</div>';
    }
    
    html += '</div></div>';
    
    // New Items Section
    if (newCount > 0) {
        html += '<div style="margin-bottom: 25px;">';
        html += '<h4 style="color: #155724; margin-bottom: 15px; border-bottom: 2px solid #c3e6cb; padding-bottom: 10px;">';
        html += '<i class="bi bi-plus-circle-fill"></i> Items to Add (' + newCount + ')';
        html += '</h4>';
        html += '<table class="table table-sm table-striped" style="font-size: 13px;">';
        html += '<thead style="background-color: #d4edda;">';
        html += '<tr><th>Barcode</th><th>Material</th><th>Dimensions</th><th>Customer</th><th>Quantity</th></tr>';
        html += '</thead><tbody>';
        pnxStagingData.newItems.forEach(item => {
            html += '<tr>';
            html += `<td><strong>${item.barcode}</strong></td>`;
            html += `<td>${item.matname}</td>`;
            html += `<td>${item.dimensions}</td>`;
            html += `<td>${item.customer || ''}</td>`;
            html += `<td><span style="background-color: #d4edda; padding: 3px 8px; border-radius: 3px; font-weight: 600;">${item.qty}</span></td>`;
            html += '</tr>';
        });
        html += '</tbody></table>';
        html += '</div>';
    }
    
    // Updated Items Section
    if (updateCount > 0) {
        html += '<div style="margin-bottom: 25px;">';
        html += '<h4 style="color: #856404; margin-bottom: 15px; border-bottom: 2px solid #ffc107; padding-bottom: 10px;">';
        html += '<i class="bi bi-arrow-up-circle-fill"></i> Quantity Updates (' + updateCount + ')';
        html += '</h4>';
        html += '<table class="table table-sm table-striped" style="font-size: 13px;">';
        html += '<thead style="background-color: #fff3cd;">';
        html += '<tr><th>Barcode</th><th>Material</th><th>Dimensions</th><th>Current</th><th>New</th><th>Change</th></tr>';
        html += '</thead><tbody>';
        pnxStagingData.updatedItems.forEach(item => {
            const change = item.qty - item.old_qty;
            html += '<tr>';
            html += `<td><strong>${item.barcode}</strong></td>`;
            html += `<td>${item.matname}</td>`;
            html += `<td>${item.dimensions}</td>`;
            html += `<td>${item.old_qty}</td>`;
            html += `<td><strong style="color: #856404;">${item.qty}</strong></td>`;
            html += `<td><span style="background-color: #fff3cd; padding: 3px 8px; border-radius: 3px; font-weight: 600; color: #856404;">+${change}</span></td>`;
            html += '</tr>';
        });
        html += '</tbody></table>';
        html += '</div>';
    }
    
    // Duplicate Items Section
    if (duplicateCount > 0) {
        html += '<div id="duplicates-section" style="margin-bottom: 25px;">';
        html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">';
        html += '<h4 style="color: #6c757d; margin: 0; border-bottom: 2px solid #dee2e6; padding-bottom: 10px; flex-grow: 1;">';
        html += '<i class="bi bi-dash-circle-fill"></i> Items to Ignore (' + duplicateCount + ')';
        html += '</h4>';
        html += '<button type="button" class="btn btn-sm btn-outline-success" onclick="moveSelectedDuplicatesToImport()" style="margin-left: 15px;">';
        html += '<i class="bi bi-arrow-up-circle"></i> Move Selected to Import';
        html += '</button>';
        html += '</div>';
        html += '<p style="color: #6c757d; font-size: 13px; margin-bottom: 10px;">';
        html += '<em>These items already exist with the same quantity. Select items below to include them in the import anyway.</em>';
        html += '</p>';
        html += '<table class="table table-sm table-striped" style="font-size: 13px;">';
        html += '<thead style="background-color: #f8f9fa;">';
        html += '<tr>';
        html += '<th style="width: 40px;"><input type="checkbox" id="select-all-duplicates" onchange="toggleAllDuplicates(this.checked)"></th>';
        html += '<th>Barcode</th><th>Material</th><th>Dimensions</th><th>Quantity</th>';
        html += '</tr>';
        html += '</thead><tbody id="duplicates-tbody">';
        pnxStagingData.duplicateItems.forEach((item, index) => {
            html += `<tr data-duplicate-index="${index}">`;
            html += `<td><input type="checkbox" class="duplicate-checkbox" data-barcode="${item.barcode}"></td>`;
            html += `<td>${item.barcode}</td>`;
            html += `<td>${item.matname}</td>`;
            html += `<td>${item.dimensions}</td>`;
            html += `<td>${item.qty}</td>`;
            html += '</tr>';
        });
        html += '</tbody></table>';
        html += '</div>';
    }
    
    // If nothing to do
    if (duplicateCount === 0 && updateCount === 0 && newCount === 0) {
        html += '<div class="alert alert-warning">';
        html += '<p style="margin: 0;">No changes detected. The PNX file contains no new or updated items.</p>';
        html += '</div>';
    }
    
    content.innerHTML = html;
}

function toggleAllDuplicates(checked) {
    document.querySelectorAll('.duplicate-checkbox').forEach(checkbox => {
        checkbox.checked = checked;
    });
}

function moveSelectedDuplicatesToImport() {
    const checkboxes = document.querySelectorAll('.duplicate-checkbox:checked');
    
    if (checkboxes.length === 0) {
        showAlert('Please select at least one item to move', 'warning');
        return;
    }
    
    const selectedBarcodes = Array.from(checkboxes).map(cb => cb.dataset.barcode);
    
    // Move selected items from duplicates to new items
    const itemsToMove = pnxStagingData.duplicateItems.filter(item => 
        selectedBarcodes.includes(item.barcode)
    );
    
    // Change their status to 'new' so they'll be imported
    itemsToMove.forEach(item => {
        item.status = 'new';
        item.original_status = 'duplicate'; // Track that it was originally a duplicate
    });
    
    // Add to new items
    pnxStagingData.newItems.push(...itemsToMove);
    
    // Remove from duplicates
    pnxStagingData.duplicateItems = pnxStagingData.duplicateItems.filter(item => 
        !selectedBarcodes.includes(item.barcode)
    );
    
    // Re-render the modal
    renderPNXAnalysisModal();
    
    showAlert(`Moved ${itemsToMove.length} item(s) to import list`, 'success');
}

function closePNXAnalysisModal() {
    closeModal('pnxAnalysisModal');
}

function confirmPNXGeneration() {
    const orderId = {{ order.id }};
    const btn = document.getElementById('confirm-pnx-btn');
    btn.disabled = true;
    btn.textContent = 'Processing...';
    
    // Collect barcodes that were originally duplicates but moved to import
    const forceImportBarcodes = pnxStagingData.newItems
        .filter(item => item.original_status === 'duplicate')
        .map(item => item.barcode);
    
    fetch(`/order/${orderId}/confirm-pnx/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            force_import_barcodes: forceImportBarcodes
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(`PNX generated successfully! ${data.items_created} items added, ${data.items_updated} items updated.`, 'success');
            closePNXAnalysisModal();
            setTimeout(() => location.reload(), 1500);
        } else {
            showAlert('Error: ' + data.error, 'danger');
            btn.disabled = false;
            btn.textContent = 'Proceed with Generation';
        }
    })
    .catch(error => {
        console.error('Error confirming PNX:', error);
        showAlert('Error confirming PNX generation', 'danger');
        btn.disabled = false;
        btn.textContent = 'Proceed with Generation';
    });
}

// PNX Item Selection and Delete Functions
function updateDeleteButtonVisibility(boardsPoId) {
    if (boardsPoId) {
        const checkboxes = document.querySelectorAll(`.pnx-item-checkbox[data-boards-po-id="${boardsPoId}"]:checked`);
        const deleteBtn = document.querySelector(`.btn-delete-selected[data-boards-po-id="${boardsPoId}"]`);
        if (deleteBtn) {
            deleteBtn.style.display = checkboxes.length > 0 ? 'block' : 'none';
        }
    } else {
        // Update all delete buttons
        document.querySelectorAll('.btn-delete-selected').forEach(function(deleteBtn) {
            const poId = deleteBtn.getAttribute('data-boards-po-id');
            const checkboxes = document.querySelectorAll(`.pnx-item-checkbox[data-boards-po-id="${poId}"]:checked`);
            deleteBtn.style.display = checkboxes.length > 0 ? 'block' : 'none';
        });
    }
}

// Timesheet Functions
function openTimesheetModal(type) {
    const modal = document.getElementById('addTimesheetModal');
    const title = document.getElementById('timesheet-modal-title');
    const typeInput = document.getElementById('timesheet_type');
    const fitterGroup = document.getElementById('fitter-group');
    const helperGroup = document.getElementById('helper-group');
    const installationWorkerGroup = document.getElementById('installation-worker-group');
    const workerGroup = document.getElementById('worker-group');
    const expenseGroup = document.getElementById('add-expense-group');
    const priceGroup = document.getElementById('price-group');
    const hoursGroup = document.getElementById('hours-group');
    
    // Get staging elements
    const stagingSection = document.getElementById('manufacturing-staging-section');
    const addToStagingBtn = document.getElementById('add-to-staging-btn');
    const saveAllBtn = document.getElementById('save-all-timesheets-btn');
    const saveSingleBtn = document.getElementById('save-single-timesheet-btn');
    
    typeInput.value = type;
    
    // Reset all selects and enable them
    document.getElementById('timesheet_fitter').value = '';
    document.getElementById('timesheet_fitter').disabled = false;
    document.getElementById('timesheet_helper').value = '';
    document.getElementById('timesheet_helper').disabled = false;
    if (document.getElementById('timesheet_installation_worker')) {
        document.getElementById('timesheet_installation_worker').value = '';
        document.getElementById('timesheet_installation_worker').disabled = false;
    }
    
    if (type === 'installation') {
        title.textContent = 'Add Installation Timesheet';
        fitterGroup.style.display = 'block';
        helperGroup.style.display = 'block';
        installationWorkerGroup.style.display = 'block';
        workerGroup.style.display = 'none';
        expenseGroup.style.display = 'block';
        priceGroup.style.display = 'block';
        hoursGroup.style.display = 'block';
        document.getElementById('hours-optional-label').style.display = 'inline';
        // Set required/optional
        document.getElementById('timesheet_price').required = true;
        document.getElementById('timesheet_hours').required = false;
        // Show single save button, hide staging
        stagingSection.style.display = 'none';
        addToStagingBtn.style.display = 'none';
        saveAllBtn.style.display = 'none';
        saveSingleBtn.style.display = 'inline-block';
        loadFitters();
        loadHelpers();
        loadInstallationWorkers();
    } else {
        title.textContent = 'Add Manufacturing Timesheet';
        fitterGroup.style.display = 'none';
        helperGroup.style.display = 'none';
        installationWorkerGroup.style.display = 'none';
        workerGroup.style.display = 'block';
        expenseGroup.style.display = 'none';
        priceGroup.style.display = 'none';
        hoursGroup.style.display = 'block';
        document.getElementById('hours-optional-label').style.display = 'none';
        // Set required/optional
        document.getElementById('timesheet_price').required = false;
        document.getElementById('timesheet_hours').required = true;
        // Show staging section and buttons for manufacturing
        stagingSection.style.display = 'block';
        addToStagingBtn.style.display = 'inline-block';
        saveAllBtn.style.display = 'inline-block';
        saveSingleBtn.style.display = 'none';
        // Clear staging table
        clearStagingTable();
        loadFactoryWorkers();
    }
    
    openModal('addTimesheetModal');
}

function handleInstallationPersonSelect(selectedField) {
    const fitterSelect = document.getElementById('timesheet_fitter');
    const helperSelect = document.getElementById('timesheet_helper');
    const installationWorkerSelect = document.getElementById('timesheet_installation_worker');
    
    const fitterValue = fitterSelect.value;
    const helperValue = helperSelect.value;
    const workerValue = installationWorkerSelect ? installationWorkerSelect.value : '';
    
    // Check if any field has a value
    const anySelected = fitterValue || helperValue || workerValue;
    
    if (anySelected) {
        // Disable fields that don't have the selection
        if (selectedField === 'fitter' && fitterValue) {
            helperSelect.disabled = true;
            if (installationWorkerSelect) installationWorkerSelect.disabled = true;
        } else if (selectedField === 'helper' && helperValue) {
            fitterSelect.disabled = true;
            if (installationWorkerSelect) installationWorkerSelect.disabled = true;
        } else if (selectedField === 'installation_worker' && workerValue) {
            fitterSelect.disabled = true;
            helperSelect.disabled = true;
        }
    } else {
        // All empty - enable all
        fitterSelect.disabled = false;
        helperSelect.disabled = false;
        if (installationWorkerSelect) installationWorkerSelect.disabled = false;
    }
}

// Manufacturing Timesheet Staging Functions
let stagedTimesheets = [];

function clearStagingTable() {
    stagedTimesheets = [];
    updateStagingTableDisplay();
}

function addToStagingTable() {
    const workerId = document.getElementById('timesheet_worker').value;
    const workerSelect = document.getElementById('timesheet_worker');
    const hours = document.getElementById('timesheet_hours').value;
    const description = document.getElementById('timesheet_description').value;
    
    // Validation
    if (!workerId) {
        showAlert('Please select a factory worker', 'danger');
        return;
    }
    if (!hours || parseFloat(hours) <= 0) {
        showAlert('Please enter valid hours', 'danger');
        return;
    }
    
    // Get worker details
    const selectedOption = workerSelect.options[workerSelect.selectedIndex];
    const workerName = selectedOption.textContent;
    const hourlyRate = parseFloat(selectedOption.dataset.rate) || 0;
    const totalCost = parseFloat(hours) * hourlyRate;
    
    // Add to staging array
    stagedTimesheets.push({
        workerId: workerId,
        workerName: workerName,
        hours: parseFloat(hours),
        hourlyRate: hourlyRate,
        totalCost: totalCost,
        description: description
    });
    
    // Reset form fields for next entry
    document.getElementById('timesheet_worker').value = '';
    document.getElementById('timesheet_hours').value = '';
    document.getElementById('timesheet_description').value = '';
    
    // Update display
    updateStagingTableDisplay();
    
    showAlert(`Added ${workerName} - ${hours} hours to list`, 'success');
}

function removeFromStagingTable(index) {
    const removed = stagedTimesheets.splice(index, 1)[0];
    updateStagingTableDisplay();
    showAlert(`Removed ${removed.workerName} from list`, 'info');
}

function updateStagingTableDisplay() {
    const tbody = document.getElementById('staging-table-body');
    const emptyMsg = document.getElementById('staging-empty-message');
    const table = document.getElementById('staging-table');
    const totalSpan = document.getElementById('staging-total');
    const countSpan = document.getElementById('staged-count');
    const saveAllBtn = document.getElementById('save-all-timesheets-btn');
    
    // Update count
    countSpan.textContent = stagedTimesheets.length;
    
    // Enable/disable save all button
    saveAllBtn.disabled = stagedTimesheets.length === 0;
    
    if (stagedTimesheets.length === 0) {
        table.style.display = 'none';
        emptyMsg.style.display = 'block';
        totalSpan.textContent = 'Total: £0.00';
        return;
    }
    
    table.style.display = 'table';
    emptyMsg.style.display = 'none';
    
    // Calculate total
    const grandTotal = stagedTimesheets.reduce((sum, ts) => sum + ts.totalCost, 0);
    totalSpan.textContent = `Total: £${grandTotal.toFixed(2)}`;
    
    // Build table rows
    tbody.innerHTML = stagedTimesheets.map((ts, index) => `
        <tr>
            <td>${ts.workerName}</td>
            <td>${ts.hours}</td>
            <td>£${ts.hourlyRate.toFixed(2)}</td>
            <td>£${ts.totalCost.toFixed(2)}</td>
            <td>
                <button type="button" class="btn btn-sm btn-danger" onclick="removeFromStagingTable(${index})" title="Remove">
                    <i class="bi bi-x"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

function saveAllStagedTimesheets() {
    if (stagedTimesheets.length === 0) {
        showAlert('No timesheets staged. Add entries first.', 'warning');
        return;
    }
    
    // Disable button during save
    const saveBtn = document.getElementById('save-all-timesheets-btn');
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Saving...';
    
    // Prepare data for bulk submission
    const data = {
        timesheets: stagedTimesheets.map(ts => ({
            timesheet_type: 'manufacturing',
            factory_worker_id: ts.workerId,
            hours: ts.hours,
            description: ts.description
        }))
    };
    
    fetch(`/order/{{ order.id }}/add-multiple-timesheets/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showAlert(`${stagedTimesheets.length} timesheets added successfully!`, 'success');
            closeModal('addTimesheetModal');
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert('Error: ' + result.error, 'danger');
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="bi bi-check-all"></i> Save All (<span id="staged-count">' + stagedTimesheets.length + '</span>)';
        }
    })
    .catch(error => {
        console.error('Error saving timesheets:', error);
        showAlert('Error saving timesheets', 'danger');
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="bi bi-check-all"></i> Save All (<span id="staged-count">' + stagedTimesheets.length + '</span>)';
    });
}

function loadInstallationWorkers() {
    fetch('/api/get-factory-workers/')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('timesheet_installation_worker');
            if (!select) return;
            select.innerHTML = '<option value="">Select a factory worker...</option>';
            data.workers.forEach(worker => {
                const option = document.createElement('option');
                option.value = worker.id;
                option.textContent = worker.name;
                option.dataset.rate = worker.hourly_rate;
                select.appendChild(option);
            });
        })
        .catch(error => console.error('Error loading factory workers:', error));
}

function loadFitters() {
    fetch('/api/get-fitters/')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('timesheet_fitter');
            select.innerHTML = '<option value="">Select a fitter...</option>';
            data.fitters.forEach(fitter => {
                const option = document.createElement('option');
                option.value = fitter.id;
                option.textContent = fitter.name;
                option.dataset.rate = fitter.hourly_rate;
                select.appendChild(option);
            });
            
            // Auto-populate hourly rate when fitter is selected
            select.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                if (selectedOption.dataset.rate) {
                    document.getElementById('timesheet_hourly_rate').value = selectedOption.dataset.rate;
                }
            });
        })
        .catch(error => console.error('Error loading fitters:', error));
}

function loadHelpers() {
    // Helpers use the same fitter list
    fetch('/api/get-fitters/')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('timesheet_helper');
            select.innerHTML = '<option value="">Select a helper (optional)...</option>';
            data.fitters.forEach(fitter => {
                const option = document.createElement('option');
                option.value = fitter.id;
                option.textContent = fitter.name;
                select.appendChild(option);
            });
        })
        .catch(error => console.error('Error loading helpers:', error));
}

function loadFactoryWorkers() {
    fetch('/api/get-factory-workers/')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('timesheet_worker');
            select.innerHTML = '<option value="">Select a worker...</option>';
            data.workers.forEach(worker => {
                const option = document.createElement('option');
                option.value = worker.id;
                option.textContent = worker.name;
                option.dataset.rate = worker.hourly_rate;
                select.appendChild(option);
            });
            
            // Auto-populate hourly rate when worker is selected
            select.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                if (selectedOption.dataset.rate) {
                    document.getElementById('timesheet_hourly_rate').value = selectedOption.dataset.rate;
                }
            });
        })
        .catch(error => console.error('Error loading factory workers:', error));
}

function togglePetrolAmount() {
    const checkbox = document.getElementById('add_petrol_expense');
    const amountInput = document.getElementById('petrol_amount');
    amountInput.style.display = checkbox.checked ? 'block' : 'none';
}

// Create Boards PO with next available number
function createNextBoardsPO(orderId) {
    fetch(`/order/${orderId}/update-boards-po/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ auto_next: true })
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            showAlert(`Boards PO ${result.boards_po.po_number} created and linked`, 'success');
            location.reload();
        } else {
            showAlert('Error: ' + (result.error || 'Unknown'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error creating PO: ' + error.message, 'danger');
    });
}

// Add Additional Boards PO to an order
function addAdditionalBoardsPO(orderId) {
    if (!confirm('Create an additional Boards PO for this order?')) return;
    
    fetch(`/order/${orderId}/add-additional-boards-po/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ auto_next: true })
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            showAlert(`Additional Boards PO ${result.po_number} added`, 'success');
            location.reload();
        } else {
            showAlert('Error: ' + (result.error || 'Unknown'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error adding additional PO: ' + error.message, 'danger');
    });
}

// Remove Additional Boards PO from order
function removeAdditionalBoardsPO(orderId, boardsPoId) {
    if (!confirm('Remove this additional boards PO from the order? The PO itself will not be deleted.')) {
        return;
    }
    
    fetch(`/order/${orderId}/remove-additional-boards-po/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ boards_po_id: boardsPoId })
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            showAlert('Additional boards PO removed', 'success');
            location.reload();
        } else {
            showAlert('Error: ' + (result.error || 'Unknown'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error removing PO: ' + error.message, 'danger');
    });
}

// Inline fitter management
function toggleAddFitterInline() {
    const form = document.getElementById('new-fitter-inline');
    if (form.style.display === 'none' || form.style.display === '') {
        form.style.display = 'block';
        document.getElementById('new-fitter-name').focus();
    } else {
        form.style.display = 'none';
        clearFitterForm();
    }
}

function cancelAddFitter() {
    document.getElementById('new-fitter-inline').style.display = 'none';
    clearFitterForm();
}

function clearFitterForm() {
    document.getElementById('new-fitter-name').value = '';
}

function saveNewFitter() {
    const name = document.getElementById('new-fitter-name').value.trim();
    
    if (!name) {
        showAlert('Please enter a fitter name', 'warning');
        return;
    }
    
    fetch('/api/add-fitter/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ name })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const select = document.getElementById('timesheet_fitter');
            const option = new Option(data.fitter.name, data.fitter.id, true, true);
            select.add(option);
            
            document.getElementById('new-fitter-inline').style.display = 'none';
            clearFitterForm();
            showAlert('Fitter added successfully!', 'success');
        } else {
            showAlert('Error: ' + (data.error || 'Failed to add fitter'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error adding fitter', 'danger');
    });
}

// Inline factory worker management
function toggleAddWorkerInline() {
    const form = document.getElementById('new-worker-inline');
    if (form.style.display === 'none' || form.style.display === '') {
        form.style.display = 'block';
        document.getElementById('new-worker-name').focus();
    } else {
        form.style.display = 'none';
        clearWorkerForm();
    }
}

function cancelAddWorker() {
    document.getElementById('new-worker-inline').style.display = 'none';
    clearWorkerForm();
}

function clearWorkerForm() {
    document.getElementById('new-worker-name').value = '';
}

// Inline helper management
function toggleAddHelperInline() {
    const form = document.getElementById('new-helper-inline');
    if (form.style.display === 'none' || form.style.display === '') {
        form.style.display = 'block';
        document.getElementById('new-helper-name').focus();
    } else {
        form.style.display = 'none';
        clearHelperForm();
    }
}

function cancelAddHelper() {
    document.getElementById('new-helper-inline').style.display = 'none';
    clearHelperForm();
}

function clearHelperForm() {
    document.getElementById('new-helper-name').value = '';
}

function saveNewHelper() {
    const name = document.getElementById('new-helper-name').value.trim();
    
    if (!name) {
        showAlert('Please enter a helper name', 'warning');
        return;
    }
    
    // Helpers are just fitters, so use the same API
    fetch('/api/add-fitter/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ name })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const select = document.getElementById('timesheet_helper');
            const option = new Option(data.fitter.name, data.fitter.id, true, true);
            select.add(option);
            
            document.getElementById('new-helper-inline').style.display = 'none';
            clearHelperForm();
            showAlert('Helper added successfully!', 'success');
        } else {
            showAlert('Error: ' + (data.error || 'Failed to add helper'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error adding helper', 'danger');
    });
}

function saveNewWorker() {
    const name = document.getElementById('new-worker-name').value.trim();
    
    if (!name) {
        showAlert('Please enter a worker name', 'warning');
        return;
    }
    
    fetch('/api/add-factory-worker/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ name })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const select = document.getElementById('timesheet_worker');
            const option = new Option(data.worker.name, data.worker.id, true, true);
            select.add(option);
            
            document.getElementById('new-worker-inline').style.display = 'none';
            clearWorkerForm();
            showAlert('Factory worker added successfully!', 'success');
        } else {
            showAlert('Error: ' + (data.error || 'Failed to add worker'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error adding factory worker', 'danger');
    });
}

function saveTimesheet() {
    const type = document.getElementById('timesheet_type').value;
    const fitterId = document.getElementById('timesheet_fitter').value;
    const helperId = document.getElementById('timesheet_helper').value;
    const installationWorkerId = document.getElementById('timesheet_installation_worker') ? 
                                  document.getElementById('timesheet_installation_worker').value : '';
    const workerId = document.getElementById('timesheet_worker').value;
    const price = document.getElementById('timesheet_price').value;
    const hours = document.getElementById('timesheet_hours').value;
    const hourlyRate = document.getElementById('timesheet_hourly_rate').value;
    const description = document.getElementById('timesheet_description').value;
    const addPetrol = document.getElementById('add_petrol_expense').checked;
    const petrolAmount = document.getElementById('petrol_amount').value;
    
    // Validation
    if (type === 'installation') {
        if (!fitterId && !helperId && !installationWorkerId) {
            showAlert('Please select a fitter, helper, or factory worker', 'danger');
            return;
        }
        if (!price) {
            showAlert('Please enter a price', 'danger');
            return;
        }
    } else {
        if (!workerId) {
            showAlert('Please select a factory worker', 'danger');
            return;
        }
        if (!hours) {
            showAlert('Please fill in hours worked', 'danger');
            return;
        }
    }
    
    const data = {
        timesheet_type: type,
        description: description
    };
    
    if (type === 'installation') {
        if (fitterId) data.fitter_id = fitterId;
        if (helperId) data.helper_id = helperId;
        if (installationWorkerId) data.installation_factory_worker_id = installationWorkerId;
        data.price = price;
        if (hours) data.hours = hours;  // Optional hours for installation
        if (addPetrol) {
            data.petrol_amount = petrolAmount;
        }
    } else {
        data.factory_worker_id = workerId;
        data.hours = hours;
        // hourly_rate is fetched from the worker on the backend
    }
    
    fetch(`/order/{{ order.id }}/add-timesheet/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showAlert('Timesheet added successfully!', 'success');
            closeModal('addTimesheetModal');
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert('Error: ' + result.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error saving timesheet:', error);
        showAlert('Error saving timesheet', 'danger');
    });
}

function deleteTimesheet(timesheetId) {
    if (!confirm('Are you sure you want to delete this timesheet?')) {
        return;
    }
    
    fetch(`/timesheet/${timesheetId}/delete/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showAlert('Timesheet deleted successfully!', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert('Error: ' + result.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error deleting timesheet:', error);
        showAlert('Error deleting timesheet', 'danger');
    });
}

function deleteExpense(expenseId) {
    if (!confirm('Are you sure you want to delete this expense?')) {
        return;
    }
    
    fetch(`/expense/${expenseId}/delete/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showAlert('Expense deleted successfully!', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert('Error: ' + result.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error deleting expense:', error);
        showAlert('Error deleting expense', 'danger');
    });
}

function deletePNXItems() {
    const checkboxes = document.querySelectorAll('.pnx-item-checkbox:checked');
    const itemIds = Array.from(checkboxes).map(cb => cb.dataset.itemId);
    
    if (itemIds.length === 0) {
        showAlert('No items selected', 'warning');
        return;
    }
    
    if (!confirm(`Are you sure you want to delete ${itemIds.length} item(s)?`)) {
        return;
    }
    
    fetch('/delete-pnx-items/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ item_ids: itemIds })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(`Successfully deleted ${data.deleted_count} item(s)`, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert('Error: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error deleting items:', error);
        showAlert('Error deleting items', 'danger');
    });
}

document.addEventListener('DOMContentLoaded', function() {
    // Select All checkboxes for PNX items (one per boards PO)
    document.querySelectorAll('.select-all-pnx').forEach(function(selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            const boardsPoId = this.getAttribute('data-boards-po-id');
            const checkboxes = document.querySelectorAll(`.pnx-item-checkbox[data-boards-po-id="${boardsPoId}"]`);
            checkboxes.forEach(cb => cb.checked = this.checked);
            updateDeleteButtonVisibility(boardsPoId);
        });
    });
    
    // Individual checkboxes for PNX items
    document.querySelectorAll('.pnx-item-checkbox').forEach(function(cb) {
        cb.addEventListener('change', function() {
            const boardsPoId = this.getAttribute('data-boards-po-id');
            updateDeleteButtonVisibility(boardsPoId);
        });
    });
    
    // Delete buttons for PNX items (one per boards PO)
    document.querySelectorAll('.btn-delete-selected').forEach(function(deleteBtn) {
        deleteBtn.addEventListener('click', deletePNXItems);
    });
});

function copyToClipboard(text, btn) {
    navigator.clipboard.writeText(text).then(() => {
        const icon = btn.querySelector('i');
        icon.className = 'bi bi-clipboard-check';
        btn.classList.add('copied');
        setTimeout(() => {
            icon.className = 'bi bi-clipboard';
            btn.classList.remove('copied');
        }, 1500);
    }).catch(() => {
        // Fallback for older browsers
        const el = document.createElement('textarea');
        el.value = text;
        document.body.appendChild(el);
        el.select();
        document.execCommand('copy');
        document.body.removeChild(el);
        const icon = btn.querySelector('i');
        icon.className = 'bi bi-clipboard-check';
        btn.classList.add('copied');
        setTimeout(() => {
            icon.className = 'bi bi-clipboard';
            btn.classList.remove('copied');
        }, 1500);
    });
}
</script>

{% endblock %}