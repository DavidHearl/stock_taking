{% extends 'base.html' %}
{% load static %}

{% block title %}Stock Take - {{ block.super }}{% endblock %}

{% block nav_schedules_active %}active{% endblock %}

{% block page_title %}Stock Take{% endblock %}
{% block page_actions %}
<button id="open-history-btn" class="btn btn-secondary btn-sm">
    <i class="bi bi-clock-history"></i> History
</button>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/schedules.css' %}">
{% endblock %}

{% block extra_js %}
<script>
function getCookie(name) {
    const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return m ? m.pop() : '';
}

document.addEventListener('DOMContentLoaded', function() {
    // ── Inline stock count update ──
    document.querySelectorAll('.count-input').forEach(function(input) {
        const itemId = input.dataset.itemId;
        const systemQty = parseInt(input.dataset.systemQty);

        input.addEventListener('input', function() {
            const row = input.closest('tr');
            const counted = parseInt(input.value) || 0;
            const variance = counted - systemQty;
            const varianceEl = row.querySelector('.variance-cell');
            varianceEl.textContent = variance;
            varianceEl.className = 'variance-cell' + (variance > 0 ? ' positive' : variance < 0 ? ' negative' : '');
        });
    });

    document.querySelectorAll('.save-count-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const row = btn.closest('tr');
            const itemId = btn.dataset.itemId;
            const input = row.querySelector('.count-input');
            const counted = parseInt(input.value) || 0;

            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-arrow-repeat spinning"></i>';

            fetch('{% url "update_stock_count" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: 'item_id=' + itemId + '&counted_quantity=' + counted
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    btn.innerHTML = '<i class="bi bi-check-lg"></i>';
                    btn.classList.add('saved');
                    row.querySelector('.system-qty').textContent = data.new_quantity;
                    row.querySelector('.variance-cell').textContent = '0';
                    row.querySelector('.variance-cell').className = 'variance-cell';
                    input.dataset.systemQty = data.new_quantity;

                    // Update last-checked
                    const checkedCell = row.querySelector('.last-checked');
                    if (checkedCell) checkedCell.textContent = 'Just now';

                    // Increment counters
                    updateCountedStats();
                } else {
                    btn.innerHTML = '<i class="bi bi-x-lg"></i>';
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(() => {
                btn.innerHTML = '<i class="bi bi-x-lg"></i>';
                alert('Network error');
            })
            .finally(() => {
                setTimeout(() => {
                    btn.disabled = false;
                    if (!btn.classList.contains('saved')) {
                        btn.innerHTML = '<i class="bi bi-check-lg"></i> Save';
                    }
                }, 2000);
            });
        });
    });


    function updateCountedStats() {
        const saved = document.querySelectorAll('.save-count-btn.saved');
        const statEl = document.getElementById('counted-today-stat');
        if (statEl) {
            statEl.textContent = parseInt(statEl.textContent) + 1;
        }
    }

    // Category accordion toggles
    document.querySelectorAll('.category-toggle').forEach(function(toggle) {
        toggle.addEventListener('click', function() {
            const target = document.getElementById(toggle.dataset.target);
            const icon = toggle.querySelector('.toggle-icon');
            if (target.style.display === 'none') {
                target.style.display = '';
                icon.classList.replace('bi-chevron-right', 'bi-chevron-down');
            } else {
                target.style.display = 'none';
                icon.classList.replace('bi-chevron-down', 'bi-chevron-right');
            }
        });
    });

    // Tab switching
    document.querySelectorAll('.stock-tab-btn').forEach(function(tab) {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.stock-tab-btn').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            const target = tab.dataset.tab;
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            document.getElementById(target).classList.add('active');
        });
    });

    // History modal
    const historyModal = document.getElementById('history-modal');
    document.getElementById('open-history-btn').addEventListener('click', function() {
        historyModal.classList.add('open');
        document.body.style.overflow = 'hidden';
    });
    document.getElementById('close-history-modal').addEventListener('click', function() {
        historyModal.classList.remove('open');
        document.body.style.overflow = '';
    });
    historyModal.addEventListener('click', function(e) {
        if (e.target === historyModal) {
            historyModal.classList.remove('open');
            document.body.style.overflow = '';
        }
    });

    // Activity log search
    const activitySearch = document.getElementById('activity-search');
    if (activitySearch) {
        activitySearch.addEventListener('input', function() {
            const query = this.value.toLowerCase().trim();
            const clearBtn = document.getElementById('activity-search-clear');
            clearBtn.style.display = query ? 'block' : 'none';
            const rows = document.querySelectorAll('#activity-log-table tbody tr');
            rows.forEach(function(row) {
                const sku = row.querySelector('.sku-text')?.textContent.toLowerCase() || '';
                const name = row.querySelector('.mobile-name')?.textContent.toLowerCase() || '';
                row.style.display = (sku.includes(query) || name.includes(query)) ? '' : 'none';
            });
        });
    }
});

function clearActivitySearch() {
    const input = document.getElementById('activity-search');
    input.value = '';
    input.dispatchEvent(new Event('input'));
    input.focus();
}

// ── Historical Adjustment ──
let haSelectedItemId = null;
let haMode = 'exact'; // 'exact' or 'adjust'

function setHAMode(mode) {
    haMode = mode;
    document.querySelectorAll('.ha-mode-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('ha-mode-' + mode).classList.add('active');
    const label = document.getElementById('ha-qty-label');
    const input = document.getElementById('ha-new-qty');
    if (mode === 'exact') {
        label.textContent = 'New Quantity';
        input.placeholder = '0';
        input.min = '0';
    } else {
        label.textContent = 'Adjust By (+/-)';
        input.placeholder = '+24 or -5';
        input.removeAttribute('min');
    }
}

function openHistoricalAdjustment() {
    const modal = document.getElementById('historical-adjustment-modal');
    modal.classList.add('open');
    document.body.style.overflow = 'hidden';
    // Default date to today
    document.getElementById('ha-effective-date').value = new Date().toISOString().split('T')[0];
    // Clear previous state
    clearHASelection();
    document.getElementById('ha-sku-input').value = '';
    document.getElementById('ha-new-qty').value = '';
    document.getElementById('ha-notes').value = '';
    document.getElementById('ha-result-message').style.display = 'none';
    setTimeout(() => document.getElementById('ha-sku-input').focus(), 100);
}

function closeHistoricalAdjustment() {
    const modal = document.getElementById('historical-adjustment-modal');
    modal.classList.remove('open');
    document.body.style.overflow = '';
}

function clearHASelection() {
    haSelectedItemId = null;
    document.getElementById('ha-selected-item').style.display = 'none';
    document.getElementById('ha-sku-input').style.display = '';
    document.getElementById('ha-sku-input').value = '';
    document.getElementById('ha-sku-input').focus();
}

// SKU search with debounce
let haSearchTimeout = null;
document.addEventListener('DOMContentLoaded', function() {
    const skuInput = document.getElementById('ha-sku-input');
    const resultsDiv = document.getElementById('ha-sku-results');

    if (skuInput) {
        skuInput.addEventListener('input', function() {
            clearTimeout(haSearchTimeout);
            const query = this.value.trim();
            if (query.length < 2) {
                resultsDiv.style.display = 'none';
                return;
            }
            haSearchTimeout = setTimeout(() => {
                fetch(`/api/product-search/?q=${encodeURIComponent(query)}`)
                    .then(r => r.json())
                    .then(data => {
                        if (data.results && data.results.length > 0) {
                            resultsDiv.innerHTML = data.results.map(item =>
                                `<div class="ha-result-item" style="padding: 10px 14px; cursor: pointer; border-bottom: 1px solid var(--border-color); transition: background 0.15s;" 
                                     onmouseover="this.style.background='var(--bg-secondary)'" 
                                     onmouseout="this.style.background=''"
                                     onclick="selectHAItem(${item.id}, '${item.sku.replace(/'/g, "\\'")}', '${(item.name || '').replace(/'/g, "\\'")}', ${item.quantity || 0})">
                                    <strong style="color: var(--primary-color);">${item.sku}</strong>
                                    <span style="margin-left: 8px; color: var(--text-secondary); font-size: 0.85rem;">${item.name || ''}</span>
                                    <span style="float: right; font-size: 0.8rem; color: var(--text-secondary);">Qty: ${item.quantity || 0}</span>
                                </div>`
                            ).join('');
                            resultsDiv.style.display = 'block';
                        } else {
                            resultsDiv.innerHTML = '<div style="padding: 12px 14px; color: var(--text-secondary);">No items found</div>';
                            resultsDiv.style.display = 'block';
                        }
                    });
            }, 300);
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!skuInput.contains(e.target) && !resultsDiv.contains(e.target)) {
                resultsDiv.style.display = 'none';
            }
        });
    }

    // Historical adjustment modal close handlers
    const haModal = document.getElementById('historical-adjustment-modal');
    if (haModal) {
        document.getElementById('close-historical-modal').addEventListener('click', closeHistoricalAdjustment);
        haModal.addEventListener('click', function(e) {
            if (e.target === haModal) closeHistoricalAdjustment();
        });
    }
});

function selectHAItem(id, sku, name, quantity) {
    haSelectedItemId = id;
    document.getElementById('ha-sku-input').style.display = 'none';
    document.getElementById('ha-sku-results').style.display = 'none';
    document.getElementById('ha-selected-sku').textContent = sku;
    document.getElementById('ha-selected-name').textContent = name;
    document.getElementById('ha-current-qty').textContent = quantity;
    document.getElementById('ha-selected-item').style.display = 'block';
    document.getElementById('ha-new-qty').focus();
}

function submitHistoricalAdjustment() {
    const sku = document.getElementById('ha-selected-sku').textContent;
    const newQty = document.getElementById('ha-new-qty').value;
    const effectiveDate = document.getElementById('ha-effective-date').value;
    const notes = document.getElementById('ha-notes').value;
    const resultMsg = document.getElementById('ha-result-message');
    const submitBtn = document.getElementById('ha-submit-btn');

    if (!haSelectedItemId || !sku) {
        resultMsg.style.display = 'block';
        resultMsg.style.background = 'var(--danger-bg, #fef2f2)';
        resultMsg.style.color = 'var(--danger-color, #dc2626)';
        resultMsg.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Please select a stock item first.';
        return;
    }
    if (newQty === '' || newQty === null) {
        resultMsg.style.display = 'block';
        resultMsg.style.background = 'var(--danger-bg, #fef2f2)';
        resultMsg.style.color = 'var(--danger-color, #dc2626)';
        resultMsg.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Please enter a quantity.';
        return;
    }
    if (!effectiveDate) {
        resultMsg.style.display = 'block';
        resultMsg.style.background = 'var(--danger-bg, #fef2f2)';
        resultMsg.style.color = 'var(--danger-color, #dc2626)';
        resultMsg.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Please select an effective date.';
        return;
    }

    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="bi bi-arrow-repeat spinning"></i> Applying...';

    fetch('{% url "historical_stock_adjustment" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            sku: sku,
            mode: haMode,
            value: parseInt(newQty),
            effective_date: effectiveDate,
            notes: notes
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            resultMsg.style.display = 'block';
            resultMsg.style.background = 'var(--success-bg, #f0fdf4)';
            resultMsg.style.color = 'var(--success-color, #16a34a)';
            resultMsg.innerHTML = `<i class="bi bi-check-circle"></i> <strong>${data.sku}</strong> adjusted from ${data.old_quantity} → ${data.new_quantity} (effective ${data.effective_date})`;
            // Reset for next adjustment
            setTimeout(() => {
                clearHASelection();
                document.getElementById('ha-new-qty').value = '';
                document.getElementById('ha-notes').value = '';
            }, 1500);
        } else {
            resultMsg.style.display = 'block';
            resultMsg.style.background = 'var(--danger-bg, #fef2f2)';
            resultMsg.style.color = 'var(--danger-color, #dc2626)';
            resultMsg.innerHTML = `<i class="bi bi-exclamation-triangle"></i> ${data.error}`;
        }
    })
    .catch(err => {
        resultMsg.style.display = 'block';
        resultMsg.style.background = 'var(--danger-bg, #fef2f2)';
        resultMsg.style.color = 'var(--danger-color, #dc2626)';
        resultMsg.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Network error. Please try again.';
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="bi bi-check-lg"></i> Apply Adjustment';
    });
}
</script>
{% endblock %}


{% block content %}
{% if user.is_authenticated %}
<div class="page-content">
    <!-- Header Bar -->
    <div class="stock-header-bar">
        <div class="stock-tab-group">
            <button type="button" class="stock-tab-btn tab-all active" data-tab="stock-panel">
                <i class="bi bi-box-seam"></i> Stock Items
                <span class="tab-count">{{ total_stock }}</span>
            </button>
            <button type="button" class="stock-tab-btn" data-tab="non-stock-panel">
                <i class="bi bi-archive"></i> Non-Stock
                <span class="tab-count">{{ total_non_stock }}</span>
            </button>
            <button type="button" class="stock-tab-btn" data-tab="raumplus-panel">
                <i class="bi bi-gear"></i> Raumplus
                <span class="tab-count">{{ total_raumplus }}</span>
            </button>
            <button type="button" class="stock-tab-btn" data-tab="categories-panel">
                <i class="bi bi-grid"></i> Categories
                <span class="tab-count">{{ categories|length }}</span>
            </button>
        </div>

        {% if unclassified_count > 0 %}
        <span class="unclassified-notice">
            <i class="bi bi-exclamation-triangle"></i> {{ unclassified_count }} unclassified
        </span>
        {% endif %}

        <div class="header-sep"></div>

        <!-- Actions (right-aligned) -->
        <div class="stock-header-actions">
            <button class="btn btn-secondary btn-sm" onclick="openHistoricalAdjustment()">
                <i class="bi bi-clock-history"></i> Historical Adjustment
            </button>
            <a href="{% url 'export_all_stock_pdf' %}" class="btn btn-primary btn-sm" target="_blank">
                <i class="bi bi-printer"></i> Print Sheet
            </a>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════ -->
    <!-- STOCK ITEMS PANEL                           -->
    <!-- ═══════════════════════════════════════════ -->
    <div id="stock-panel" class="tab-panel active">

        <!-- Everyday Plan -->
        <div class="schedule-card">
            <div class="schedule-card-header">
                <h2>Q{{ quarter_number }} Day {{ day_number }}/{{ total_days }}<span class="plan-sub">{{ total_plan_items }} items over {{ cycle_days }} days</span></h2>
                <div class="plan-controls">
                    {% if day_number > 1 %}
                    <a href="?day={{ day_number|add:"-1" }}" class="btn btn-sm btn-secondary"><i class="bi bi-chevron-left"></i></a>
                    {% endif %}
                    <span class="plan-info">{{ today_date }}</span>
                    {% if day_number < total_days %}
                    <a href="?day={{ day_number|add:"1" }}" class="btn btn-sm btn-secondary"><i class="bi bi-chevron-right"></i></a>
                    {% endif %}
                </div>
            </div>

            {% if todays_items %}
            <div class="count-table-wrap">
                <table class="count-table">
                    <thead>
                        <tr>
                            <th>SKU</th>
                            <th class="hide-mobile">Category</th>
                            <th class="hide-mobile">Location</th>
                            <th class="text-center hide-mobile">System Qty</th>
                            <th class="text-center">Count</th>
                            <th class="text-center">Variance</th>
                            <th class="text-center hide-mobile">Last Checked</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in todays_items %}
                        <tr class="stock-row{% if '_RAU_' in item.sku %} raumplus-highlight{% endif %}" id="item-{{ item.id }}">
                            <td class="sku-cell">
                                <span class="sku-text">{{ item.sku }}</span>
                                <span class="mobile-name">{{ item.name }}</span>
                            </td>
                            <td class="hide-mobile"><span class="cat-badge" {% if item.category %}style="border-left: 3px solid {{ item.category.color }}"{% endif %}>{{ item.category.name|default:"—" }}</span></td>
                            <td class="hide-mobile">{{ item.location }}</td>
                            <td class="text-center hide-mobile"><span class="system-qty">{{ item.quantity }}</span></td>
                            <td class="text-center">
                                <input type="number" class="count-input" data-item-id="{{ item.id }}" data-system-qty="{{ item.quantity }}" value="{{ item.quantity }}" min="0">
                            </td>
                            <td class="text-center"><span class="variance-cell">0</span></td>
                            <td class="text-center last-checked hide-mobile">
                                {% if item.last_checked %}
                                    {{ item.last_checked|timesince }} ago
                                {% else %}
                                    <span class="never-checked">Never</span>
                                {% endif %}
                            </td>
                            <td class="save-cell">
                                <button class="btn btn-sm btn-primary save-count-btn" data-item-id="{{ item.id }}">
                                    <i class="bi bi-check-lg"></i> <span class="hide-mobile">Save</span>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-state-icon"><i class="bi bi-check-circle"></i></div>
                <h5>No Items for Today</h5>
                <p>All stock items have been allocated to other days or none are classified as "Stock" yet.</p>
            </div>
            {% endif %}
        </div>

        <!-- Activity Log -->
        <div class="schedule-card">
            <div class="schedule-card-header">
                <button class="category-toggle" data-target="activity-log">
                    <i class="bi bi-chevron-right toggle-icon"></i>
                    <strong>Activity Log</strong>
                    <span class="cat-item-count">{{ recent_activity|length }} entries</span>
                </button>
            </div>
            {% if recent_activity %}
            <div id="activity-log" class="category-items" style="display: none;">
                <!-- Search -->
                <div class="activity-search-bar">
                    <i class="bi bi-search"></i>
                    <input type="text" id="activity-search" placeholder="Search by SKU or name..." autocomplete="off">
                    <button class="activity-search-clear" id="activity-search-clear" onclick="clearActivitySearch()">&times;</button>
                </div>
                <div class="activity-log-scroll">
                <table class="count-table" id="activity-log-table">
                    <thead>
                        <tr>
                            <th>SKU</th>
                            <th class="hide-mobile">Counted By</th>
                            <th class="hide-mobile">Type</th>
                            <th class="text-center">Qty</th>
                            <th class="text-center">Variance</th>
                            <th class="text-end">Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entry in recent_activity %}
                        <tr>
                            <td class="sku-cell">
                                <span class="sku-text">{{ entry.stock_item.sku }}</span>
                                <span class="mobile-name">{{ entry.stock_item.name }}</span>
                            </td>
                            <td class="hide-mobile">{{ entry.created_by.get_full_name|default:entry.created_by.username|default:"System" }}</td>
                            <td class="hide-mobile">
                                {% if entry.change_type == 'stock_take' %}
                                    <span class="badge" style="background: var(--primary-color); color: #fff; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px;">Stock Take</span>
                                {% elif entry.change_type == 'adjustment' %}
                                    <span class="badge" style="background: var(--warning-color); color: #000; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px;">Stock List</span>
                                {% else %}
                                    <span class="badge" style="background: var(--text-secondary); color: #fff; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px;">{{ entry.get_change_type_display }}</span>
                                {% endif %}
                            </td>
                            <td class="text-center">{{ entry.quantity }}</td>
                            <td class="text-center">
                                {% if entry.change_amount > 0 %}
                                    <span style="color: var(--success-color);">+{{ entry.change_amount }}</span>
                                {% elif entry.change_amount < 0 %}
                                    <span style="color: var(--danger-color);">{{ entry.change_amount }}</span>
                                {% else %}
                                    <span style="color: var(--text-secondary);">0</span>
                                {% endif %}
                            </td>
                            <td class="text-end" style="white-space: nowrap;">{{ entry.created_at|date:"d M Y" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                </div>
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-state-icon"><i class="bi bi-clock-history"></i></div>
                <h5>No Activity Yet</h5>
                <p>Stock take counts will appear here as items are counted.</p>
            </div>
            {% endif %}
        </div>

        <!-- Full Stock Inventory (collapsed by category) -->
        <div class="schedule-card">
            <div class="schedule-card-header">
                <h2>All Stock Items by Category</h2>
            </div>
            {% for cat_name, items in stock_by_category.items %}
            <div class="category-section">
                <button class="category-toggle" data-target="stock-cat-{{ forloop.counter }}">
                    <i class="bi bi-chevron-right toggle-icon"></i>
                    <strong>{{ cat_name }}</strong>
                    <span class="cat-item-count">{{ items|length }} items</span>
                </button>
                <div id="stock-cat-{{ forloop.counter }}" style="display: none;">
                    <div class="count-table-wrap">
                    <table class="count-table compact">
                        <thead>
                            <tr>
                                <th>SKU</th>
                                <th class="hide-mobile">Name</th>
                                <th class="hide-mobile">Location</th>
                                <th class="text-center hide-mobile">System Qty</th>
                                <th class="text-center">Count</th>
                                <th class="text-center">Variance</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in items %}
                            <tr class="stock-row">
                                <td class="sku-cell">
                                    <span class="sku-text">{{ item.sku }}</span>
                                    <span class="mobile-name">{{ item.name }}</span>
                                </td>
                                <td class="hide-mobile">{{ item.name }}</td>
                                <td class="hide-mobile">{{ item.location }}</td>
                                <td class="text-center hide-mobile"><span class="system-qty">{{ item.quantity }}</span></td>
                                <td class="text-center">
                                    <input type="number" class="count-input" data-item-id="{{ item.id }}" data-system-qty="{{ item.quantity }}" value="{{ item.quantity }}" min="0">
                                </td>
                                <td class="text-center"><span class="variance-cell">0</span></td>
                                <td class="save-cell">
                                    <button class="btn btn-sm btn-primary save-count-btn" data-item-id="{{ item.id }}">
                                        <i class="bi bi-check-lg"></i> <span class="hide-mobile">Save</span>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="empty-state">
                <div class="empty-state-icon"><i class="bi bi-box"></i></div>
                <h5>No Stock Items</h5>
                <p>No items are classified as "Stock" yet. Set the tracking type on individual products.</p>
            </div>
            {% endfor %}
        </div>

    </div>

    <!-- ═══════════════════════════════════════════ -->
    <!-- NON-STOCK ITEMS PANEL                       -->
    <!-- ═══════════════════════════════════════════ -->
    <div id="non-stock-panel" class="tab-panel">

        {% for cat_name, items in non_stock_by_category.items %}
        <div class="schedule-card">
            <div class="schedule-card-header">
                <h2>{{ cat_name }}</h2>
                <span class="cat-item-count">{{ items|length }} items</span>
            </div>
            <div class="count-table-wrap">
                <table class="count-table">
                    <thead>
                        <tr>
                            <th>SKU</th>
                            <th class="hide-mobile">Name</th>
                            <th class="hide-mobile">Location</th>
                            <th class="text-center hide-mobile">System Qty</th>
                            <th class="text-center">Count</th>
                            <th class="text-center">Variance</th>
                            <th class="text-center hide-mobile">Last Checked</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in items %}
                        <tr class="non-stock-row">
                            <td class="sku-cell">
                                <span class="sku-text">{{ item.sku }}</span>
                                <span class="mobile-name">{{ item.name }}</span>
                            </td>
                            <td class="hide-mobile">{{ item.name }}</td>
                            <td class="hide-mobile">{{ item.location }}</td>
                            <td class="text-center hide-mobile"><span class="system-qty">{{ item.quantity }}</span></td>
                            <td class="text-center">
                                <input type="number" class="count-input" data-item-id="{{ item.id }}" data-system-qty="{{ item.quantity }}" value="{{ item.quantity }}" min="0">
                            </td>
                            <td class="text-center"><span class="variance-cell">0</span></td>
                            <td class="text-center last-checked hide-mobile">
                                {% if item.last_checked %}
                                    {{ item.last_checked|timesince }} ago
                                {% else %}
                                    <span class="never-checked">Never</span>
                                {% endif %}
                            </td>
                            <td class="save-cell">
                                <button class="btn btn-sm btn-primary save-count-btn" data-item-id="{{ item.id }}">
                                    <i class="bi bi-check-lg"></i> <span class="hide-mobile">Save</span>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% empty %}
        <div class="schedule-card">
            <div class="empty-state">
                <div class="empty-state-icon"><i class="bi bi-archive"></i></div>
                <h5>No Non-Stock Items</h5>
                <p>No items are classified as "Non-Stock" yet. Set the tracking type on individual products.</p>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- ═══════════════════════════════════════════ -->
    <!-- RAUMPLUS PANEL                              -->
    <!-- ═══════════════════════════════════════════ -->
    <div id="raumplus-panel" class="tab-panel">

        {% for cat_name, items in raumplus_by_category.items %}
        <div class="schedule-card">
            <div class="schedule-card-header">
                <h2>{{ cat_name }}</h2>
                <span class="cat-item-count">{{ items|length }} items</span>
            </div>
            <div class="count-table-wrap">
                <table class="count-table">
                    <thead>
                        <tr>
                            <th>SKU</th>
                            <th class="hide-mobile">Name</th>
                            <th class="hide-mobile">Location</th>
                            <th class="text-center hide-mobile">System Qty</th>
                            <th class="text-center">Count</th>
                            <th class="text-center">Variance</th>
                            <th class="text-center hide-mobile">Last Checked</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in items %}
                        <tr class="raumplus-row">
                            <td class="sku-cell">
                                <span class="sku-text">{{ item.sku }}</span>
                                <span class="mobile-name">{{ item.name }}</span>
                            </td>
                            <td class="hide-mobile">{{ item.name }}</td>
                            <td class="hide-mobile">{{ item.location }}</td>
                            <td class="text-center hide-mobile"><span class="system-qty">{{ item.quantity }}</span></td>
                            <td class="text-center">
                                <input type="number" class="count-input" data-item-id="{{ item.id }}" data-system-qty="{{ item.quantity }}" value="{{ item.quantity }}" min="0">
                            </td>
                            <td class="text-center"><span class="variance-cell">0</span></td>
                            <td class="text-center last-checked hide-mobile">
                                {% if item.last_checked %}
                                    {{ item.last_checked|timesince }} ago
                                {% else %}
                                    <span class="never-checked">Never</span>
                                {% endif %}
                            </td>
                            <td class="save-cell">
                                <button class="btn btn-sm btn-primary save-count-btn" data-item-id="{{ item.id }}">
                                    <i class="bi bi-check-lg"></i> <span class="hide-mobile">Save</span>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% empty %}
        <div class="schedule-card">
            <div class="empty-state">
                <div class="empty-state-icon"><i class="bi bi-gear"></i></div>
                <h5>No Raumplus Items</h5>
                <p>Items with <code>_RAU_</code> in their SKU will appear here.</p>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- ═══════════════════════════════════════════ -->
    <!-- CATEGORIES PANEL                            -->
    <!-- ═══════════════════════════════════════════ -->
    <div id="categories-panel" class="tab-panel">

        {% for category in categories %}
        <div class="schedule-card">
            <div class="schedule-card-header">
                <h2>
                    {% if category.color %}<span class="cat-color-dot" style="background: {{ category.color }}"></span>{% endif %}
                    {{ category.name }}
                </h2>
                <div class="cat-header-meta">
                    <span class="cat-item-count">{{ category.item_count }} items</span>
                    {% if category.unassigned_items > 0 %}
                    <span class="cat-unassigned-badge">{{ category.unassigned_items }} unassigned</span>
                    {% endif %}
                </div>
            </div>
            {% if category.stock_take_groups.all %}
            <div class="cat-groups-list">
                {% for group in category.stock_take_groups.all %}
                <div class="cat-group-row">
                    <span class="group-badge" style="background: {{ group.color|default:'#6b7280' }}">{{ group.name }}</span>
                    <span class="group-item-count">{{ group.stock_items.count }} items</span>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="cat-no-groups">
                <span class="text-secondary">No stock take groups defined for this category</span>
            </div>
            {% endif %}
        </div>
        {% empty %}
        <div class="schedule-card">
            <div class="empty-state">
                <div class="empty-state-icon"><i class="bi bi-grid"></i></div>
                <h5>No Categories</h5>
                <p>Categories will appear here once stock items are imported and categorised.</p>
            </div>
        </div>
        {% endfor %}
    </div>

</div>

<!-- ═══════════════════════════════════════════ -->
<!-- HISTORY MODAL                               -->
<!-- ═══════════════════════════════════════════ -->
<div id="history-modal" class="history-modal-overlay">
    <div class="history-modal">
        <div class="history-modal-header">
            <h2><i class="bi bi-clock-history"></i> Completed Stock Takes</h2>
            <button id="close-history-modal" class="modal-close-btn"><i class="bi bi-x-lg"></i></button>
        </div>
        <div class="history-modal-stats">
            <div class="stat-box">
                <span class="stat-value">{{ completed_last_7 }}</span>
                <span class="stat-label">Last 7 Days</span>
            </div>
            <div class="stat-box">
                <span class="stat-value">{{ completed_last_30 }}</span>
                <span class="stat-label">Last 30 Days</span>
            </div>
            <div class="stat-box">
                <span class="stat-value">{{ completed_total }}</span>
                <span class="stat-label">All Time</span>
            </div>
        </div>
        <div class="history-modal-body">
            {% if completed_schedules %}
            <table class="count-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Groups</th>
                        <th>Assigned To</th>
                        <th>Completed</th>
                    </tr>
                </thead>
                <tbody>
                    {% for schedule in completed_schedules %}
                    <tr>
                        <td>
                            <strong>{{ schedule.name }}</strong>
                            {% if schedule.auto_generated %}<span class="badge badge-info">Auto</span>{% endif %}
                        </td>
                        <td>
                            <div class="groups-list">
                                {% for group in schedule.stock_take_groups.all %}
                                <span class="group-badge" style="background: {{ group.color|default:'#6b7280' }}">{{ group.name }}</span>
                                {% empty %}
                                <span class="text-secondary">—</span>
                                {% endfor %}
                            </div>
                        </td>
                        <td>{{ schedule.assigned_to|default:"—" }}</td>
                        <td class="last-checked">{{ schedule.completed_date|date:"d M Y" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="empty-state" style="padding: 40px 20px;">
                <div class="empty-state-icon"><i class="bi bi-clock-history"></i></div>
                <h5>No Completed Stock Takes</h5>
                <p>Completed stock take schedules will appear here.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

{% endif %}

<!-- Historical Adjustment Modal -->
<div id="historical-adjustment-modal" class="ha-modal-overlay">
    <div class="ha-modal">
        <div class="ha-modal-header">
            <h3 style="margin: 0; font-size: 1.1rem;"><i class="bi bi-clock-history"></i> Historical Stock Adjustment</h3>
            <button class="modal-close-btn" id="close-historical-modal"><i class="bi bi-x-lg"></i></button>
        </div>
        <div style="padding: 24px;">
            <div id="ha-search-group" style="margin-bottom: 16px; position: relative;">
                <label style="font-weight: 600; margin-bottom: 6px; display: block;">SKU</label>
                <input type="text" id="ha-sku-input" class="form-control" placeholder="Search by SKU or product name..." autocomplete="off">
                <div id="ha-sku-results" style="position: absolute; top: 100%; left: 0; right: 0; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 6px; max-height: 200px; overflow-y: auto; display: none; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15);"></div>
            </div>

            <div id="ha-selected-item" style="display: none; margin-bottom: 16px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border-color);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong id="ha-selected-sku" style="color: var(--primary-color);"></strong>
                        <span id="ha-selected-name" style="margin-left: 8px; color: var(--text-secondary);"></span>
                    </div>
                    <button class="btn btn-sm" onclick="clearHASelection()" style="padding: 2px 8px; font-size: 0.75rem;">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
                <div style="margin-top: 6px; font-size: 0.85rem; color: var(--text-secondary);">
                    Current stock: <strong id="ha-current-qty">0</strong>
                </div>
            </div>

            <div style="display: flex; gap: 4px; margin-bottom: 16px; background: var(--bg-primary); border-radius: 8px; padding: 4px; border: 1px solid var(--border-color);">
                <button type="button" class="btn btn-sm ha-mode-btn active" id="ha-mode-exact" onclick="setHAMode('exact')" style="flex: 1; border-radius: 6px;">
                    <i class="bi bi-bullseye"></i> Set Exact Qty
                </button>
                <button type="button" class="btn btn-sm ha-mode-btn" id="ha-mode-adjust" onclick="setHAMode('adjust')" style="flex: 1; border-radius: 6px;">
                    <i class="bi bi-plus-slash-minus"></i> Adjust By Amount
                </button>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                <div>
                    <label style="font-weight: 600; margin-bottom: 6px; display: block;" id="ha-qty-label">New Quantity</label>
                    <input type="number" id="ha-new-qty" class="form-control" placeholder="0">
                </div>
                <div>
                    <label style="font-weight: 600; margin-bottom: 6px; display: block;">Effective Date</label>
                    <input type="date" id="ha-effective-date" class="form-control">
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="font-weight: 600; margin-bottom: 6px; display: block;">Notes <span style="font-weight: 400; color: var(--text-secondary);">(optional)</span></label>
                <textarea id="ha-notes" class="form-control" rows="2" placeholder="Reason for adjustment..."></textarea>
            </div>

            <div id="ha-result-message" style="display: none; margin-bottom: 16px; padding: 12px; border-radius: 8px;"></div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeHistoricalAdjustment()">Cancel</button>
                <button class="btn btn-primary" id="ha-submit-btn" onclick="submitHistoricalAdjustment()">
                    <i class="bi bi-check-lg"></i> Apply Adjustment
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
