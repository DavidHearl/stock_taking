{% extends 'base.html' %}
{% load static %}

{% block title %}Stock Takes - {{ block.super }}{% endblock %}

{% block nav_schedules_active %}active{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/schedules.css' %}">
{% endblock %}

{% block extra_js %}
<script>
function getCookie(name) {
  const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
  return m ? m.pop() : '';
}

document.addEventListener('DOMContentLoaded', function() {
    // Delete schedule
    document.addEventListener('click', function(e) {
        if (e.target.closest('.delete-schedule-btn')) {
            e.preventDefault();
            const btn = e.target.closest('.delete-schedule-btn');
            const scheduleId = btn.dataset.id;
            
            if (confirm('Are you sure you want to delete this schedule?')) {
                fetch('{% url "delete_schedule" 0 %}'.replace('0', scheduleId), {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(() => location.reload())
                .catch(() => alert('Error deleting schedule.'));
            }
        }
    });
    
    // Edit schedule
    document.addEventListener('click', function(e) {
        if (e.target.closest('.edit-schedule-btn')) {
            e.preventDefault();
            const btn = e.target.closest('.edit-schedule-btn');
            
            // Populate the edit modal with current values
            document.getElementById('editScheduleId').value = btn.dataset.id;
            document.getElementById('editScheduleName').value = btn.dataset.name;
            document.getElementById('editScheduleDate').value = btn.dataset.date;
            document.getElementById('editScheduleDescription').value = btn.dataset.description || '';
            document.getElementById('editScheduleLocations').value = btn.dataset.locations || '';
            document.getElementById('editScheduleAssigned').value = btn.dataset.assigned || '';
            document.getElementById('editScheduleNotes').value = btn.dataset.notes || '';
            
            // Show the edit modal
            openModal('editScheduleModal');
        }
    });
    
    // Edit schedule form submission
    const editForm = document.getElementById('editScheduleForm');
    if (editForm) {
        editForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const scheduleId = document.getElementById('editScheduleId').value;
            const formData = new FormData(this);
            
            fetch('{% url "schedule_edit" 0 %}'.replace('0', scheduleId), {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error updating schedule: ' + data.error);
                }
            })
            .catch(() => alert('Error updating schedule.'));
        });
    }
});
</script>
{% endblock %}


{% block content %}
{% if user.is_authenticated %}
<div class="page-content">
    <div class="page-header">
        <h1>Stock Takes</h1>
        <button type="button" class="btn btn-primary" onclick="openModal('scheduleModal')">
            <i class="bi bi-plus-lg"></i> Add New Schedule
        </button>
    </div>

    <div class="stats-bar">
        <div class="stat-box">
            <span class="stat-value">{{ pending_count }}</span>
            <span class="stat-label">Pending</span>
        </div>
        <div class="stat-box">
            <span class="stat-value">{{ in_progress_count }}</span>
            <span class="stat-label">In Progress</span>
        </div>
        <div class="stat-box">
            <span class="stat-value">{{ completed_count }}</span>
            <span class="stat-label">Completed</span>
        </div>
        {% if auto_schedules_count > 0 %}
        <div class="stat-box">
            <span class="stat-value info">{{ auto_schedules_count }}</span>
            <span class="stat-label">Auto-generated</span>
        </div>
        {% endif %}
    </div>

    <div class="schedule-card">
        <div class="schedule-card-header">
            <h2>‚è±Ô∏è Pending Stock Takes</h2>
        </div>
        {% if pending_schedules %}
            {% include 'stock_take/schedule_table.html' with schedules=pending_schedules hide_description=True hide_assigned_to=True %}
        {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">‚úì</div>
                <h5>No Pending Schedules</h5>
                <p>All stock takes are either in progress or completed.</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Schedule Modal -->
<div class="modal" id="scheduleModal">
    <div class="modal-overlay" onclick="closeModal('scheduleModal')"></div>
    <div class="modal-dialog" style="max-width: 800px;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Schedule</h3>
                <button type="button" class="modal-close" onclick="closeModal('scheduleModal')">‚úï</button>
            </div>
            <form method="post" action="{% url 'schedule_create' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="scheduleName">Name</label>
                            <input type="text" class="form-input" id="scheduleName" name="name" required>
                        </div>
                        <div class="form-group">
                            <label for="scheduleDate">Scheduled Date</label>
                            <input type="datetime-local" class="form-input" id="scheduleDate" name="scheduled_date" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="scheduleDescription">Description</label>
                        <textarea class="form-textarea" id="scheduleDescription" name="description" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="scheduleGroups">Stock Take Groups</label>
                        <select class="form-select" id="scheduleGroups" name="stock_take_groups" multiple>
                            {% for group in stock_take_groups %}
                                <option value="{{ group.id }}">{{ group.category.name }} - {{ group.name }}</option>
                            {% endfor %}
                        </select>
                        <small class="form-text">Hold Ctrl/Cmd to select multiple groups</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('scheduleModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">üíæ Create Schedule</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Schedule Modal -->
<div class="modal" id="editScheduleModal">
    <div class="modal-overlay" onclick="closeModal('editScheduleModal')"></div>
    <div class="modal-dialog" style="max-width: 800px;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Schedule</h3>
                <button type="button" class="modal-close" onclick="closeModal('editScheduleModal')">‚úï</button>
            </div>
            <form id="editScheduleForm">
                {% csrf_token %}
                <input type="hidden" id="editScheduleId" name="schedule_id">
                <div class="modal-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editScheduleName">Name</label>
                            <input type="text" class="form-input" id="editScheduleName" name="name" required>
                        </div>
                        <div class="form-group">
                            <label for="editScheduleDate">Scheduled Date</label>
                            <input type="datetime-local" class="form-input" id="editScheduleDate" name="scheduled_date" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editScheduleDescription">Description</label>
                        <textarea class="form-textarea" id="editScheduleDescription" name="description" rows="3"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editScheduleLocations">Locations</label>
                            <input type="text" class="form-input" id="editScheduleLocations" name="locations" placeholder="Comma-separated locations">
                        </div>
                        <div class="form-group">
                            <label for="editScheduleAssigned">Assigned To</label>
                            <input type="text" class="form-input" id="editScheduleAssigned" name="assigned_to">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editScheduleNotes">Notes</label>
                        <textarea class="form-textarea" id="editScheduleNotes" name="notes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editScheduleModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">üíæ Update Schedule</button>
                </div>
            </form>
        </div>
    </div>
</div>
</div>
{% endif %}
{% endblock %}
