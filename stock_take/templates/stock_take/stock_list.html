{% extends 'base.html' %}
{% load static %}

{% block title %}Stock Management - {{ block.super }}{% endblock %}

{% block nav_stock_active %}active{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/stock_manager.css' %}">
{% endblock %}

{% block content %}
{% if user.is_authenticated %}

<!-- Page Header -->
<div class="page-header">
    <h1>Stock Management {% if query_time %}<small style="font-size: 0.5em; color: #6c757d;">Loaded in {{ query_time }}s</small>{% endif %}</h1>
    <div class="btn-group-inline">
        <button type="button" id="updateItemsBtn" class="btn btn-success" onclick="saveAllTrackingChanges()" style="display: none;">
            <i class="bi bi-save"></i> Update Items <span id="changesCount" class="badge badge-light">0</span>
        </button>
        <button type="button" class="btn btn-primary" onclick="openModal('importModal')">
            ðŸ“¤ Import CSV
        </button>
        <button type="button" class="btn btn-secondary" onclick="openModal('importHistoryModal')">
            <i class="bi bi-clock-history"></i> Import History
        </button>
    </div>
</div>

<!-- Recent Import Alert -->
{% if latest_import %}
<div class="alert alert-info">
    <strong>Most Recent Import:</strong>
    {{ latest_import.imported_at|date:"M d, Y H:i" }}
    <span class="import-filename">({{ latest_import.filename }})</span>
    <span class="badge badge-primary import-count">{{ latest_import.record_count }} items</span>
</div>
{% endif %}

<!-- Statistics Cards Grid -->
<div class="stats-grid">
    <div class="stats-card stats-card-success">
        <div class="stats-content">
            <div class="stats-label">In Stock</div>
            <div class="stats-number" id="in-stock-count">{{ in_stock_count }}</div>
        </div>
        <div class="stats-icon">âœ“</div>
    </div>
    
    <div class="stats-card stats-card-warning">
        <div class="stats-content">
            <div class="stats-label">Low Stock</div>
            <div class="stats-number" id="low-stock-count">{{ low_stock_count }}</div>
        </div>
        <div class="stats-icon">âš </div>
    </div>
    
    <div class="stats-card stats-card-danger">
        <div class="stats-content">
            <div class="stats-label">Out of Stock</div>
            <div class="stats-number" id="out-of-stock-count">{{ zero_quantity_count }}</div>
        </div>
        <div class="stats-icon">âœ—</div>
    </div>
    
    <div class="stats-card stats-card-primary">
        <div class="stats-content">
            <div class="stats-label">Non-Stock</div>
            <div class="stats-number" id="non-stock-count">{{ non_stock_count }}</div>
        </div>
        <div class="stats-icon"><i class="bi bi-box-seam"></i></div>
    </div>
    
    <div class="stats-card stats-card-wide stats-card-primary">
        <div class="stats-content">
            <div class="stats-label">Total Value</div>
            <div class="stats-number" id="total-value">Â£{{ total_value|floatformat:2 }}</div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="card">
    <div class="card-header">
        <i class="bi bi-funnel"></i>
        <span>Filters</span>
        <div class="form-group form-actions">
            <div class="btn-group-inline">
                <a href="{% url 'stock_list' %}" class="btn btn-secondary">Clear</a>
                <button type="submit" class="btn btn-primary">Filter</button>
            </div>
        </div>
    </div>
    <div class="card-body">
        <form method="get" class="filter-form">
            <div class="form-row">
                <div class="form-group">
                    <label for="search">Search</label>
                    <input type="text" id="search" name="search" 
                        value="{{ current_filters.search }}" placeholder="SKU, Name, Serial...">
                </div>
                <div class="form-group">
                    <label for="category">Category</label>
                    <select id="category" name="category">
                        <option value="">All Categories</option>
                        {% for category in categories %}
                            <option value="{{ category.id }}" {% if current_filters.category == category.id|stringformat:"s" %}selected{% endif %}>
                                {{ category.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <!-- <div class="form-group">
                    <label for="stock_take_group">Stock Take Group</label>
                    <select id="stock_take_group" name="stock_take_group">
                        <option value="">All Groups</option>
                        {% for group in stock_take_groups %}
                            <option value="{{ group.id }}" {% if current_filters.stock_take_group == group.id|stringformat:"s" %}selected{% endif %}>
                                {{ group.category.name }} - {{ group.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div> -->
                <div class="form-group">
                    <label for="tracking_type">Tracking Type</label>
                    <select id="tracking_type" name="tracking_type">
                        <option value="">All Types</option>
                        <option value="stock" {% if current_filters.tracking_type == 'stock' %}selected{% endif %}>Stock</option>
                        <option value="non-stock" {% if current_filters.tracking_type == 'non-stock' %}selected{% endif %}>Non-Stock</option>
                        <option value="not-classified" {% if current_filters.tracking_type == 'not-classified' %}selected{% endif %}>Not Classified</option>
                    </select>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Stock Items Table with Tabs -->
<div class="card">
    <div class="tabs">
        <div class="tab-nav">
            <button class="tab-button active" onclick="switchTab('in-stock')">
                âœ“ In Stock
                {% if in_stock_count %}
                    <span class="badge badge-success" id="in-stock-tab-count">{{ in_stock_count }}</span>
                {% endif %}
            </button>
            <button class="tab-button" onclick="switchTab('low-stock')">
                âš  Low Stock
                {% if low_stock_count %}
                    <span class="badge badge-warning" id="low-stock-tab-count">{{ low_stock_count }}</span>
                {% endif %}
            </button>
            <button class="tab-button" onclick="switchTab('out-of-stock')">
                âœ— Out of Stock
                {% if zero_quantity_count %}
                    <span class="badge badge-danger" id="out-of-stock-tab-count">{{ zero_quantity_count }}</span>
                {% endif %}
            </button>
            <button class="tab-button" onclick="switchTab('non-stock')">
                <i class="bi bi-box-seam"></i> Non-Stock
                {% if non_stock_count %}
                    <span class="badge badge-info" id="non-stock-tab-count">{{ non_stock_count }}</span>
                {% endif %}
            </button>
        </div>

        <div class="tab-content">
            <!-- In Stock Tab -->
            <div class="tab-panel active" id="in-stock">
                {% if in_stock_items %}
                    <table class="table">
                        <thead>
                            <tr>
                                <th>SKU</th>
                                <th>Name</th>
                                <th>Cost</th>
                                <th>Category</th>
                                <th>Tracking</th>
                                <th>Qty</th>
                                <th>Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in in_stock_items %}
                            <tr>
                                <td class="sku-cell" data-field="sku" data-id="{{ item.id }}">
                                    <a href="{% url 'product_detail' item.id %}" style="color: var(--primary-color); text-decoration: none;">
                                        {{ item.sku }}
                                    </a>
                                </td>
                                <td data-field="name" data-id="{{ item.id }}">{{ item.name }}</td>
                                <td class="text-right currency" data-field="cost" data-id="{{ item.id }}">Â£{{ item.cost|floatformat:2 }}</td>
                                <td>
                                    {% if item.category %}
                                        <span class="category-badge" style="background-color: {{ item.category.color }};">
                                            {{ item.category.name }}
                                        </span>
                                    {% else %}
                                        <span class="uncategorized">{{ item.category_name|default:"Uncategorized" }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <select class="tracking-select" data-field="tracking_type" data-id="{{ item.id }}" >
                                        <option value="stock" {% if item.tracking_type == 'stock' %}selected{% endif %}>Stock</option>
                                        <option value="non-stock" {% if item.tracking_type == 'non-stock' %}selected{% endif %}>Non-Stock</option>
                                        <option value="not-classified" {% if item.tracking_type == 'not-classified' %}selected{% endif %}>Not Classified</option>
                                    </select>
                                </td>
                                <td class="text-center" data-field="quantity" data-id="{{ item.id }}">{{ item.quantity }}</td>
                                <td class="text-right currency">Â£{{ item.total_value|floatformat:2 }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <div class="empty-state">
                        <div class="empty-icon">âœ“</div>
                        <p>No items with 10+ quantity found.</p>
                        {% if non_stock_items %}
                            <p class="text-muted">Some items matching your filter are in the Non-Stock tab.</p>
                        {% endif %}
                    </div>
                {% endif %}
            </div>

            <!-- Low Stock Tab -->
            <div class="tab-panel" id="low-stock">
                {% if low_stock_items %}
                    <table class="table">
                        <thead>
                            <tr>
                                <th>SKU</th>
                                <th>Name</th>
                                <th>Cost</th>
                                <th>Category</th>
                                <th>Tracking</th>
                                <th>Qty</th>
                                <th>Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in low_stock_items %}
                            <tr>
                                <td class="sku-cell" data-field="sku" data-id="{{ item.id }}">
                                    <a href="{% url 'product_detail' item.id %}" style="color: var(--primary-color); text-decoration: none;">
                                        {{ item.sku }}
                                    </a>
                                </td>
                                <td data-field="name" data-id="{{ item.id }}">{{ item.name }}</td>
                                <td class="text-right currency" data-field="cost" data-id="{{ item.id }}">Â£{{ item.cost|floatformat:2 }}</td>
                                <td>
                                    {% if item.category %}
                                        <span class="category-badge" style="background-color: {{ item.category.color }};">
                                            {{ item.category.name }}
                                        </span>
                                    {% else %}
                                        <span class="uncategorized">{{ item.category_name|default:"Uncategorized" }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <select class="tracking-select" data-field="tracking_type" data-id="{{ item.id }}" >
                                        <option value="stock" {% if item.tracking_type == 'stock' %}selected{% endif %}>Stock</option>
                                        <option value="non-stock" {% if item.tracking_type == 'non-stock' %}selected{% endif %}>Non-Stock</option>
                                        <option value="not-classified" {% if item.tracking_type == 'not-classified' %}selected{% endif %}>Not Classified</option>
                                    </select>
                                </td>
                                <td class="text-center" data-field="quantity" data-id="{{ item.id }}">{{ item.quantity }}</td>
                                <td class="text-right currency">Â£{{ item.total_value|floatformat:2 }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <div class="empty-state">
                        <div class="empty-icon">âš </div>
                        <p>No low stock items found.</p>
                        {% if non_stock_items %}
                            <p class="text-muted">Some items matching your filter are in the Non-Stock tab.</p>
                        {% endif %}
                    </div>
                {% endif %}
            </div>

            <!-- Out of Stock Tab -->
            <div class="tab-panel" id="out-of-stock">
                {% if zero_quantity_items %}
                    <table class="table">
                        <thead>
                            <tr>
                                <th>SKU</th>
                                <th>Name</th>
                                <th>Cost</th>
                                <th>Category</th>
                                <th>Tracking</th>
                                <th>Qty</th>
                                <th>Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in zero_quantity_items %}
                            <tr>
                                <td class="sku-cell" data-field="sku" data-id="{{ item.id }}">
                                    <a href="{% url 'product_detail' item.id %}" style="color: var(--primary-color); text-decoration: none;">
                                        {{ item.sku }}
                                    </a>
                                </td>
                                <td data-field="name" data-id="{{ item.id }}">{{ item.name }}</td>
                                <td class="text-right currency" data-field="cost" data-id="{{ item.id }}">Â£{{ item.cost|floatformat:2 }}</td>
                                <td>
                                    {% if item.category %}
                                        <span class="category-badge" style="background-color: {{ item.category.color }};">
                                            {{ item.category.name }}
                                        </span>
                                    {% else %}
                                        <span class="uncategorized">{{ item.category_name|default:"Uncategorized" }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <select class="tracking-select" data-field="tracking_type" data-id="{{ item.id }}" >
                                        <option value="stock" {% if item.tracking_type == 'stock' %}selected{% endif %}>Stock</option>
                                        <option value="non-stock" {% if item.tracking_type == 'non-stock' %}selected{% endif %}>Non-Stock</option>
                                        <option value="not-classified" {% if item.tracking_type == 'not-classified' %}selected{% endif %}>Not Classified</option>
                                    </select>
                                </td>
                                <td class="text-center" data-field="quantity" data-id="{{ item.id }}">{{ item.quantity }}</td>
                                <td class="text-right currency">Â£{{ item.total_value|floatformat:2 }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <div class="empty-state">
                        <div class="empty-icon">âœ—</div>
                        <p>No out of stock items found.</p>
                        {% if non_stock_items %}
                            <p class="text-muted">Some items matching your filter are in the Non-Stock tab.</p>
                        {% endif %}
                    </div>
                {% endif %}
            </div>

            <!-- Non-Stock Tab -->
            <div class="tab-panel" id="non-stock">
                {% if non_stock_items %}
                    <table class="table">
                        <thead>
                            <tr>
                                <th>SKU</th>
                                <th>Name</th>
                                <th>Cost</th>
                                <th>Category</th>
                                <th>Tracking</th>
                                <th>Qty</th>
                                <th>Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in non_stock_items %}
                            <tr>
                                <td class="sku-cell" data-field="sku" data-id="{{ item.id }}">
                                    <a href="{% url 'product_detail' item.id %}" style="color: var(--primary-color); text-decoration: none;">
                                        {{ item.sku }}
                                    </a>
                                </td>
                                <td data-field="name" data-id="{{ item.id }}">{{ item.name }}</td>
                                <td class="text-right currency" data-field="cost" data-id="{{ item.id }}">Â£{{ item.cost|floatformat:2 }}</td>
                                <td>
                                    {% if item.category %}
                                        <span class="category-badge" style="background-color: {{ item.category.color }};">
                                            {{ item.category.name }}
                                        </span>
                                    {% else %}
                                        <span class="uncategorized">{{ item.category_name|default:"Uncategorized" }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <select class="tracking-select" data-field="tracking_type" data-id="{{ item.id }}" >
                                        <option value="stock" {% if item.tracking_type == 'stock' %}selected{% endif %}>Stock</option>
                                        <option value="non-stock" {% if item.tracking_type == 'non-stock' %}selected{% endif %}>Non-Stock</option>
                                        <option value="not-classified" {% if item.tracking_type == 'not-classified' %}selected{% endif %}>Not Classified</option>
                                    </select>
                                </td>
                                <td class="text-center" data-field="quantity" data-id="{{ item.id }}">{{ item.quantity }}</td>
                                <td class="text-right currency">Â£{{ item.total_value|floatformat:2 }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <div class="empty-state">
                        <div class="empty-icon"><i class="bi bi-inbox"></i></div>
                        <p>No non-stock items found. Use the tracking dropdown to classify items as non-stock.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Empty State -->
{% if not in_stock_items and not low_stock_items and not zero_quantity_items and not non_stock_items %}
<div class="empty-state-large">
    <div class="empty-icon">ðŸ“¦</div>
    <h3>No Items Found</h3>
    <p>No items match your current filters.</p>
    <a href="{% url 'stock_list' %}" class="btn btn-primary">Clear Filters</a>
</div>
{% endif %}

<!-- Import Modal -->
<div class="modal" id="importModal">
    <div class="modal-overlay" onclick="closeModal('importModal')"></div>
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Import CSV File</h3>
                <button type="button" class="modal-close" onclick="closeModal('importModal')">&times;</button>
            </div>
            <form method="post" action="{% url 'import_csv' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <strong>Warning:</strong> This will delete all existing stock data and replace it with the imported data.
                    </div>
                    <div class="form-group">
                        <label for="csv_file">Choose CSV File</label>
                        <input type="file" id="csv_file" name="csv_file" accept=".csv" required>
                    </div>
                    <div class="alert alert-info">
                        <strong>CSV Format:</strong> Sku, Name, Cost, Category, Location, Quantity, SerialOrBatch
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('importModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Import Data</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Restock Modal -->
<div class="modal" id="restockModal">
    <div class="modal-overlay" onclick="closeModal('restockModal')"></div>
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Restock Item</h3>
                <button type="button" class="modal-close" onclick="closeModal('restockModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p>Enter the new quantity for: <strong id="restockItemName"></strong></p>
                <div class="form-group">
                    <label for="restockQuantity">New Quantity</label>
                    <input type="number" id="restockQuantity" min="1" value="1">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('restockModal')">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmRestock">Update Stock</button>
            </div>
        </div>
    </div>
</div>

<!-- Import History Modal -->
<div id="importHistoryModal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h2>Import History</h2>
            <span class="close" onclick="closeModal('importHistoryModal')">&times;</span>
        </div>
        <div class="modal-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Import Date</th>
                            <th>Filename</th>
                            <th>Records</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for import in import_history %}
                        <tr id="import-row-{{ import.id }}">
                            <td>{{ import.imported_at|date:"Y-m-d H:i" }}</td>
                            <td>{{ import.filename }}</td>
                            <td>{{ import.record_count }}</td>
                            <td>
                                <button class="btn btn-danger btn-sm" onclick="deleteImport({{ import.id }}, '{{ import.filename }}')">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="text-center">No import history found</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal('importHistoryModal')">Close</button>
        </div>
    </div>
</div>

{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// Track pending tracking type changes
const pendingChanges = new Map();

// Track when a tracking type dropdown changes
function trackChange(selectElement) {
    const itemId = selectElement.getAttribute('data-id');
    const originalValue = selectElement.getAttribute('data-original');
    const newValue = selectElement.value;
    
    if (originalValue !== newValue) {
        // Mark as changed
        pendingChanges.set(itemId, newValue);
        selectElement.style.borderColor = '#ffc107';
        selectElement.style.borderWidth = '2px';
    } else {
        // Revert to original
        pendingChanges.delete(itemId);
        selectElement.style.borderColor = '';
        selectElement.style.borderWidth = '';
    }
    
    // Update button visibility and count
    updateSaveButton();
}

// Update the save button visibility and count
function updateSaveButton() {
    const btn = document.getElementById('updateItemsBtn');
    const countBadge = document.getElementById('changesCount');
    
    if (pendingChanges.size > 0) {
        btn.style.display = 'inline-block';
        countBadge.textContent = pendingChanges.size;
    } else {
        btn.style.display = 'none';
    }
}

// Save all tracking type changes
function saveAllTrackingChanges() {
    if (pendingChanges.size === 0) return;
    
    const btn = document.getElementById('updateItemsBtn');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    // Disable button and show loading state
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Updating...';
    
    // Create array of promises for all updates
    const updatePromises = Array.from(pendingChanges.entries()).map(([itemId, trackingType]) => {
        return fetch(`/update/${itemId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrfToken
            },
            body: `tracking_type=${encodeURIComponent(trackingType)}&csrfmiddlewaretoken=${encodeURIComponent(csrfToken)}`
        });
    });
    
    // Wait for all updates to complete
    Promise.all(updatePromises)
        .then(responses => {
            const allSuccessful = responses.every(r => r.ok);
            
            if (allSuccessful) {
                // Show success notification
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
                alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                alertDiv.innerHTML = `
                    <i class="bi bi-check-circle"></i> ${pendingChanges.size} item(s) updated successfully! Reloading...
                    <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
                `;
                document.body.appendChild(alertDiv);
                
                // Reload page to reflect changes
                setTimeout(() => location.reload(), 1000);
            } else {
                throw new Error('Some updates failed');
            }
        })
        .catch(error => {
            // Show error notification
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed';
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                <i class="bi bi-exclamation-triangle"></i> Error updating items. Please try again.
                <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
            `;
            document.body.appendChild(alertDiv);
            
            // Re-enable button
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-save"></i> Update Items <span id="changesCount" class="badge badge-light">' + pendingChanges.size + '</span>';
        });
}

// Tab switching functionality
function switchTab(tabId) {
    // Hide all tab panels
    document.querySelectorAll('.tab-panel').forEach(panel => {
        panel.classList.remove('active');
    });
    
    // Remove active from all buttons
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
    });
    
    // Show selected tab panel
    document.getElementById(tabId).classList.add('active');
    
    // Add active to clicked button
    event.target.closest('.tab-button').classList.add('active');
}

// Update stats based on visible items after filtering
function updateStats() {
    // Count visible items in each tab
    const inStockCount = document.querySelectorAll('#in-stock tbody tr').length;
    const lowStockCount = document.querySelectorAll('#low-stock tbody tr').length;
    const outOfStockCount = document.querySelectorAll('#out-of-stock tbody tr').length;
    const nonStockCount = document.querySelectorAll('#non-stock tbody tr').length;
    
    // Update stats cards
    document.getElementById('in-stock-count').textContent = inStockCount;
    document.getElementById('low-stock-count').textContent = lowStockCount;
    document.getElementById('out-of-stock-count').textContent = outOfStockCount;
    document.getElementById('non-stock-count').textContent = nonStockCount;
    
    // Update tab badges
    const inStockBadge = document.getElementById('in-stock-tab-count');
    const lowStockBadge = document.getElementById('low-stock-tab-count');
    const outOfStockBadge = document.getElementById('out-of-stock-tab-count');
    const nonStockBadge = document.getElementById('non-stock-tab-count');
    
    if (inStockBadge) inStockBadge.textContent = inStockCount;
    if (lowStockBadge) lowStockBadge.textContent = lowStockCount;
    if (outOfStockBadge) outOfStockBadge.textContent = outOfStockCount;
    if (nonStockBadge) nonStockBadge.textContent = nonStockCount;
    
    // Calculate total value from visible items
    let totalValue = 0;
    document.querySelectorAll('.tab-panel tbody tr').forEach(row => {
        const valueCell = row.querySelector('.currency:last-child');
        if (valueCell) {
            const value = parseFloat(valueCell.textContent.replace('Â£', '').replace(',', ''));
            if (!isNaN(value)) {
                totalValue += value;
            }
        }
    });
    
    document.getElementById('total-value').textContent = 'Â£' + totalValue.toFixed(2);
}

// Update counts on page load and convert tracking selects to manual save mode
document.addEventListener('DOMContentLoaded', function() {
    // Convert all tracking selects to use trackChange instead of updateTrackingType
    document.querySelectorAll('.tracking-select').forEach(select => {
        // Store original value
        select.setAttribute('data-original', select.value);
        // Add change event listener
        select.addEventListener('change', function() {
            trackChange(this);
        });
    });
    
    // Update stats initially
    updateStats();
    
    // Watch for filter form submission
    const filterForm = document.querySelector('.filter-form');
    if (filterForm) {
        // Stats will update on page reload after filter submit
    }
});

// Delete import function for modal
function deleteImport(importId, filename) {
    if (confirm(`Are you sure you want to delete the import record for "${filename}"?`)) {
        fetch(`/stock/delete-import/${importId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove the row from the table
                const row = document.getElementById(`import-row-${importId}`);
                if (row) {
                    row.remove();
                }
                // Show success message
                alert('Import record deleted successfully');
                // If no more rows, show empty message
                const tbody = document.querySelector('#importHistoryModal tbody');
                if (tbody && tbody.querySelectorAll('tr').length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center">No import history found</td></tr>';
                }
            } else {
                alert('Error deleting import: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting import');
        });
    }
}

</script>
{% endblock %}
