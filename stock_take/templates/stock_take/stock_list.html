{% extends 'base.html' %}
{% load static %}

{% block title %}Stock Management - {{ block.super }}{% endblock %}

{% block nav_stock_active %}active{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/stock_manager.css' %}">
{% endblock %}

{% block content %}
{% if user.is_authenticated %}

<!-- Page Header -->
<div class="page-header">
    <h1>Stock Management</h1>
    <button type="button" class="btn btn-primary" onclick="openModal('importModal')">
        ðŸ“¤ Import CSV
    </button>
</div>

<!-- Recent Import Alert -->
{% if latest_import %}
<div class="alert alert-info">
    <strong>Most Recent Import:</strong>
    {{ latest_import.imported_at|date:"M d, Y H:i" }}
    <span class="import-filename">({{ latest_import.filename }})</span>
    <span class="badge badge-primary import-count">{{ latest_import.record_count }} items</span>
</div>
{% endif %}

<!-- Statistics Cards Grid -->
<div class="stats-grid">
    <div class="stats-card stats-card-success">
        <div class="stats-content">
            <div class="stats-label">In Stock</div>
            <div class="stats-number" id="in-stock-count">{{ in_stock_count }}</div>
        </div>
        <div class="stats-icon">âœ“</div>
    </div>
    
    <div class="stats-card stats-card-warning">
        <div class="stats-content">
            <div class="stats-label">Low Stock</div>
            <div class="stats-number" id="low-stock-count">{{ low_stock_count }}</div>
        </div>
        <div class="stats-icon">âš </div>
    </div>
    
    <div class="stats-card stats-card-danger">
        <div class="stats-content">
            <div class="stats-label">Out of Stock</div>
            <div class="stats-number" id="out-of-stock-count">{{ zero_quantity_count }}</div>
        </div>
        <div class="stats-icon">âœ—</div>
    </div>
    
    <div class="stats-card stats-card-info">
        <div class="stats-content">
            <div class="stats-label">Non-Stock</div>
            <div class="stats-number" id="non-stock-count">0</div>
        </div>
        <div class="stats-icon"><i class="bi bi-box-seam"></i></div>
    </div>
    
    <div class="stats-card stats-card-wide stats-card-primary">
        <div class="stats-content">
            <div class="stats-label">Total Value</div>
            <div class="stats-number" id="total-value">Â£{{ total_value|floatformat:2 }}</div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="card">
    <div class="card-header">
        <i class="bi bi-funnel"></i> Filters
    </div>
    <div class="card-body">
        <form method="get" class="filter-form">
            <div class="form-row">
                <div class="form-group">
                    <label for="search">Search</label>
                    <input type="text" id="search" name="search" 
                        value="{{ current_filters.search }}" placeholder="SKU, Name, Serial...">
                </div>
                <div class="form-group">
                    <label for="category">Category</label>
                    <select id="category" name="category">
                        <option value="">All Categories</option>
                        {% for category in categories %}
                            <option value="{{ category.id }}" {% if current_filters.category == category.id|stringformat:"s" %}selected{% endif %}>
                                {{ category.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="stock_take_group">Stock Take Group</label>
                    <select id="stock_take_group" name="stock_take_group">
                        <option value="">All Groups</option>
                        {% for group in stock_take_groups %}
                            <option value="{{ group.id }}" {% if current_filters.stock_take_group == group.id|stringformat:"s" %}selected{% endif %}>
                                {{ group.category.name }} - {{ group.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group form-actions">
                    <label>&nbsp;</label>
                    <div class="btn-group-inline">
                        <button type="submit" class="btn btn-primary">Filter</button>
                        <a href="{% url 'stock_list' %}" class="btn btn-secondary">Clear</a>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Stock Items Table with Tabs -->
<div class="card">
    <div class="tabs">
        <div class="tab-nav">
            <button class="tab-button active" onclick="switchTab('in-stock')">
                âœ“ In Stock
                {% if in_stock_count %}
                    <span class="badge badge-success" id="in-stock-tab-count">{{ in_stock_count }}</span>
                {% endif %}
            </button>
            <button class="tab-button" onclick="switchTab('low-stock')">
                âš  Low Stock
                {% if low_stock_count %}
                    <span class="badge badge-warning" id="low-stock-tab-count">{{ low_stock_count }}</span>
                {% endif %}
            </button>
            <button class="tab-button" onclick="switchTab('out-of-stock')">
                âœ— Out of Stock
                {% if zero_quantity_count %}
                    <span class="badge badge-danger" id="out-of-stock-tab-count">{{ zero_quantity_count }}</span>
                {% endif %}
            </button>
            <button class="tab-button" onclick="switchTab('non-stock')">
                <i class="bi bi-box-seam"></i> Non-Stock
                <span class="badge badge-info" id="non-stock-tab-count">0</span>
            </button>
        </div>

        <div class="tab-content">
            <!-- In Stock Tab -->
            <div class="tab-panel active" id="in-stock">
                {% if in_stock_items %}
                    <table class="table">
                        <thead>
                            <tr>
                                <th>SKU</th>
                                <th>Name</th>
                                <th>Cost</th>
                                <th>Category</th>
                                <th>Qty</th>
                                <th>Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in in_stock_items %}
                            <tr>
                                <td class="sku-cell" data-field="sku" data-id="{{ item.id }}">{{ item.sku }}</td>
                                <td data-field="name" data-id="{{ item.id }}">{{ item.name }}</td>
                                <td class="text-right currency" data-field="cost" data-id="{{ item.id }}">Â£{{ item.cost|floatformat:2 }}</td>
                                <td>
                                    {% if item.category %}
                                        <span class="category-badge" style="background-color: {{ item.category.color }};">
                                            {{ item.category.name }}
                                        </span>
                                    {% else %}
                                        <span class="uncategorized">{{ item.category_name|default:"Uncategorized" }}</span>
                                    {% endif %}
                                </td>
                                <td class="text-center" data-field="quantity" data-id="{{ item.id }}">{{ item.quantity }}</td>
                                <td class="text-right currency">Â£{{ item.total_value|floatformat:2 }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <div class="empty-state">
                        <div class="empty-icon">âœ“</div>
                        <p>All items are in stock!</p>
                    </div>
                {% endif %}
            </div>

            <!-- Low Stock Tab -->
            <div class="tab-panel" id="low-stock">
                {% if low_stock_items %}
                    <table class="table">
                        <thead>
                            <tr>
                                <th>SKU</th>
                                <th>Name</th>
                                <th>Cost</th>
                                <th>Category</th>
                                <th>Qty</th>
                                <th>Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in low_stock_items %}
                            <tr>
                                <td class="sku-cell" data-field="sku" data-id="{{ item.id }}">{{ item.sku }}</td>
                                <td data-field="name" data-id="{{ item.id }}">{{ item.name }}</td>
                                <td class="text-right currency" data-field="cost" data-id="{{ item.id }}">Â£{{ item.cost|floatformat:2 }}</td>
                                <td>
                                    {% if item.category %}
                                        <span class="category-badge" style="background-color: {{ item.category.color }};">
                                            {{ item.category.name }}
                                        </span>
                                    {% else %}
                                        <span class="uncategorized">{{ item.category_name|default:"Uncategorized" }}</span>
                                    {% endif %}
                                </td>
                                <td class="text-center" data-field="quantity" data-id="{{ item.id }}">{{ item.quantity }}</td>
                                <td class="text-right currency">Â£{{ item.total_value|floatformat:2 }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <div class="empty-state">
                        <div class="empty-icon">âš </div>
                        <p>No low stock items!</p>
                    </div>
                {% endif %}
            </div>

            <!-- Out of Stock Tab -->
            <div class="tab-panel" id="out-of-stock">
                {% if zero_quantity_items %}
                    <table class="table">
                        <thead>
                            <tr>
                                <th>SKU</th>
                                <th>Name</th>
                                <th>Cost</th>
                                <th>Category</th>
                                <th>Qty</th>
                                <th>Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in zero_quantity_items %}
                            <tr>
                                <td class="sku-cell" data-field="sku" data-id="{{ item.id }}">{{ item.sku }}</td>
                                <td data-field="name" data-id="{{ item.id }}">{{ item.name }}</td>
                                <td class="text-right currency" data-field="cost" data-id="{{ item.id }}">Â£{{ item.cost|floatformat:2 }}</td>
                                <td>
                                    {% if item.category %}
                                        <span class="category-badge" style="background-color: {{ item.category.color }};">
                                            {{ item.category.name }}
                                        </span>
                                    {% else %}
                                        <span class="uncategorized">{{ item.category_name|default:"Uncategorized" }}</span>
                                    {% endif %}
                                </td>
                                <td class="text-center" data-field="quantity" data-id="{{ item.id }}">{{ item.quantity }}</td>
                                <td class="text-right currency">Â£{{ item.total_value|floatformat:2 }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <div class="empty-state">
                        <div class="empty-icon">âœ—</div>
                        <p>No out of stock items!</p>
                    </div>
                {% endif %}
            </div>

            <!-- Non-Stock Tab -->
            <div class="tab-panel" id="non-stock">
                <div class="empty-state">
                    <div class="empty-icon"><i class="bi bi-inbox"></i></div>
                    <p>Non-stock items feature coming soon!</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Empty State -->
{% if not in_stock_items and not low_stock_items and not zero_quantity_items %}
<div class="empty-state-large">
    <div class="empty-icon">ðŸ“¦</div>
    <h3>No Items Found</h3>
    <p>No items match your current filters.</p>
    <a href="{% url 'stock_list' %}" class="btn btn-primary">Clear Filters</a>
</div>
{% endif %}

<!-- Import Modal -->
<div class="modal" id="importModal">
    <div class="modal-overlay" onclick="closeModal('importModal')"></div>
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Import CSV File</h3>
                <button type="button" class="modal-close" onclick="closeModal('importModal')">&times;</button>
            </div>
            <form method="post" action="{% url 'import_csv' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <strong>Warning:</strong> This will delete all existing stock data and replace it with the imported data.
                    </div>
                    <div class="form-group">
                        <label for="csv_file">Choose CSV File</label>
                        <input type="file" id="csv_file" name="csv_file" accept=".csv" required>
                    </div>
                    <div class="alert alert-info">
                        <strong>CSV Format:</strong> Sku, Name, Cost, Category, Location, Quantity, SerialOrBatch
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('importModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Import Data</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Restock Modal -->
<div class="modal" id="restockModal">
    <div class="modal-overlay" onclick="closeModal('restockModal')"></div>
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Restock Item</h3>
                <button type="button" class="modal-close" onclick="closeModal('restockModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p>Enter the new quantity for: <strong id="restockItemName"></strong></p>
                <div class="form-group">
                    <label for="restockQuantity">New Quantity</label>
                    <input type="number" id="restockQuantity" min="1" value="1">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('restockModal')">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmRestock">Update Stock</button>
            </div>
        </div>
    </div>
</div>

{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// Tab switching functionality
function switchTab(tabId) {
    // Hide all tab panels
    document.querySelectorAll('.tab-panel').forEach(panel => {
        panel.classList.remove('active');
    });
    
    // Remove active from all buttons
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
    });
    
    // Show selected tab panel
    document.getElementById(tabId).classList.add('active');
    
    // Add active to clicked button
    event.target.closest('.tab-button').classList.add('active');
}

// Update tab counts based on visible filtered items
function updateTabCounts() {
    const inStockRows = document.querySelectorAll('#in-stock tbody tr').length;
    const lowStockRows = document.querySelectorAll('#low-stock tbody tr').length;
    const outOfStockRows = document.querySelectorAll('#out-of-stock tbody tr').length;
    const nonStockRows = document.querySelectorAll('#non-stock tbody tr').length;
    
    document.getElementById('in-stock-tab-count').textContent = inStockRows;
    document.getElementById('low-stock-tab-count').textContent = lowStockRows;
    document.getElementById('out-of-stock-tab-count').textContent = outOfStockRows;
    document.getElementById('non-stock-tab-count').textContent = nonStockRows;
}

// Update counts on page load
document.addEventListener('DOMContentLoaded', function() {
    updateTabCounts();
});
</script>
{% endblock %}