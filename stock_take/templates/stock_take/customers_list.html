{% extends 'base.html' %}
{% load static %}

{% block title %}Customers{% endblock %}

{% block nav_stock_active %}active{% endblock %}
{% block nav_customers_active %}active{% endblock %}

{% block page_title %}
Customers
<button class="btn btn-add-customer" onclick="document.getElementById('add-customer-modal').style.display='flex'" style="margin-left: 12px; padding: 4px 10px; font-size: 0.75rem; border-radius: 6px; border: 1px solid var(--primary-color); background: transparent; color: var(--primary-color); cursor: pointer; display: inline-flex; align-items: center; gap: 4px; vertical-align: middle; transition: all 0.2s;">
    <i class="bi bi-plus-lg"></i> Add Customer
</button>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/customers.css' %}">
{% endblock %}

{% block content %}
<div class="content-card">
    <!-- Search & Filters -->
    <div class="customers-controls">
        <div class="customers-search">
            <div class="search-input-wrapper">
                <i class="bi bi-search"></i>
                <input type="text" id="customer-search" value="{{ search_query }}" placeholder="Search by name, email, phone, city or postcode..." autocomplete="off">
            </div>
        </div>
        <div class="customers-filter-tabs">
            <a href="?age=9m{% if search_query %}&q={{ search_query }}{% endif %}" class="filter-tab {% if age_filter == '9m' %}active{% endif %}">
                &lt; 9 Months ({{ count_9m }})
            </a>
            <a href="?age=2y{% if search_query %}&q={{ search_query }}{% endif %}" class="filter-tab {% if age_filter == '2y' %}active{% endif %}">
                &lt; 2 Years ({{ count_2y }})
            </a>
            <a href="?age=10y{% if search_query %}&q={{ search_query }}{% endif %}" class="filter-tab {% if age_filter == '10y' %}active{% endif %}">
                &lt; 10 Years ({{ count_10y }})
            </a>
            <a href="?age=over10{% if search_query %}&q={{ search_query }}{% endif %}" class="filter-tab {% if age_filter == 'over10' %}active{% endif %}">
                Over 10 Years ({{ count_over10 }})
            </a>
        </div>
        {% if location_filter %}
        <div class="customers-location-badge">
            <i class="bi bi-geo-alt-fill"></i> {{ location_filter }}
        </div>
        {% endif %}
    </div>

    {% if search_expanded_from %}
    <div class="search-expanded-notice">
        <i class="bi bi-info-circle"></i>
        No results in current bracket — showing results found in 
        <strong>
            {% if search_expanded_from == '9m' %}&lt; 9 Months
            {% elif search_expanded_from == '2y' %}&lt; 2 Years
            {% elif search_expanded_from == '10y' %}&lt; 10 Years
            {% elif search_expanded_from == 'over10' %}Over 10 Years
            {% endif %}
        </strong>
    </div>
    {% endif %}

    {% if search_by_bracket %}
    <!-- Grouped search results across all brackets -->
    <div class="customers-result-bar">
        <div class="bulk-actions-bar" id="bulk-actions-bar" style="display:none;">
            <span id="selected-count">0 selected</span>
            <button class="merge-btn" id="merge-btn" onclick="mergeCustomers()" style="display:none;" title="Merge selected customers">
                <i class="bi bi-arrow-left-right"></i> Merge
            </button>
            <button class="bulk-delete-btn" onclick="bulkDelete()">
                <i class="bi bi-trash"></i> Delete Selected
            </button>
        </div>
    </div>
    {% for bracket in search_by_bracket %}
    <div class="bracket-separator">
        <span class="bracket-label">{{ bracket.label }}</span>
        <span class="bracket-count">{{ bracket.count }} result{{ bracket.count|pluralize }}</span>
    </div>
    <div class="customers-table-container">
        <table class="customers-table">
            <thead>
                <tr>
                    <th class="checkbox-col"><input type="checkbox" class="select-all-bracket" data-bracket="{{ bracket.key }}" onclick="toggleSelectAllBracket(this, '{{ bracket.key }}')"></th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>City</th>
                    <th>Postcode</th>
                    <th>Orders</th>
                    <th>Active</th>
                    <th class="text-center">Xero</th>
                    <th class="text-right">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for customer in bracket.customers %}
                <tr data-id="{{ customer.pk }}" data-bracket="{{ bracket.key }}">
                    <td class="checkbox-col"><input type="checkbox" class="row-select" value="{{ customer.pk }}" onclick="updateSelection()"></td>
                    <td>
                        <a href="{% url 'customer_detail' customer.pk %}" class="customer-name-link">
                            {{ customer.name|default:customer|default:"-" }}
                        </a>
                    </td>
                    <td>
                        {% if customer.email %}
                        <a href="mailto:{{ customer.email }}" class="customer-email">{{ customer.email }}</a>
                        {% else %}-{% endif %}
                    </td>
                    <td>{{ customer.phone|default:"-" }}</td>
                    <td>{{ customer.city|default:"-" }}</td>
                    <td>{{ customer.postcode|default:"-" }}</td>
                    <td class="customer-orders-cell">
                        {% for order in customer.orders.all %}
                        <a href="{% url 'order_details' order.id %}" class="customer-order-badge" title="{{ order.get_order_type_display }}">{{ order.sale_number }}</a>
                        {% empty %}-
                        {% endfor %}
                    </td>
                    <td>
                        {% if customer.is_active %}
                        <span class="customer-active-badge active">Active</span>
                        {% else %}
                        <span class="customer-active-badge inactive">Inactive</span>
                        {% endif %}
                    </td>
                    <td class="text-center xero-status-cell">
                        {% if customer.xero_id %}
                        <i class="bi bi-check-circle-fill xero-linked" title="Linked to Xero"></i>
                        {% else %}
                        <i class="bi bi-x-circle xero-unlinked" title="Not in Xero"></i>
                        {% endif %}
                    </td>
                    <td class="text-right">
                        <button class="customer-delete-btn" onclick="deleteCustomer({{ customer.pk }}, '{{ customer.name|escapejs }}')" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endfor %}

    {% elif customers %}
    <div class="customers-result-bar">
        <div class="bulk-actions-bar" id="bulk-actions-bar" style="display:none;">
            <span id="selected-count">0 selected</span>
            <button class="merge-btn" id="merge-btn" onclick="mergeCustomers()" style="display:none;" title="Merge selected customers">
                <i class="bi bi-arrow-left-right"></i> Merge
            </button>
            <button class="bulk-delete-btn" onclick="bulkDelete()">
                <i class="bi bi-trash"></i> Delete Selected
            </button>
        </div>
    </div>
    <div class="customers-table-container">
        <table class="customers-table">
            <thead>
                <tr>
                    <th class="checkbox-col"><input type="checkbox" id="select-all" onclick="toggleSelectAll(this)"></th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>City</th>
                    <th>Postcode</th>
                    <th>Orders</th>
                    <th>Active</th>
                    <th class="text-center">Xero</th>
                    <th class="text-right">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for customer in customers %}
                <tr data-id="{{ customer.pk }}" data-has-details="{{ customer.workguru_id|yesno:'1,0' }}" data-search="{{ customer.name|lower }} {{ customer.email|lower }} {{ customer.phone|lower }} {{ customer.city|lower }} {{ customer.postcode|lower }}">
                    <td class="checkbox-col"><input type="checkbox" class="row-select" value="{{ customer.pk }}" onclick="updateSelection()"></td>
                    <td>
                        <a href="{% url 'customer_detail' customer.pk %}" class="customer-name-link">
                            {{ customer.name|default:customer|default:"-" }}
                        </a>
                    </td>
                    <td>
                        {% if customer.email %}
                        <a href="mailto:{{ customer.email }}" class="customer-email">{{ customer.email }}</a>
                        {% else %}-{% endif %}
                    </td>
                    <td>{{ customer.phone|default:"-" }}</td>
                    <td>{{ customer.city|default:"-" }}</td>
                    <td>{{ customer.postcode|default:"-" }}</td>
                    <td class="customer-orders-cell">
                        {% for order in customer.orders.all %}
                        <a href="{% url 'order_details' order.id %}" class="customer-order-badge" title="{{ order.get_order_type_display }}">{{ order.sale_number }}</a>
                        {% empty %}-
                        {% endfor %}
                    </td>
                    <td>
                        {% if customer.is_active %}
                        <span class="customer-active-badge active">Active</span>
                        {% else %}
                        <span class="customer-active-badge inactive">Inactive</span>
                        {% endif %}
                    </td>
                    <td class="text-center xero-status-cell">
                        {% if customer.xero_id %}
                        <i class="bi bi-check-circle-fill xero-linked" title="Linked to Xero"></i>
                        {% else %}
                        <i class="bi bi-x-circle xero-unlinked" title="Not in Xero"></i>
                        {% endif %}
                    </td>
                    <td class="text-right">
                        <button class="customer-delete-btn" onclick="deleteCustomer({{ customer.pk }}, '{{ customer.name|escapejs }}')" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="customers-empty-state">
        <i class="bi bi-people"></i>
        <p>No customers found.</p>
    </div>
    {% endif %}

    <!-- Pagination -->
    {% if page_obj and page_obj.paginator.num_pages > 1 %}
    <div class="customers-pagination">
        <div class="pagination-info">
            Showing {{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ page_obj.paginator.count }} customers
        </div>
        <div class="pagination-controls">
            {% if page_obj.has_previous %}
            <a href="?page=1&age={{ age_filter }}{% if search_query %}&q={{ search_query }}{% endif %}" class="page-btn" title="First">&laquo;</a>
            <a href="?page={{ page_obj.previous_page_number }}&age={{ age_filter }}{% if search_query %}&q={{ search_query }}{% endif %}" class="page-btn" title="Previous">&lsaquo;</a>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                    <span class="page-btn active">{{ num }}</span>
                {% elif num > page_obj.number|add:'-4' and num < page_obj.number|add:'4' %}
                    <a href="?page={{ num }}&age={{ age_filter }}{% if search_query %}&q={{ search_query }}{% endif %}" class="page-btn">{{ num }}</a>
                {% elif num == 1 or num == page_obj.paginator.num_pages %}
                    <a href="?page={{ num }}&age={{ age_filter }}{% if search_query %}&q={{ search_query }}{% endif %}" class="page-btn">{{ num }}</a>
                {% elif num == page_obj.number|add:'-4' or num == page_obj.number|add:'4' %}
                    <span class="page-ellipsis">&hellip;</span>
                {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}&age={{ age_filter }}{% if search_query %}&q={{ search_query }}{% endif %}" class="page-btn" title="Next">&rsaquo;</a>
            <a href="?page={{ page_obj.paginator.num_pages }}&age={{ age_filter }}{% if search_query %}&q={{ search_query }}{% endif %}" class="page-btn" title="Last">&raquo;</a>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Add Customer Modal -->
<div class="modal-overlay" id="add-customer-modal" style="display:none;" onclick="if(event.target===this)this.style.display='none'">
    <div class="modal-box">
        <div class="modal-header">
            <h2><i class="bi bi-person-plus"></i> Add New Customer</h2>
            <button class="modal-close" onclick="document.getElementById('add-customer-modal').style.display='none'">&times;</button>
        </div>
        <form method="POST" action="{% url 'customer_create' %}">
            {% csrf_token %}
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group" style="flex: 0 0 100px;">
                        <label for="cust-title">Title</label>
                        <select id="cust-title" name="title">
                            <option value="">—</option>
                            <option value="Mr">Mr</option>
                            <option value="Mrs">Mrs</option>
                            <option value="Ms">Ms</option>
                            <option value="Miss">Miss</option>
                            <option value="Dr">Dr</option>
                            <option value="Prof">Prof</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="cust-first-name">First Name <span class="required">*</span></label>
                        <input type="text" id="cust-first-name" name="first_name" required placeholder="First name">
                    </div>
                    <div class="form-group">
                        <label for="cust-last-name">Last Name <span class="required">*</span></label>
                        <input type="text" id="cust-last-name" name="last_name" required placeholder="Last name">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="cust-email">Email</label>
                        <input type="email" id="cust-email" name="email" placeholder="email@example.com">
                    </div>
                    <div class="form-group">
                        <label for="cust-phone">Phone</label>
                        <input type="text" id="cust-phone" name="phone" placeholder="Phone number">
                    </div>
                </div>
                <div class="form-group">
                    <label for="cust-website">Website</label>
                    <input type="url" id="cust-website" name="website" placeholder="https://...">
                </div>
                <div class="form-group">
                    <label for="cust-address">Address</label>
                    <input type="text" id="cust-address" name="address_1" placeholder="Street address">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="cust-city">City</label>
                        <input type="text" id="cust-city" name="city" placeholder="City">
                    </div>
                    <div class="form-group">
                        <label for="cust-postcode">Postcode</label>
                        <input type="text" id="cust-postcode" name="postcode" placeholder="Postcode">
                    </div>
                    <div class="form-group">
                        <label for="cust-country">Country</label>
                        <input type="text" id="cust-country" name="country" placeholder="Country">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="document.getElementById('add-customer-modal').style.display='none'">Cancel</button>
                <button type="submit" class="btn-save">Create Customer</button>
            </div>
        </form>
    </div>
</div>

<!-- Merge Customer Modal -->
<div class="modal-overlay" id="merge-modal" style="display:none;" onclick="if(event.target===this)this.style.display='none'">
    <div class="modal-box">
        <div class="modal-header">
            <h2><i class="bi bi-arrow-left-right"></i> Merge Customers</h2>
            <button class="modal-close" onclick="document.getElementById('merge-modal').style.display='none'">&times;</button>
        </div>
        <div class="modal-body">
            <p style="margin-bottom: 16px;">Choose which customer to <strong>keep</strong>. The other customer's orders and data will be transferred into the kept customer, then the other will be deleted.</p>
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <label style="display: flex; align-items: center; gap: 10px; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: border-color 0.2s;">
                    <input type="radio" name="merge-keep" id="merge-option-0" value="" onchange="this.closest('.modal-body').querySelectorAll('label').forEach(l=>l.style.borderColor='var(--border-color)'); this.closest('label').style.borderColor='var(--primary-color)';">
                    <div>
                        <strong>Keep: <span id="merge-option-0-name"></span></strong>
                        <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 2px;">Delete &amp; merge in: <span id="merge-option-0-remove"></span></div>
                    </div>
                </label>
                <label style="display: flex; align-items: center; gap: 10px; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: border-color 0.2s;">
                    <input type="radio" name="merge-keep" id="merge-option-1" value="" onchange="this.closest('.modal-body').querySelectorAll('label').forEach(l=>l.style.borderColor='var(--border-color)'); this.closest('label').style.borderColor='var(--primary-color)';">
                    <div>
                        <strong>Keep: <span id="merge-option-1-name"></span></strong>
                        <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 2px;">Delete &amp; merge in: <span id="merge-option-1-remove"></span></div>
                    </div>
                </label>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-cancel" onclick="document.getElementById('merge-modal').style.display='none'">Cancel</button>
            <button type="button" class="btn-save" onclick="executeMerge()">Merge</button>
        </div>
    </div>
</div>

<script>
// --- Server-side search with debounce ---
const searchInput = document.getElementById('customer-search');
let searchTimeout;
if (searchInput) {
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            const query = this.value.trim();
            const params = new URLSearchParams(window.location.search);
            if (query) {
                params.set('q', query);
            } else {
                params.delete('q');
            }
            params.delete('page'); // reset to page 1 on search
            // preserve age and loc filters
            if (!params.has('age')) params.set('age', '{{ age_filter }}');
            if (!params.has('loc') && '{{ location_filter }}') params.set('loc', '{{ location_filter }}');
            window.location.href = '?' + params.toString();
        }, 500);
    });
    searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            clearTimeout(searchTimeout);
            const query = this.value.trim();
            const params = new URLSearchParams(window.location.search);
            if (query) {
                params.set('q', query);
            } else {
                params.delete('q');
            }
            params.delete('page');
            if (!params.has('age')) params.set('age', '{{ age_filter }}');
            if (!params.has('loc') && '{{ location_filter }}') params.set('loc', '{{ location_filter }}');
            window.location.href = '?' + params.toString();
        }
    });
    searchInput.focus();
}

function clearSelectionAndReload() {
    document.querySelectorAll('.row-select').forEach(cb => cb.checked = false);
    const sa = document.getElementById('select-all');
    if (sa) { sa.checked = false; sa.indeterminate = false; }
    location.reload();
}

// --- Merge logic ---
function checkMergeEligibility() {
    const mergeBtn = document.getElementById('merge-btn');
    if (!mergeBtn) return;
    const checked = document.querySelectorAll('.row-select:checked');
    // Show merge button whenever exactly 2 customers are selected
    mergeBtn.style.display = checked.length === 2 ? 'inline-flex' : 'none';
}

function mergeCustomers() {
    const checked = document.querySelectorAll('.row-select:checked');
    if (checked.length !== 2) return;
    const rows = Array.from(checked).map(cb => cb.closest('tr'));
    const name0 = rows[0].querySelector('td:nth-child(2)').textContent.trim();
    const name1 = rows[1].querySelector('td:nth-child(2)').textContent.trim();
    const id0 = parseInt(rows[0].getAttribute('data-id'));
    const id1 = parseInt(rows[1].getAttribute('data-id'));

    // Show merge modal to let user choose which to keep
    const modal = document.getElementById('merge-modal');
    document.getElementById('merge-option-0-name').textContent = name0;
    document.getElementById('merge-option-1-name').textContent = name1;
    document.getElementById('merge-option-0').value = id0;
    document.getElementById('merge-option-1').value = id1;
    document.getElementById('merge-option-0-remove').textContent = name1;
    document.getElementById('merge-option-1-remove').textContent = name0;
    document.getElementById('merge-option-0').checked = true;
    modal.style.display = 'flex';
}

function executeMerge() {
    const selected = document.querySelector('input[name="merge-keep"]:checked');
    if (!selected) return;
    const keepId = parseInt(selected.value);
    const otherId = parseInt(selected.value) === parseInt(document.getElementById('merge-option-0').value)
        ? parseInt(document.getElementById('merge-option-1').value)
        : parseInt(document.getElementById('merge-option-0').value);

    document.getElementById('merge-modal').style.display = 'none';

    fetch('{% url "customer_merge" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ keep_id: keepId, remove_id: otherId }),
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            clearSelectionAndReload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(err => alert('Network error: ' + err.message));
}

function deleteCustomer(id, name) {
    if (!confirm('Delete customer "' + name + '"?')) return;

    fetch('/customer/' + id + '/delete/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        },
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            clearSelectionAndReload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(err => alert('Network error: ' + err.message));
}

function toggleSelectAll(el) {
    document.querySelectorAll('.row-select').forEach(cb => cb.checked = el.checked);
    updateSelection();
}

function toggleSelectAllBracket(el, bracketKey) {
    const rows = document.querySelectorAll(`tr[data-bracket="${bracketKey}"] .row-select`);
    rows.forEach(cb => cb.checked = el.checked);
    updateSelection();
}

function updateSelection() {
    const checked = document.querySelectorAll('.row-select:checked');
    const bar = document.getElementById('bulk-actions-bar');
    const countEl = document.getElementById('selected-count');
    const selectAll = document.getElementById('select-all');
    const allBoxes = document.querySelectorAll('.row-select');

    if (checked.length > 0) {
        bar.style.display = 'flex';
        countEl.textContent = checked.length + ' selected';
    } else {
        bar.style.display = 'none';
    }
    selectAll.checked = allBoxes.length > 0 && checked.length === allBoxes.length;
    selectAll.indeterminate = checked.length > 0 && checked.length < allBoxes.length;
    checkMergeEligibility();
}

function bulkDelete() {
    const ids = Array.from(document.querySelectorAll('.row-select:checked')).map(cb => parseInt(cb.value));
    if (ids.length === 0) return;
    if (!confirm('Delete ' + ids.length + ' customer(s)? This cannot be undone.')) return;

    fetch('{% url "customers_bulk_delete" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ids: ids}),
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            clearSelectionAndReload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(err => alert('Network error: ' + err.message));
}
</script>
{% endblock %}
