{% extends 'base.html' %}
{% load static humanize %}

{% block title %}Invoices{% endblock %}
{% block page_title %}Invoices{% endblock %}

{% block nav_invoices_active %}active{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/invoices.css' %}">
{% endblock %}

{% block content %}

<!-- Sync Bar -->
<div class="inv-sync-bar">
    <div class="inv-sync-info">
        {% if last_sync %}
        <span class="inv-sync-label">Last synced: {{ last_sync|date:"d M Y H:i" }}</span>
        {% else %}
        <span class="inv-sync-label">Never synced</span>
        {% endif %}
    </div>
    <div class="inv-sync-actions">
        <button class="inv-sync-btn" id="add-invoice-btn" onclick="toggleAddInvoiceModal()">
            <i class="bi bi-plus-lg"></i>
            <span>Add Invoice</span>
        </button>
        <button class="inv-sync-btn secondary" id="full-sync-btn" onclick="syncInvoices(true)" title="Re-sync all invoices including payment data">
            <i class="bi bi-arrow-clockwise"></i>
            <span>Full Resync</span>
        </button>
        <button class="inv-sync-btn" id="sync-btn" onclick="syncInvoices(false)">
            <i class="bi bi-arrow-repeat" id="sync-icon"></i>
            <span id="sync-text">Sync Invoices</span>
        </button>
    </div>
</div>

<!-- Sync Progress -->
<div class="inv-sync-progress" id="sync-progress" style="display:none;">
    <div class="inv-sync-progress-inner">
        <div class="spinner"></div>
        <span id="sync-message">Syncing invoices...</span>
    </div>
    <div class="inv-sync-log" id="sync-log"></div>
</div>

<!-- Stats Bar -->
<div class="inv-stats-bar">
    <div class="inv-stat-card">
        <span class="stat-label">Total Invoices</span>
        <span class="stat-value primary">{{ total_invoices|intcomma }}</span>
    </div>
    <div class="inv-stat-card">
        <span class="stat-label">Total Value</span>
        <span class="stat-value">£{{ total_value|floatformat:2|intcomma }}</span>
    </div>
    <div class="inv-stat-card">
        <span class="stat-label">Outstanding</span>
        <span class="stat-value {% if total_outstanding > 0 %}danger{% else %}success{% endif %}">£{{ total_outstanding|floatformat:2|intcomma }}</span>
    </div>
    <div class="inv-stat-card">
        <span class="stat-label">Paid</span>
        <span class="stat-value success">£{{ total_paid|floatformat:2|intcomma }}</span>
    </div>
    <div class="inv-stat-card">
        <span class="stat-label">Overdue</span>
        <span class="stat-value {% if overdue_count > 0 %}danger{% else %}success{% endif %}">{{ overdue_count }}</span>
    </div>
</div>

<!-- Filter Bar -->
<div class="inv-filter-bar">
    <div class="inv-search-box">
        <form method="get" action="">
            {% if status_filter != 'all' %}
            <input type="hidden" name="status" value="{{ status_filter }}">
            {% endif %}
            <input type="text" name="q" value="{{ search_query }}" placeholder="  Search invoices..." autocomplete="off">
        </form>
    </div>
</div>

<!-- Status Tabs -->
<div class="inv-tabs">
    <a href="?{% if search_query %}q={{ search_query }}&{% endif %}status=all" 
       class="inv-tab {% if status_filter == 'all' %}active{% endif %}">
        All ({{ total_invoices }})
    </a>
    <a href="?{% if search_query %}q={{ search_query }}&{% endif %}status=unpaid" 
       class="inv-tab {% if status_filter == 'unpaid' %}active{% endif %}">
        Unpaid ({{ unpaid_count }})
    </a>
    <a href="?{% if search_query %}q={{ search_query }}&{% endif %}status=draft" 
       class="inv-tab {% if status_filter == 'draft' %}active{% endif %}">
        Draft
    </a>
    <a href="?{% if search_query %}q={{ search_query }}&{% endif %}status=approved" 
       class="inv-tab {% if status_filter == 'approved' %}active{% endif %}">
        Approved
    </a>
    <a href="?{% if search_query %}q={{ search_query }}&{% endif %}status=sent" 
       class="inv-tab {% if status_filter == 'sent' %}active{% endif %}">
        Sent
    </a>
</div>

<!-- Invoices Table -->
<div class="inv-table-container">
    {% if invoices %}
    <table class="inv-table" id="invoices-table">
        <thead>
            <tr>
                <th>Invoice #</th>
                <th>Client</th>
                <th>Project</th>
                <th>Date</th>
                <th>Due Date</th>
                <th>Status</th>
                <th style="text-align: right;">Total</th>
                <th style="text-align: right;">Outstanding</th>
                <th>Payment</th>
                <th style="width:30px;"></th>
            </tr>
        </thead>
        <tbody>
            {% for invoice in invoices %}
            <tr onclick="window.location='{% url 'invoice_detail' invoice.id %}'" style="cursor:pointer;">
                <td>
                    <a href="{% url 'invoice_detail' invoice.id %}" class="inv-number">{{ invoice.invoice_number }}</a>
                </td>
                <td>
                    <span class="inv-client" title="{{ invoice.client_name }}">{{ invoice.client_name }}</span>
                </td>
                <td>
                    {% if invoice.project_number %}
                    <span class="inv-project">{{ invoice.project_number }}</span>
                    {% endif %}
                </td>
                <td>
                    {% if invoice.date %}
                    {{ invoice.date|date:"d M Y" }}
                    {% else %}
                    —
                    {% endif %}
                </td>
                <td>
                    {% if invoice.due_date %}
                    <span {% if invoice.is_overdue %}style="color: #dc3545; font-weight: 600;"{% endif %}>
                        {{ invoice.due_date|date:"d M Y" }}
                    </span>
                    {% else %}
                    —
                    {% endif %}
                </td>
                <td>
                    <span class="inv-status {{ invoice.status|lower }}">{{ invoice.status }}</span>
                </td>
                <td class="number-cell">
                    £{{ invoice.total|floatformat:2|intcomma }}
                </td>
                <td class="number-cell">
                    {% if invoice.amount_outstanding > 0 %}
                    <span style="color: #dc3545;">£{{ invoice.amount_outstanding|floatformat:2|intcomma }}</span>
                    {% else %}
                    <span style="color: #28a745;">£0.00</span>
                    {% endif %}
                </td>
                <td>
                    {% if invoice.is_overdue %}
                    <span class="inv-payment overdue">Overdue</span>
                    {% elif invoice.payment_status == 'paid' %}
                    <span class="inv-payment paid">Paid</span>
                    {% elif invoice.payment_status == 'partial' %}
                    <span class="inv-payment partial">Partial</span>
                    {% else %}
                    <span class="inv-payment unpaid">Unpaid</span>
                    {% endif %}
                </td>
                <td style="text-align:center;">
                    {% if invoice.attachment %}
                    <i class="bi bi-paperclip" style="color:var(--primary-color);" title="Has attachment"></i>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="inv-empty">
        <i class="bi bi-receipt"></i>
        <p>No invoices found{% if not last_sync %} — click <strong>Sync Invoices</strong> to import{% endif %}</p>
    </div>
    {% endif %}
</div>

<!-- Add Invoice Modal -->
<div class="modal-overlay" id="add-invoice-modal" style="display:none;" onclick="closeAddInvoiceModal(event)">
    <div class="modal-dialog" style="max-width: 520px;" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3><i class="bi bi-plus-lg"></i> Add Invoice</h3>
            <button class="modal-close" onclick="closeAddInvoiceModal()">&times;</button>
        </div>
        <div class="modal-body" style="display: flex; flex-direction: column; gap: 12px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <div>
                    <label style="font-size:0.82rem;font-weight:600;margin-bottom:4px;display:block;">Invoice Number *</label>
                    <input type="text" id="new-inv-number" placeholder="e.g. INV-001"
                           style="width:100%;padding:8px 10px;border:1px solid var(--border-color);border-radius:6px;background:var(--bg-primary);color:var(--text-primary);font-size:0.9rem;">
                </div>
                <div>
                    <label style="font-size:0.82rem;font-weight:600;margin-bottom:4px;display:block;">Client Name</label>
                    <input type="text" id="new-inv-client" placeholder="Client name"
                           style="width:100%;padding:8px 10px;border:1px solid var(--border-color);border-radius:6px;background:var(--bg-primary);color:var(--text-primary);font-size:0.9rem;">
                </div>
                <div>
                    <label style="font-size:0.82rem;font-weight:600;margin-bottom:4px;display:block;">Date</label>
                    <input type="date" id="new-inv-date"
                           style="width:100%;padding:8px 10px;border:1px solid var(--border-color);border-radius:6px;background:var(--bg-primary);color:var(--text-primary);font-size:0.9rem;">
                </div>
                <div>
                    <label style="font-size:0.82rem;font-weight:600;margin-bottom:4px;display:block;">Due Date</label>
                    <input type="date" id="new-inv-due-date"
                           style="width:100%;padding:8px 10px;border:1px solid var(--border-color);border-radius:6px;background:var(--bg-primary);color:var(--text-primary);font-size:0.9rem;">
                </div>
                <div>
                    <label style="font-size:0.82rem;font-weight:600;margin-bottom:4px;display:block;">Total (£)</label>
                    <input type="number" id="new-inv-total" step="0.01" min="0" placeholder="0.00"
                           style="width:100%;padding:8px 10px;border:1px solid var(--border-color);border-radius:6px;background:var(--bg-primary);color:var(--text-primary);font-size:0.9rem;">
                </div>
                <div>
                    <label style="font-size:0.82rem;font-weight:600;margin-bottom:4px;display:block;">Status</label>
                    <select id="new-inv-status"
                            style="width:100%;padding:8px 10px;border:1px solid var(--border-color);border-radius:6px;background:var(--bg-primary);color:var(--text-primary);font-size:0.9rem;">
                        <option value="Draft">Draft</option>
                        <option value="Approved">Approved</option>
                        <option value="Sent">Sent</option>
                        <option value="Paid">Paid</option>
                    </select>
                </div>
            </div>
            <div>
                <label style="font-size:0.82rem;font-weight:600;margin-bottom:4px;display:block;">Description</label>
                <input type="text" id="new-inv-desc" placeholder="Optional description"
                       style="width:100%;padding:8px 10px;border:1px solid var(--border-color);border-radius:6px;background:var(--bg-primary);color:var(--text-primary);font-size:0.9rem;">
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-cancel" onclick="closeAddInvoiceModal()">Cancel</button>
            <button type="button" class="btn-save" onclick="submitNewInvoice()">
                <i class="bi bi-check-lg"></i> Create Invoice
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>

// ── Add Invoice Modal ─────────────────────────────────────────
function toggleAddInvoiceModal() {
    const modal = document.getElementById('add-invoice-modal');
    modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
}

function closeAddInvoiceModal(e) {
    if (e && e.target !== e.currentTarget) return;
    document.getElementById('add-invoice-modal').style.display = 'none';
}

function submitNewInvoice() {
    const invoiceNumber = document.getElementById('new-inv-number').value.trim();
    if (!invoiceNumber) {
        alert('Invoice number is required');
        return;
    }

    const payload = {
        invoice_number: invoiceNumber,
        client_name: document.getElementById('new-inv-client').value,
        date: document.getElementById('new-inv-date').value,
        due_date: document.getElementById('new-inv-due-date').value,
        total: document.getElementById('new-inv-total').value,
        status: document.getElementById('new-inv-status').value,
        description: document.getElementById('new-inv-desc').value,
    };

    fetch('{% url "create_invoice" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            window.location.href = data.invoice_url;
        } else {
            alert(data.error || 'Failed to create invoice');
        }
    })
    .catch(err => alert('Error: ' + err.message));
}

// ── Sync via SSE ──────────────────────────────────────────────
function syncInvoices(full) {
    const btn = document.getElementById('sync-btn');
    const fullBtn = document.getElementById('full-sync-btn');
    const icon = document.getElementById('sync-icon');
    const text = document.getElementById('sync-text');
    const progress = document.getElementById('sync-progress');
    const msgEl = document.getElementById('sync-message');
    const logEl = document.getElementById('sync-log');

    btn.disabled = true;
    fullBtn.disabled = true;
    icon.classList.add('spinning');
    text.textContent = 'Syncing...';
    progress.style.display = '';
    logEl.innerHTML = '';

    function addLog(msg) {
        const time = new Date().toLocaleTimeString();
        const entry = document.createElement('div');
        entry.className = 'sync-log-entry';
        entry.innerHTML = '<span class="log-time">' + time + '</span> ' + msg;
        logEl.appendChild(entry);
        logEl.scrollTop = logEl.scrollHeight;
    }

    const url = '{% url "sync_invoices" %}' + (full ? '?full=1' : '');
    const source = new EventSource(url);

    source.onmessage = function(e) {
        const data = JSON.parse(e.data);

        if (data.error) {
            msgEl.textContent = 'Error: ' + data.error;
            addLog('<span class="log-error">Error: ' + data.error + '</span>');
            source.close();
            setTimeout(() => location.reload(), 3000);
            return;
        }

        if (data.message) {
            msgEl.textContent = data.message;
            addLog(data.message);
        }

        if (data.status === 'complete') {
            const skipped = data.skipped || 0;
            const summary =
                'Done: ' + data.created + ' created, ' + data.updated + ' updated, ' +
                skipped + ' skipped' +
                (data.errors && data.errors.length ? ', ' + data.errors.length + ' errors' : '');
            msgEl.textContent = summary;
            addLog('<span class="log-complete">' + summary + '</span>');
            source.close();
            setTimeout(() => location.reload(), 2000);
        }
    };

    source.onerror = function() {
        source.close();
        msgEl.textContent = 'Connection lost. Reloading...';
        addLog('<span class="log-error">Connection lost</span>');
        setTimeout(() => location.reload(), 2000);
    };
}

// ── Client-side search filtering ──────────────────────────────
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.querySelector('.inv-search-box input');
    const table = document.getElementById('invoices-table');

    if (searchInput && table) {
        searchInput.addEventListener('input', function() {
            const filter = this.value.toLowerCase();
            const rows = table.querySelectorAll('tbody tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(filter) ? '' : 'none';
            });
        });
    }
});
</script>
{% endblock %}
