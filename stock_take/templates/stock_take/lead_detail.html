{% extends 'base.html' %}
{% load static %}

{% block title %}{{ lead.name }} - Lead{% endblock %}

{% block nav_leads_active %}active{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/leads.css' %}">
{% endblock %}

{% block content %}
<div class="content-card">
    <div class="lead-detail-header">
        <div class="lead-detail-title">
            <a href="{% url 'leads_list' %}" class="back-link" title="Back to Leads">
                <i class="bi bi-arrow-left"></i>
            </a>
            <h1>{{ lead.name|default:"Unnamed Lead" }}</h1>
            <span class="lead-status-badge {{ lead.status }}">{{ lead.get_status_display }}</span>
            {% if lead.source %}
            <span class="lead-source-badge {{ lead.source }}">{{ lead.get_source_display }}</span>
            {% endif %}
        </div>
        <div class="lead-detail-actions">
            {% if lead.status != 'converted' %}
            <button class="btn-convert-lead" id="btn-convert" onclick="convertLead()"><i class="bi bi-arrow-right-circle"></i> Convert to Customer</button>
            {% else %}
            <a href="{% url 'customer_detail' lead.converted_to_customer.pk %}" class="btn-view-customer"><i class="bi bi-person-check"></i> View Customer</a>
            {% endif %}
            <button class="btn-edit-lead" id="btn-edit" onclick="toggleEditMode()"><i class="bi bi-pencil"></i> Edit</button>
            <button class="btn-save-lead" id="btn-save" style="display:none;" onclick="saveLead()"><i class="bi bi-check-lg"></i> Save Changes</button>
            <button class="btn-cancel-lead" id="btn-cancel" style="display:none;" onclick="cancelEdit()"><i class="bi bi-x-lg"></i> Cancel</button>
        </div>
    </div>

    <div id="save-notification" class="lead-save-notification" style="display:none;"></div>

    <!-- Lead Info Grid -->
    <div class="lead-info-grid" id="lead-info">
        <!-- Contact Information -->
        <div class="lead-info-section">
            <h3><i class="bi bi-person-lines-fill"></i> Contact Details</h3>
            <div class="lead-info-row">
                <span class="lead-info-label">Name</span>
                <span class="lead-info-value view-val">{{ lead.name|default:"-" }}</span>
                <input class="lead-edit-input edit-val" data-field="name" value="{{ lead.name|default:'' }}" style="display:none;">
            </div>
            <div class="lead-info-row">
                <span class="lead-info-label">Email</span>
                <span class="lead-info-value view-val">
                    {% if lead.email %}
                    <a href="mailto:{{ lead.email }}">{{ lead.email }}</a>
                    {% else %}-{% endif %}
                </span>
                <input class="lead-edit-input edit-val" data-field="email" type="email" value="{{ lead.email|default:'' }}" style="display:none;">
            </div>
            <div class="lead-info-row">
                <span class="lead-info-label">Phone</span>
                <span class="lead-info-value view-val">{{ lead.phone|default:"-" }}</span>
                <input class="lead-edit-input edit-val" data-field="phone" value="{{ lead.phone|default:'' }}" style="display:none;">
            </div>
            <div class="lead-info-row">
                <span class="lead-info-label">Website</span>
                <span class="lead-info-value view-val">
                    {% if lead.website %}
                    <a href="{{ lead.website }}" target="_blank">{{ lead.website }}</a>
                    {% else %}-{% endif %}
                </span>
                <input class="lead-edit-input edit-val" data-field="website" value="{{ lead.website|default:'' }}" style="display:none;">
            </div>
        </div>

        <!-- Address -->
        <div class="lead-info-section">
            <h3><i class="bi bi-geo-alt"></i> Address</h3>
            <div class="lead-info-row">
                <span class="lead-info-label">Address 1</span>
                <span class="lead-info-value view-val">{{ lead.address_1|default:"-" }}</span>
                <input class="lead-edit-input edit-val" data-field="address_1" value="{{ lead.address_1|default:'' }}" style="display:none;">
            </div>
            <div class="lead-info-row">
                <span class="lead-info-label">Address 2</span>
                <span class="lead-info-value view-val">{{ lead.address_2|default:"-" }}</span>
                <input class="lead-edit-input edit-val" data-field="address_2" value="{{ lead.address_2|default:'' }}" style="display:none;">
            </div>
            <div class="lead-info-row">
                <span class="lead-info-label">City</span>
                <span class="lead-info-value view-val">{{ lead.city|default:"-" }}</span>
                <input class="lead-edit-input edit-val" data-field="city" value="{{ lead.city|default:'' }}" style="display:none;">
            </div>
            <div class="lead-info-row">
                <span class="lead-info-label">State</span>
                <span class="lead-info-value view-val">{{ lead.state|default:"-" }}</span>
                <input class="lead-edit-input edit-val" data-field="state" value="{{ lead.state|default:'' }}" style="display:none;">
            </div>
            <div class="lead-info-row">
                <span class="lead-info-label">Postcode</span>
                <span class="lead-info-value view-val">{{ lead.postcode|default:"-" }}</span>
                <input class="lead-edit-input edit-val" data-field="postcode" value="{{ lead.postcode|default:'' }}" style="display:none;">
            </div>
            <div class="lead-info-row">
                <span class="lead-info-label">Country</span>
                <span class="lead-info-value view-val">{{ lead.country|default:"-" }}</span>
                <input class="lead-edit-input edit-val" data-field="country" value="{{ lead.country|default:'' }}" style="display:none;">
            </div>
        </div>

        <!-- Lead Status & Source -->
        <div class="lead-info-section">
            <h3><i class="bi bi-funnel"></i> Lead Info</h3>
            <div class="lead-info-row">
                <span class="lead-info-label">Status</span>
                <span class="lead-info-value view-val">
                    <span class="lead-status-badge {{ lead.status }}">{{ lead.get_status_display }}</span>
                </span>
                <select class="lead-edit-input edit-val" data-field="status" style="display:none;">
                    {% for value, label in status_choices %}
                    <option value="{{ value }}" {% if lead.status == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="lead-info-row">
                <span class="lead-info-label">Source</span>
                <span class="lead-info-value view-val">{{ lead.get_source_display|default:"-" }}</span>
                <select class="lead-edit-input edit-val" data-field="source" style="display:none;">
                    <option value="">-- None --</option>
                    {% for value, label in source_choices %}
                    <option value="{{ value }}" {% if lead.source == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="lead-info-row">
                <span class="lead-info-label">Est. Value</span>
                <span class="lead-info-value view-val">Â£{{ lead.value|floatformat:2 }}</span>
                <input class="lead-edit-input edit-val" data-field="value" type="number" step="0.01" value="{{ lead.value }}" style="display:none;">
            </div>
            {% if lead.converted_to_customer %}
            <div class="lead-info-row">
                <span class="lead-info-label">Converted To</span>
                <span class="lead-info-value view-val">
                    <a href="{% url 'customer_detail' lead.converted_to_customer.pk %}">{{ lead.converted_to_customer.name }}</a>
                </span>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Notes Section -->
    <div class="lead-notes-section">
        <h3><i class="bi bi-journal-text"></i> Notes</h3>
        <div class="lead-notes-content view-val">
            {% if lead.notes %}
            <p>{{ lead.notes|linebreaksbr }}</p>
            {% else %}
            <p class="text-muted">No notes for this lead.</p>
            {% endif %}
        </div>
        <textarea class="lead-edit-input edit-val lead-notes-textarea" data-field="notes" style="display:none;">{{ lead.notes|default:'' }}</textarea>
    </div>

    <!-- System Info -->
    <div class="lead-system-info">
        <div class="system-info-row">
            <span>Created</span>
            <span>{{ lead.created_at|date:"d/m/Y H:i" }}</span>
        </div>
        <div class="system-info-row">
            <span>Last Modified</span>
            <span>{{ lead.updated_at|date:"d/m/Y H:i" }}</span>
        </div>
    </div>
</div>

<script>
function toggleEditMode() {
    document.getElementById('lead-info').classList.add('editing');
    document.querySelectorAll('.view-val').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.edit-val').forEach(el => el.style.display = 'block');
    document.getElementById('btn-edit').style.display = 'none';
    document.getElementById('btn-save').style.display = 'inline-flex';
    document.getElementById('btn-cancel').style.display = 'inline-flex';
    const convertBtn = document.getElementById('btn-convert');
    if (convertBtn) convertBtn.style.display = 'none';
}

function cancelEdit() {
    document.getElementById('lead-info').classList.remove('editing');
    document.querySelectorAll('.view-val').forEach(el => el.style.display = '');
    document.querySelectorAll('.edit-val').forEach(el => el.style.display = 'none');
    document.getElementById('btn-edit').style.display = '';
    document.getElementById('btn-save').style.display = 'none';
    document.getElementById('btn-cancel').style.display = 'none';
    const convertBtn = document.getElementById('btn-convert');
    if (convertBtn) convertBtn.style.display = '';
    // Reset input values
    document.querySelectorAll('.edit-val').forEach(input => {
        if (input.tagName === 'SELECT') {
            input.selectedIndex = input.querySelector('[selected]') ? input.querySelector('[selected]').index : 0;
        } else {
            input.value = input.defaultValue;
        }
    });
}

function saveLead() {
    const data = {};
    document.querySelectorAll('.edit-val').forEach(input => {
        const field = input.getAttribute('data-field');
        if (field) data[field] = input.value;
    });

    const btn = document.getElementById('btn-save');
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Saving...';

    const notification = document.getElementById('save-notification');

    fetch("{% url 'lead_save' lead.pk %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            notification.className = 'lead-save-notification success';
            notification.innerHTML = '<i class="bi bi-check-circle"></i> Lead saved successfully';
            notification.style.display = 'flex';
            setTimeout(() => location.reload(), 800);
        } else {
            notification.className = 'lead-save-notification error';
            notification.innerHTML = '<i class="bi bi-exclamation-circle"></i> ' + (result.error || 'Failed to save');
            notification.style.display = 'flex';
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-check-lg"></i> Save Changes';
            setTimeout(() => notification.style.display = 'none', 3000);
        }
    })
    .catch(err => {
        notification.className = 'lead-save-notification error';
        notification.innerHTML = '<i class="bi bi-exclamation-circle"></i> Network error';
        notification.style.display = 'flex';
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-check-lg"></i> Save Changes';
        setTimeout(() => notification.style.display = 'none', 3000);
    });
}

function convertLead() {
    if (!confirm('Convert this lead to a customer? A new customer record will be created with this lead\'s details.')) return;

    const btn = document.getElementById('btn-convert');
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Converting...';

    fetch("{% url 'lead_convert' lead.pk %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            const notification = document.getElementById('save-notification');
            notification.className = 'lead-save-notification success';
            notification.innerHTML = '<i class="bi bi-check-circle"></i> Lead converted to customer "' + result.customer_name + '"! Redirecting...';
            notification.style.display = 'flex';
            setTimeout(() => window.location.href = '/customer/' + result.customer_id + '/', 1200);
        } else {
            alert('Error: ' + (result.error || 'Unknown error'));
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-arrow-right-circle"></i> Convert to Customer';
        }
    })
    .catch(err => {
        alert('Network error: ' + err.message);
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-arrow-right-circle"></i> Convert to Customer';
    });
}
</script>
{% endblock %}
