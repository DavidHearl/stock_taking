<div class="detail-content">
    <div class="copy-controls">
        <span class="copy-label">Sale:</span>
        <input type="text" class="copy-input" value="{{ order.sale_number }}" readonly>
        <button class="btn btn-sm btn-secondary copy-detail-btn" data-text="{{ order.sale_number }}" title="Copy Sale Number">
            ðŸ“‹
        </button>
        <span class="copy-label">Customer:</span>
        <input type="text" class="copy-input" value="{{ order.customer_number }}" readonly>
        <button class="btn btn-sm btn-secondary copy-detail-btn" data-text="{{ order.customer_number }}" title="Copy Customer Number">
            ðŸ“‹
        </button>
    </div>
    
    {% if order.order_pnx_items %}
    <div class="detail-section">
        <h4>PNX Items ({{ order.order_pnx_items|length }} items)</h4>
        <table class="table detail-table">
            <thead>
                <tr>
                    <th>Barcode</th>
                    <th>Material</th>
                    <th>Length</th>
                    <th>Width</th>
                    <th>Count</th>
                    <th style="text-align: center;" title="PRFID1">E1</th>
                    <th style="text-align: center;" title="PRFID3">E3</th>
                    <th style="text-align: center;" title="PRFID4">E4</th>
                    <th style="text-align: center;" title="PRFID2">E2</th>
                    <th>Part</th>
                    <th>Cost</th>
                    <th>Received</th>
                </tr>
            </thead>
            <tbody>
                {% for item in order.order_pnx_items %}
                <tr>
                    <td>{{ item.barcode }}</td>
                    <td>{{ item.matname }}</td>
                    <td>{{ item.cleng|floatformat:1 }}</td>
                    <td>{{ item.cwidth|floatformat:1 }}</td>
                    <td>{{ item.cnt|floatformat:0 }}</td>
                    <td style="text-align: center;">{% if item.prfid1 %}<span style="color: #28a745; font-size: 0.9em;">âœ“</span>{% endif %}</td>
                    <td style="text-align: center;">{% if item.prfid3 %}<span style="color: #28a745; font-size: 0.9em;">âœ“</span>{% endif %}</td>
                    <td style="text-align: center;">{% if item.prfid4 %}<span style="color: #28a745; font-size: 0.9em;">âœ“</span>{% endif %}</td>
                    <td style="text-align: center;">{% if item.prfid2 %}<span style="color: #28a745; font-size: 0.9em;">âœ“</span>{% endif %}</td>
                    <td>{{ item.partdesc|default:"â€”" }}</td>
                    <td>Â£{{ item.calculated_cost|floatformat:2 }}</td>
                    <td>
                        {% if item.is_fully_received %}
                            <span class="status-icon success" title="Fully Received">âœ“</span>
                        {% elif item.is_partially_received %}
                            <span class="status-icon warning" title="Partially Received ({{ item.received_quantity|floatformat:0 }}/{{ item.cnt|floatformat:0 }})">âš </span>
                        {% else %}
                            <span class="status-icon danger" title="Not Received">âœ—</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
                <tr class="total-row">
                    <td colspan="11"><strong>Total Cost:</strong></td>
                    <td><strong>Â£{{ order.pnx_total_cost|floatformat:2 }}</strong></td>
                </tr>
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="detail-section">
        <p><strong>PNX Items:</strong> No items found for this order.</p>
    </div>
    {% endif %}
    
    {% if order.os_doors.all %}
    <div class="detail-section">
        <h4>OS Doors ({{ order.os_doors.count }} items)</h4>
        <table class="table detail-table">
            <thead>
                <tr>
                    <th>Door Style</th>
                    <th>Style Colour</th>
                    <th>Dimensions</th>
                    <th>Colour</th>
                    <th>Qty</th>
                    <th>Ordered</th>
                    <th>Received</th>
                </tr>
            </thead>
            <tbody>
                {% for os_door in order.os_doors.all %}
                <tr>
                    <td>{{ os_door.door_style }}</td>
                    <td>{{ os_door.style_colour }}</td>
                    <td>{{ os_door.height }} x {{ os_door.width }}</td>
                    <td>{{ os_door.colour }}</td>
                    <td>{{ os_door.quantity|floatformat:0 }}</td>
                    <td>
                        {% if os_door.ordered %}
                            <span class="status-icon success">âœ“</span>
                        {% else %}
                            <span class="status-icon danger">âœ—</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if os_door.received %}
                            <span class="status-icon success">âœ“</span>
                        {% else %}
                            <span class="status-icon danger">âœ—</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
    
    {% if glass_items %}
    {% load custom_filters %}
    <div class="detail-section">
        <h4>Glass ({{ glass_items|length }} items)</h4>
        <table class="table detail-table">
            <thead>
                <tr>
                    <th>SKU</th>
                    <th>Name</th>
                    <th>Qty</th>
                    <th>Stock/Allocated/Remaining</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for glass in glass_items %}
                <tr>
                    <td>{{ glass.sku }}</td>
                    <td>{{ glass.name|truncatechars:30 }}</td>
                    <td>{{ glass.quantity|floatformat:0 }}</td>
                    <td>
                        {% if glass.stock_item %}
                            {% with remaining=glass|calculate_remaining %}
                                <div style="font-size: 0.85em;">
                                    <div>Stock: {{ glass.available_quantity|floatformat:0 }}</div>
                                    <div>Allocated: {{ glass.allocated_quantity|floatformat:0 }}</div>
                                    <div style="font-weight: bold; {% if remaining < 0 %}color: #dc3545;{% else %}color: #28a745;{% endif %}">
                                        Remaining: {{ remaining|floatformat:0 }}
                                    </div>
                                </div>
                            {% endwith %}
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if glass.missing %}
                            <span class="badge badge-warning">Missing</span>
                        {% elif glass.stock_item %}
                            {% with remaining=glass|calculate_remaining %}
                                {% if remaining >= 0 %}
                                    <span class="badge badge-success">In Stock</span>
                                {% else %}
                                    <span class="badge badge-danger">Out of Stock</span>
                                {% endif %}
                            {% endwith %}
                        {% else %}
                            <span class="badge badge-info">No Stock Link</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
    
    {% if non_glass_accessories %}
    {% load custom_filters %}
    <div class="detail-section">
        <h4>Accessories ({{ non_glass_accessories|length }} items)</h4>
        <table class="table detail-table">
            <thead>
                <tr>
                    <th>SKU</th>
                    <th>Name</th>
                    <th>Qty</th>
                    <th>Stock/Allocated/Remaining</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for accessory in non_glass_accessories %}
                <tr>
                    <td>{{ accessory.sku }}</td>
                    <td>{{ accessory.name|truncatechars:30 }}</td>
                    <td>{{ accessory.quantity|floatformat:0 }}</td>
                    <td>
                        {% if accessory.stock_item %}
                            {% with remaining=accessory|calculate_remaining %}
                                <div style="font-size: 0.85em;">
                                    <div>Stock: {{ accessory.available_quantity|floatformat:0 }}</div>
                                    <div>Allocated: {{ accessory.allocated_quantity|floatformat:0 }}</div>
                                    <div style="font-weight: bold; {% if remaining < 0 %}color: #dc3545;{% else %}color: #28a745;{% endif %}">
                                        Remaining: {{ remaining|floatformat:0 }}
                                    </div>
                                </div>
                            {% endwith %}
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if accessory.missing %}
                            <span class="badge badge-warning">Missing</span>
                        {% elif accessory.stock_item %}
                            {% with remaining=accessory|calculate_remaining %}
                                {% if remaining >= 0 %}
                                    <span class="badge badge-success">In Stock</span>
                                {% else %}
                                    <span class="badge badge-danger">Out of Stock</span>
                                {% endif %}
                            {% endwith %}
                        {% else %}
                            <span class="badge badge-info">No Stock Link</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
</div>
