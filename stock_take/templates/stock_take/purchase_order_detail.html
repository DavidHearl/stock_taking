{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}{{ purchase_order.display_number }} - Purchase Order{% endblock %}

{% block nav_purchase_orders_active %}active{% endblock %}

{% block page_title %}Purchase Order Details{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/purchase_orders.css' %}">
{% endblock %}

{% block content %}
<div class="content-card">
    {% if error %}
    <div class="po-error">
        <i class="bi bi-exclamation-triangle"></i> {{ error }}
    </div>
    <a href="{% url 'purchase_orders_list' %}" class="btn btn-sm btn-secondary">
        <i class="bi bi-arrow-left"></i> Back to Purchase Orders
    </a>
    {% elif purchase_order %}
    
    <!-- Header -->
    <div class="po-detail-header">
        <div class="po-detail-title">
            <button class="btn btn-sm btn-icon btn-danger" onclick="deletePO()" title="Delete this purchase order">
                <i class="bi bi-trash"></i>
            </button>
            <h1>{{ purchase_order.display_number }}</h1>
            <div class="po-detail-meta">
                <span class="po-status {% if purchase_order.status == 'Draft' %}draft{% elif purchase_order.status == 'Approved' %}approved{% elif purchase_order.status == 'Received' %}received{% elif purchase_order.status == 'Cancelled' %}cancelled{% endif %}">
                    {{ purchase_order.status }}
                </span>
                {% if purchase_order.email_sent %}
                <span class="po-email-badge sent" title="Sent {{ purchase_order.email_sent_at|date:'d/m/Y H:i' }} to {{ purchase_order.email_sent_to }}">
                    <i class="bi bi-envelope-check"></i> Emailed
                </span>
                {% endif %}
                {% if purchase_order.creator_name %}
                <span class="po-meta-sep">|</span>
                <span>Created by {{ purchase_order.creator_name }}</span>
                {% endif %}
                {% if purchase_order.warehouse_name %}
                <span class="po-meta-sep">|</span>
                <span><i class="bi bi-building"></i> {{ purchase_order.warehouse_name }}</span>
                {% endif %}
                <span class="po-meta-sep">|</span>
                <span>Last synced: {{ purchase_order.last_synced|date:"d/m/Y H:i" }}</span>
            </div>
        </div>
        <div class="po-detail-actions">
            <a href="{% url 'purchase_orders_list' %}" class="btn btn-sm btn-secondary">
                <i class="bi bi-arrow-left"></i> Back
            </a>
            {% if purchase_order.status == 'Draft' %}
            <button class="btn btn-sm btn-approve" id="approve-btn" onclick="updatePOStatus('Approved')">
                <i class="bi bi-check-circle"></i> Approve
            </button>
            {% endif %}
            {% if purchase_order.status == 'Approved' %}
            <button class="btn btn-sm btn-revert" id="revert-btn" onclick="updatePOStatus('Draft')">
                <i class="bi bi-arrow-counterclockwise"></i> Revert to Draft
            </button>
            {% endif %}
            {% if purchase_order.status != 'Received' %}
            <button class="btn btn-sm btn-receive" id="receive-btn" onclick="receivePO()">
                <i class="bi bi-box-arrow-in-down"></i> Receive
            </button>
            {% endif %}
            <button class="btn btn-sm btn-edit" id="edit-toggle-btn" onclick="toggleEditMode()">
                <i class="bi bi-pencil"></i> Edit
            </button>
            <button class="btn btn-sm btn-save" id="save-btn" onclick="savePO()" style="display:none;">
                <i class="bi bi-check-lg"></i> Save
            </button>
            <button class="btn btn-sm btn-secondary" id="cancel-btn" onclick="cancelEdit()" style="display:none;">
                <i class="bi bi-x-lg"></i> Cancel
            </button>
            <a href="{% url 'purchase_order_download_pdf' purchase_order.workguru_id %}" class="btn btn-sm btn-secondary" title="Download PDF">
                <i class="bi bi-file-earmark-pdf"></i> PDF
            </a>
            <button class="btn btn-sm btn-send" id="send-btn" onclick="openSendModal()">
                <i class="bi bi-envelope"></i> Send
            </button>
        </div>
    </div>

    <!-- Save Notification -->
    <div class="po-save-notification" id="save-notification" style="display: none;"></div>

    <!-- Overview Grid - 3 columns -->
    <div class="po-overview-grid" id="po-overview">
        <div class="po-overview-row">
            <div class="po-overview-item">
                <span class="po-overview-label">Supplier</span>
                {% if supplier_obj %}
                <a class="po-overview-value highlight po-view-val" data-field="supplier_name" href="{% url 'supplier_detail' supplier_obj.workguru_id %}">{{ purchase_order.supplier_name|default:"-" }}</a>
                {% else %}
                <span class="po-overview-value highlight po-view-val" data-field="supplier_name">{{ purchase_order.supplier_name|default:"-" }}</span>
                {% endif %}
                <select class="po-edit-input po-edit-val" data-field="supplier_name" style="display:none;">
                    <option value="">-- Select supplier --</option>
                    {% for s in all_suppliers %}
                    <option value="{{ s.name }}" {% if s.name == purchase_order.supplier_name %}selected{% endif %}>{{ s.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="po-overview-item">
                <span class="po-overview-label">Supplier Invoice #</span>
                <span class="po-overview-value po-view-val" data-field="supplier_invoice_number">{{ purchase_order.supplier_invoice_number|default:"-" }}</span>
                <input class="po-edit-input po-edit-val" data-field="supplier_invoice_number" value="{{ purchase_order.supplier_invoice_number|default:'' }}" style="display:none;">
            </div>
            <div class="po-overview-item">
                <span class="po-overview-label">Description</span>
                <span class="po-overview-value po-view-val" data-field="description">{{ purchase_order.description|default:"-" }}</span>
                <input class="po-edit-input po-edit-val" data-field="description" value="{{ purchase_order.description|default:'' }}" style="display:none;">
            </div>
        </div>
        <div class="po-overview-row">
            <div class="po-overview-item po-projects-section">
                <span class="po-overview-label">Project
                    <button class="btn-project-add" id="project-add-stock-btn"
                        data-po-id="{{ purchase_order.workguru_id }}"
                        onclick="addProjectStock()"
                        title="Add Stock entry">
                        <i class="bi bi-box-seam"></i>
                    </button>
                    <button class="btn-project-add" id="project-add-customer-btn"
                        data-po-id="{{ purchase_order.workguru_id }}"
                        onclick="toggleProjectCustomerSearch()"
                        title="Link a customer order">
                        <i class="bi bi-person-plus"></i>
                    </button>
                </span>
                <div class="po-projects-list" id="project-display">
                    {% for proj in po_projects %}
                    <div class="po-project-entry {% if proj.project_type == 'stock' %}is-stock{% endif %}" data-project-id="{{ proj.id }}">
                        {% if proj.project_type == 'stock' %}
                            <span class="po-stock-badge">Stock</span>
                        {% elif proj.order %}
                            <a href="{% url 'order_details' proj.order.id %}" class="po-project-link" title="View order {{ proj.order.sale_number }}">
                                <i class="bi bi-box-arrow-up-right"></i> {{ proj.label }}
                            </a>
                        {% else %}
                            <span>{{ proj.label }}</span>
                        {% endif %}
                        <button class="btn-project-remove" onclick="removeProject({{ purchase_order.workguru_id }}, {{ proj.id }}, this)" title="Remove"><i class="bi bi-x-lg"></i></button>
                    </div>
                    {% empty %}
                    <span class="po-projects-empty">No projects assigned</span>
                    {% endfor %}
                </div>
                {# Inline search for adding a customer order #}
                <div class="po-project-search-wrapper" id="project-customer-search" style="display:none;">
                    <input type="text" class="po-project-search-input" id="project-search-input"
                        placeholder="Search by name or order number..." autocomplete="off"
                        oninput="searchProjectOrders(this.value)">
                    <input type="hidden" id="project-search-order-id">
                    <div class="po-project-search-results" id="project-search-results"></div>
                    <div class="po-project-search-actions">
                        <button class="alloc-save-btn" onclick="addProjectCustomer()" title="Add"><i class="bi bi-check-lg"></i></button>
                        <button class="alloc-sub-remove" onclick="toggleProjectCustomerSearch()" title="Cancel"><i class="bi bi-x-lg"></i></button>
                    </div>
                </div>
            </div>
            <div class="po-overview-item">
                <span class="po-overview-label">Issue Date</span>
                <span class="po-overview-value po-view-val" data-field="issue_date">{{ purchase_order.issue_date|format_date_str|default:"-" }}</span>
                <input class="po-edit-input po-edit-val" data-field="issue_date" type="date" id="po-issue-date" value="{{ purchase_order.issue_date|default:'' }}" style="display:none;" oninput="autoCalcExpectedDate()">
            </div>
            <div class="po-overview-item">
                <span class="po-overview-label">Expected Date{% if supplier_obj and supplier_obj.estimate_lead_time %} <small class="po-lead-time-hint">(lead time: {{ supplier_obj.estimate_lead_time }} days)</small>{% endif %}</span>
                <span class="po-overview-value po-view-val" data-field="expected_date">{{ purchase_order.expected_date|format_date_str|default:"-" }}</span>
                <input class="po-edit-input po-edit-val" data-field="expected_date" type="date" id="po-expected-date" value="{{ purchase_order.expected_date|default:'' }}" style="display:none;">
            </div>
        </div>
        <div class="po-overview-row">
            <div class="po-overview-item">
                <span class="po-overview-label">Received Date</span>
                <span class="po-overview-value po-view-val" data-field="received_date">{{ purchase_order.received_date|format_date_str|default:"-" }}</span>
                <input class="po-edit-input po-edit-val" data-field="received_date" type="date" value="{{ purchase_order.received_date|default:'' }}" style="display:none;">
            </div>
            <div class="po-overview-item">
                <span class="po-overview-label">Invoice Date</span>
                <span class="po-overview-value po-view-val" data-field="invoice_date">{{ purchase_order.invoice_date|format_date_str|default:"-" }}</span>
                <input class="po-edit-input po-edit-val" data-field="invoice_date" type="date" value="{{ purchase_order.invoice_date|default:'' }}" style="display:none;">
            </div>
            <div class="po-overview-item">
                <span class="po-overview-label">Received By</span>
                <span class="po-overview-value po-view-val" data-field="received_by_name">{{ purchase_order.received_by_name|default:"-" }}</span>
                <input class="po-edit-input po-edit-val" data-field="received_by_name" value="{{ purchase_order.received_by_name|default:'' }}" style="display:none;">
            </div>
        </div>
        <div class="po-overview-row">
            <div class="po-overview-item">
                <span class="po-overview-label">Delivery Instructions</span>
                <span class="po-overview-value po-view-val" data-field="delivery_instructions">{{ purchase_order.delivery_instructions|default:"-" }}</span>
                <input class="po-edit-input po-edit-val" data-field="delivery_instructions" value="{{ purchase_order.delivery_instructions|default:'' }}" style="display:none;">
            </div>
            <div class="po-overview-item">
                <span class="po-overview-label">Delivery Address</span>
                <span class="po-overview-value po-view-val" data-field="delivery_address_1">
                    {% if purchase_order.delivery_address_1 %}
                        {{ purchase_order.delivery_address_1 }}{% if purchase_order.delivery_address_2 %}<br>{{ purchase_order.delivery_address_2 }}{% endif %}
                    {% else %}
                        -
                    {% endif %}
                </span>
                <input class="po-edit-input po-edit-val" data-field="delivery_address_1" value="{{ purchase_order.delivery_address_1|default:'' }}" style="display:none;" placeholder="Address line 1">
            </div>
            <div class="po-overview-item">
                <span class="po-overview-label">Billable</span>
                <span class="po-overview-value po-view-val" data-field="billable">{% if purchase_order.billable %}Yes{% else %}No{% endif %}</span>
                <label class="po-edit-checkbox po-edit-val" data-field="billable" style="display:none;">
                    <input type="checkbox" id="billable-check" {% if purchase_order.billable %}checked{% endif %}>
                    <span>Billable</span>
                </label>
            </div>
        </div>
        {% if purchase_order.currency and purchase_order.currency != 'GBP' %}
        <div class="po-overview-row">
            <div class="po-overview-item">
                <span class="po-overview-label">Currency</span>
                <span class="po-overview-value po-view-val" data-field="currency">
                    {{ purchase_order.currency|default:"GBP" }}
                    {% if supplier_obj and supplier_obj.currency and supplier_obj.currency|upper != purchase_order.currency|upper %}
                    <button class="po-currency-sync-btn" title="Supplier uses {{ supplier_obj.currency }} — click to sync" onclick="syncCurrencyFromSupplier('{{ supplier_obj.currency|upper }}')">⚠ Supplier uses {{ supplier_obj.currency|upper }} — Sync</button>
                    {% endif %}
                </span>
                <select class="po-edit-input po-edit-val" data-field="currency" style="display:none;">
                    <option value="GBP" {% if purchase_order.currency == 'GBP' or not purchase_order.currency %}selected{% endif %}>GBP (£)</option>
                    <option value="EUR" {% if purchase_order.currency == 'EUR' %}selected{% endif %}>EUR (€)</option>
                    <option value="USD" {% if purchase_order.currency == 'USD' %}selected{% endif %}>USD ($)</option>
                </select>
            </div>
            <div class="po-overview-item">
                <span class="po-overview-label">Exchange Rate</span>
                <span class="po-overview-value">{{ purchase_order.exchange_rate }}</span>
            </div>
            <div class="po-overview-item">
                <span class="po-overview-label">Base Currency Total (GBP)</span>
                <span class="po-overview-value">£{{ purchase_order.base_currency_total|floatformat:2 }}</span>
            </div>
        </div>
        {% else %}
        <div class="po-overview-row">
            <div class="po-overview-item">
                <span class="po-overview-label">Currency</span>
                <span class="po-overview-value po-view-val" data-field="currency">
                    {{ purchase_order.currency|default:"GBP" }}
                    {% if supplier_obj and supplier_obj.currency and supplier_obj.currency|upper != purchase_order.currency|upper %}
                    <button class="po-currency-sync-btn" title="Supplier uses {{ supplier_obj.currency }} — click to sync" onclick="syncCurrencyFromSupplier('{{ supplier_obj.currency|upper }}')">⚠ Supplier uses {{ supplier_obj.currency|upper }} — Sync</button>
                    {% endif %}
                </span>
                <select class="po-edit-input po-edit-val" data-field="currency" style="display:none;">
                    <option value="GBP" {% if purchase_order.currency == 'GBP' or not purchase_order.currency %}selected{% endif %}>GBP (£)</option>
                    <option value="EUR" {% if purchase_order.currency == 'EUR' %}selected{% endif %}>EUR (€)</option>
                    <option value="USD" {% if purchase_order.currency == 'USD' %}selected{% endif %}>USD ($)</option>
                </select>
            </div>
        </div>
        {% endif %}
        {% if purchase_order.approved_by_name or purchase_order.approved_date or purchase_order.contact_name %}
        <div class="po-overview-row">
            <div class="po-overview-item">
                <span class="po-overview-label">Approved By</span>
                <span class="po-overview-value">{{ purchase_order.approved_by_name|default:"-" }}</span>
            </div>
            <div class="po-overview-item">
                <span class="po-overview-label">Approved Date</span>
                <span class="po-overview-value">{{ purchase_order.approved_date|default:"-" }}</span>
            </div>
            <div class="po-overview-item">
                <span class="po-overview-label">Contact</span>
                <span class="po-overview-value">{{ purchase_order.contact_name|default:"-" }}</span>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Products Section -->
    <div class="po-products-section">
        <div class="po-products-header-row">
            <h3><i class="bi bi-box-seam"></i> Products
                {% if total_board_qty %}
                <span class="po-board-count-badge">{{ total_board_items }} items &middot; {{ total_board_qty|floatformat:0 }} boards</span>
                {% elif products.count %}
                <span class="po-board-count-badge">{{ products.count }} items</span>
                {% endif %}
            </h3>
            <button class="btn btn-sm btn-add-product" onclick="toggleAddProductRow()">
                <i class="bi bi-plus-lg"></i> Add Product
            </button>
        </div>

        {% if boards_po %}
        <div class="po-boards-meta">
            <span class="po-boards-badge {% if boards_po.boards_ordered %}ordered{% else %}not-ordered{% endif %}">
                <i class="bi bi-{% if boards_po.boards_ordered %}check-circle{% else %}clock{% endif %}"></i>
                {% if boards_po.boards_ordered %}Ordered{% else %}Not Ordered{% endif %}
            </span>
            <span class="po-boards-badge {% if boards_po.boards_received %}received{% else %}pending{% endif %}">
                <i class="bi bi-{% if boards_po.boards_received %}box-seam{% else %}hourglass-split{% endif %}"></i>
                {% if boards_po.boards_received %}All Received{% else %}Pending{% endif %}
            </span>
            {% if boards_po.file %}
            <a href="{{ boards_po.file.url }}" class="po-boards-file-link" download>
                <i class="bi bi-file-earmark-arrow-down"></i> PNX File
            </a>
            {% endif %}
            {% if boards_po.csv_file %}
            <a href="{{ boards_po.csv_file.url }}" class="po-boards-file-link" download>
                <i class="bi bi-filetype-csv"></i> CSV File
            </a>
            {% endif %}
        </div>
        {% endif %}

        <div class="po-table-container">
            <table class="po-products-table" id="products-table">
                <thead>
                    <tr>
                        <th>SKU</th>
                        <th>Name</th>
                        <th class="text-right">Order Price</th>
                        <th class="text-right">Order Qty</th>
                        <th class="text-right">Rec'd Qty</th>
                        <th class="text-right">Invoice Price</th>
                        <th class="text-right">Line Total</th>
                        <th class="text-center" style="width: 50px;"></th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Add Product Row (hidden by default) -->
                    <tr id="add-product-row" style="display:none;" class="add-product-row">
                        <td colspan="2" id="search-cell">
                            <input type="text" class="po-inline-input" id="product-search" placeholder="Search products by SKU or name..." autocomplete="off" oninput="searchProducts(this.value)">
                            <input type="hidden" id="new-stock-item-id">
                        </td>
                        <td id="selected-sku" class="selected-product-cell" style="display:none;"><span id="display-sku"></span></td>
                        <td id="selected-name" class="selected-product-cell" style="display:none;"><span id="display-name"></span></td>
                        <input type="hidden" id="new-sku">
                        <input type="hidden" id="new-supplier-code">
                        <input type="hidden" id="new-name">
                        <input type="hidden" id="new-description">
                        <td><input type="number" class="po-inline-input text-right" id="new-order-price" placeholder="0.00" step="0.01" min="0" onchange="calcNewLineTotal()"></td>
                        <td><input type="number" class="po-inline-input text-right" id="new-order-qty" placeholder="0" step="1" min="0" onchange="calcNewLineTotal()"></td>
                        <td class="text-right">-</td>
                        <td class="text-right">-</td>
                        <td class="text-right" id="new-line-total">£0.00</td>
                        <td class="text-center">
                            <button class="btn-inline-save" onclick="saveNewProduct()" title="Save"><i class="bi bi-check-lg"></i></button>
                            <button class="btn-inline-cancel" onclick="toggleAddProductRow()" title="Cancel"><i class="bi bi-x-lg"></i></button>
                        </td>
                    </tr>
                    {% for product in products %}
                    <tr data-product-id="{{ product.id }}">
                        <td>
                            <span class="po-product-sku po-view-val">{% if product.stock_item %}<a href="{% url 'product_detail' product.stock_item.id %}" class="po-sku-link">{{ product.sku|default:"-" }}</a>{% else %}{{ product.sku|default:"-" }}{% endif %}</span>
                            <input class="po-edit-input po-edit-val po-edit-narrow" data-field="sku" value="{{ product.sku|default:'' }}" style="display:none;">
                        </td>
                        <td>
                            <div class="product-name-row">
                                <span class="po-view-val">{{ product.name|default:"-" }}</span>
                                <button class="alloc-link-btn" onclick="event.stopPropagation(); toggleAllocRow({{ product.id }})" title="Allocate to customer orders">
                                    <i class="bi bi-diagram-3"></i>
                                    {% if product.allocations.count %}
                                    <span class="alloc-count">{{ product.allocations.count }}</span>
                                    {% endif %}
                                </button>
                            </div>
                            {% if product.description %}
                            <div class="po-product-description po-view-val">{{ product.description }}</div>
                            {% endif %}
                            <input class="po-edit-input po-edit-val" data-field="name" value="{{ product.name|default:'' }}" style="display:none;">
                        </td>
                        <td class="text-right">
                            <span class="po-view-val">£{{ product.order_price|floatformat:2 }}</span>
                            <input class="po-edit-input po-edit-val po-edit-number" data-field="order_price" type="number" step="0.01" value="{{ product.order_price }}" style="display:none;" oninput="recalcRowLineTotal(this)">
                        </td>
                        <td class="text-right">
                            <span class="po-view-val">{{ product.order_quantity|floatformat:0 }}</span>
                            <input class="po-edit-input po-edit-val po-edit-number" data-field="order_quantity" type="number" step="1" value="{{ product.order_quantity|floatformat:0 }}" style="display:none;" oninput="recalcRowLineTotal(this)">
                        </td>
                        <td class="text-right">
                            <span class="po-view-val">{{ product.received_quantity|floatformat:2 }}</span>
                            <input class="po-edit-input po-edit-val po-edit-number" data-field="received_quantity" type="number" step="0.01" value="{{ product.received_quantity }}" style="display:none;">
                        </td>
                        <td class="text-right">
                            <span class="po-view-val">£{{ product.invoice_price|floatformat:2 }}</span>
                            <input class="po-edit-input po-edit-val po-edit-number" data-field="invoice_price" type="number" step="0.01" value="{{ product.invoice_price }}" style="display:none;">
                        </td>
                        <td class="text-right">
                            <span class="po-line-total-display">£{{ product.line_total|floatformat:2 }}</span>
                        </td>
                        <td class="text-center">
                            <button class="btn-inline-delete" onclick="deleteProduct({{ product.id }}, this)" title="Delete"><i class="bi bi-trash"></i></button>
                        </td>
                    </tr>
                    {# Sub-allocation rows – always visible so distribution is clear #}
                    {% for alloc in product.allocations.all %}
                    <tr class="alloc-sub-row" data-product-id="{{ product.id }}" data-alloc-id="{{ alloc.id }}">
                        <td></td>
                        <td colspan="2">
                            <div class="alloc-sub-detail">
                                <i class="bi bi-arrow-return-right alloc-sub-indent"></i>
                                <a href="{% url 'order_details' alloc.order.id %}" class="alloc-sub-link">{{ alloc.order.sale_number }}</a>
                                <span class="alloc-sub-customer">{% if alloc.order.customer %}{{ alloc.order.customer }}{% elif alloc.order.first_name %}{{ alloc.order.first_name }} {{ alloc.order.last_name }}{% else %}Unknown{% endif %}</span>
                            </div>
                        </td>
                        <td class="text-right"><span class="alloc-sub-qty">{{ alloc.quantity|floatformat:0 }}</span></td>
                        <td colspan="3"></td>
                        <td class="text-center">
                            <button class="alloc-sub-remove" onclick="removeAllocation({{ purchase_order.workguru_id }}, {{ product.id }}, {{ alloc.id }}, this)" title="Remove allocation"><i class="bi bi-x-lg"></i></button>
                        </td>
                    </tr>
                    {% endfor %}
                    {# Add allocation form row (hidden, toggled by the alloc button) #}
                    <tr class="alloc-sub-add-row" id="alloc-row-{{ product.id }}" data-product-id="{{ product.id }}" style="display:none;">
                        <td></td>
                        <td colspan="2">
                            <div class="alloc-sub-detail">
                                <i class="bi bi-arrow-return-right alloc-sub-indent"></i>
                                <div class="alloc-search-wrapper">
                                    <input type="text" class="alloc-order-search" id="alloc-search-{{ product.id }}" placeholder="Search by name or order number..." autocomplete="off" oninput="searchOrders(this.value, {{ product.id }})">
                                    <input type="hidden" id="alloc-order-{{ product.id }}">
                                    <div class="alloc-search-results" id="alloc-results-{{ product.id }}"></div>
                                </div>
                            </div>
                        </td>
                        <td class="text-right">
                            <input type="number" class="alloc-qty-input" id="alloc-qty-{{ product.id }}" value="1" min="1" step="1" placeholder="Qty">
                        </td>
                        <td colspan="3"></td>
                        <td class="text-center">
                            <button class="alloc-save-btn" onclick="saveAllocation({{ purchase_order.workguru_id }}, {{ product.id }})" title="Add"><i class="bi bi-check-lg"></i></button>
                            <button class="alloc-sub-remove" onclick="toggleAllocRow({{ product.id }})" title="Cancel"><i class="bi bi-x-lg"></i></button>
                        </td>
                    </tr>
                    {% empty %}
                    {% endfor %}
                    {% for bp in board_product_rows %}
                    <tr class="board-product-row">
                        <td><code class="board-sku">{{ bp.sku }}</code></td>
                        <td>
                            <span>{{ bp.name }}</span>
                        </td>
                        <td class="text-right">£{{ bp.order_price|floatformat:2 }}</td>
                        <td class="text-right">{{ bp.order_quantity|floatformat:0 }}</td>
                        <td class="text-right">{{ bp.received_quantity|floatformat:0 }}</td>
                        <td class="text-right">-</td>
                        <td class="text-right">£{{ bp.line_total|floatformat:2 }}</td>
                        <td class="text-center">
                            <button class="btn-inline-delete" onclick="deleteBoardItems('{{ bp.item_ids }}', this)" title="Delete"><i class="bi bi-trash"></i></button>
                        </td>
                    </tr>
                    {% endfor %}
                    {% if board_product_rows %}
                    <tr class="board-product-totals-row">
                        <td colspan="3" class="text-right"><strong>Total</strong></td>
                        <td class="text-right"><strong>{{ total_board_qty|floatformat:0 }}</strong></td>
                        <td colspan="4"></td>
                    </tr>
                    {% endif %}
                    {% if not products and not board_product_rows %}
                    <tr id="no-products-row">
                        <td colspan="8" class="text-center" style="padding: 24px; color: var(--text-secondary);">
                            <i class="bi bi-inbox" style="font-size: 1.5rem; display: block; margin-bottom: 8px; opacity: 0.4;"></i>
                            No products yet. Click <strong>Add Product</strong> above to get started.
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
        
        <!-- Totals -->
        <div class="po-totals">
            <div class="po-totals-table">
                <div class="po-totals-row">
                    <div class="po-totals-label">Sub Total</div>
                    <div class="po-totals-value">{{ purchase_order.currency|default:"GBP" }} {{ purchase_order.total|floatformat:2 }}</div>
                </div>
                {% if purchase_order.tax_total %}
                <div class="po-totals-row">
                    <div class="po-totals-label">Tax Total</div>
                    <div class="po-totals-value">{{ purchase_order.currency|default:"GBP" }} {{ purchase_order.tax_total|floatformat:2 }}</div>
                </div>
                {% endif %}
                <div class="po-totals-row total">
                    <div class="po-totals-label">Total</div>
                    <div class="po-totals-value" id="po-total-display">{{ purchase_order.currency|default:"GBP" }} {{ purchase_order.total|floatformat:2 }}</div>
                </div>
                {% if purchase_order.currency and purchase_order.currency != 'GBP' and purchase_order.base_currency_total %}
                <div class="po-totals-row">
                    <div class="po-totals-label">GBP Equivalent</div>
                    <div class="po-totals-value">£{{ purchase_order.base_currency_total|floatformat:2 }}</div>
                </div>
                {% endif %}
                {% if purchase_order.invoiced_amount %}
                <div class="po-totals-row">
                    <div class="po-totals-label">Invoiced</div>
                    <div class="po-totals-value">£{{ purchase_order.invoiced_amount|floatformat:2 }}</div>
                </div>
                {% endif %}
                {% if purchase_order.amount_outstanding %}
                <div class="po-totals-row">
                    <div class="po-totals-label">Outstanding</div>
                    <div class="po-totals-value">£{{ purchase_order.amount_outstanding|floatformat:2 }}</div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    {% if os_door_items %}
    <!-- OS Door Products -->
    <div class="po-products-section">
        <h3><i class="bi bi-door-open"></i> OS Door Items</h3>
        <div class="po-table-container">
            <table class="po-products-table po-osdoor-table">
                <thead>
                    <tr>
                        <th>Order</th>
                        <th>Style</th>
                        <th>Colour</th>
                        <th class="text-right">Height</th>
                        <th class="text-right">Width</th>
                        <th class="text-right">Qty</th>
                        <th class="text-right">Received</th>
                        <th class="text-right">Cost</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for door in os_door_items %}
                    <tr class="{% if door.is_fully_received %}pnx-received{% endif %}">
                        <td>{{ door.customer.sale_number }}</td>
                        <td>{{ door.door_style }}</td>
                        <td>{{ door.colour }}</td>
                        <td class="text-right">{{ door.height|floatformat:0 }}</td>
                        <td class="text-right">{{ door.width|floatformat:0 }}</td>
                        <td class="text-right">{{ door.quantity }}</td>
                        <td class="text-right">{{ door.received_quantity|floatformat:0 }}</td>
                        <td class="text-right">£{{ door.cost_price|floatformat:2 }}</td>
                        <td>
                            {% if door.is_fully_received %}
                            <span class="pnx-status-badge received"><i class="bi bi-check-circle"></i> Received</span>
                            {% else %}
                            <span class="pnx-status-badge pending"><i class="bi bi-clock"></i> Pending</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    {% if related_pos %}
    <!-- Related POs Section -->
    <div class="po-products-section po-related-section">
        <h3><i class="bi bi-link-45deg"></i> Related Purchase Orders</h3>
        <p class="po-related-subtitle">Other POs on the same project ({{ purchase_order.project_number }})</p>
        <div class="po-table-container">
            <table class="po-products-table po-related-table">
                <thead>
                    <tr>
                        <th>PO Number</th>
                        <th>Supplier</th>
                        <th>Status</th>
                        <th class="text-right">Total</th>
                        <th class="text-right">Products</th>
                    </tr>
                </thead>
                <tbody>
                    {% for rpo in related_pos %}
                    <tr>
                        <td><a href="{% url 'purchase_order_detail' rpo.workguru_id %}" class="po-project-link">{{ rpo.display_number }}</a></td>
                        <td>{{ rpo.supplier_name|default:"-" }}</td>
                        <td>
                            <span class="po-status {% if rpo.status == 'Draft' %}draft{% elif rpo.status == 'Approved' %}approved{% elif rpo.status == 'Received' %}received{% elif rpo.status == 'Cancelled' %}cancelled{% endif %}">
                                {{ rpo.status }}
                            </span>
                        </td>
                        <td class="text-right">£{{ rpo.total|floatformat:2 }}</td>
                        <td class="text-right">{{ rpo.products.count }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Attachments Section -->
    <div class="po-products-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h3><i class="bi bi-paperclip"></i> Attachments</h3>
            <div style="display: flex; gap: 8px;">
                <button class="btn btn-sm btn-info" onclick="openMediaFilesModal()" title="Attach files from the app (PNX, CSV, etc.)">
                    <i class="bi bi-folder2-open"></i> Attach from Media
                </button>
                <button class="btn btn-sm btn-primary" onclick="document.getElementById('attachment-file-input').click()">
                    <i class="bi bi-upload"></i> Upload File
                </button>
                <form id="upload-attachment-form" style="display:none;">
                    {% csrf_token %}
                    <input type="file" id="attachment-file-input" onchange="uploadAttachment(this)">
                </form>
            </div>
        </div>
        <div id="attachments-list">
            {% if attachments %}
            <div class="po-table-container">
                <table class="po-products-table">
                    <thead>
                        <tr>
                            <th>File</th>
                            <th>Description</th>
                            <th>Uploaded By</th>
                            <th>Date</th>
                            <th style="width: 80px;"></th>
                        </tr>
                    </thead>
                    <tbody id="attachments-tbody">
                        {% for att in attachments %}
                        <tr id="attachment-row-{{ att.id }}">
                            <td>
                                <a href="{{ att.file.url }}" download class="po-boards-file-link">
                                    <i class="bi bi-file-earmark-arrow-down"></i> {{ att.filename }}
                                </a>
                            </td>
                            <td>{{ att.description }}</td>
                            <td>{{ att.uploaded_by }}</td>
                            <td>{{ att.uploaded_at|date:"d-m-Y H:i" }}</td>
                            <td>
                                <button class="btn btn-sm btn-danger" onclick="deleteAttachment({{ att.id }})" title="Delete">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted" id="no-attachments-msg">No attachments yet.</p>
            {% endif %}
        </div>
    </div>

    <!-- Invoices Section -->
    <div class="po-products-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h3><i class="bi bi-receipt"></i> Invoices</h3>
            <button class="btn btn-sm btn-primary" onclick="toggleInvoiceForm()">
                <i class="bi bi-plus-lg"></i> Add Invoice
            </button>
        </div>

        <!-- Add Invoice Form (hidden by default) -->
        <div id="invoice-add-form" class="po-invoice-form" style="display: none;">
            <form id="invoice-upload-form" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="po-invoice-form-grid">
                    <div class="po-invoice-field">
                        <label>Invoice Number</label>
                        <input type="text" id="inv-number" placeholder="e.g. INV-001" class="po-invoice-input">
                    </div>
                    <div class="po-invoice-field">
                        <label>Date</label>
                        <input type="date" id="inv-date" class="po-invoice-input">
                    </div>
                    <div class="po-invoice-field">
                        <label>Due Date</label>
                        <input type="date" id="inv-due-date" class="po-invoice-input">
                    </div>
                    <div class="po-invoice-field">
                        <label>Amount (£)</label>
                        <input type="number" id="inv-amount" step="0.01" min="0" placeholder="0.00" class="po-invoice-input">
                    </div>
                    <div class="po-invoice-field">
                        <label>Status</label>
                        <select id="inv-status" class="po-invoice-input">
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="paid">Paid</option>
                        </select>
                    </div>
                    <div class="po-invoice-field">
                        <label>File (optional)</label>
                        <input type="file" id="inv-file" class="po-invoice-input">
                    </div>
                    <div class="po-invoice-field po-invoice-field-wide">
                        <label>Notes</label>
                        <input type="text" id="inv-notes" placeholder="Optional notes" class="po-invoice-input">
                    </div>
                </div>
                <div class="po-invoice-form-actions">
                    <button type="button" class="btn btn-sm btn-success" onclick="submitInvoice()">
                        <i class="bi bi-check-lg"></i> Save Invoice
                    </button>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="toggleInvoiceForm()">
                        Cancel
                    </button>
                </div>
            </form>
        </div>

        <div id="invoices-list">
            {% if po_invoices %}
            <div class="po-table-container">
                <table class="po-products-table">
                    <thead>
                        <tr>
                            <th>Invoice #</th>
                            <th>Date</th>
                            <th>Due Date</th>
                            <th style="text-align: right;">Amount</th>
                            <th>Status</th>
                            <th>File</th>
                            <th>Notes</th>
                            <th style="width: 80px;"></th>
                        </tr>
                    </thead>
                    <tbody id="invoices-tbody">
                        {% for inv in po_invoices %}
                        <tr id="invoice-row-{{ inv.id }}">
                            <td>{{ inv.invoice_number|default:"—" }}</td>
                            <td>{{ inv.date|date:"d-m-Y"|default:"—" }}</td>
                            <td>{{ inv.due_date|date:"d-m-Y"|default:"—" }}</td>
                            <td style="text-align: right;">£{{ inv.amount|floatformat:2 }}</td>
                            <td>
                                <span class="po-invoice-status po-invoice-status-{{ inv.status }}">
                                    {{ inv.get_status_display }}
                                </span>
                            </td>
                            <td>
                                {% if inv.file %}
                                <a href="{{ inv.file.url }}" download class="po-boards-file-link">
                                    <i class="bi bi-file-earmark-arrow-down"></i> {{ inv.filename }}
                                </a>
                                {% else %}
                                <span class="text-muted">—</span>
                                {% endif %}
                            </td>
                            <td>{{ inv.notes|default:"" }}</td>
                            <td>
                                <button class="btn btn-sm btn-danger" onclick="deleteInvoice({{ inv.id }})" title="Delete">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted" id="no-invoices-msg">No invoices attached yet.</p>
            {% endif %}
        </div>
    </div>

    {% endif %}
</div>

<!-- Product search dropdown (outside table container to avoid overflow clipping) -->
<div class="product-search-results" id="product-search-results" style="display:none;"></div>

<!-- Attach from Media Modal -->
<div class="modal-overlay" id="media-files-modal" style="display:none;" onclick="closeMediaFilesModal(event)">
    <div class="modal-dialog" style="max-width: 700px;" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3><i class="bi bi-folder2-open"></i> Attach from Media</h3>
            <button class="modal-close" onclick="closeMediaFilesModal()">&times;</button>
        </div>
        <div class="modal-body" id="media-files-list">
            <p class="text-muted">Loading...</p>
        </div>
    </div>
</div>

<!-- Send Email Modal -->
<div class="modal-overlay" id="send-modal" style="display:none;" onclick="closeSendModal(event)">
    <div class="modal-dialog" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3><i class="bi bi-envelope"></i> Send Purchase Order</h3>
            <button class="modal-close" onclick="closeSendModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="modal-form-group">
                <label>To <span class="required">*</span></label>
                {% if supplier_contacts %}
                <div class="email-recipients-list">
                    {% for c in supplier_contacts %}
                    <label class="email-recipient-item">
                        <input type="checkbox" class="contact-recipient-cb"
                               value="{{ c.email }}"
                               {% if c.is_default %}checked{% endif %}>
                        {% if c.first_name or c.last_name %}<span class="email-recipient-name">{{ c.first_name }} {{ c.last_name }}</span> &mdash; {% endif %}
                        <span class="email-recipient-email">{{ c.email }}</span>
                        {% if c.position %}<span class="email-recipient-position">({{ c.position }})</span>{% endif %}
                        {% if c.is_default %}<span class="attachment-auto-tag" style="margin-left:auto;">default</span>{% endif %}
                    </label>
                    {% endfor %}
                </div>
                {% endif %}
                <input type="email" id="send-to" class="modal-input" placeholder="{% if supplier_contacts %}Additional email address…{% else %}supplier@example.com{% endif %}" value="{% if not supplier_contacts %}{{ supplier_email|default:'' }}{% endif %}">
                {% if supplier_contacts %}<div class="email-recipients-hint">Tick contacts above to include them as recipients, or enter an additional address below.</div>{% endif %}
            </div>
            <div class="modal-form-group">
                <label for="send-cc">CC</label>
                <input type="text" id="send-cc" class="modal-input" placeholder="Optional, comma-separated" value="orders@sliderobes.com">
            </div>
            <div class="modal-form-group">
                <label for="send-subject">Subject</label>
                <input type="text" id="send-subject" class="modal-input" value="Purchase Order {{ purchase_order.display_number }} - Sliderobes">
            </div>
            <div class="modal-form-group">
                <label for="send-body">Message</label>
                <textarea id="send-body" class="modal-textarea" rows="8">Dear {{ purchase_order.supplier_name|default:"Supplier" }},

Please find attached Purchase Order {{ purchase_order.display_number }}.

Expected delivery date: {{ expected_delivery_date }}

If you have any questions, please do not hesitate to contact us.

Kind regards,
Sliderobes</textarea>
            </div>
            <div class="modal-form-group">
                <label>Attachments</label>
                <div class="email-attachments-list">
                    <label class="email-attachment-item">
                        <input type="checkbox" checked disabled>
                        <i class="bi bi-file-earmark-pdf"></i>
                        <span>Purchase_Order_{{ purchase_order.display_number }}.pdf</span>
                        <span class="attachment-auto-tag">auto</span>
                    </label>
                    {% for att in attachments %}
                    <label class="email-attachment-item">
                        <input type="checkbox" class="email-att-checkbox" value="{{ att.id }}">
                        <i class="bi bi-file-earmark-arrow-down"></i>
                        <span>{{ att.filename }}</span>
                    </label>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-sm btn-secondary" onclick="closeSendModal()">Cancel</button>
            <button class="btn btn-sm btn-send" id="send-email-btn" onclick="sendPOEmail()">
                <i class="bi bi-send"></i> Send Email
            </button>
        </div>
    </div>
</div>

<script>
let editMode = false;
const poId = {{ purchase_order.workguru_id }};

// ===== Multi-Project Management =====

function addProjectStock() {
    fetch(`/purchase-order/${poId}/add-project/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
        },
        body: JSON.stringify({ project_type: 'stock' }),
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            const list = document.getElementById('project-display');
            // Remove "No projects assigned" placeholder
            const empty = list.querySelector('.po-projects-empty');
            if (empty) empty.remove();

            const entry = document.createElement('div');
            entry.className = 'po-project-entry is-stock';
            entry.dataset.projectId = data.project.id;
            entry.innerHTML = `
                <span class="po-stock-badge">Stock</span>
                <button class="btn-project-remove" onclick="removeProject(${poId}, ${data.project.id}, this)" title="Remove"><i class="bi bi-x-lg"></i></button>
            `;
            list.appendChild(entry);
            showNotification('Stock entry added', 'success');
        } else {
            showNotification(data.error || 'Failed to add stock entry', 'error');
        }
    })
    .catch(err => showNotification('Error: ' + err.message, 'error'));
}

let projectSearchTimeout = null;

function toggleProjectCustomerSearch() {
    const wrapper = document.getElementById('project-customer-search');
    if (wrapper.style.display === 'none') {
        wrapper.style.display = 'block';
        document.getElementById('project-search-input').focus();
    } else {
        wrapper.style.display = 'none';
        document.getElementById('project-search-input').value = '';
        document.getElementById('project-search-order-id').value = '';
        document.getElementById('project-search-results').innerHTML = '';
        document.getElementById('project-search-results').style.display = 'none';
    }
}

function searchProjectOrders(query) {
    clearTimeout(projectSearchTimeout);
    const resultsDiv = document.getElementById('project-search-results');

    if (query.length < 2) {
        resultsDiv.innerHTML = '';
        resultsDiv.style.display = 'none';
        return;
    }

    projectSearchTimeout = setTimeout(() => {
        fetch(`/api/order-search/?q=${encodeURIComponent(query)}`)
        .then(r => r.json())
        .then(data => {
            if (data.results && data.results.length > 0) {
                resultsDiv.innerHTML = data.results.map(o =>
                    `<div class="alloc-search-item" onclick="selectProjectOrder(${o.id}, '${o.sale_number}', '${o.customer_name.replace(/'/g, "\\'")}')">
                        <span class="alloc-result-name">${o.customer_name}</span>
                        <span class="alloc-result-sale">${o.sale_number}</span>
                    </div>`
                ).join('');
                resultsDiv.style.display = 'block';
            } else {
                resultsDiv.innerHTML = '<div class="alloc-search-empty">No orders found</div>';
                resultsDiv.style.display = 'block';
            }
        })
        .catch(() => { resultsDiv.style.display = 'none'; });
    }, 250);
}

function selectProjectOrder(orderId, saleNumber, customerName) {
    document.getElementById('project-search-order-id').value = orderId;
    document.getElementById('project-search-input').value = customerName + ' - ' + saleNumber;
    document.getElementById('project-search-results').style.display = 'none';
}

function addProjectCustomer() {
    const orderId = document.getElementById('project-search-order-id').value;
    if (!orderId) {
        showNotification('Please search and select an order', 'error');
        return;
    }

    fetch(`/purchase-order/${poId}/add-project/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
        },
        body: JSON.stringify({ project_type: 'customer', order_id: parseInt(orderId) }),
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            const list = document.getElementById('project-display');
            const empty = list.querySelector('.po-projects-empty');
            if (empty) empty.remove();

            const entry = document.createElement('div');
            entry.className = 'po-project-entry';
            entry.dataset.projectId = data.project.id;
            const orderUrl = data.project.order_id ? `/order/${data.project.order_id}/` : '#';
            entry.innerHTML = `
                <a href="${orderUrl}" class="po-project-link" title="View order ${data.project.sale_number}">
                    <i class="bi bi-box-arrow-up-right"></i> ${data.project.label}
                </a>
                <button class="btn-project-remove" onclick="removeProject(${poId}, ${data.project.id}, this)" title="Remove"><i class="bi bi-x-lg"></i></button>
            `;
            list.appendChild(entry);

            // Reset search
            toggleProjectCustomerSearch();
            showNotification('Customer order linked', 'success');
        } else {
            showNotification(data.error || 'Failed to link customer order', 'error');
        }
    })
    .catch(err => showNotification('Error: ' + err.message, 'error'));
}

function removeProject(poId, projectId, btn) {
    if (!confirm('Remove this project entry?')) return;

    fetch(`/purchase-order/${poId}/remove-project/${projectId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
        },
        body: '{}',
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            const entry = btn.closest('.po-project-entry');
            if (entry) entry.remove();
            // Show empty placeholder if none left
            const list = document.getElementById('project-display');
            if (!list.querySelector('.po-project-entry')) {
                list.innerHTML = '<span class="po-projects-empty">No projects assigned</span>';
            }
            showNotification('Project entry removed', 'success');
        } else {
            showNotification(data.error || 'Failed to remove', 'error');
        }
    })
    .catch(err => showNotification('Error: ' + err.message, 'error'));
}

function toggleEditMode() {
    editMode = true;
    document.querySelectorAll('.po-view-val').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.po-edit-val').forEach(el => el.style.display = '');
    document.getElementById('edit-toggle-btn').style.display = 'none';
    document.getElementById('save-btn').style.display = '';
    document.getElementById('cancel-btn').style.display = '';
    document.getElementById('po-overview').classList.add('editing');
    document.getElementById('products-table')?.classList.add('editing');
}

function cancelEdit() {
    editMode = false;
    document.querySelectorAll('.po-view-val').forEach(el => el.style.display = '');
    document.querySelectorAll('.po-edit-val').forEach(el => el.style.display = 'none');
    document.getElementById('edit-toggle-btn').style.display = '';
    document.getElementById('save-btn').style.display = 'none';
    document.getElementById('cancel-btn').style.display = 'none';
    document.getElementById('po-overview').classList.remove('editing');
    document.getElementById('products-table')?.classList.remove('editing');
}

function savePO() {
    const saveBtn = document.getElementById('save-btn');
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Saving...';
    
    // Gather header fields
    const data = {};
    document.querySelectorAll('#po-overview .po-edit-val[data-field]').forEach(input => {
        if (input.tagName === 'LABEL') return;  // checkbox handled separately
        data[input.dataset.field] = input.value;
    });
    data.billable = document.getElementById('billable-check')?.checked || false;
    
    // Gather product line edits
    const products = [];
    document.querySelectorAll('#products-table tbody tr[data-product-id]').forEach(row => {
        const prod = { id: row.dataset.productId };
        row.querySelectorAll('.po-edit-val[data-field]').forEach(input => {
            prod[input.dataset.field] = input.value;
        });
        products.push(prod);
    });
    data.products = products;
    
    fetch('{% url "purchase_order_save" purchase_order.workguru_id %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
        },
        body: JSON.stringify(data),
    })
    .then(res => res.json())
    .then(result => {
        if (result.success) {
            showNotification('Purchase order saved successfully.', 'success');
            // Update total display
            if (result.total) {
                document.getElementById('po-total-display').textContent = '£' + parseFloat(result.total).toFixed(2);
            }
            setTimeout(() => location.reload(), 800);
        } else {
            showNotification('Error: ' + (result.error || 'Unknown error'), 'error');
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="bi bi-check-lg"></i> Save';
        }
    })
    .catch(err => {
        showNotification('Network error: ' + err.message, 'error');
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="bi bi-check-lg"></i> Save';
    });
}

function showNotification(message, type) {
    const el = document.getElementById('save-notification');
    el.textContent = message;
    el.className = 'po-save-notification ' + type;
    el.style.display = 'block';
    if (type === 'success') {
        setTimeout(() => { el.style.display = 'none'; }, 3000);
    }
}

function receivePO() {
    if (!confirm('Mark this PO as received? This will update all linked items (boards/doors) as received.')) {
        return;
    }
    const btn = document.getElementById('receive-btn');
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Receiving...';
    
    fetch('{% url "purchase_order_receive" purchase_order.workguru_id %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
        },
        body: JSON.stringify({}),
    })
    .then(res => res.json())
    .then(result => {
        if (result.success) {
            showNotification('PO marked as received. ' + result.received_items + ' items updated.', 'success');
            setTimeout(() => location.reload(), 800);
        } else {
            showNotification('Error: ' + (result.error || 'Unknown error'), 'error');
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-box-arrow-in-down"></i> Receive';
        }
    })
    .catch(err => {
        showNotification('Network error: ' + err.message, 'error');
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-box-arrow-in-down"></i> Receive';
    });
}

/* ── Add Product ─────────────────────────────────── */
let addRowVisible = false;

function toggleAddProductRow() {
    const row = document.getElementById('add-product-row');
    addRowVisible = !addRowVisible;
    row.style.display = addRowVisible ? '' : 'none';

    // Hide the empty-state row when adding
    const emptyRow = document.getElementById('no-products-row');
    if (emptyRow && addRowVisible) emptyRow.style.display = 'none';
    if (emptyRow && !addRowVisible) {
        const hasProducts = document.querySelectorAll('#products-table tbody tr[data-product-id]').length > 0;
        emptyRow.style.display = hasProducts ? 'none' : '';
    }

    if (addRowVisible) {
        document.getElementById('product-search').focus();
    } else {
        // Reset to search mode
        document.getElementById('search-cell').style.display = '';
        document.getElementById('search-cell').setAttribute('colspan', '2');
        document.getElementById('selected-sku').style.display = 'none';
        document.getElementById('selected-name').style.display = 'none';
        document.getElementById('product-search').value = '';
        document.getElementById('new-sku').value = '';
        document.getElementById('new-supplier-code').value = '';
        document.getElementById('new-name').value = '';
        document.getElementById('new-stock-item-id').value = '';
        document.getElementById('new-description').value = '';
        document.getElementById('display-sku').textContent = '';
        document.getElementById('display-name').textContent = '';
        ['new-order-price','new-order-qty'].forEach(id => {
            document.getElementById(id).value = '';
        });
        document.getElementById('new-line-total').textContent = '£0.00';
        document.getElementById('product-search-results').style.display = 'none';
    }
}

function calcNewLineTotal() {
    const price = parseFloat(document.getElementById('new-order-price').value) || 0;
    const qty = parseFloat(document.getElementById('new-order-qty').value) || 0;
    document.getElementById('new-line-total').textContent = '£' + (price * qty).toFixed(2);
}

function recalcRowLineTotal(input) {
    const row = input.closest('tr');
    if (!row) return;
    const priceInput = row.querySelector('input[data-field="order_price"]');
    const qtyInput = row.querySelector('input[data-field="order_quantity"]');
    if (!priceInput || !qtyInput) return;
    const price = parseFloat(priceInput.value) || 0;
    const qty = parseFloat(qtyInput.value) || 0;
    const total = (price * qty).toFixed(2);
    const display = row.querySelector('.po-line-total-display');
    if (display) display.textContent = '£' + total;
}

/* ── Product Search ─────────────────────────────── */
let searchTimeout = null;

function searchProducts(query) {
    const resultsDiv = document.getElementById('product-search-results');
    if (query.length < 2) {
        resultsDiv.style.display = 'none';
        return;
    }

    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        const url = '{% url "product_search" %}?q=' + encodeURIComponent(query);
        fetch(url)
            .then(res => res.json())
            .then(data => {
                // Position the dropdown below the search input using fixed positioning
                const input = document.getElementById('product-search');
                const rect = input.getBoundingClientRect();
                resultsDiv.style.top = (rect.bottom + 2) + 'px';
                resultsDiv.style.left = rect.left + 'px';
                resultsDiv.style.width = rect.width + 'px';

                if (data.results.length === 0) {
                    resultsDiv.innerHTML = '<div class="product-search-item no-results">No products found</div>';
                    resultsDiv.style.display = 'block';
                    return;
                }
                resultsDiv.innerHTML = data.results.map(item => {
                    const safeSku = (item.sku || '').replace(/'/g, "\\'");
                    const safeName = (item.name || '').replace(/'/g, "\\'");
                    const safeDesc = (item.description || '').replace(/'/g, "\\'").replace(/\n/g, ' ');
                    return `<div class="product-search-item" onclick="selectProduct(${item.id}, '${safeSku}', '${safeName}', '${item.cost}', '${safeDesc}')">
                        <span class="product-search-sku">${item.sku}</span>
                        <span class="product-search-name">${item.name}</span>
                        <span class="product-search-cost">£${parseFloat(item.cost).toFixed(2)}</span>
                    </div>`;
                }).join('');
                resultsDiv.style.display = 'block';
            })
            .catch(err => {
                console.error('Product search error:', err);
                resultsDiv.style.display = 'none';
            });
    }, 250);
}

function selectProduct(id, sku, name, cost, description) {
    // Hide search, show selected product in correct columns
    document.getElementById('search-cell').style.display = 'none';
    document.getElementById('selected-sku').style.display = '';
    document.getElementById('selected-name').style.display = '';
    document.getElementById('display-sku').textContent = sku;
    document.getElementById('display-name').textContent = name;

    document.getElementById('new-sku').value = sku;
    document.getElementById('new-name').value = name;
    document.getElementById('new-stock-item-id').value = id;
    document.getElementById('new-description').value = description;
    document.getElementById('new-order-price').value = parseFloat(cost).toFixed(2);
    document.getElementById('product-search-results').style.display = 'none';
    document.getElementById('new-order-qty').focus();
    calcNewLineTotal();
}

// Close search results when clicking outside
document.addEventListener('click', function(e) {
    const resultsDiv = document.getElementById('product-search-results');
    const searchInput = document.getElementById('product-search');
    if (resultsDiv && searchInput && !resultsDiv.contains(e.target) && e.target !== searchInput) {
        resultsDiv.style.display = 'none';
    }
});

function saveNewProduct() {
    const name = document.getElementById('new-name').value.trim();
    if (!name) {
        showNotification('Please search and select a product first.', 'error');
        document.getElementById('product-search').focus();
        return;
    }

    const stockItemId = document.getElementById('new-stock-item-id').value;
    const data = {
        sku: document.getElementById('new-sku').value.trim(),
        supplier_code: document.getElementById('new-supplier-code').value.trim(),
        name: name,
        description: document.getElementById('new-description').value.trim(),
        order_price: document.getElementById('new-order-price').value || 0,
        order_quantity: document.getElementById('new-order-qty').value || 0,
        stock_item_id: stockItemId ? parseInt(stockItemId) : null,
    };

    fetch('{% url "purchase_order_add_product" purchase_order.workguru_id %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
        },
        body: JSON.stringify(data),
    })
    .then(res => res.json())
    .then(result => {
        if (result.success) {
            showNotification('Product added.', 'success');
            // Update total
            if (result.po_total) {
                const el = document.getElementById('po-total-display');
                if (el) el.textContent = '{{ purchase_order.currency|default:"GBP" }} ' + parseFloat(result.po_total).toFixed(2);
            }
            setTimeout(() => location.reload(), 600);
        } else {
            showNotification('Error: ' + (result.error || 'Unknown'), 'error');
        }
    })
    .catch(err => showNotification('Network error: ' + err.message, 'error'));
}

function deleteProduct(productId, btn) {
    if (!confirm('Delete this product line?')) return;
    btn.disabled = true;

    fetch(`/purchase-order/{{ purchase_order.workguru_id }}/delete-product/${productId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
        },
        body: JSON.stringify({}),
    })
    .then(res => res.json())
    .then(result => {
        if (result.success) {
            showNotification('Product removed.', 'success');
            // Remove the table row
            const row = btn.closest('tr');
            if (row) row.remove();
            // Update total
            if (result.po_total) {
                const el = document.getElementById('po-total-display');
                if (el) el.textContent = '{{ purchase_order.currency|default:"GBP" }} ' + parseFloat(result.po_total).toFixed(2);
            }
        } else {
            showNotification('Error: ' + (result.error || 'Unknown'), 'error');
            btn.disabled = false;
        }
    })
    .catch(err => {
        showNotification('Network error: ' + err.message, 'error');
        btn.disabled = false;
    });
}

function deleteBoardItems(itemIds, btn) {
    if (!confirm('Delete this board product group?')) return;
    btn.disabled = true;

    fetch(`/purchase-order/{{ purchase_order.workguru_id }}/delete-board-items/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
        },
        body: JSON.stringify({ item_ids: itemIds }),
    })
    .then(res => res.json())
    .then(result => {
        if (result.success) {
            showNotification('Board items removed.', 'success');
            const row = btn.closest('tr');
            if (row) row.remove();
            if (result.po_total) {
                const el = document.getElementById('po-total-display');
                if (el) el.textContent = '{{ purchase_order.currency|default:"GBP" }} ' + parseFloat(result.po_total).toFixed(2);
            }
        } else {
            showNotification('Error: ' + (result.error || 'Unknown'), 'error');
            btn.disabled = false;
        }
    })
    .catch(err => {
        showNotification('Network error: ' + err.message, 'error');
        btn.disabled = false;
    });
}

/* ── Send PO Email ──────────────────────────────── */
function openSendModal() {
    document.getElementById('send-modal').style.display = 'flex';
}

function closeSendModal(event) {
    if (event && event.target !== document.getElementById('send-modal')) return;
    document.getElementById('send-modal').style.display = 'none';
}

function sendPOEmail() {
    const btn = document.getElementById('send-email-btn');

    // Collect recipients: checked contact checkboxes + manual field
    const recipientSet = new Set();
    document.querySelectorAll('.contact-recipient-cb:checked').forEach(cb => {
        if (cb.value.trim()) recipientSet.add(cb.value.trim());
    });
    const manualTo = document.getElementById('send-to').value.trim();
    if (manualTo) manualTo.split(',').forEach(e => { if (e.trim()) recipientSet.add(e.trim()); });
    const to = Array.from(recipientSet).join(', ');

    const cc = document.getElementById('send-cc').value.trim();
    const subject = document.getElementById('send-subject').value.trim();
    const body = document.getElementById('send-body').value.trim();

    // Gather selected attachment IDs
    const attachmentIds = [];
    document.querySelectorAll('.email-att-checkbox:checked').forEach(cb => {
        attachmentIds.push(parseInt(cb.value));
    });

    if (!to) {
        showNotification('Please enter a recipient email address.', 'error');
        document.getElementById('send-to').focus();
        return;
    }

    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Sending...';

    fetch('{% url "purchase_order_send_email" purchase_order.workguru_id %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
        },
        body: JSON.stringify({ to, cc, subject, body, attachment_ids: attachmentIds }),
    })
    .then(res => res.json())
    .then(result => {
        if (result.success) {
            showNotification(result.message || 'Email sent successfully!', 'success');
            closeSendModal();
            // Reload to reflect auto-approved status
            if (result.new_status) {
                setTimeout(() => location.reload(), 1000);
            }
        } else {
            showNotification('Error: ' + (result.error || 'Failed to send'), 'error');
        }
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-send"></i> Send Email';
    })
    .catch(err => {
        showNotification('Network error: ' + err.message, 'error');
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-send"></i> Send Email';
    });
}

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        document.getElementById('send-modal').style.display = 'none';
    }
});

function updatePOStatus(newStatus) {
    const action = newStatus === 'Approved' ? 'approve' : 'revert to draft';
    if (!confirm(`Are you sure you want to ${action} this purchase order?`)) return;

    fetch('{% url "purchase_order_update_status" purchase_order.workguru_id %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
        },
        body: JSON.stringify({ status: newStatus }),
    })
    .then(res => res.json())
    .then(result => {
        if (result.success) {
            showNotification(`Purchase order ${result.status.toLowerCase()} successfully.`, 'success');
            setTimeout(() => location.reload(), 800);
        } else {
            showNotification('Error: ' + (result.error || 'Failed'), 'error');
        }
    })
    .catch(err => showNotification('Network error: ' + err.message, 'error'));
}

// ---- Attachments ----
function uploadAttachment(input) {
    if (!input.files.length) return;
    const file = input.files[0];
    const formData = new FormData();
    formData.append('file', file);
    formData.append('description', '');

    fetch(`/purchase-order/{{ purchase_order.workguru_id }}/upload-attachment/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': '{{ csrf_token }}' },
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showNotification('File uploaded successfully', 'success');
            setTimeout(() => location.reload(), 800);
        } else {
            showNotification(data.error || 'Upload failed', 'error');
        }
    })
    .catch(err => showNotification('Upload error: ' + err.message, 'error'));

    input.value = '';
}

function deleteAttachment(attachmentId) {
    if (!confirm('Delete this attachment?')) return;

    fetch(`/purchase-order/{{ purchase_order.workguru_id }}/delete-attachment/${attachmentId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            const row = document.getElementById(`attachment-row-${attachmentId}`);
            if (row) row.remove();
            showNotification('Attachment deleted', 'success');
        } else {
            showNotification(data.error || 'Delete failed', 'error');
        }
    })
    .catch(err => showNotification('Error: ' + err.message, 'error'));
}

function attachBoardsFiles() {
    if (!confirm('Attach the PNX and CSV files from the linked boards PO?')) return;

    fetch(`/purchase-order/{{ purchase_order.workguru_id }}/attach-boards-files/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            setTimeout(() => location.reload(), 800);
        } else {
            showNotification(data.error || 'Failed to attach files', 'error');
        }
    })
    .catch(err => showNotification('Error: ' + err.message, 'error'));
}

// ---- Invoices ----
function toggleInvoiceForm() {
    const form = document.getElementById('invoice-add-form');
    form.style.display = form.style.display === 'none' ? 'block' : 'none';
}

function submitInvoice() {
    const formData = new FormData();
    formData.append('invoice_number', document.getElementById('inv-number').value);
    formData.append('date', document.getElementById('inv-date').value);
    formData.append('due_date', document.getElementById('inv-due-date').value);
    formData.append('amount', document.getElementById('inv-amount').value);
    formData.append('status', document.getElementById('inv-status').value);
    formData.append('notes', document.getElementById('inv-notes').value);

    const fileInput = document.getElementById('inv-file');
    if (fileInput.files.length) {
        formData.append('file', fileInput.files[0]);
    }

    fetch(`/purchase-order/{{ purchase_order.workguru_id }}/upload-invoice/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': '{{ csrf_token }}' },
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showNotification('Invoice added successfully', 'success');
            setTimeout(() => location.reload(), 800);
        } else {
            showNotification(data.error || 'Failed to add invoice', 'error');
        }
    })
    .catch(err => showNotification('Error: ' + err.message, 'error'));
}

function deleteInvoice(invoiceId) {
    if (!confirm('Delete this invoice?')) return;

    fetch(`/purchase-order/{{ purchase_order.workguru_id }}/delete-invoice/${invoiceId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            const row = document.getElementById(`invoice-row-${invoiceId}`);
            if (row) row.remove();
            showNotification('Invoice deleted', 'success');
        } else {
            showNotification(data.error || 'Delete failed', 'error');
        }
    })
    .catch(err => showNotification('Error: ' + err.message, 'error'));
}

function deletePO() {
    if (!confirm('Are you sure you want to delete Purchase Order {{ purchase_order.display_number }}? This cannot be undone.')) return;

    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/purchase-order/{{ purchase_order.workguru_id }}/delete/';
    const csrf = document.createElement('input');
    csrf.type = 'hidden';
    csrf.name = 'csrfmiddlewaretoken';
    csrf.value = '{{ csrf_token }}';
    form.appendChild(csrf);
    document.body.appendChild(form);
    form.submit();
}

function openMediaFilesModal() {
    const modal = document.getElementById('media-files-modal');
    const list = document.getElementById('media-files-list');
    list.innerHTML = '<p class="text-muted">Loading...</p>';
    modal.style.display = 'flex';

    fetch(`/purchase-order/{{ purchase_order.workguru_id }}/media-files/`)
    .then(r => r.json())
    .then(data => {
        if (!data.files || data.files.length === 0) {
            list.innerHTML = '<p class="text-muted">No media files found for this PO.</p>';
            return;
        }
        let html = '<table class="po-products-table"><thead><tr><th>File</th><th>Description</th><th style="width:120px;"></th></tr></thead><tbody>';
        data.files.forEach(f => {
            const disabled = f.already_attached ? 'disabled' : '';
            const btnText = f.already_attached ? 'Attached' : 'Attach';
            const btnClass = f.already_attached ? 'btn-secondary' : 'btn-primary';
            html += `<tr>
                <td><i class="bi bi-file-earmark"></i> ${f.filename}</td>
                <td>${f.description}</td>
                <td><button class="btn btn-sm ${btnClass}" ${disabled}
                    onclick="attachMediaFile(this, '${f.source}', '${f.field}', ${f.order_id || 'null'})">
                    <i class="bi bi-paperclip"></i> ${btnText}</button></td>
            </tr>`;
        });
        html += '</tbody></table>';
        list.innerHTML = html;
    })
    .catch(err => {
        list.innerHTML = `<p class="text-danger">Error loading files: ${err.message}</p>`;
    });
}

function closeMediaFilesModal(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('media-files-modal').style.display = 'none';
}

function attachMediaFile(btn, source, field, orderId) {
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Attaching...';

    const payload = { source: source, field: field };
    if (orderId) payload.order_id = orderId;

    fetch(`/purchase-order/{{ purchase_order.workguru_id }}/attach-media-file/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            btn.innerHTML = '<i class="bi bi-check"></i> Attached';
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-secondary');
            showNotification(`${data.attachment.filename} attached`, 'success');
        } else {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-paperclip"></i> Attach';
            showNotification(data.error || 'Failed', 'error');
        }
    })
    .catch(err => {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-paperclip"></i> Attach';
        showNotification('Error: ' + err.message, 'error');
    });
}

// ===== Product Customer Allocations =====
let allocSearchTimeout = null;

function toggleAllocRow(productId) {
    const row = document.getElementById('alloc-row-' + productId);
    if (row.style.display === 'none') {
        row.style.display = 'table-row';
        document.getElementById('alloc-search-' + productId).focus();
    } else {
        row.style.display = 'none';
        // Clear search
        document.getElementById('alloc-search-' + productId).value = '';
        document.getElementById('alloc-order-' + productId).value = '';
        document.getElementById('alloc-results-' + productId).innerHTML = '';
        document.getElementById('alloc-results-' + productId).style.display = 'none';
    }
}

function searchOrders(query, productId) {
    clearTimeout(allocSearchTimeout);
    const resultsDiv = document.getElementById('alloc-results-' + productId);

    if (query.length < 2) {
        resultsDiv.innerHTML = '';
        resultsDiv.style.display = 'none';
        return;
    }

    allocSearchTimeout = setTimeout(() => {
        fetch(`/api/order-search/?q=${encodeURIComponent(query)}`)
        .then(r => r.json())
        .then(data => {
            if (data.results && data.results.length > 0) {
                resultsDiv.innerHTML = data.results.map(o =>
                    `<div class="alloc-search-item" onclick="selectAllocOrder(${productId}, ${o.id}, '${o.sale_number}', '${o.customer_name.replace(/'/g, "\\'")}')">
                        <span class="alloc-result-name">${o.customer_name}</span>
                        <span class="alloc-result-sale">${o.sale_number}</span>
                    </div>`
                ).join('');
                resultsDiv.style.display = 'block';
            } else {
                resultsDiv.innerHTML = '<div class="alloc-search-empty">No orders found</div>';
                resultsDiv.style.display = 'block';
            }
        })
        .catch(() => {
            resultsDiv.style.display = 'none';
        });
    }, 250);
}

function selectAllocOrder(productId, orderId, saleNumber, customerName) {
    document.getElementById('alloc-order-' + productId).value = orderId;
    document.getElementById('alloc-search-' + productId).value = customerName + ' - ' + saleNumber;
    document.getElementById('alloc-results-' + productId).style.display = 'none';
}

// Close search results when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('.alloc-search-wrapper')) {
        document.querySelectorAll('.alloc-search-results').forEach(el => el.style.display = 'none');
    }
});

function saveAllocation(poId, productId) {
    const orderId = document.getElementById('alloc-order-' + productId).value;
    const qty = document.getElementById('alloc-qty-' + productId).value;

    if (!orderId) {
        showNotification('Please search and select an order', 'error');
        return;
    }

    const formData = new FormData();
    formData.append('order_id', orderId);
    formData.append('quantity', qty);
    formData.append('notes', '');
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

    fetch(`/purchase-order/${poId}/product/${productId}/add-allocation/`, {
        method: 'POST',
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            // Insert a new sub-row before the add-form row
            const addRow = document.getElementById('alloc-row-' + productId);
            const newRow = document.createElement('tr');
            newRow.className = 'alloc-sub-row';
            newRow.dataset.productId = productId;
            newRow.dataset.allocId = data.allocation.id;
            newRow.innerHTML = `
                <td></td>
                <td colspan="2">
                    <div class="alloc-sub-detail">
                        <i class="bi bi-arrow-return-right alloc-sub-indent"></i>
                        <a href="/order/${data.allocation.order_id}/" class="alloc-sub-link">${data.allocation.sale_number}</a>
                        <span class="alloc-sub-customer">${data.allocation.customer_name}</span>
                    </div>
                </td>
                <td class="text-right"><span class="alloc-sub-qty">${Math.round(data.allocation.quantity)}</span></td>
                <td colspan="3"></td>
                <td class="text-center">
                    <button class="alloc-sub-remove" onclick="removeAllocation(${poId}, ${productId}, ${data.allocation.id}, this)" title="Remove allocation"><i class="bi bi-x-lg"></i></button>
                </td>
            `;
            addRow.parentNode.insertBefore(newRow, addRow);

            // Update the count badge on the alloc button
            const productRow = document.querySelector(`tr[data-product-id='${productId}']:not(.alloc-sub-row):not(.alloc-sub-add-row)`);
            const subRowCount = document.querySelectorAll(`tr.alloc-sub-row[data-product-id='${productId}']`).length;
            const badge = productRow.querySelector('.alloc-count');
            if (badge) {
                badge.textContent = subRowCount;
            } else {
                const btn = productRow.querySelector('.alloc-link-btn');
                if (btn) {
                    const span = document.createElement('span');
                    span.className = 'alloc-count';
                    span.textContent = subRowCount;
                    btn.appendChild(span);
                }
            }

            // Reset search but keep row visible
            document.getElementById('alloc-search-' + productId).value = '';
            document.getElementById('alloc-order-' + productId).value = '';
            document.getElementById('alloc-qty-' + productId).value = '1';
            showNotification('Allocation added');
        } else {
            showNotification(data.error || 'Failed to add allocation', 'error');
        }
    })
    .catch(err => showNotification('Error: ' + err.message, 'error'));
}

function removeAllocation(poId, productId, allocId, btn) {
    if (!confirm('Remove this allocation?')) return;

    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

    fetch(`/purchase-order/${poId}/product/${productId}/delete-allocation/${allocId}/`, {
        method: 'POST',
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            // Remove the sub-row
            const subRow = btn.closest('tr.alloc-sub-row');
            if (subRow) {
                subRow.remove();
            }

            // Update the count badge
            const productRow = document.querySelector(`tr[data-product-id='${productId}']:not(.alloc-sub-row):not(.alloc-sub-add-row)`);
            const subRowCount = document.querySelectorAll(`tr.alloc-sub-row[data-product-id='${productId}']`).length;
            const badge = productRow ? productRow.querySelector('.alloc-count') : null;
            if (subRowCount > 0 && badge) {
                badge.textContent = subRowCount;
            } else if (badge) {
                badge.remove();
            }
            showNotification('Allocation removed');
        } else {
            showNotification(data.error || 'Failed to remove', 'error');
        }
    })
    .catch(err => showNotification('Error: ' + err.message, 'error'));
}

function autoCalcExpectedDate() {
    const leadTimeDays = {{ supplier_obj.estimate_lead_time|default:0 }};
    if (!leadTimeDays) return;
    const issueDateInput = document.getElementById('po-issue-date');
    const expectedDateInput = document.getElementById('po-expected-date');
    if (!issueDateInput || !expectedDateInput || !issueDateInput.value) return;
    const d = new Date(issueDateInput.value);
    if (isNaN(d)) return;
    d.setDate(d.getDate() + leadTimeDays);
    // Push weekends to Monday
    if (d.getDay() === 6) d.setDate(d.getDate() + 2); // Saturday → Monday
    if (d.getDay() === 0) d.setDate(d.getDate() + 1); // Sunday → Monday
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, '0');
    const dd = String(d.getDate()).padStart(2, '0');
    expectedDateInput.value = `${yyyy}-${mm}-${dd}`;
}

function syncCurrencyFromSupplier(supplierCurrency) {
    if (!supplierCurrency) return;
    if (!confirm('Set PO currency to ' + supplierCurrency + ' (synced from supplier)?')) return;

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value
        || '{{ csrf_token }}';

    fetch('{% url "purchase_order_save" purchase_order.workguru_id %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
        },
        body: JSON.stringify({ currency: supplierCurrency })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showNotification('Currency updated to ' + supplierCurrency);
            setTimeout(() => location.reload(), 800);
        } else {
            showNotification(data.error || 'Failed to update currency', 'error');
        }
    })
    .catch(err => showNotification('Error: ' + err.message, 'error'));
}
</script>
{% endblock %}
