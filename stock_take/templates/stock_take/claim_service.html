{% extends "base.html" %}
{% load static %}

{% block title %}Claim Service - Atlas{% endblock %}

{% block page_title %}Claim Service{% endblock %}

{% block nav_claim_service_active %}active{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/claim_service.css' %}">
{% endblock %}

{% block content %}
<div class="claims-page">

    <!-- Header -->
    <div class="claims-header">
        <div class="claims-search-bar">
            <i class="bi bi-search"></i>
            <input type="text"
                   id="claims-search"
                   placeholder="Search by customer, job number or filename..."
                   value="{{ search_query }}"
                   autocomplete="off">
            {% if search_query %}
            <a href="{% url 'claim_service' %}" class="search-clear" title="Clear search">&times;</a>
            {% endif %}
        </div>
        <div class="claims-header-right">
            <span class="claims-count">
                {% if search_query %}
                    {{ showing_count }} result{{ showing_count|pluralize }} &middot; {{ total_count }} total
                {% else %}
                    Showing {{ showing_count }} of {{ group_count }} job{{ group_count|pluralize }} &middot; {{ total_count }} files
                {% endif %}
            </span>
        </div>
    </div>

    <!-- Grouped Documents -->
    {% if groups %}
    <div class="claims-groups" id="claims-groups">
        {% for group in groups %}
        <div class="claim-group" data-group="{{ group.key|lower }}" data-customer="{{ group.customer|lower }}" data-jobnumber="{{ group.job_number|lower }}">
            <div class="claim-group-header" onclick="toggleGroup(this)">
                <div class="claim-group-left">
                    <i class="bi bi-chevron-right group-chevron"></i>
                    <div class="claim-group-icon">
                        <i class="bi bi-folder2"></i>
                    </div>
                    <div class="claim-group-info">
                        <span class="claim-group-name">{{ group.display_name }}</span>
                        <span class="claim-group-meta">{{ group.count }} file{{ group.count|pluralize }} &middot; {{ group.date|date:"d M Y" }}</span>
                    </div>
                </div>
                <div class="claim-group-actions" onclick="event.stopPropagation()">
                    <a href="{% url 'claim_download_zip' group.key %}" class="btn-download-zip" title="Download all as ZIP">
                        <i class="bi bi-download"></i> Download ZIP
                    </a>
                </div>
            </div>
            <div class="claim-group-content">
                {% for doc in group.documents %}
                <div class="claim-file-row">
                    <a href="{{ doc.file.url }}" target="_blank" class="claim-file-link">
                        <i class="bi bi-file-earmark-pdf claim-file-icon"></i>
                        <span class="claim-file-type">{{ doc.doc_type }}</span>
                        <span class="claim-file-name">{{ doc.filename }}</span>
                    </a>
                    <div class="claim-file-actions">
                        <a href="{{ doc.file.url }}" target="_blank" class="claim-file-btn" title="View PDF">
                            <i class="bi bi-eye"></i>
                        </a>
                        <button class="claim-file-btn delete" onclick="deleteClaim({{ doc.id }}, this)" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Ungrouped Documents -->
    {% if ungrouped %}
    <div class="claims-ungrouped-section">
        <h3 class="claims-section-title">Other Documents</h3>
        <div class="claims-groups">
            {% for doc in ungrouped %}
            <div class="claim-group single-file" data-group="{{ doc.title|lower }}" data-customer="{{ doc.customer_name|lower }}">
                <div class="claim-group-header">
                    <div class="claim-group-left">
                        <div class="claim-group-icon single">
                            <i class="bi bi-file-earmark-pdf"></i>
                        </div>
                        <div class="claim-group-info">
                            <a href="{{ doc.file.url }}" target="_blank" class="claim-group-name file-link">{{ doc.title }}</a>
                            <span class="claim-group-meta">
                                {% if doc.customer_name %}{{ doc.customer_name }} &middot; {% endif %}
                                {{ doc.uploaded_at|date:"d M Y" }}
                            </span>
                        </div>
                    </div>
                    <div class="claim-group-actions">
                        <button class="claim-file-btn delete" onclick="deleteClaim({{ doc.id }}, this)" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% if not groups and not ungrouped %}
    <div class="claims-empty">
        <i class="bi bi-file-earmark-pdf"></i>
        <h3>No claim documents found</h3>
        {% if search_query %}
        <p>No documents match "<strong>{{ search_query }}</strong>". Try a different search term.</p>
        {% else %}
        <p>Upload your first claim PDF to get started.</p>
        {% endif %}
    </div>
    {% endif %}

    <!-- Pagination -->
    {% if total_pages > 1 and not search_query %}
    <div class="claims-pagination">
        {% if page > 1 %}
        <a href="?page={{ page|add:'-1' }}" class="pagination-btn"><i class="bi bi-chevron-left"></i> Previous</a>
        {% endif %}
        <span class="pagination-info">Page {{ page }} of {{ total_pages }}</span>
        {% if page < total_pages %}
        <a href="?page={{ page|add:'1' }}" class="pagination-btn">Next <i class="bi bi-chevron-right"></i></a>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
// Toggle group expand/collapse
function toggleGroup(header) {
    const group = header.closest('.claim-group');
    group.classList.toggle('expanded');
}

// Server-side search with debounce
const searchInput = document.getElementById('claims-search');
let searchTimeout = null;
if (searchInput) {
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const q = this.value.trim();
        searchTimeout = setTimeout(() => {
            if (q) {
                window.location.href = '{% url "claim_service" %}?q=' + encodeURIComponent(q);
            } else {
                window.location.href = '{% url "claim_service" %}';
            }
        }, 400);
    });

    // Focus and place cursor at end of search input if there's a query
    {% if search_query %}
    searchInput.focus();
    searchInput.setSelectionRange(searchInput.value.length, searchInput.value.length);
    {% endif %}
}

// Delete claim
function deleteClaim(docId, btn) {
    if (!confirm('Delete this document?')) return;

    const group = btn.closest('.claim-group');
    const row = btn.closest('.claim-file-row');
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

    fetch(`/claims/${docId}/delete/`, {
        method: 'POST',
        body: formData,
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            if (row) {
                row.style.opacity = '0';
                setTimeout(() => {
                    row.remove();
                    // If no files left in group, remove entire group
                    const remaining = group.querySelectorAll('.claim-file-row');
                    if (remaining.length === 0) {
                        group.style.opacity = '0';
                        setTimeout(() => group.remove(), 200);
                    }
                }, 200);
            } else {
                // Ungrouped single file
                group.style.opacity = '0';
                setTimeout(() => group.remove(), 200);
            }
        } else {
            alert(data.error || 'Failed to delete');
        }
    })
    .catch(err => alert('Error: ' + err.message));
}
</script>
{% endblock %}
