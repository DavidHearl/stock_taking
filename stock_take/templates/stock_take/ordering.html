{% extends 'base.html' %}
{% load static %}

{% block title %}Ordering{% endblock %}

{% block page_title %}Orders{% endblock %}

{% block extra_css %}
<link href="{% static 'css/ordering.css' %}" rel="stylesheet">
<link href="{% static 'css/ordering_modal.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<!-- Tabs with Add Order button on the right -->
<div class="tabs">
    <div class="tab-nav">
        <a href="?tab=wip{% if current_sort %}&sort={{ current_sort }}&order={{ current_order }}{% endif %}" 
           class="tab-button {% if current_tab == 'wip' %}active{% endif %}">
            WIP ({{ wip_orders }})
        </a>
        <a href="?tab=completed{% if current_sort %}&sort={{ current_sort }}&order={{ current_order }}{% endif %}" 
           class="tab-button {% if current_tab == 'completed' %}active{% endif %}">
            COMPLETED ({{ completed_orders }})
        </a>
        <a href="?tab=all{% if current_sort %}&sort={{ current_sort }}&order={{ current_order }}{% endif %}" 
           class="tab-button {% if current_tab == 'all' %}active{% endif %}">
            ALL ORDERS ({{ total_orders }})
        </a>
        <button type="button" class="btn btn-success btn-add-order" onclick="openModal('addOrderModal')">
            <i class="bi bi-plus-lg"></i> Add Order
        </button>
    </div>
</div>

<!-- Form Errors Display -->
{% if form.errors %}
<div class="alert alert-danger">
    <strong>Please correct the following errors:</strong>
    <ul>
        {% for field in form %}
            {% for error in field.errors %}
                <li><strong>{{ field.label }}:</strong> {{ error }}</li>
            {% endfor %}
        {% endfor %}
        {% for error in form.non_field_errors %}
            <li>{{ error }}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}

<!-- Search Box -->
<div class="search-box">
    <input type="text" id="orderSearch" placeholder="ðŸ” Search orders...">
</div>

<div class="card">
    <table class="table orders-table" id="order-table">
        <thead>
            <tr>
                <th class="sortable" data-sort="first_name">
                    First Name 
                    {% if current_sort == 'first_name' %}
                        {% if current_order == 'asc' %}â†‘{% else %}â†“{% endif %}
                    {% endif %}
                </th>
                <th class="sortable" data-sort="last_name">
                    Last Name 
                    {% if current_sort == 'last_name' %}
                        {% if current_order == 'asc' %}â†‘{% else %}â†“{% endif %}
                    {% endif %}
                </th>
                <th class="sortable text-center" data-sort="sale_number">
                    Sale # 
                    {% if current_sort == 'sale_number' %}
                        {% if current_order == 'asc' %}â†‘{% else %}â†“{% endif %}
                    {% endif %}
                </th>
                <th class="sortable text-center" data-sort="fit_date">
                    Fit Date 
                    {% if current_sort == 'fit_date' %}
                        {% if current_order == 'asc' %}â†‘{% else %}â†“{% endif %}
                    {% endif %}
                </th>
                <th class="text-center">Days</th>
                <th class="sortable text-center" data-sort="boards_po">
                    Boards PO 
                    {% if current_sort == 'boards_po' %}
                        {% if current_order == 'asc' %}â†‘{% else %}â†“{% endif %}
                    {% endif %}
                </th>
                <th class="text-center">OS Doors</th>
                <th class="text-center">CSV</th>
                <th class="text-center">Acc</th>
                <th class="text-center">Ord</th>
                <th class="text-center">Ant</th>
                <th class="text-center">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for order in orders %}
            <tr 
                class="clickable-row {% if order.job_finished %}row-finished{% endif %} {% if order.order_type == 'remedial' %}row-remedial{% endif %}" 
                onclick="toggleDetails('details-{{ order.sale_number }}', this)"
                id="main-{{ order.sale_number }}"
                data-sale-number="{{ order.sale_number }}"
            >
                <td>{{ order.first_name }}</td>
                <td>{{ order.last_name }}</td>
                <td class="text-center">{{ order.sale_number }}</td>
                <td class="text-center">{{ order.fit_date|date:"d F" }}</td>
                <td class="text-center">{{ order.time_allowance }}</td>
                <!-- Boards -->
                <td class="text-center">
                    {% if not order.job_finished %}
                        {% if order.boards_po %}
                            <div class="status-cell">
                                <a class="po-link" href="{% url 'order_details' order.id %}">
                                    {{ order.boards_po.po_number }}
                                </a>
                                {% if order.boards_po.boards_ordered %}
                                    <span class="status-icon success" title="Ordered">âœ“</span>
                                {% else %}
                                    <span class="status-icon danger" title="Not Ordered">âœ—</span>
                                {% endif %}
                            </div>
                        {% else %}
                            <a href="{% url 'order_details' order.id %}" class="text-muted">
                                Not assigned
                            </a>
                        {% endif %}
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                </td>
                <!-- OS Doors -->
                <td class="text-center">
                    {% if order.os_doors.exists or order.os_doors_required %}
                        <div class="status-cell">
                            <a class="po-link" href="{% url 'order_details' order.id %}">
                                {% if order.os_doors_po %}
                                    {{ order.os_doors_po }}
                                {% elif order.os_doors_required %}
                                    Required
                                {% else %}
                                    No PO
                                {% endif %}
                            </a>
                            {% if order.os_doors_po %}
                                <span class="status-icon success" title="OS Doors Ordered">âœ“</span>
                            {% else %}
                                <span class="status-icon danger" title="OS Doors Not Ordered">âœ—</span>
                            {% endif %}
                        </div>
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                </td>
                <!-- Address Check -->
                <td class="text-center">
                    {% if order.address %}
                        <span class="status-icon success" title="Has Address">âœ“</span>
                    {% else %}
                        <span class="status-icon danger" title="No Address">âœ—</span>
                    {% endif %}
                </td>
                <!-- Accessories Check -->
                <td class="text-center" data-indicator="accessories">
                    <!-- Loaded via AJAX -->
                </td>
                <!-- Items ordered Check -->
                <td class="text-center">
                    {% if order.all_items_ordered %}
                        <span class="status-icon success" title="All Materials Ordered">âœ“</span>
                    {% endif %}
                </td>
                <td class="text-center" onclick="event.stopPropagation();">
                    {% if order.anthill_id %}
                        <a href="https://sliderobes.anthillcrm.com/system/Customers/ViewCustomer.aspx?CustomerID={{ order.anthill_id }}" 
                           target="_blank" class="btn btn-sm btn-outline-success" title="Open in Anthill CRM">
                            ðŸ‘¤
                        </a>
                    {% endif %}
                </td>
                <td class="text-center" onclick="event.stopPropagation();">
                    <a href="{% url 'order_details' order.id %}" class="btn btn-sm btn-outline-primary">Details</a>
                </td>
            </tr>

            <tr class="detail-row hidden" id="details-{{ order.sale_number }}" data-sale-number="{{ order.sale_number }}">
                <td colspan="12" class="detail-cell">
                    <div class="loading-spinner">Loading order details...</div>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<!-- Modal for Creating New Boards PO -->
<!-- Modal for Adding New Order -->
<div class="modal" id="addOrderModal">
    <div class="modal-overlay" onclick="closeModal('addOrderModal')"></div>
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="POST" id="add-order-form">
                {% csrf_token %}
                <div class="modal-header">
                    <h3>Add New Order</h3>
                    <button type="button" class="modal-close" onclick="closeModal('addOrderModal')">âœ•</button>
                </div>
                <div class="modal-body">
                    <!-- Customer Info Section -->
                    <div class="add-order-section customer-section">
                        <h4 class="section-title customer-title">
                            <i class="bi bi-person"></i> Customer Information
                        </h4>
                        {{ form.customer }}
                        <div class="form-grid">
                            <div class="form-group full-width">
                                <label for="customer-search">Search Existing Customer</label>
                                <input type="text" id="customer-search" class="form-input" placeholder="Type to search by name, email, phone..." autocomplete="off">
                                <div id="customer-results" class="search-results"></div>
                            </div>
                        </div>
                        <div class="divider-text">OR ADD NEW CUSTOMER</div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="{{ form.first_name.id_for_label }}">First Name</label>
                                {{ form.first_name }}
                            </div>
                            <div class="form-group">
                                <label for="{{ form.last_name.id_for_label }}">Last Name</label>
                                {{ form.last_name }}
                            </div>
                            <div class="form-group">
                                <label for="{{ form.anthill_id.id_for_label }}">Anthill Customer ID</label>
                                {{ form.anthill_id }}
                            </div>
                            <div class="form-group">
                                <label for="{{ form.postcode.id_for_label }}">Postcode</label>
                                {{ form.postcode }}
                            </div>
                            <div class="form-group">
                                <label for="{{ form.address.id_for_label }}">Address</label>
                                {{ form.address }}
                            </div>
                        </div>
                    </div>

                    <!-- Sale Info Section -->
                    <div class="add-order-section sale-section">
                        <div class="section-header-with-select">
                            <h4 class="section-title sale-title">
                                <i class="bi bi-receipt"></i> Sale Information
                            </h4>
                            <div class="order-type-wrapper">
                                {{ form.order_type }}
                            </div>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="{{ form.sale_number.id_for_label }}">Sale Number</label>
                                {{ form.sale_number }}
                            </div>
                            <div class="form-group">
                                <label for="{{ form.customer_number.id_for_label }}">Customer Number (CAD)</label>
                                {{ form.customer_number }}
                            </div>
                            <div class="form-group">
                                <label for="{{ form.order_date.id_for_label }}">Order Date</label>
                                {{ form.order_date }}
                            </div>
                            <div class="form-group">
                                <label for="{{ form.fit_date.id_for_label }}">Fit Date</label>
                                {{ form.fit_date }}
                            </div>
                            <div class="form-group">
                                <label for="{{ form.designer.id_for_label }}">Designer</label>
                                <div class="designer-input-wrapper">
                                    {{ form.designer }}
                                    <button type="button" class="btn btn-sm btn-success add-designer-btn" onclick="toggleAddDesigner()" title="Add new designer">
                                        <i class="bi bi-plus-lg"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="{{ form.workguru_id.id_for_label }}">WorkGuru ID</label>
                                {{ form.workguru_id }}
                            </div>
                        </div>
                        <!-- New Designer Row - outside the grid -->
                        <div id="new-designer-row" class="new-designer-input" style="display: none;">
                            <input type="text" id="new-designer-name" class="form-input" placeholder="New designer name">
                            <button type="button" class="btn btn-sm btn-success" onclick="saveNewDesigner()" title="Save designer">
                                <i class="bi bi-check-lg"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-secondary" onclick="cancelAddDesigner()" title="Cancel">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addOrderModal')">Cancel</button>
                    <button type="submit" class="btn btn-success">Add Order</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function toggleDetails(detailRowId, clickedRowElement) {
        // Get the detail row element using the unique ID
        var detailRow = document.getElementById(detailRowId);
        
        if (!detailRow) {
            console.error('Detail row not found:', detailRowId);
            return;
        }
        
        // Get sale number from the detail row
        const saleNumber = detailRow.getAttribute('data-sale-number');
        
        // Priority load the indicator for this row when clicked
        if (saleNumber && typeof loadOrderIndicator === 'function') {
            loadOrderIndicator(saleNumber, true);
        }
        
        // Check if row is currently expanded (check for hidden class)
        const isExpanded = !detailRow.classList.contains('hidden');
        
        if (isExpanded) {
            // Collapse the row
            detailRow.classList.add('hidden');
            clickedRowElement.classList.remove('expanded');
        } else {
            // Expand the row
            detailRow.classList.remove('hidden');
            clickedRowElement.classList.add('expanded');
            
            // Check if content has already been loaded (data-loaded attribute)
            if (!detailRow.hasAttribute('data-loaded')) {
                // Show loading spinner
                const detailCell = detailRow.querySelector('.detail-cell');
                detailCell.innerHTML = '<div class="loading-spinner">Loading order details...</div>';
                
                // Load the content via AJAX
                fetch(`/ordering/load-order-details/${saleNumber}/`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            detailCell.innerHTML = data.html;
                            // Mark as loaded
                            detailRow.setAttribute('data-loaded', 'true');
                        } else {
                            detailCell.innerHTML = '<div class="alert alert-danger">Error loading order details: ' + (data.error || 'Unknown error') + '</div>';
                        }
                    })
                    .catch(error => {
                        console.error('Error loading order details:', error);
                        detailCell.innerHTML = '<div class="alert alert-danger">Error loading order details: ' + error.message + '</div>';
                    });
            }
        }
    }

    function editOrder(orderId) {
        // Placeholder for edit functionality
        // You can implement inline editing or redirect to an edit page
        console.log('Edit order:', orderId);
        alert('Edit functionality for order ' + orderId + ' - to be implemented');
    }

    function updateBoardsOrdered(poId, isChecked) {
        // Send AJAX request to update the boards_ordered status for a Boards PO
        fetch(`/stock-take/boards-po/${poId}/update-boards-ordered/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                boards_ordered: isChecked
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Boards ordered status updated successfully');
                // Update the visual status
                const card = document.querySelector(`#po-${poId}`).closest('.card');
                const badge = card.querySelector('.badge');
                if (isChecked) {
                    card.classList.add('border-success');
                    if (!badge) {
                        // Add badge if it doesn't exist
                        const badgeHtml = '<span class="badge bg-success"><i class="bi bi-check-circle"></i> Ordered</span>';
                        card.querySelector('.card-text').insertAdjacentHTML('beforeend', '<br>' + badgeHtml);
                    }
                } else {
                    card.classList.remove('border-success');
                    if (badge) {
                        badge.remove();
                    }
                }
            } else {
                console.error('Failed to update boards ordered status');
                // Revert the checkbox
                document.querySelector(`#po-${poId}`).checked = !isChecked;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Revert the checkbox
            document.querySelector(`#po-${poId}`).checked = !isChecked;
        });
    }

    // Add event listeners to the boards ordered toggles
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.boards-ordered-toggle').forEach(function(checkbox) {
            checkbox.addEventListener('change', function() {
                const poId = this.getAttribute('data-po-id');
                updateBoardsOrdered(poId, this.checked);
            });
        });

        // Search functionality
        const searchInput = document.getElementById('orderSearch');
        const tableBody = document.querySelector('#order-table tbody');

        // Copy functionality
        document.addEventListener('click', function(e) {
            if (e.target.closest('.copy-detail-btn')) {
                const button = e.target.closest('.copy-detail-btn');
                const textToCopy = button.getAttribute('data-text');
                copyToClipboard(textToCopy, button);
            }
        });

        // Helper function for copying to clipboard
        function copyToClipboard(text, button) {
            navigator.clipboard.writeText(text).then(function() {
                // Show success feedback
                const originalIcon = button.innerHTML;
                button.innerHTML = 'âœ“';
                button.classList.remove('btn-secondary');
                button.classList.add('btn-success');
                
                setTimeout(function() {
                    button.innerHTML = originalIcon;
                    button.classList.remove('btn-success');
                    button.classList.add('btn-secondary');
                }, 1000);
            }).catch(function(err) {
                console.error('Failed to copy: ', err);
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                // Show success feedback
                const originalIcon = button.innerHTML;
                button.innerHTML = 'âœ“';
                button.classList.remove('btn-secondary');
                button.classList.add('btn-success');
                
                setTimeout(function() {
                    button.innerHTML = originalIcon;
                    button.classList.remove('btn-success');
                    button.classList.add('btn-secondary');
                }, 1000);
            });
        }

        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const rows = tableBody.querySelectorAll('tr');

            rows.forEach(row => {
                // Skip detail rows (they're handled with their main rows)
                if (row.classList.contains('detail-row')) return;

                const text = row.textContent.toLowerCase();
                const shouldShow = text.includes(searchTerm);
                
                // Find the corresponding detail row
                const saleNumber = row.id.replace('main-', '');
                const detailRow = document.getElementById('details-' + saleNumber);
                
                if (shouldShow) {
                    // Show the main row
                    row.style.display = '';
                    // Reset detail row to its proper state (clear inline style, use CSS class only)
                    if (detailRow) {
                        detailRow.style.display = ''; // Always clear inline style
                        if (row.classList.contains('expanded')) {
                            // If row was expanded, keep it expanded
                            detailRow.classList.remove('hidden');
                        } else {
                            // If row was collapsed, keep it collapsed
                            detailRow.classList.add('hidden');
                        }
                    }
                } else {
                    // Hide the main row
                    row.style.display = 'none';
                    // Always hide and collapse detail row when main row is hidden
                    if (detailRow) {
                        detailRow.style.display = 'none'; // Use inline style for filtered-out rows
                        detailRow.classList.add('hidden');
                        row.classList.remove('expanded');
                    }
                }
            });
        });
    });

    // Modal functions
    function openModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('active');
        }
    }

    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('active');
        }
    }

    // Toggle PO section function
    function togglePOSection(sectionId) {
        const section = document.getElementById(sectionId);
        if (section) {
            section.classList.toggle('hidden');
        } else {
            console.error('Section not found:', sectionId);
        }
    }

    // Add event listeners for modal triggers
    document.addEventListener('DOMContentLoaded', function() {
        // Update existing event listeners that reference Bootstrap modals
        document.querySelectorAll('[data-target]').forEach(function(el) {
            el.addEventListener('click', function(e) {
                e.preventDefault();
                const targetId = this.getAttribute('data-target').replace('#', '');
                openModal(targetId);
            });
        });
        
        // Close modals on overlay click
        document.querySelectorAll('.modal-overlay').forEach(function(overlay) {
            overlay.addEventListener('click', function() {
                const modal = this.closest('.modal');
                if (modal) {
                    modal.classList.remove('active');
                }
            });
        });
        
        // Close modals on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal.active').forEach(function(modal) {
                    modal.classList.remove('active');
                });
            }
        });
    });

    // Sorting functionality
    document.querySelectorAll('.sortable').forEach(header => {
        header.style.cursor = 'pointer';
        header.addEventListener('click', function() {
            const sortBy = this.dataset.sort;
            const currentSort = '{{ current_sort }}';
            const currentOrder = '{{ current_order }}';
            
            let newOrder = 'desc';
            if (currentSort === sortBy && currentOrder === 'desc') {
                newOrder = 'asc';
            }
            
            const url = new URL(window.location);
            url.searchParams.set('sort', sortBy);
            url.searchParams.set('order', newOrder);
            window.location.href = url.toString();
        });
    });

    // Track loaded indicators to avoid duplicate requests
    const loadedIndicators = new Set();
    const pendingIndicators = new Set();
    
    // Priority loading queue for clicked rows
    let priorityQueue = [];
    let isLoadingPriority = false;
    
    // Load indicator for a specific order (priority load when clicked)
    function loadOrderIndicator(saleNumber, isPriority = false) {
        if (loadedIndicators.has(saleNumber) || pendingIndicators.has(saleNumber)) {
            return Promise.resolve();
        }
        
        pendingIndicators.add(saleNumber);
        
        return fetch(`/ordering/load-indicators/?sale_numbers=${saleNumber}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.indicators[saleNumber]) {
                    const indicators = data.indicators[saleNumber];
                    const row = document.getElementById(`main-${saleNumber}`);
                    if (!row) return;
                    
                    // Update row classes
                    if (indicators.has_missing) {
                        row.classList.add('row-missing');
                    }
                    if (indicators.has_remedials) {
                        row.classList.add('row-has-remedials');
                    }
                    
                    // Update accessories cell
                    const accessoriesCell = row.querySelector('[data-indicator="accessories"]');
                    if (accessoriesCell && indicators.has_accessories) {
                        accessoriesCell.innerHTML = '<span class="status-icon success" title="Has Accessories">âœ“</span>';
                    }
                    
                    loadedIndicators.add(saleNumber);
                }
                pendingIndicators.delete(saleNumber);
            })
            .catch(error => {
                console.error('Error loading indicator:', error);
                pendingIndicators.delete(saleNumber);
            });
    }
    
    // Background load order indicators and details in batches
    let detailLoadQueue = [];
    let isLoadingDetails = false;
    
    function loadOrderIndicators() {
        const rows = document.querySelectorAll('.clickable-row');
        const saleNumbers = Array.from(rows)
            .map(row => row.dataset.saleNumber)
            .filter(sn => !loadedIndicators.has(sn) && !pendingIndicators.has(sn));
        
        if (saleNumbers.length === 0) return;
        
        // Load indicators in batches of 30
        const batchSize = 30;
        for (let i = 0; i < saleNumbers.length; i += batchSize) {
            const batch = saleNumbers.slice(i, i + batchSize);
            
            setTimeout(() => {
                batch.forEach(sn => pendingIndicators.add(sn));
                
                fetch(`/ordering/load-indicators/?sale_numbers=${batch.join(',')}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Object.entries(data.indicators).forEach(([saleNumber, indicators]) => {
                                const row = document.getElementById(`main-${saleNumber}`);
                                if (!row) return;
                                
                                // Update row classes
                                if (indicators.has_missing) {
                                    row.classList.add('row-missing');
                                }
                                if (indicators.has_remedials) {
                                    row.classList.add('row-has-remedials');
                                }
                                
                                // Update accessories cell
                                const accessoriesCell = row.querySelector('[data-indicator="accessories"]');
                                if (accessoriesCell && indicators.has_accessories) {
                                    accessoriesCell.innerHTML = '<span class="status-icon success" title="Has Accessories">âœ“</span>';
                                }
                                
                                loadedIndicators.add(saleNumber);
                                pendingIndicators.delete(saleNumber);
                            });
                        }
                        batch.forEach(sn => pendingIndicators.delete(sn));
                    })
                    .catch(error => {
                        console.error('Error loading indicators:', error);
                        batch.forEach(sn => pendingIndicators.delete(sn));
                    });
                
                // Add batch to detail load queue
                detailLoadQueue.push(...batch);
            }, i * 150); // Stagger batch requests by 150ms
        }
        
        // Start loading details from queue
        setTimeout(processDetailQueue, 1000);
    }
    
    // Process detail queue one at a time to avoid overwhelming the browser
    function processDetailQueue() {
        if (isLoadingDetails || detailLoadQueue.length === 0) return;
        
        isLoadingDetails = true;
        const saleNumber = detailLoadQueue.shift();
        
        const detailRow = document.getElementById(`details-${saleNumber}`);
        if (detailRow && !detailRow.hasAttribute('data-loaded')) {
            fetch(`/ordering/load-order-details/${saleNumber}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const detailCell = detailRow.querySelector('.detail-cell');
                        detailCell.innerHTML = data.html;
                        detailRow.setAttribute('data-loaded', 'true');
                    }
                })
                .catch(error => {
                    // Silently fail - details will load on click if needed
                    console.log(`Will load details for ${saleNumber} on demand`);
                })
                .finally(() => {
                    isLoadingDetails = false;
                    // Continue processing queue with delay
                    if (detailLoadQueue.length > 0) {
                        setTimeout(processDetailQueue, 300); // 300ms between each detail load
                    }
                });
        } else {
            isLoadingDetails = false;
            // Continue processing queue
            if (detailLoadQueue.length > 0) {
                setTimeout(processDetailQueue, 50);
            }
        }
    }
    
    // Load indicators and details after a short delay to let page render first
    setTimeout(loadOrderIndicators, 500);

    // Replace file modal functionality
    let currentReplacePOId = null;

    function openReplaceFileModal(poId) {
        currentReplacePOId = poId;
        const modalHtml = `
            <div class="modal show" id="replaceFileModal" style="display: block;">
                <div class="modal-overlay" onclick="closeReplaceFileModal()"></div>
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Replace PNX File</h3>
                            <button type="button" class="modal-close" onclick="closeReplaceFileModal()">âœ•</button>
                        </div>
                        <form method="POST" enctype="multipart/form-data" action="/stock-take/boards-po/${poId}/replace-pnx/">
                            <input type="hidden" name="csrfmiddlewaretoken" value="${document.querySelector('[name=csrfmiddlewaretoken]').value}">
                            <div class="modal-body">
                                <div class="form-group">
                                    <label for="pnx_file">Select PNX File</label>
                                    <input type="file" name="pnx_file" id="pnx_file" accept=".pnx" required class="form-control">
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" onclick="closeReplaceFileModal()">Cancel</button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-upload"></i> Upload
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
    }

    function closeReplaceFileModal() {
        const modal = document.getElementById('replaceFileModal');
        if (modal) {
            modal.remove();
        }
        currentReplacePOId = null;
    }

    // Update PO Number
    function updatePONumber(poId, newPONumber) {
        const originalValue = document.querySelector(`input[data-po-id="${poId}"]`).defaultValue;
        
        // If value hasn't changed, don't make request
        if (newPONumber === originalValue) {
            return;
        }
        
        fetch(`/stock-take/boards-po/${poId}/update-po-number/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                po_number: newPONumber
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update the default value
                document.querySelector(`input[data-po-id="${poId}"]`).defaultValue = newPONumber;
                console.log('PO number updated successfully');
            } else {
                alert('Error updating PO number: ' + (data.error || 'Unknown error'));
                // Revert to original value
                document.querySelector(`input[data-po-id="${poId}"]`).value = originalValue;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating PO number');
            // Revert to original value
            document.querySelector(`input[data-po-id="${poId}"]`).value = originalValue;
        });
    }

    // Preview PNX file
    function previewPNX(poId) {
        fetch(`/stock-take/boards-po/${poId}/preview-pnx/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Build table HTML
                    let tableHtml = '<div style="overflow-x: auto;"><table id="previewTable" class="table table-striped" style="font-size: 11px;"><thead><tr>';
                    
                    // Header row
                    data.header.forEach(col => {
                        tableHtml += `<th style="white-space: nowrap; padding: 6px;">${col || '&nbsp;'}</th>`;
                    });
                    tableHtml += '</tr></thead><tbody>';
                    
                    // Data rows
                    data.rows.forEach((row, rowIndex) => {
                        tableHtml += '<tr>';
                        row.forEach((cell, cellIndex) => {
                            tableHtml += `<td contenteditable="true" data-row="${rowIndex}" data-col="${cellIndex}" style="white-space: nowrap; padding: 6px; cursor: text;">${cell || ''}</td>`;
                        });
                        tableHtml += '</tr>';
                    });
                    tableHtml += '</tbody></table></div>';
                    
                    const modalHtml = `
                        <div class="modal show" id="previewPNXModal" style="display: block;">
                            <div class="modal-overlay" onclick="closePreviewModal()"></div>
                            <div class="modal-dialog" style="max-width: 95%;">
                                <div class="modal-content-csv-table">
                                    <div class="modal-header">
                                        <h3>PNX Preview - ${data.po_number}</h3>
                                        <button type="button" class="modal-close" onclick="closePreviewModal()">âœ•</button>
                                    </div>
                                    <div class="modal-body" style="overflow: auto; max-height: 70vh;">
                                        ${tableHtml}
                                        <div style="margin-top: 16px; padding: 12px; background: var(--bg-secondary); border-radius: 6px;">
                                            <strong>Total Lines:</strong> ${data.line_count} | 
                                            <strong>Total Items:</strong> ${data.item_count}
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" onclick="closePreviewModal()">Close</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.insertAdjacentHTML('beforeend', modalHtml);
                } else {
                    alert('Error loading preview: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error loading preview');
            });
    }

    function closePreviewModal() {
        const modal = document.getElementById('previewPNXModal');
        if (modal) {
            modal.remove();
        }
    }

    // Save preview changes
    function savePreview(poId, fileType) {
        const table = document.getElementById('previewTable');
        if (!table) {
            alert('Table not found');
            return;
        }

        // Collect header
        const headerCells = table.querySelectorAll('thead th');
        const header = Array.from(headerCells).map(th => th.textContent.trim());

        // Collect rows
        const rows = [];
        const dataRows = table.querySelectorAll('tbody tr');
        dataRows.forEach(tr => {
            const cells = tr.querySelectorAll('td');
            const row = Array.from(cells).map(td => td.textContent.trim());
            rows.push(row);
        });

        // Send to backend to update both files
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        fetch(`/stock-take/boards-po/${poId}/update-both-files/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({ header, rows, source: fileType })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Files updated successfully (PNX and CSV)');
                closePreviewModal();
                location.reload();
            } else {
                alert('Error: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error saving changes');
        });
    }

    // Preview Accessory CSV file
    function previewAccessoryCSV(csvId) {
        fetch(`/stock-take/accessory-csv/${csvId}/preview/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Build table HTML
                    let tableHtml = '<div style="overflow-x: auto;"><table id="previewTable" class="table table-striped" style="font-size: 11px;"><thead><tr>';
                    
                    // Header row
                    data.header.forEach(col => {
                        tableHtml += `<th style="white-space: nowrap; padding: 6px;">${col || '&nbsp;'}</th>`;
                    });
                    tableHtml += '</tr></thead><tbody>';
                    
                    // Data rows
                    data.rows.forEach((row, rowIndex) => {
                        tableHtml += '<tr>';
                        row.forEach((cell, cellIndex) => {
                            tableHtml += `<td style="white-space: nowrap; padding: 6px;">${cell || '&nbsp;'}</td>`;
                        });
                        tableHtml += '</tr>';
                    });
                    tableHtml += '</tbody></table></div>';
                    
                    const modalHtml = `
                        <div class="modal show" id="previewPNXModal" style="display: block;">
                            <div class="modal-overlay" onclick="closePreviewModal()"></div>
                            <div class="modal-dialog" style="max-width: 95%;">
                                <div class="modal-content-csv-table">
                                    <div class="modal-header">
                                        <h3>Accessories CSV Preview - ${data.sale_number}</h3>
                                        <button type="button" class="modal-close" onclick="closePreviewModal()">âœ•</button>
                                    </div>
                                    <div class="modal-body" style="overflow: auto; max-height: 70vh;">
                                        ${tableHtml}
                                        <div style="margin-top: 16px; padding: 12px; background: var(--bg-secondary); border-radius: 6px;">
                                            <strong>Total Lines:</strong> ${data.line_count} | 
                                            <strong>Total Items:</strong> ${data.item_count}
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" onclick="closePreviewModal()">Close</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.insertAdjacentHTML('beforeend', modalHtml);
                } else {
                    alert('Error loading preview: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error loading preview');
            });
    }

    // Preview CSV file
    function previewCSV(poId) {
        fetch(`/stock-take/boards-po/${poId}/preview-csv/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Build table HTML
                    let tableHtml = '<div style="overflow-x: auto;"><table id="previewTable" class="table table-striped" style="font-size: 11px;"><thead><tr>';
                    
                    // Header row
                    data.header.forEach(col => {
                        tableHtml += `<th style="white-space: nowrap; padding: 6px;">${col || '&nbsp;'}</th>`;
                    });
                    tableHtml += '</tr></thead><tbody>';
                    
                    // Data rows
                    data.rows.forEach((row, rowIndex) => {
                        tableHtml += '<tr>';
                        row.forEach((cell, cellIndex) => {
                            tableHtml += `<td contenteditable="true" data-row="${rowIndex}" data-col="${cellIndex}" style="white-space: nowrap; padding: 6px; cursor: text;">${cell || ''}</td>`;
                        });
                        tableHtml += '</tr>';
                    });
                    tableHtml += '</tbody></table></div>';
                    
                    const modalHtml = `
                        <div class="modal show" id="previewPNXModal" style="display: block;">
                            <div class="modal-overlay" onclick="closePreviewModal()"></div>
                            <div class="modal-dialog" style="max-width: 95%;">
                                <div class="modal-content-csv-table">
                                    <div class="modal-header">
                                        <h3>CSV Preview - ${data.po_number}</h3>
                                        <button type="button" class="modal-close" onclick="closePreviewModal()">âœ•</button>
                                    </div>
                                    <div class="modal-body" style="overflow: auto; max-height: 70vh;">
                                        ${tableHtml}
                                        <div style="margin-top: 16px; padding: 12px; background: var(--bg-secondary); border-radius: 6px;">
                                            <strong>Total Lines:</strong> ${data.line_count} | 
                                            <strong>Total Items:</strong> ${data.item_count}
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" onclick="closePreviewModal()">Close</button>
                                        <button type="button" class="btn btn-success" onclick="savePreview(${poId}, 'csv')">Save Changes</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.insertAdjacentHTML('beforeend', modalHtml);
                } else {
                    alert('Error loading preview: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error loading preview');
            });
    }

    // Generate CSV file from PNX
    function generateCSV(poId) {
        if (!confirm('Generate CSV file from PNX? This will create a comma-delimited version of the boards order.')) {
            return;
        }

        fetch(`/stock-take/boards-po/${poId}/generate-csv/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('CSV file generated successfully!');
                location.reload();
            } else {
                alert('Error generating CSV: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error generating CSV');
        });
    }

    // Customer Search and Designer Management
    document.addEventListener('DOMContentLoaded', function() {
        // Customer Search Functionality
        let customerSearchTimeout;
        const customerSearchInput = document.getElementById('customer-search');
        const customerResults = document.getElementById('customer-results');
        
        if (customerSearchInput) {
            customerSearchInput.addEventListener('input', function() {
                clearTimeout(customerSearchTimeout);
                const query = this.value.trim();
                
                if (query.length < 2) {
                    customerResults.classList.remove('show');
                    return;
                }
                
                customerSearchTimeout = setTimeout(() => {
                    fetch(`/search-customers/?q=${encodeURIComponent(query)}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.customers && data.customers.length > 0) {
                                customerResults.innerHTML = data.customers.map(customer => {
                                    const name = customer.name || `${customer.first_name} ${customer.last_name}`.trim();
                                    const escapedName = name.replace(/'/g, "\\'");
                                    const details = [customer.address, customer.city, customer.postcode].filter(Boolean).join(', ') || 'No address';
                                    return `
                                    <div class="search-result-item" onclick="selectCustomer(${customer.customer_id}, '${escapedName}', '${(customer.anthill_customer_id || '').replace(/'/g, "\\'")}', '${(customer.address || '').replace(/'/g, "\\'")}', '${customer.postcode || ''}')">
                                        <div class="search-result-name">${name}</div>
                                        <div class="search-result-details">${details}${customer.phone ? ' Â· ' + customer.phone : ''}</div>
                                    </div>`;
                                }).join('');
                                customerResults.classList.add('show');
                            } else {
                                customerResults.innerHTML = '<div class="search-result-item">No customers found</div>';
                                customerResults.classList.add('show');
                            }
                        })
                        .catch(error => {
                            console.error('Error searching customers:', error);
                            customerResults.classList.remove('show');
                        });
                }, 300);
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.form-group.full-width')) {
                    customerResults.classList.remove('show');
                }
            });
        }
        
        // Designer input - clear dropdown when typing
        const newDesignerInput = document.getElementById('new-designer-name');
        const designerSelect = document.getElementById('id_designer');
        
        // When selecting from dropdown, hide the new designer input
        if (designerSelect) {
            designerSelect.addEventListener('change', function() {
                if (this.value) {
                    document.getElementById('new-designer-row').style.display = 'none';
                    document.getElementById('new-designer-name').value = '';
                }
            });
        }
        
        // Order Type color change based on selection
        const orderTypeSelect = document.getElementById('id_order_type');
        if (orderTypeSelect) {
            function updateOrderTypeColor() {
                const value = orderTypeSelect.value;
                if (value === 'sale') {
                    orderTypeSelect.style.background = '#10b981';
                    orderTypeSelect.style.borderColor = '#10b981';
                } else if (value === 'remedial') {
                    orderTypeSelect.style.background = '#f59e0b';
                    orderTypeSelect.style.borderColor = '#f59e0b';
                } else if (value === 'warranty') {
                    orderTypeSelect.style.background = '#ef4444';
                    orderTypeSelect.style.borderColor = '#ef4444';
                }
            }
            
            // Set initial color
            updateOrderTypeColor();
            
            // Update on change
            orderTypeSelect.addEventListener('change', updateOrderTypeColor);
        }
    });
    
    function selectCustomer(customerId, name, anthillId, address, postcode) {
        // Set the Customer FK
        document.getElementById('id_customer').value = customerId;
        // Split name into first/last for legacy fields
        const parts = name.split(' ');
        const firstName = parts[0] || '';
        const lastName = parts.slice(1).join(' ') || '';
        document.getElementById('id_first_name').value = firstName;
        document.getElementById('id_last_name').value = lastName;
        document.getElementById('id_anthill_id').value = anthillId;
        document.getElementById('id_address').value = address;
        document.getElementById('id_postcode').value = postcode;
        document.getElementById('customer-results').classList.remove('show');
        document.getElementById('customer-search').value = name;
    }
    
    // Designer management functions
    function toggleAddDesigner() {
        const row = document.getElementById('new-designer-row');
        if (row.style.display === 'none') {
            row.style.display = 'flex';
            document.getElementById('new-designer-name').focus();
        } else {
            row.style.display = 'none';
            document.getElementById('new-designer-name').value = '';
        }
    }
    
    function cancelAddDesigner() {
        document.getElementById('new-designer-row').style.display = 'none';
        document.getElementById('new-designer-name').value = '';
    }
    
    function saveNewDesigner() {
        const designerName = document.getElementById('new-designer-name').value.trim();
        
        if (!designerName) {
            alert('Please enter a designer name');
            return;
        }
        
        fetch('/add-designer/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ name: designerName })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Add new option to designer dropdown and select it
                const designerSelect = document.getElementById('id_designer');
                const option = new Option(data.designer.name, data.designer.id, true, true);
                designerSelect.add(option);
                
                // Hide the input row
                document.getElementById('new-designer-row').style.display = 'none';
                document.getElementById('new-designer-name').value = '';
            } else {
                alert('Error: ' + (data.error || 'Failed to add designer'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error adding designer');
        });
    }

</script>

{% endblock %}