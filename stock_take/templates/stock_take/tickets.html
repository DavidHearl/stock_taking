{% extends "base.html" %}
{% load static %}

{% block title %}Tickets - Atlas{% endblock %}

{% block page_title %}Tickets{% endblock %}

{% block nav_tickets_active %}active{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/tickets.css' %}">
{% endblock %}

{% block content %}
<div class="tickets-page">

    <!-- Header: Filters + Create Button -->
    <div class="tickets-header">
        <div class="tickets-filters">
            <a href="{% url 'tickets_list' %}?status=open" class="filter-btn {% if status_filter == 'open' %}active{% endif %}">Open</a>
            <a href="{% url 'tickets_list' %}?status=in_progress" class="filter-btn {% if status_filter == 'in_progress' %}active{% endif %}">In Progress</a>
            <a href="{% url 'tickets_list' %}?status=resolved" class="filter-btn {% if status_filter == 'resolved' %}active{% endif %}">Resolved</a>
            <a href="{% url 'tickets_list' %}?status=closed" class="filter-btn {% if status_filter == 'closed' %}active{% endif %}">Closed</a>
            <a href="{% url 'tickets_list' %}" class="filter-btn {% if not status_filter %}active{% endif %}">All</a>
        </div>
        <button class="btn-create-ticket" onclick="document.getElementById('createTicketModal').classList.add('active')">
            <i class="bi bi-plus-lg"></i> New Ticket
        </button>
    </div>

    <!-- Tickets Grid -->
    {% if tickets %}
    <div class="tickets-grid">
        {% for ticket in tickets %}
        <div class="ticket-card">
            <div class="ticket-card-header">
                <h4 class="ticket-title">{{ ticket.title }}</h4>
                <span class="ticket-id">#{{ ticket.id }}</span>
            </div>

            <p class="ticket-description">{{ ticket.description }}</p>

            {% if ticket.image %}
            <div class="ticket-image-preview">
                <img src="{{ ticket.image.url }}" alt="Ticket image">
            </div>
            {% endif %}

            <div class="ticket-card-footer">
                <div class="ticket-meta">
                    <span><i class="bi bi-person"></i> {{ ticket.submitted_by.get_full_name|default:ticket.submitted_by.username }}</span>
                    <span><i class="bi bi-clock"></i> {{ ticket.created_at|timesince }} ago</span>
                    <span class="badge-priority {{ ticket.priority }}">{{ ticket.get_priority_display }}</span>
                </div>

                <div style="display: flex; align-items: center; gap: 8px;">
                    {% if user.is_staff %}
                    <form method="POST" action="{% url 'ticket_update_status' ticket.id %}" style="margin: 0;">
                        {% csrf_token %}
                        <select name="status" class="status-select" onchange="this.form.submit()">
                            <option value="open" {% if ticket.status == 'open' %}selected{% endif %}>Open</option>
                            <option value="in_progress" {% if ticket.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                            <option value="resolved" {% if ticket.status == 'resolved' %}selected{% endif %}>Resolved</option>
                            <option value="closed" {% if ticket.status == 'closed' %}selected{% endif %}>Closed</option>
                        </select>
                    </form>
                    {% else %}
                    <span class="badge-status {{ ticket.status }}">{{ ticket.get_status_display }}</span>
                    {% endif %}

                    {% if user.is_staff or user == ticket.submitted_by %}
                    <button type="button" class="btn-edit-ticket" title="Edit ticket" onclick="openEditModal({{ ticket.id }}, '{{ ticket.title|escapejs }}', `{{ ticket.description|escapejs }}`, '{{ ticket.priority }}')">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <form method="POST" action="{% url 'ticket_delete' ticket.id %}" style="margin: 0;" onsubmit="return confirm('Delete ticket #{{ ticket.id }}?');">
                        {% csrf_token %}
                        <button type="submit" class="btn-delete-ticket" title="Delete ticket">
                            <i class="bi bi-trash"></i>
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="tickets-empty">
        <i class="bi bi-ticket-detailed"></i>
        <p>No tickets found. Click "New Ticket" to submit one.</p>
    </div>
    {% endif %}
</div>

<!-- Edit Ticket Modal -->
<div class="modal-overlay" id="editTicketModal">
    <div class="ticket-modal">
        <div class="ticket-modal-header">
            <h3><i class="bi bi-pencil-square"></i> Edit Ticket <span id="editTicketId"></span></h3>
            <button class="modal-close" onclick="document.getElementById('editTicketModal').classList.remove('active')">&times;</button>
        </div>
        <form method="POST" id="editTicketForm" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="ticket-modal-body">
                <div class="form-group">
                    <label for="edit-title">Title</label>
                    <input type="text" id="edit-title" name="title" required>
                </div>
                <div class="form-group">
                    <label for="edit-description">Description</label>
                    <textarea id="edit-description" name="description" required></textarea>
                </div>
                <div class="form-group">
                    <label for="edit-priority">Priority</label>
                    <select id="edit-priority" name="priority">
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit-image">Replace Screenshot (optional)</label>
                    <input type="file" id="edit-image" name="image" accept="image/*">
                </div>
            </div>
            <div class="ticket-modal-footer">
                <button type="button" class="btn-cancel" onclick="document.getElementById('editTicketModal').classList.remove('active')">Cancel</button>
                <button type="submit" class="btn-submit-ticket">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<!-- Create Ticket Modal -->
<div class="modal-overlay" id="createTicketModal">
    <div class="ticket-modal">
        <div class="ticket-modal-header">
            <h3><i class="bi bi-ticket-detailed"></i> Submit a Ticket</h3>
            <button class="modal-close" onclick="document.getElementById('createTicketModal').classList.remove('active')">&times;</button>
        </div>
        <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="ticket-modal-body">
                <div class="form-group">
                    <label for="title">Title</label>
                    <input type="text" id="title" name="title" placeholder="Brief summary of the issue" required>
                </div>
                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" name="description" placeholder="Describe the issue in detail..." required></textarea>
                </div>
                <div class="form-group">
                    <label for="priority">Priority</label>
                    <select id="priority" name="priority">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="image">Screenshot (optional)</label>
                    <input type="file" id="image" name="image" accept="image/*">
                </div>
            </div>
            <div class="ticket-modal-footer">
                <button type="button" class="btn-cancel" onclick="document.getElementById('createTicketModal').classList.remove('active')">Cancel</button>
                <button type="submit" class="btn-submit-ticket">Submit Ticket</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
function openEditModal(ticketId, title, description, priority) {
    document.getElementById('editTicketId').textContent = '#' + ticketId;
    document.getElementById('edit-title').value = title;
    document.getElementById('edit-description').value = description;
    document.getElementById('edit-priority').value = priority;
    document.getElementById('editTicketForm').action = '/tickets/' + ticketId + '/edit/';
    document.getElementById('editTicketModal').classList.add('active');
}
</script>
{% endblock %}
