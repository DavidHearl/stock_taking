{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block title %}Tickets - Atlas{% endblock %}

{% block page_title %}Tickets{% endblock %}

{% block nav_tickets_active %}active{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/tickets.css' %}">
{% endblock %}

{% block content %}
<div class="tickets-page">

    <!-- Header: Filters + Create Button -->
    <div class="tickets-header">
        <div class="tickets-filters">
            <a href="{% url 'tickets_list' %}?status=open" class="filter-btn {% if status_filter == 'open' %}active{% endif %}">Open</a>
            <a href="{% url 'tickets_list' %}?status=in_progress" class="filter-btn {% if status_filter == 'in_progress' %}active{% endif %}">In Progress</a>
            <a href="{% url 'tickets_list' %}?status=resolved" class="filter-btn {% if status_filter == 'resolved' %}active{% endif %}">Resolved</a>
            <a href="{% url 'tickets_list' %}?status=closed" class="filter-btn {% if status_filter == 'closed' %}active{% endif %}">Closed</a>
            <a href="{% url 'tickets_list' %}?status=all" class="filter-btn {% if status_filter == 'all' %}active{% endif %}">All</a>
        </div>
        <button class="btn-create-ticket" onclick="document.getElementById('createTicketModal').classList.add('active')">
            <i class="bi bi-plus-lg"></i> New Ticket
        </button>
    </div>

    <!-- Tickets Table -->
    {% if tickets %}
    <div class="tickets-table-wrapper">
        <table class="tickets-table">
            <thead>
                <tr>
                    <th class="col-id">#</th>
                    <th class="col-title">Title</th>
                    <th class="col-priority">Priority</th>
                    <th class="col-status">Status</th>
                    <th class="col-submitted">Submitted By</th>
                    <th class="col-date">Created</th>
                </tr>
            </thead>
            <tbody>
                {% for ticket in tickets %}
                <tr class="ticket-row{% if is_role_admin and not ticket.read_by_admin %} unread{% endif %}" onclick="window.location='{% url 'ticket_detail' ticket.id %}'">
                    <td class="col-id">{{ ticket.id }}</td>
                    <td class="col-title">
                        <span class="ticket-title-text">{{ ticket.title }}</span>
                    </td>
                    <td class="col-priority">
                        <span class="badge-priority {{ ticket.priority }}">{{ ticket.get_priority_display }}</span>
                    </td>
                    <td class="col-status">
                        <span class="badge-status {{ ticket.status }}">{{ ticket.get_status_display }}</span>
                    </td>
                    <td class="col-submitted">{{ ticket.submitted_by.get_full_name|default:ticket.submitted_by.username }}</td>
                    <td class="col-date">{{ ticket.created_at|short_timesince }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="tickets-empty">
        <i class="bi bi-ticket-detailed"></i>
        <p>No tickets found. Click "New Ticket" to submit one.</p>
    </div>
    {% endif %}
</div>

<!-- Create Ticket Modal -->
<div class="modal-overlay" id="createTicketModal">
    <div class="ticket-modal">
        <div class="ticket-modal-header">
            <h3><i class="bi bi-ticket-detailed"></i> Submit a Ticket</h3>
            <button class="modal-close" onclick="document.getElementById('createTicketModal').classList.remove('active')">&times;</button>
        </div>
        <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="ticket-modal-body">
                <div class="form-group">
                    <label for="title">Title</label>
                    <input type="text" id="title" name="title" placeholder="Brief summary of the issue" required>
                </div>
                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" name="description" placeholder="Describe the issue in detail..." required></textarea>
                </div>
                <div class="form-group">
                    <label for="priority">Priority</label>
                    <select id="priority" name="priority">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="image">Screenshot (optional)</label>
                    <input type="file" id="image" name="image" accept="image/*">
                </div>
            </div>
            <div class="ticket-modal-footer">
                <button type="button" class="btn-cancel" onclick="document.getElementById('createTicketModal').classList.remove('active')">Cancel</button>
                <button type="submit" class="btn-submit-ticket">Submit Ticket</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}
