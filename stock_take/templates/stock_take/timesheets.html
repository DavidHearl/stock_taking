{% extends 'base.html' %}

{% block title %}Timesheets{% endblock %}

{% block page_title %}Timesheets{% endblock %}

{% block nav_timesheets_active %}active{% endblock %}

{% block content %}
<div class="page-content">
    <!-- All Timesheets Table -->
    <div class="card" style="margin-bottom: 16px;">
        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h3><i class="bi bi-table"></i> All Timesheets</h3>
            <button type="button" class="btn btn-primary btn-sm" onclick="openAddTimesheetModal()">
                <i class="bi bi-plus-lg"></i> Add Timesheet
            </button>
        </div>
        <div class="card-body" style="padding: 0;">
            {% if timesheets %}
            <div class="table-container" style="max-height: 500px; overflow-y: auto;">
                <table class="table ts-table">
                    <thead style="position: sticky; top: 0; background: var(--bg-secondary); z-index: 1;">
                        <tr>
                            <th>Date</th>
                            <th>Order</th>
                            <th>Type</th>
                            <th>Worker</th>
                            <th>Hours</th>
                            <th>Rate/Price</th>
                            <th>Total</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ts in timesheets %}
                        <tr>
                            <td>{{ ts.date|date:"d/m/Y" }}</td>
                            <td>
                                {% if ts.order %}
                                <a class="job-info-link" href="{% url 'order_details' ts.order.id %}">
                                    {{ ts.order.sale_number }} - {{ ts.order.last_name }}
                                </a>
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td>
                                {% if ts.timesheet_type == 'installation' %}
                                <span class="badge badge-installation">Installation</span>
                                {% else %}
                                <span class="badge badge-manufacturing">Manufacturing</span>
                                {% endif %}
                            </td>
                            <td>{{ ts.worker_name }}</td>
                            <td>
                                {% if ts.hours %}
                                {{ ts.hours }}h
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td>
                                {% if ts.timesheet_type == 'installation' %}
                                {{ ts.purchase_order.display_number|default:"-" }}
                                {% else %}
                                £{{ ts.hourly_rate|floatformat:2 }}/hr
                                {% endif %}
                            </td>
                            <td><strong>£{{ ts.total_cost|floatformat:2 }}</strong></td>
                            <td>{{ ts.description|default:"-"|truncatewords:10 }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <p class="text-muted" style="margin: 8px 12px; font-size: 0.8rem;">
                Showing latest 100 timesheets.
            </p>
            {% else %}
            <div class="empty-state">
                <i class="bi bi-clock" style="font-size: 2.5rem; color: #6c757d;"></i>
                <p>No timesheets recorded yet.</p>
            </div>
            {% endif %}
        </div>
    </div>

    {% if is_role_admin or user_role == 'director' or user_role == 'accounting' %}
    <div class="row" style="display: flex; gap: 16px; flex-wrap: wrap;">
        <!-- Factory Workers Section -->
        <div class="card" style="flex: 1; min-width: 380px;">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h3><i class="bi bi-person-gear"></i> Factory Workers</h3>
                <button type="button" class="btn btn-primary btn-sm" onclick="openAddWorkerModal()">
                    <i class="bi bi-plus-lg"></i> Add Worker
                </button>
            </div>
            <div class="card-body" style="padding: 0;">
                {% if factory_workers %}
                <div class="table-container">
                    <table class="table ts-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Hourly Rate</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="factory-workers-table">
                            {% for worker in factory_workers %}
                            <tr id="worker-row-{{ worker.id }}" class="{% if not worker.active %}text-muted{% endif %}">
                                <td>
                                    <input type="text" class="form-input form-input-sm worker-name" 
                                           data-id="{{ worker.id }}" value="{{ worker.name }}"
                                           style="max-width: 140px;">
                                </td>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 2px;">
                                        <span>£</span>
                                        <input type="number" step="0.01" min="0" 
                                               class="form-input form-input-sm worker-rate" 
                                               data-id="{{ worker.id }}" value="{{ worker.hourly_rate }}"
                                               style="max-width: 70px;">
                                        <span>/hr</span>
                                    </div>
                                </td>
                                <td>
                                    <label class="toggle-switch">
                                        <input type="checkbox" class="worker-active" 
                                               data-id="{{ worker.id }}" {% if worker.active %}checked{% endif %}>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </td>
                                <td>
                                    <button type="button" class="btn btn-success btn-sm" onclick="saveWorker({{ worker.id }})" title="Save">
                                        <i class="bi bi-check-lg"></i>
                                    </button>
                                    <button type="button" class="btn btn-danger btn-sm" onclick="confirmDeleteWorker({{ worker.id }}, '{{ worker.name }}')" title="Delete">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="empty-state" id="no-workers-message">
                    <i class="bi bi-person-x" style="font-size: 2.5rem; color: #6c757d;"></i>
                    <p>No factory workers added yet.</p>
                    <button type="button" class="btn btn-primary btn-sm" onclick="openAddWorkerModal()">
                        <i class="bi bi-plus-lg"></i> Add First Worker
                    </button>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Fitters Section -->
        <div class="card" style="flex: 1; min-width: 380px;">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h3><i class="bi bi-people"></i> Fitters</h3>
                <button type="button" class="btn btn-primary btn-sm" onclick="openAddFitterModal()">
                    <i class="bi bi-plus-lg"></i> Add Fitter
                </button>
            </div>
            <div class="card-body" style="padding: 0;">
                {% if fitters %}
                <div class="table-container">
                    <table class="table ts-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="fitters-table">
                            {% for fitter in fitters %}
                            <tr class="{% if not fitter.active %}text-muted{% endif %}">
                                <td>{{ fitter.name }}</td>
                                <td>
                                    {% if fitter.active %}
                                    <span class="badge badge-success">Active</span>
                                    {% else %}
                                    <span class="badge badge-secondary">Inactive</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="empty-state">
                    <i class="bi bi-people" style="font-size: 2.5rem; color: #6c757d;"></i>
                    <p>No fitters added yet.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Add Timesheet Modal -->
<div class="modal" id="addTimesheetModal">
    <div class="modal-overlay" onclick="closeModal('addTimesheetModal')"></div>
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Timesheet</h3>
                <button type="button" class="modal-close" onclick="closeModal('addTimesheetModal')">✕</button>
            </div>
            <div class="modal-body">
                <!-- Order Search -->
                <div class="form-group">
                    <label for="ts_order_search">Order *</label>
                    <div style="position: relative;">
                        <input type="text" class="form-input" id="ts_order_search" placeholder="Search by sale number or customer name..." autocomplete="off">
                        <input type="hidden" id="ts_order_id">
                        <div id="ts_order_results" class="autocomplete-dropdown" style="display:none;"></div>
                    </div>
                </div>
                <!-- Type -->
                <div class="form-group">
                    <label for="ts_type">Type *</label>
                    <select class="form-input" id="ts_type" onchange="onTimesheetTypeChange()">
                        <option value="installation">Installation</option>
                        <option value="manufacturing">Manufacturing</option>
                    </select>
                </div>
                <!-- Date -->
                <div class="form-group">
                    <label for="ts_date">Date *</label>
                    <input type="date" class="form-input" id="ts_date">
                </div>
                <!-- Installation fields -->
                <div id="ts_installation_fields">
                    <div class="form-group">
                        <label for="ts_fitter">Fitter</label>
                        <select class="form-input" id="ts_fitter">
                            <option value="">-- Select Fitter --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="ts_po_search">Purchase Order</label>
                        <div style="position: relative;">
                            <input type="text" class="form-input" id="ts_po_search" placeholder="Search PO by number or supplier..." autocomplete="off">
                            <input type="hidden" id="ts_po_id">
                            <div id="ts_po_results" class="autocomplete-dropdown" style="display:none;"></div>
                        </div>
                    </div>
                </div>
                <!-- Manufacturing fields -->
                <div id="ts_manufacturing_fields" style="display:none;">
                    <div class="form-group">
                        <label for="ts_factory_worker">Factory Worker *</label>
                        <select class="form-input" id="ts_factory_worker">
                            <option value="">-- Select Worker --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="ts_hours">Hours *</label>
                        <input type="number" step="0.25" min="0" class="form-input" id="ts_hours" placeholder="0">
                    </div>
                </div>
                <!-- Description -->
                <div class="form-group">
                    <label for="ts_description">Description</label>
                    <input type="text" class="form-input" id="ts_description" placeholder="Optional description">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('addTimesheetModal')">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitTimesheet()">Add Timesheet</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Fitter Modal -->
<div class="modal" id="addFitterModal">
    <div class="modal-overlay" onclick="closeModal('addFitterModal')"></div>
    <div class="modal-dialog" style="max-width: 400px;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Fitter</h3>
                <button type="button" class="modal-close" onclick="closeModal('addFitterModal')">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="new_fitter_name">Name *</label>
                    <input type="text" class="form-input" id="new_fitter_name" placeholder="Fitter name" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('addFitterModal')">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addFitter()">Add Fitter</button>
            </div>
        </div>
    </div>
</div>

{% if is_role_admin or user_role == 'director' or user_role == 'accounting' %}
<!-- Add Worker Modal -->
<div class="modal" id="addWorkerModal">
    <div class="modal-overlay" onclick="closeModal('addWorkerModal')"></div>
    <div class="modal-dialog" style="max-width: 400px;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Factory Worker</h3>
                <button type="button" class="modal-close" onclick="closeModal('addWorkerModal')">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="new_worker_name">Name *</label>
                    <input type="text" class="form-input" id="new_worker_name" placeholder="Worker name" required>
                </div>
                <div class="form-group">
                    <label for="new_worker_rate">Hourly Rate (£) *</label>
                    <input type="number" step="0.01" min="0" class="form-input" id="new_worker_rate" placeholder="15.00" value="15.00" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('addWorkerModal')">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addWorker()">Add Worker</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal" id="deleteConfirmModal">
    <div class="modal-overlay" onclick="closeModal('deleteConfirmModal')"></div>
    <div class="modal-dialog" style="max-width: 400px;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirm Delete</h3>
                <button type="button" class="modal-close" onclick="closeModal('deleteConfirmModal')">✕</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong id="delete-worker-name"></strong>?</p>
                <p class="text-muted" style="font-size: 0.85rem;">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('deleteConfirmModal')">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-btn" onclick="deleteWorker()">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<style>
/* Compact table styling */
.ts-table thead th {
    padding: 6px 10px;
    text-align: left;
    font-weight: 600;
    color: var(--text-secondary);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 2px solid var(--border-color);
    white-space: nowrap;
}

.ts-table tbody td {
    padding: 5px 10px;
    border-bottom: 1px solid var(--border-color);
    color: var(--text-primary);
    font-size: 0.85rem;
}

.ts-table tbody tr:last-child td {
    border-bottom: none;
}

/* Toggle Switch */
.toggle-switch {
    position: relative;
    display: inline-block;
    width: 42px;
    height: 22px;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .3s;
    border-radius: 22px;
}

.toggle-slider:before {
    position: absolute;
    content: "";
    height: 16px;
    width: 16px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: .3s;
    border-radius: 50%;
}

.toggle-switch input:checked + .toggle-slider {
    background-color: #059669;
}

.toggle-switch input:checked + .toggle-slider:before {
    transform: translateX(20px);
}

/* Badge styles — matching costing report colours */
.badge {
    display: inline-block;
    padding: 3px 8px;
    font-size: 0.7rem;
    font-weight: 600;
    border-radius: 4px;
    white-space: nowrap;
}

.badge-installation {
    background-color: rgba(139, 92, 246, 0.15);
    color: #8b5cf6;
}

.badge-manufacturing {
    background-color: rgba(240, 173, 78, 0.15);
    color: #d97706;
}

.badge-success {
    background-color: #d1fae5;
    color: #065f46;
}

.badge-secondary {
    background-color: #e5e7eb;
    color: #4b5563;
}

/* Form input small */
.form-input-sm {
    padding: 3px 6px;
    font-size: 0.82rem;
}

/* Empty state */
.empty-state {
    text-align: center;
    padding: 24px 16px;
}

.empty-state p {
    margin: 8px 0;
    color: #6c757d;
    font-size: 0.85rem;
}

/* Muted text for inactive rows */
tr.text-muted td {
    opacity: 0.6;
}

/* Order search autocomplete dropdown */
.autocomplete-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.autocomplete-item {
    padding: 8px 12px;
    cursor: pointer;
    font-size: 0.85rem;
    border-bottom: 1px solid var(--border-color);
}

.autocomplete-item:last-child {
    border-bottom: none;
}

.autocomplete-item:hover {
    background: var(--bg-secondary);
}

.autocomplete-item .sale-num {
    font-weight: 600;
    color: var(--primary-color);
}
</style>

<script>
let deleteWorkerId = null;
let orderSearchTimeout = null;

// ═══════════════════════════════════════
// Modal functions
// ═══════════════════════════════════════
function openModal(modalId) {
    document.getElementById(modalId).classList.add('active');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
}

// ═══════════════════════════════════════
// Add Timesheet
// ═══════════════════════════════════════
function openAddTimesheetModal() {
    // Reset form
    document.getElementById('ts_order_search').value = '';
    document.getElementById('ts_order_id').value = '';
    document.getElementById('ts_order_results').style.display = 'none';
    document.getElementById('ts_type').value = 'installation';
    document.getElementById('ts_date').value = new Date().toISOString().split('T')[0];
    document.getElementById('ts_price').value = '';
    document.getElementById('ts_hours').value = '';
    document.getElementById('ts_description').value = '';
    onTimesheetTypeChange();
    loadFittersAndWorkers();
    openModal('addTimesheetModal');
}

function onTimesheetTypeChange() {
    const type = document.getElementById('ts_type').value;
    document.getElementById('ts_installation_fields').style.display = type === 'installation' ? 'block' : 'none';
    document.getElementById('ts_manufacturing_fields').style.display = type === 'manufacturing' ? 'block' : 'none';
}

function loadFittersAndWorkers() {
    // Load fitters
    fetch('/api/get-fitters/')
        .then(r => r.json())
        .then(data => {
            const fitterSel = document.getElementById('ts_fitter');
            fitterSel.innerHTML = '<option value="">-- Select Fitter --</option>';
            (data.fitters || []).forEach(f => {
                fitterSel.innerHTML += `<option value="${f.id}">${f.name}</option>`;
            });
        });
    // Load factory workers
    fetch('/api/get-factory-workers/')
        .then(r => r.json())
        .then(data => {
            const sel = document.getElementById('ts_factory_worker');
            sel.innerHTML = '<option value="">-- Select Worker --</option>';
            (data.workers || []).forEach(w => {
                sel.innerHTML += `<option value="${w.id}">${w.name} (£${parseFloat(w.hourly_rate).toFixed(2)}/hr)</option>`;
            });
        });
}

// Order search autocomplete
document.addEventListener('DOMContentLoaded', function() {
    const input = document.getElementById('ts_order_search');
    const resultsDiv = document.getElementById('ts_order_results');

    input.addEventListener('input', function() {
        clearTimeout(orderSearchTimeout);
        const q = this.value.trim();
        if (q.length < 2) {
            resultsDiv.style.display = 'none';
            return;
        }
        orderSearchTimeout = setTimeout(() => {
            fetch('/api/order-search/?q=' + encodeURIComponent(q))
                .then(r => r.json())
                .then(data => {
                    if (data.results && data.results.length) {
                        resultsDiv.innerHTML = data.results.map(o =>
                            `<div class="autocomplete-item" onclick="selectOrder(${o.id}, '${o.sale_number}', '${(o.customer_name || '').replace(/'/g, "\\'")}')">
                                <span class="sale-num">${o.sale_number}</span> — ${o.customer_name || 'Unknown'}
                            </div>`
                        ).join('');
                        resultsDiv.style.display = 'block';
                    } else {
                        resultsDiv.innerHTML = '<div class="autocomplete-item" style="color:#999;">No orders found</div>';
                        resultsDiv.style.display = 'block';
                    }
                });
        }, 300);
    });

    // Close dropdown on outside click
    document.addEventListener('click', function(e) {
        if (!input.contains(e.target) && !resultsDiv.contains(e.target)) {
            resultsDiv.style.display = 'none';
        }
    });

    // PO search autocomplete for installation modal
    let _tsPOTimer = null;
    const tsPoInput = document.getElementById('ts_po_search');
    const tsPoResults = document.getElementById('ts_po_results');
    if (tsPoInput) {
        tsPoInput.addEventListener('input', function() {
            clearTimeout(_tsPOTimer);
            const q = this.value.trim();
            if (q.length < 2) { tsPoResults.style.display = 'none'; return; }
            _tsPOTimer = setTimeout(() => {
                fetch('/api/purchase-order-search/?q=' + encodeURIComponent(q))
                    .then(r => r.json())
                    .then(data => {
                        tsPoResults.innerHTML = '';
                        if (!data.results || !data.results.length) {
                            tsPoResults.innerHTML = '<div class="autocomplete-item" style="color:#999;">No POs found</div>';
                        } else {
                            data.results.forEach(po => {
                                const div = document.createElement('div');
                                div.className = 'autocomplete-item';
                                div.textContent = `${po.display_number} — ${po.supplier_name} (${po.status})`;
                                div.addEventListener('click', () => {
                                    tsPoInput.value = po.display_number;
                                    document.getElementById('ts_po_id').value = po.id;
                                    tsPoResults.style.display = 'none';
                                });
                                tsPoResults.appendChild(div);
                            });
                        }
                        tsPoResults.style.display = 'block';
                    })
                    .catch(() => { tsPoResults.style.display = 'none'; });
            }, 250);
        });
        document.addEventListener('click', function(e) {
            if (!tsPoInput.contains(e.target) && !tsPoResults.contains(e.target)) {
                tsPoResults.style.display = 'none';
            }
        });
    }
});

function selectOrder(id, saleNum, customerName) {
    document.getElementById('ts_order_id').value = id;
    document.getElementById('ts_order_search').value = saleNum + ' — ' + customerName;
    document.getElementById('ts_order_results').style.display = 'none';
}

function submitTimesheet() {
    const orderId = document.getElementById('ts_order_id').value;
    if (!orderId) {
        alert('Please select an order');
        return;
    }

    const type = document.getElementById('ts_type').value;
    const date = document.getElementById('ts_date').value;
    const description = document.getElementById('ts_description').value;

    const payload = {
        timesheet_type: type,
        date: date,
        description: description,
    };

    if (type === 'installation') {
        const fitterId = document.getElementById('ts_fitter').value;
        const poId = document.getElementById('ts_po_id').value;
        payload.fitter_id = fitterId || null;
        payload.purchase_order_id = poId || null;
    } else {
        const workerId = document.getElementById('ts_factory_worker').value;
        const hours = document.getElementById('ts_hours').value;
        if (!workerId) { alert('Please select a factory worker'); return; }
        if (!hours) { alert('Please enter hours'); return; }
        payload.factory_worker_id = workerId;
        payload.hours = hours;
    }

    fetch('/order/' + orderId + '/add-timesheet/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            closeModal('addTimesheetModal');
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(err => {
        console.error(err);
        alert('Error adding timesheet');
    });
}

// ═══════════════════════════════════════
// Add Fitter
// ═══════════════════════════════════════
function openAddFitterModal() {
    document.getElementById('new_fitter_name').value = '';
    openModal('addFitterModal');
}

function addFitter() {
    const name = document.getElementById('new_fitter_name').value.trim();
    if (!name) {
        alert('Please enter a fitter name');
        return;
    }

    fetch('/api/add-fitter/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({ name: name })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            closeModal('addFitterModal');
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(err => {
        console.error(err);
        alert('Error adding fitter');
    });
}

// ═══════════════════════════════════════
// Factory Workers CRUD
// ═══════════════════════════════════════
function openAddWorkerModal() {
    document.getElementById('new_worker_name').value = '';
    document.getElementById('new_worker_rate').value = '15.00';
    openModal('addWorkerModal');
}

function addWorker() {
    const name = document.getElementById('new_worker_name').value.trim();
    const hourlyRate = document.getElementById('new_worker_rate').value;
    
    if (!name) {
        alert('Please enter a worker name');
        return;
    }
    
    fetch('/api/add-factory-worker/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            name: name,
            hourly_rate: hourlyRate
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeModal('addWorkerModal');
            location.reload();
        } else {
            alert('Error adding worker: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error adding worker');
    });
}

function saveWorker(workerId) {
    const row = document.getElementById('worker-row-' + workerId);
    const name = row.querySelector('.worker-name').value.trim();
    const hourlyRate = row.querySelector('.worker-rate').value;
    const active = row.querySelector('.worker-active').checked;
    
    if (!name) {
        alert('Name cannot be empty');
        return;
    }
    
    fetch('/api/factory-worker/' + workerId + '/update/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            name: name,
            hourly_rate: hourlyRate,
            active: active
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const btn = row.querySelector('.btn-success');
            btn.innerHTML = '<i class="bi bi-check-circle-fill"></i>';
            setTimeout(() => { btn.innerHTML = '<i class="bi bi-check-lg"></i>'; }, 1500);
            if (data.worker.active) {
                row.classList.remove('text-muted');
            } else {
                row.classList.add('text-muted');
            }
        } else {
            alert('Error saving worker: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving worker');
    });
}

function confirmDeleteWorker(workerId, workerName) {
    deleteWorkerId = workerId;
    document.getElementById('delete-worker-name').textContent = workerName;
    openModal('deleteConfirmModal');
}

function deleteWorker() {
    if (!deleteWorkerId) return;
    
    fetch('/api/factory-worker/' + deleteWorkerId + '/delete/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeModal('deleteConfirmModal');
            const row = document.getElementById('worker-row-' + deleteWorkerId);
            if (row) row.remove();
            deleteWorkerId = null;
        } else {
            alert('Error deleting worker: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error deleting worker');
    });
}

// ═══════════════════════════════════════
// Utility
// ═══════════════════════════════════════
function getCsrfToken() {
    const name = 'csrftoken';
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
