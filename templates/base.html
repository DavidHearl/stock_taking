<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Inventory and Order Management{% endblock %}</title>
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <!-- Custom CSS -->
    {% load static %}
    <link href="{% static 'css/styles.css' %}" rel="stylesheet">
    <link href="{% static 'css/light-mode.css' %}" rel="stylesheet">
    
    {% block extra_css %}{% endblock %}
</head>
<body>
    {% if is_impersonating %}
    <!-- Impersonation Banner -->
    <div class="impersonation-banner">
        <div class="impersonation-inner">
            <i class="bi bi-eye-fill"></i>
            <span>You are viewing as <strong>{{ user.get_full_name|default:user.username }}</strong></span>
            <a href="{% url 'impersonate_stop' %}" class="impersonation-stop">
                <i class="bi bi-x-circle"></i> Stop Impersonating
            </a>
        </div>
    </div>
    {% endif %}
    <!-- Vertical Sidebar Navigation -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <img src="{% static 'images/logo-full-dark.png' %}" alt="Atlas" class="logo-full logo-dark-bg">
                <img src="{% static 'images/logo-full-light.png' %}" alt="Atlas" class="logo-full logo-light-bg">
                <img src="{% static 'images/logo-icon-dark.png' %}" alt="Atlas" class="logo-icon logo-dark-bg">
                <img src="{% static 'images/logo-icon-light.png' %}" alt="Atlas" class="logo-icon logo-light-bg">
            </div>
            <button class="sidebar-toggle" id="sidebarToggle">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <button class="mobile-nav-close" id="mobileNavClose" title="Close menu">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>

        {% if user.is_authenticated %}

        <!-- Navigation Menu -->
        <nav class="sidebar-nav">
            <!-- Dashboard -->
            {% if role_perms.dashboard.can_view or is_role_admin %}
            <div class="nav-section">
                <a href="{% url 'dashboard' %}" class="nav-link single {% block nav_dashboard_active %}{% endblock %}" title="Dashboard">
                    <i class="bi bi-speedometer2"></i><span class="nav-text">Dashboard</span>
                </a>
            </div>
            {% endif %}

            <!-- Projects Section -->
            {% if role_perms.orders.can_view or role_perms.customers.can_view or role_perms.remedials.can_view or is_role_admin %}
            <div class="nav-section">
                <div class="nav-section-header" onclick="toggleSection('projects')" title="Projects">
                    <span class="nav-label"><i class="bi bi-folder"></i><span class="nav-text">Projects</span></span>
                    <span class="section-arrow">▼</span>
                </div>
                <div class="nav-section-content" id="projects-section">
                    {% if role_perms.orders.can_view or is_role_admin %}
                    <a href="{% url 'ordering' %}" class="nav-link" title="Orders"><span class="nav-text">Orders</span></a>
                    {% endif %}
                    {% if role_perms.customers.can_view or is_role_admin %}
                    <a href="{% url 'customers_list' %}" class="nav-link {% block nav_customers_active %}{% endblock %}" title="Customers"><span class="nav-text">Customers</span></a>
                    {% endif %}
                    {% if role_perms.remedials.can_view or is_role_admin %}
                    <a href="{% url 'remedials' %}" class="nav-link {% block nav_remedials_active %}{% endblock %}" title="Remedials"><span class="nav-text">Remedials</span></a>
                    {% endif %}
                    {% if role_perms.customers.can_view or is_role_admin %}
                    <a href="{% url 'sales_list' %}" class="nav-link {% block nav_sales_active %}{% endblock %}" title="Events"><span class="nav-text">Events</span></a>
                    {% endif %}
                    {% if role_perms.customers.can_view or is_role_admin %}
                    <a href="{% url 'leads_list' %}" class="nav-link {% block nav_leads_active %}{% endblock %}" title="Contacts"><span class="nav-text">Contacts</span></a>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Accounting Section -->
            {% if role_perms.invoices.can_view or is_role_admin %}
            <div class="nav-section">
                <div class="nav-section-header" onclick="toggleSection('accounting')" title="Accounting">
                    <span class="nav-label"><i class="bi bi-cash-stack"></i><span class="nav-text">Accounting</span></span>
                    <span class="section-arrow">▼</span>
                </div>
                <div class="nav-section-content" id="accounting-section">
                    {% if role_perms.invoices.can_view or is_role_admin %}
                    <a href="{% url 'invoices_list' %}" class="nav-link {% block nav_invoices_active %}{% endblock %}" title="Invoices"><span class="nav-text">Sales Invoices</span></a>
                    {% endif %}
                    <a href="{% url 'xero_status' %}" class="nav-link {% block nav_xero_active %}{% endblock %}" title="Xero"><span class="nav-text">Xero</span></a>
                </div>
            </div>
            {% endif %}

            <!-- Purchase Section -->
            {% if role_perms.purchase_orders.can_view or role_perms.suppliers.can_view or role_perms.boards_summary.can_view or role_perms.os_doors_summary.can_view or is_role_admin %}
            <div class="nav-section">
                <div class="nav-section-header" onclick="toggleSection('purchase')" title="Purchase">
                    <span class="nav-label"><i class="bi bi-cart"></i><span class="nav-text">Purchase</span></span>
                    <span class="section-arrow">▼</span>
                </div>
                <div class="nav-section-content" id="purchase-section">
                    {% if role_perms.purchase_orders.can_view or is_role_admin %}
                    <a href="{% url 'purchase_orders_list' %}" class="nav-link {% block nav_purchase_orders_active %}{% endblock %}" title="Purchase Orders"><span class="nav-text">Purchase Orders</span></a>
                    {% endif %}
                    {% if role_perms.suppliers.can_view or is_role_admin %}
                    <a href="{% url 'suppliers_list' %}" class="nav-link {% block nav_suppliers_active %}{% endblock %}" title="Suppliers"><span class="nav-text">Suppliers</span></a>
                    {% endif %}
                    {% if role_perms.boards_summary.can_view or is_role_admin %}
                    <a href="{% url 'boards_summary' %}" class="nav-link {% block nav_boards_summary_active %}{% endblock %}" title="Boards Summary"><span class="nav-text">Boards Summary</span></a>
                    {% endif %}
                    {% if role_perms.os_doors_summary.can_view or is_role_admin %}
                    <a href="{% url 'os_doors_summary' %}" class="nav-link {% block nav_os_doors_summary_active %}{% endblock %}" title="OS Doors Summary"><span class="nav-text">OS Doors Summary</span></a>
                    {% endif %}

                </div>
            </div>
            {% endif %}

            <!-- Products & Stock Section -->
            {% if role_perms.stock_list.can_view or role_perms.stock_take.can_view or role_perms.substitutions.can_view or role_perms.material_shortage.can_view or role_perms.raumplus_storage.can_view or is_role_admin %}
            <div class="nav-section">
                <div class="nav-section-header" onclick="toggleSection('products')" title="Products">
                    <span class="nav-label"><i class="bi bi-box-seam"></i><span class="nav-text">Products & Stock</span></span>
                    <span class="section-arrow">▼</span>
                </div>
                <div class="nav-section-content" id="products-section">
                    {% if role_perms.stock_list.can_view or is_role_admin %}
                    <a href="{% url 'stock_list' %}" class="nav-link {% block nav_stock_active %}{% endblock %}" title="Stock List"><span class="nav-text">Stock List</span></a>
                    {% endif %}
                    {% if role_perms.stock_take.can_view or is_role_admin %}
                    <a href="{% url 'stock_take_list' %}" class="nav-link {% block nav_schedules_active %}{% endblock %}" title="Stock Take"><span class="nav-text">Stock Take</span></a>
                    {% endif %}
                    {% if role_perms.substitutions.can_view or is_role_admin %}
                    <a href="{% url 'substitutions' %}" class="nav-link {% block nav_substitutions_active %}{% endblock %}" title="Substitutions"><span class="nav-text">Substitutions</span></a>
                    {% endif %}
                    {% if role_perms.material_shortage.can_view or role_perms.raumplus_storage.can_view or is_role_admin %}
                    <a href="{% url 'shortages' %}" class="nav-link {% block nav_shortages_active %}{% endblock %}" title="Shortages"><span class="nav-text">Shortages</span></a>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Calendar Section -->
            {% if role_perms.fit_board.can_view or role_perms.timesheets.can_view or role_perms.workflow.can_view or is_role_admin %}
            <div class="nav-section">
                <div class="nav-section-header" onclick="toggleSection('calendar')" title="Calendar">
                    <span class="nav-label"><i class="bi bi-calendar3"></i><span class="nav-text">Calendar</span></span>
                    <span class="section-arrow">▼</span>
                </div>
                <div class="nav-section-content" id="calendar-section">
                    {% if role_perms.fit_board.can_view or is_role_admin %}
                    <a href="{% url 'calendar_weekly' %}" class="nav-link {% block nav_fit_board_active %}{% endblock %}" title="Calendar"><span class="nav-text">Calendar</span></a>
                    {% endif %}
                    {% if role_perms.timesheets.can_view or is_role_admin %}
                    <a href="{% url 'timesheets' %}" class="nav-link {% block nav_timesheets_active %}{% endblock %}" title="Timesheets"><span class="nav-text">Timesheets</span></a>
                    {% endif %}
                    {% if role_perms.workflow.can_view or is_role_admin %}
                    <a href="{% url 'workflow' %}" class="nav-link {% block nav_workflow_active %}{% endblock %}" title="Workflow"><span class="nav-text">Workflow</span></a>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Tools Section -->
            {% if role_perms.map.can_view or role_perms.generate_materials.can_view or role_perms.database_check.can_view or is_role_admin %}
            <div class="nav-section">
                <div class="nav-section-header" onclick="toggleSection('tools')" title="Tools">
                    <span class="nav-label"><i class="bi bi-tools"></i><span class="nav-text">Tools</span></span>
                    <span class="section-arrow">▼</span>
                </div>
                <div class="nav-section-content" id="tools-section">
                    {% if role_perms.map.can_view or is_role_admin %}
                    <a href="{% url 'map' %}" class="nav-link {% block nav_map_active %}{% endblock %}" title="Map"><span class="nav-text">Map</span></a>
                    {% endif %}
                    {% if role_perms.generate_materials.can_view or is_role_admin %}
                    <a href="{% url 'generate_materials' %}" class="nav-link {% block nav_generate_pnx_active %}{% endblock %}" title="Order Generator"><span class="nav-text">Order Generator</span></a>
                    {% endif %}
                    {% if role_perms.database_check.can_view or is_role_admin %}
                    <a href="{% url 'check_database' %}" class="nav-link" title="Database Check"><span class="nav-text">Database Check</span></a>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Reports Section -->
            {% if role_perms.material_report.can_view or role_perms.costing_report.can_view or role_perms.remedial_report.can_view or is_role_admin %}
            <div class="nav-section">
                <div class="nav-section-header" onclick="toggleSection('reports')" title="Reports">
                    <span class="nav-label"><i class="bi bi-file-earmark-bar-graph"></i><span class="nav-text">Reports</span></span>
                    <span class="section-arrow">▼</span>
                </div>
                <div class="nav-section-content" id="reports-section">
                    {% if role_perms.material_report.can_view or is_role_admin %}
                    <a href="{% url 'material_report' %}" class="nav-link {% block nav_material_report_active %}{% endblock %}" title="Material Report"><span class="nav-text">Material Report</span></a>
                    {% endif %}
                    {% if role_perms.costing_report.can_view or is_role_admin %}
                    <a href="{% url 'costing_report' %}" class="nav-link {% block nav_costing_report_active %}{% endblock %}" title="Costing Report"><span class="nav-text">Costing Report</span></a>
                    {% endif %}
                    {% if role_perms.remedial_report.can_view or is_role_admin %}
                    <a href="{% url 'remedial_report' %}" class="nav-link {% block nav_remedial_report_active %}{% endblock %}" title="Remedial Report"><span class="nav-text">Remedial Report</span></a>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            {% if role_perms.admin_panel.can_view or is_role_admin %}
            <!-- Admin Section -->
            <div class="nav-section">
                <div class="nav-section-header" onclick="toggleSection('admin')" title="Admin">
                    <span class="nav-label"><i class="bi bi-shield-lock-fill"></i><span class="nav-text">Admin</span></span>
                    <span class="section-arrow">▼</span>
                </div>
                <div class="nav-section-content" id="admin-section">
                    <a href="{% url 'admin_users' %}" class="nav-link {% block nav_admin_users_active %}{% endblock %}" title="Users"><span class="nav-text">Users</span></a>
                    <a href="{% url 'admin_templates' %}" class="nav-link {% block nav_admin_templates_active %}{% endblock %}" title="Templates"><span class="nav-text">Templates</span></a>
                    <a href="{% url 'admin_roles' %}" class="nav-link {% block nav_admin_roles_active %}{% endblock %}" title="Roles"><span class="nav-text">Roles</span></a>
                    <a href="{% url 'admin_settings' %}" class="nav-link {% block nav_admin_settings_active %}{% endblock %}" title="Settings"><span class="nav-text">Settings</span></a>
                    <a href="/admin/" class="nav-link" title="Admin Panel" target="_blank"><span class="nav-text">Admin Panel</span></a>
                </div>
            </div>
            {% endif %}

            <!-- Tickets -->
            {% if role_perms.tickets.can_view or is_role_admin %}
            <a href="{% url 'tickets_list' %}" class="nav-link single {% block nav_tickets_active %}{% endblock %}" title="Tickets">
                <i class="bi bi-ticket-detailed"></i><span class="nav-text">Tickets{% if is_role_admin and open_ticket_count %} ({{ open_ticket_count }}){% endif %}</span>
                {% if is_role_admin and unread_ticket_count %}<span class="nav-badge unread">{{ unread_ticket_count }}</span>{% endif %}
            </a>
            {% endif %}

            <!-- Claim Service -->
            {% if role_perms.claim_service.can_view or is_role_admin %}
            <a href="{% url 'claim_service' %}" class="nav-link single {% block nav_claim_service_active %}{% endblock %}" title="Claim Service">
                <i class="bi bi-file-earmark-pdf"></i><span class="nav-text">Claim Service</span>
            </a>
            {% endif %}
        </nav>
        {% endif %}
    </div>

    <!-- Mobile Overlay -->
    <div class="mobile-overlay" id="mobileOverlay"></div>

    <!-- Top Navbar -->
    <div class="top-navbar" id="topNavbar">
        {% if user.is_authenticated %}
        <div class="top-navbar-left">
            <button class="mobile-hamburger" id="mobileHamburger" title="Menu">
                <i class="bi bi-list"></i>
            </button>
            <h1 class="page-title">{% block page_title %}{% endblock %}</h1>
        </div>
        <div class="top-navbar-right">
            {% block page_actions %}{% endblock %}
            <div class="top-search">
                <form method="GET" action="{% url 'global_search' %}">
                    <input type="search" name="q" placeholder="Search everything..." value="{{ request.GET.q }}">
                </form>
            </div>
            <select class="top-location-select" id="topLocationSelect" title="Location" onchange="setLocation(this.value)">
                <option value=""{% if not current_location %} selected{% endif %}>All Locations</option>
                {% for loc in available_locations %}
                <option value="{{ loc }}"{% if current_location == loc %} selected{% endif %}>{{ loc }}</option>
                {% endfor %}
            </select>
            <button class="theme-toggle" id="themeToggle" onclick="toggleDarkMode()" title="Toggle theme">
                <i class="bi bi-sun-fill" id="themeIcon"></i>
            </button>
            <a href="{% url 'user_profile' %}" class="top-user" title="My Profile">
                <i class="bi bi-person-circle"></i>
                <span>{{ user.username }}</span>
                {% if user_role_display %}
                <span style="font-size: 0.65rem; padding: 1px 8px; border-radius: 10px; background: rgba(255,255,255,0.1); margin-left: 4px;">{{ user_role_display }}</span>
                {% endif %}
            </a>
            <a href="{% url 'account_logout' %}" class="top-logout" title="Logout">
                <i class="bi bi-box-arrow-left"></i>
            </a>
        </div>
        {% else %}
        <div class="top-navbar-left"></div>
        <div class="top-navbar-right">
            <a href="{% url 'account_login' %}" class="top-login">
                <i class="bi bi-box-arrow-in-right"></i> Login
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Main Content Area -->
    <div class="main-content" id="mainContent">
        <div class="content-wrapper">
            {% block content %}{% endblock %}
        </div>
    </div>

    <!-- Global Toast Notifications -->
    {% if messages %}
    <div class="toast-container" id="toastContainer">
        {% for message in messages %}
        <div class="toast toast-{{ message.tags }}" role="alert">
            <span class="toast-text">{{ message }}</span>
            <button type="button" class="toast-close" onclick="dismissToast(this.parentElement)">&times;</button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {% if user.is_authenticated %}
    <!-- Import Modal -->
    <div class="modal" id="importModal">
        <div class="modal-overlay" onclick="closeModal('importModal')"></div>
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Import CSV File</h3>
                    <button type="button" class="modal-close" onclick="closeModal('importModal')">&times;</button>
                </div>
                <form method="post" action="{% url 'import_csv' %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="alert alert-warning">
                            <strong>Warning:</strong> This will delete all existing stock data and replace it with the imported data.
                        </div>
                        <div class="form-group">
                            <label for="csv_file">Choose CSV File</label>
                            <input type="file" id="csv_file" name="csv_file" accept=".csv" required>
                        </div>
                        <div class="alert alert-info">
                            <strong>CSV Format:</strong> Sku, Name, Cost, Category, Location, Quantity, SerialOrBatch
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('importModal')">Cancel</button>
                        <button type="submit" class="btn btn-primary">Import Data</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Custom JavaScript -->
    <script>
        // Sidebar toggle functionality
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        const topNavbar = document.getElementById('topNavbar');
        const sidebarToggle = document.getElementById('sidebarToggle');

        // Restore sidebar state from localStorage
        if (localStorage.getItem('sidebarCollapsed') === 'true') {
            sidebar.classList.add('collapsed');
            mainContent.classList.add('expanded');
            topNavbar.classList.add('expanded');
        }

        sidebarToggle.addEventListener('click', function(e) {
            e.stopPropagation();
            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('expanded');
            topNavbar.classList.toggle('expanded');
            localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
        });

        // Mobile hamburger menu
        const mobileHamburger = document.getElementById('mobileHamburger');
        const mobileOverlay = document.getElementById('mobileOverlay');

        function openMobileNav() {
            sidebar.classList.add('mobile-open');
            mobileOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeMobileNav() {
            sidebar.classList.remove('mobile-open');
            mobileOverlay.classList.remove('active');
            document.body.style.overflow = '';
        }

        if (mobileHamburger) {
            mobileHamburger.addEventListener('click', function(e) {
                e.stopPropagation();
                if (sidebar.classList.contains('mobile-open')) {
                    closeMobileNav();
                } else {
                    openMobileNav();
                }
            });
        }

        if (mobileOverlay) {
            mobileOverlay.addEventListener('click', closeMobileNav);
        }

        const mobileNavClose = document.getElementById('mobileNavClose');
        if (mobileNavClose) {
            mobileNavClose.addEventListener('click', closeMobileNav);
        }

        // Close mobile nav on link click
        sidebar.querySelectorAll('.nav-link').forEach(function(link) {
            link.addEventListener('click', function() {
                if (window.innerWidth <= 768) {
                    closeMobileNav();
                }
            });
        });

        // Handle resize - close mobile nav if resizing to desktop
        window.addEventListener('resize', function() {
            if (window.innerWidth > 768) {
                closeMobileNav();
            }
        });

        // Section toggle functionality
        function toggleSection(sectionName) {
            const section = document.getElementById(sectionName + '-section');
            const header = section.previousElementSibling;
            section.classList.toggle('open');
            header.classList.toggle('open');
        }

        // Auto-open nav sections that contain the active link
        document.querySelectorAll('.nav-section-content').forEach(function(section) {
            if (section.querySelector('.nav-link.active')) {
                section.classList.add('open');
                var header = section.previousElementSibling;
                if (header) header.classList.add('open');
            }
        });

        // Modal functionality
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // Dark mode toggle
        function toggleDarkMode() {
            fetch("{% url 'toggle_dark_mode' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.body.classList.toggle('light-mode', !data.dark_mode);
                    const icon = document.getElementById('themeIcon');
                    if (data.dark_mode) {
                        icon.className = 'bi bi-sun-fill';
                    } else {
                        icon.className = 'bi bi-moon-fill';
                    }
                }
            })
            .catch(error => console.error('Error toggling dark mode:', error));
        }

        // Location selector
        function setLocation(location) {
            fetch("{% url 'set_location' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ location: location }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Reload so all pages reflect the new location filter
                    window.location.reload();
                }
            })
            .catch(error => console.error('Error setting location:', error));
        }

        // Set initial theme on page load
        document.addEventListener('DOMContentLoaded', function() {
            {% if user.is_authenticated and user.profile %}
            const isDarkMode = {{ user.profile.dark_mode|lower }};
            if (!isDarkMode) {
                document.body.classList.add('light-mode');
                const icon = document.getElementById('themeIcon');
                if (icon) {
                    icon.className = 'bi bi-moon-fill';
                }
            }
            {% endif %}
        });
    </script>
    
    {% block extra_js %}{% endblock %}

    <script>
    // ── Toast auto-dismiss ──────────────────────────────────
    function dismissToast(el) {
        el.classList.add('toast-hiding');
        setTimeout(() => el.remove(), 300);
    }
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.toast').forEach(function(toast, i) {
            // Stagger the appearance slightly
            setTimeout(() => toast.classList.add('toast-visible'), i * 80);
            // Auto-dismiss after 4 seconds
            setTimeout(() => dismissToast(toast), 4000 + i * 500);
        });
    });
    </script>
</body>
</html>