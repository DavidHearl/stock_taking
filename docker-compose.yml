version: "3.9"
services:
  web:
    build: .
    entrypoint: []
    networks: [traefik-net]
    # Assess what ports are already in use by another app in the VM
    ports:
      - "8001:8000"
    # Search the name from WSGI in the settings file, ie WSGI_APPLICATION = 'stock_taking.wsgi.application'
    labels:
      - traefik.enable=true
      - traefik.http.routers.stock_taking.rule=Host(`stock-taking.mediaservers.co.uk`)
      - traefik.http.routers.stock_taking.entrypoints=web
      - traefik.http.services.stock_taking.loadbalancer.server.port=8000
    volumes:
      - /srv/static/stock_taking:/app/staticfiles
      - /srv/media/stock_taking:/app/media
    restart: unless-stopped
    command: [
      "gunicorn",
      "stock_taking.wsgi:application",
      "--bind",
      "0.0.0.0:8000",
      "--workers",
      "3",
      "--log-level",
      "debug",
      "--access-logfile",
      "-",
      "--error-logfile",
      "-"
    ]
    environment:
      DJANGO_SETTINGS_MODULE: ${DJANGO_SETTINGS_MODULE}
      SECRET_KEY: ${SECRET_KEY}
      DEBUG: ${DEBUG}
      ALLOWED_HOSTS: ${ALLOWED_HOSTS}
      DATABASE_URL: ${DATABASE_URL}
      GOOGLE_MAPS_API_KEY: ${GOOGLE_MAPS_API_KEY}
      BUCKET_ACCESS_ID: ${BUCKET_ACCESS_ID}
      BUCKET_SECRET_KEY: ${BUCKET_SECRET_KEY}
      BUCKET_NAME: ${BUCKET_NAME}
      BUCKET_ENDPOINT_URL: ${BUCKET_ENDPOINT_URL}
      BUCKET_REGION: ${BUCKET_REGION}

  # Scheduled tasks â€” syncs recent Anthill customers at 08:00 & 12:00 daily
  scheduler:
    build: .
    entrypoint: []
    networks: [traefik-net]
    volumes:
      - /srv/media/stock_taking:/app/media
    restart: unless-stopped
    command: >
      sh -c "
        apt-get update && apt-get install -y --no-install-recommends cron &&
        rm -rf /var/lib/apt/lists/* &&
        printenv | grep -E '^(DJANGO_|SECRET_|DEBUG|ALLOWED_|DATABASE_|ANTHILL_)' | sed 's/=\(.*\)/=\"\1\"/' > /etc/environment &&
        echo 'SHELL=/bin/sh' > /etc/cron.d/anthill-sync &&
        echo '0 8 * * * root . /etc/environment; cd /app && python manage.py sync_recent_customers >> /var/log/cron.log 2>&1' >> /etc/cron.d/anthill-sync &&
        echo '0 12 * * * root . /etc/environment; cd /app && python manage.py sync_recent_customers >> /var/log/cron.log 2>&1' >> /etc/cron.d/anthill-sync &&
        echo '' >> /etc/cron.d/anthill-sync &&
        chmod 0644 /etc/cron.d/anthill-sync &&
        touch /var/log/cron.log &&
        cron && tail -f /var/log/cron.log
      "
    environment:
      DJANGO_SETTINGS_MODULE: ${DJANGO_SETTINGS_MODULE}
      SECRET_KEY: ${SECRET_KEY}
      DEBUG: ${DEBUG}
      ALLOWED_HOSTS: ${ALLOWED_HOSTS}
      DATABASE_URL: ${DATABASE_URL}
      ANTHILL_USERNAME: ${ANTHILL_USERNAME}
      ANTHILL_PASSWORD: ${ANTHILL_PASSWORD}

networks:
  traefik-net:
    external: true